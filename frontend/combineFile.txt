<script setup>
import { useUIStore } from '@/stores/ui'
import { ref } from 'vue'
import AppSidebar from './components/AppSidebar.vue'
import AppTopbar from './components/AppTopbar.vue'
import Toasts from '@/components/ui/Toasts.vue'
const ui = useUIStore()
// Default: open on md+ screens, closed on mobile
const sidebarOpen = ref(typeof window !== 'undefined' ? window.matchMedia('(min-width: 768px)').matches : false)

function onTopbarToggle() {
  const isDesktop = typeof window !== 'undefined' && window.matchMedia('(min-width: 768px)').matches
  if (isDesktop) {
    ui.toggleSidebarCollapsed()
  } else {
    sidebarOpen.value = !sidebarOpen.value
  }
}

// Sidebar drag-resize
let resizing = false
function onSidebarPointerDown(e){
  resizing = true
  window.addEventListener('pointermove', onSidebarPointerMove)
  window.addEventListener('pointerup', onSidebarPointerUp)
  e.preventDefault()
}
function onSidebarPointerMove(e){
  if (!resizing) return
  // sidebar anchored at left=0; use clientX as width
  ui.setSidebarWidth(e.clientX)
}
function onSidebarPointerUp(){
  resizing = false
  ui.snapSidebar()
  window.removeEventListener('pointermove', onSidebarPointerMove)
  window.removeEventListener('pointerup', onSidebarPointerUp)
}
</script>

<template>
  <div class="min-h-screen bg-app text-app" :style="{ '--sidebar-w': ui.computedSidebarWidth + 'px' }">
    <!-- Sidebar: fixed always; slide-in on mobile -->
    <div
      class="fixed inset-y-0 left-0 z-40 sidebar transform transition-transform transition-all duration-200 motion-reduce:transition-none"
      :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'"
      :style="{ width: ui.computedSidebarWidth + 'px' }"
      :data-collapsed="ui.sidebarCollapsed"
      :data-sidebar-width="ui.computedSidebarWidth"
    >
      <AppSidebar @navigate="sidebarOpen = false" />
      <!-- Drag handle -->
      <div
        class="absolute top-0 right-0 h-full w-2 cursor-col-resize bg-[var(--sidebar-bg)] focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--sidebar-fg)]/40 focus-visible:ring-offset-0"
        title="Drag to resize"
        tabindex="0"
        role="separator"
        aria-orientation="vertical"
        :aria-valuemin="ui.SIDEBAR_MIN"
        :aria-valuemax="ui.SIDEBAR_MAX"
        :aria-valuenow="ui.computedSidebarWidth"
        aria-label="Resize sidebar"
        @pointerdown="onSidebarPointerDown"
        @keydown.left.prevent="ui.setSidebarWidth(ui.sidebarWidth - 10)"
        @keydown.right.prevent="ui.setSidebarWidth(ui.sidebarWidth + 10)"
        @keydown.enter.prevent="ui.snapSidebar(ui.sidebarWidth)"
      />
    </div>

    <!-- Main content: shifted right on md+ -->
    <div class="min-h-screen flex flex-col ml-sidebar transition-all duration-200 motion-reduce:transition-none">
      <AppTopbar @toggleSidebar="onTopbarToggle" />
      <main class="p-6">
        <RouterView />
      </main>
    </div>

    <!-- Backdrop for mobile -->
    <div
      v-if="sidebarOpen"
      class="fixed inset-0 bg-black/30 z-30 md:hidden"
      @click="sidebarOpen = false"
    />
    <Toasts />
  </div>
</template>

<style scoped>
@media (min-width: 768px) {
  .ml-sidebar { margin-left: var(--sidebar-w, 256px); }
}
</style>


import axios from 'axios'

const api = axios.create({
  baseURL: '/api/v1', // Assuming your Django backend serves API at /api/v1
  headers: {
    'Content-Type': 'application/json',
  },
})

export default api


// src/api/mock.js
const demoData = [
  { fail_id: 'AA-0001', status: 'Active',   severity: 'High',     circuit: 'CIR-12', reported_at: '2025-08-19 08:20', resolved_at: null, assigned_to: 'Supervisor A', station: 'Bandra',  section: 'Western Line' },
  { fail_id: 'AB-0342', status: 'Resolved', severity: 'Low',      circuit: 'CIR-05', reported_at: '2025-08-19 06:05', resolved_at: '2025-08-19 07:00', assigned_to: 'Supervisor B', station: 'Andheri', section: 'Western Line' },
  { fail_id: 'AC-1010', status: 'Resolved',   severity: 'Critical', circuit: 'CIR-77', reported_at: '2025-08-18 23:41', resolved_at: '2025-08-19 01:30', assigned_to: 'Supervisor C', station: 'Dadar',   section: 'Central Line' },
  // add a few more rows so filtering feels real
  { fail_id: 'AD-2001', status: 'Active',   severity: 'Low',      circuit: 'CIR-33', reported_at: '2025-08-18 20:10', resolved_at: null, assigned_to: 'Supervisor D', station: 'Virar',   section: 'Western Line' },
  { fail_id: 'AE-3302', status: 'Resolved', severity: 'High',     circuit: 'CIR-12', reported_at: '2025-08-18 14:25', resolved_at: '2025-08-18 15:00', assigned_to: 'Supervisor E', station: 'Churchgate', section: 'Western Line' },
]

export async function listFailures(params = {}) {
  // simulate network latency
  await new Promise(r => setTimeout(r, 400))
  // ignore params for now; return everything
  return { count: demoData.length, results: demoData }
}


  export async function getCircuits() {
  await new Promise(r => setTimeout(r, 100))
  const circuits = [...new Set(demoData.map(d => d.circuit))]
  return circuits.map(c => ({ label: c, value: c }))
}

export async function getSections() {
  await new Promise(r => setTimeout(r, 100))
  const sections = [...new Set(demoData.map(d => d.section))]
  return sections.map(s => ({ label: s, value: s }))
}

export async function getStations() {
  await new Promise(r => setTimeout(r, 100))
  const stations = [...new Set(demoData.map(d => d.station))]
  return stations.map(s => ({ label: s, value: s }))
}

export async function getSupervisors() {
  await new Promise(r => setTimeout(r, 100))
  const supervisors = [...new Set(demoData.map(d => d.assigned_to))]
  return supervisors.map(s => ({ label: s, value: s }))
}

export async function getStatuses() {
  await new Promise(r => setTimeout(r, 100))
  const statuses = [...new Set(demoData.map(d => d.status))]
  return statuses.map(s => ({ label: s, value: s }))
}



<?xml version="1.0" encoding="UTF-8"?>
<svg id="Layer_2" data-name="Layer 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 21.24 25.23">
  <path d="M14.39,17.38l-1.39-.03c.24.43.48.87.72,1.3H4.7c.24-.43.48-.87.72-1.3l-1.39.03c-1.34,2.38-2.68,4.76-4.03,7.15.11.62.8.89,1.13.56.32-.58.64-1.16.96-1.74h14.24c.32.58.64,1.16.96,1.74.33.33,1.02.06,1.13-.56-1.34-2.39-2.69-4.77-4.03-7.15ZM2.74,22.18c.44-.79.88-1.58,1.32-2.37h10.3c.44.79.88,1.58,1.32,2.37H2.74Z"/>
  <path d="M16.17,9.44c-.83,0-1.62-.24-2.28-.65-1.18-.72-1.99-1.99-2.08-3.45,0-.09,0-.18,0-.27,0-.97.32-1.87.86-2.59-.26-.04-.52-.07-.79-.09C7.17,1.93,1.43,2.67.35,4.64v11.14c0,.62.5,1.13,1.12,1.13h15.48c.62,0,1.12-.51,1.12-1.13v-6.78c-.57.28-1.22.44-1.9.44ZM3.43,14.33c-.86,0-1.56-.66-1.56-1.48s.7-1.48,1.56-1.48,1.55.66,1.55,1.48-.69,1.48-1.55,1.48ZM2.71,10.15c-.33,0-.6-.27-.6-.59v-3.63c0-.33.27-.59.6-.59h8.4c.09,1.87,1.19,3.47,2.78,4.27-.03.3-.29.54-.59.54H2.71ZM14.98,14.33c-.86,0-1.55-.66-1.55-1.48s.69-1.48,1.55-1.48,1.56.66,1.56,1.48-.7,1.48-1.56,1.48Z"/>
  <path d="M16.17,0c-1.82,0-3.41.95-4.3,2.39-.5.77-.78,1.69-.78,2.68,0,.09,0,.18.02.27.09,1.87,1.19,3.47,2.78,4.27.68.34,1.46.54,2.28.54.67,0,1.32-.13,1.9-.37,1.86-.76,3.17-2.58,3.17-4.71,0-2.8-2.27-5.07-5.07-5.07ZM18.07,9c-.57.28-1.22.44-1.9.44-.83,0-1.62-.24-2.28-.65-1.18-.72-1.99-1.99-2.08-3.45,0-.09,0-.18,0-.27,0-.97.32-1.87.86-2.59.79-1.08,2.07-1.77,3.51-1.77,2.41,0,4.36,1.95,4.36,4.36,0,1.73-1,3.23-2.46,3.93Z"/>
  <path d="M13.89,8.79v.82c-1.59-.8-2.69-2.4-2.78-4.27h.7c.09,1.46.9,2.73,2.08,3.45Z"/>
  <g>
    <rect x="13.41" y="4.31" width="3.37" height=".67" rx=".33" ry=".33" transform="translate(23.3 18.13) rotate(-138.42)"/>
    <rect x="15.56" y="4.31" width="4.46" height=".67" rx=".33" ry=".33" transform="translate(-.01 9.23) rotate(-29.09)"/>
  </g>
</svg>


/* Unified palette */
@import "@/styles/palettes.css";
@import "@/styles/status-palette.css";

@tailwind base;
@tailwind components;
@tailwind utilities;

/* Base: apply global colors to body and inputs */
@layer base {
  body { background-color: var(--bg-main); color: var(--body-text); }
  a { color: var(--slate-gray); }
  input, select, textarea { background-color: var(--input-bg); color: var(--body-text); border: 1px solid var(--french-gray); }
  :root { --text: var(--body-text); --border: var(--platinum); --card: var(--card-bg); }
}

/* Shared form controls */
@layer components {
  /* Shared form control style: matches Event ID look */
  .field {
    @apply w-full h-11 rounded-lg border bg-card text-app px-3 transition;
    border-color: var(--platinum);
  }
  .field::placeholder { color: color-mix(in srgb, var(--body-text) 50%, transparent); }
  .field:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--slate-gray);
    border-color: color-mix(in srgb, var(--slate-gray) 80%, #000 20%);
  }
  /* For multi-line */
  .field-textarea {
    @apply w-full min-h-[120px] rounded-lg border bg-card text-app p-3 transition;
    border-color: var(--platinum);
  }
  .field-textarea::placeholder { color: color-mix(in srgb, var(--body-text) 50%, transparent); }
  .field-textarea:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--slate-gray);
    border-color: color-mix(in srgb, var(--slate-gray) 80%, #000 20%);
  }
  /* For composite inputs (tags/search) needing focus on container */
  .field-shell {
    @apply w-full rounded-lg border bg-card text-app transition;
    border-color: var(--platinum);
  }
  .field-shell input::placeholder { color: color-mix(in srgb, var(--body-text) 50%, transparent); }
  /* Strip borders/rings from inner inputs placed inside .field-shell */
  .input-reset { @apply bg-transparent border-0 outline-none shadow-none; }
  .input-reset:focus { outline: none; box-shadow: none; border-color: transparent; }
  .field-shell:focus,
  .field-shell:focus-within {
    outline: none;
    box-shadow: 0 0 0 2px var(--slate-gray);
    border-color: color-mix(in srgb, var(--slate-gray) 80%, #000 20%);
  }

  /* Icon button + sidebar item helpers */
  .icon-btn {
    @apply inline-flex items-center justify-center h-10 w-10 rounded-lg text-app transition;
    background-color: transparent;
  }
  .icon-btn:hover { background-color: color-mix(in srgb, var(--card-bg) 92%, black 8%); }

  .side-item {
    @apply flex items-center gap-3 rounded-lg px-3 py-2 text-app transition;
  }
  .side-item:hover { background-color: color-mix(in srgb, var(--sidebar-bg) 92%, white 8%); }
}

/* Utilities bound to unified vars */
@layer utilities {
  /* Elevation */
  .shadow-card    { box-shadow: var(--shadow-card); }
  .shadow-popover { box-shadow: var(--shadow-hover); }

  /* Surfaces and text */
  .bg-app     { background-color: var(--bg-main); }
  .text-app   { color: var(--body-text); }
  .text-muted { color: var(--french-gray-2); }
  .bg-card    { background-color: var(--card-bg); }
  .border-app { border-color: var(--platinum); }
  .bg-surface { background-color: var(--card-bg); }
  .text-var   { color: var(--body-text); }
  .border-var { border-color: var(--platinum); }

  /* Shells */
  .navbar { background-color: var(--sidebar-bg); color: var(--sidebar-fg); }
  .sidebar { background-color: var(--sidebar-bg); color: var(--sidebar-fg); }

  /* Sidebar link styling */
  .sidebar-link { color: var(--sidebar-fg-muted); }
  .sidebar-link:hover { color: var(--sidebar-fg); background-color: color-mix(in srgb, var(--sidebar-fg) 8%, transparent); }
  .sidebar-link-active, .sidebar-link-active:hover { color: var(--sidebar-fg); background-color: color-mix(in srgb, var(--sidebar-fg) 12%, transparent); }

  /* Hover/selected state helpers */
  .hover-primary:not(.selected-primary):hover { background-color: var(--slate-gray-lighter); color: var(--seasalt); }
  .selected-primary { background-color: var(--slate-gray); color: var(--seasalt); border-color: var(--slate-gray); }
  /* Treat aria-pressed=true as active for neutral chips only.
     Do NOT override status-variant chips (they supply their own colors). */
  .chip[aria-pressed="true"]:not(.chip-variant-all):not(.chip-variant-active):not(.chip-variant-inprog):not(.chip-variant-resolved):not(.chip-variant-onhold):not(.is-active) {
    background-color: var(--slate-gray);
    color: var(--seasalt);
    border-color: var(--slate-gray);
    box-shadow: var(--shadow-resting);
  }
  /* Disable hover visual change when active; keep variant colors */
  .chip.selected-primary:hover,
  .chip[aria-pressed="true"]:not(.chip-variant-all):not(.chip-variant-active):not(.chip-variant-inprog):not(.chip-variant-resolved):not(.chip-variant-onhold):not(.is-active):hover {
    background-color: var(--slate-gray);
    color: var(--seasalt);
    border-color: var(--slate-gray);
    box-shadow: var(--shadow-resting);
  }

  /* Chips */
  /* Inactive/neutral pill with subtle elevation */
  .chip { @apply inline-flex items-center justify-center h-10 px-4 text-sm rounded-full transition;
    background-color: var(--card-bg);
    color: var(--body-text);
    box-shadow: var(--shadow-resting);
  }
  .chip:hover { box-shadow: var(--shadow-hover); background-color: var(--seasalt-lighter); }
  .chip:active { box-shadow: var(--shadow-resting); }
  .chip:focus-visible { outline: 2px solid color-mix(in srgb, var(--slate-gray) 40%, transparent); outline-offset: 0; }
  /* Compact transparent chip cluster (no background strip) */
  .chip-group { @apply inline-flex rounded-lg p-1 gap-2; }

  /* Status-colored chip variants (for Dashboard/New Failure filters) */
  .chip-variant-all       { background-color: var(--s-all);        color: var(--s-on-dark); }
  .chip-variant-active    { background-color: var(--s-active);     color: var(--s-on-light); }
  .chip-variant-inprog    { background-color: var(--s-inprogress); color: var(--s-on-light); }
  .chip-variant-resolved  { background-color: var(--s-resolved);   color: var(--s-on-light); }
  .chip-variant-onhold    { background-color: var(--s-onhold);     color: var(--s-on-light); }
  /* Remove hover change for any active status chip */
  .chip.is-active:hover { background: inherit; color: inherit; box-shadow: var(--shadow-resting); }

  /* Badges for statuses (use global status palette) */
  .badge { @apply inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium border; }
  .badge-success { background-color: var(--s-resolved);    color: var(--eerie-black); border-color: color-mix(in srgb, var(--s-resolved) 70%, transparent); }
  .badge-warning { background-color: var(--s-inprogress);  color: var(--eerie-black); border-color: color-mix(in srgb, var(--s-inprogress) 70%, transparent); }
  .badge-danger  { background-color: var(--s-active);      color: var(--eerie-black); border-color: color-mix(in srgb, var(--s-active) 70%, transparent); }
  .badge-hold    { background-color: var(--s-onhold);      color: var(--eerie-black); border-color: color-mix(in srgb, var(--s-onhold) 70%, transparent); }
  /* Neutral */
  .badge-neutral { background-color: var(--seasalt); color: var(--body-text); border-color: var(--platinum); }

  /* Status chip active fills */
  .chip-active-resolved    { background-color: var(--s-resolved);    color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .chip-active-inprogress  { background-color: var(--s-inprogress);  color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .chip-active-onhold      { background-color: var(--s-onhold);      color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .chip-active-active      { background-color: var(--s-active);      color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .chip-active-resolved:hover,
  .chip-active-inprogress:hover,
  .chip-active-onhold:hover,
  .chip-active-active:hover { box-shadow: var(--shadow-hover); }

  /* Buttons */
  .btn { @apply inline-flex items-center justify-center gap-2 h-10 px-4 rounded-lg text-sm font-medium transition; background-color: var(--button-primary); color: var(--seasalt); box-shadow: var(--shadow-resting); }
  .btn:hover { background-color: var(--button-hover); box-shadow: var(--shadow-hover); transform: translateY(-0.5px); }
  .btn:active { box-shadow: var(--shadow-resting); transform: translateY(0); }
  .btn:disabled { box-shadow: none; cursor: not-allowed; }
  .btn-sm { @apply h-8 px-3 text-xs; }

  .btn-primary, .button-primary { background-color: var(--button-primary); color: var(--seasalt); box-shadow: var(--shadow-resting); }
  .btn-primary:hover, .button-primary:hover { background-color: var(--button-hover); box-shadow: var(--shadow-hover); }

  .btn-secondary, .button-secondary { background-color: var(--french-gray); color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .btn-secondary:hover, .button-secondary:hover { background-color: var(--french-gray-lighter); box-shadow: var(--shadow-hover); }

  .btn-outline { background-color: transparent; color: var(--slate-gray); border: 1px solid var(--platinum); }
  .btn-outline:hover { background-color: var(--antiflash-white-lighter); }

  .btn-ghost { background-color: transparent; color: var(--body-text); }
  .btn-ghost:hover { background-color: var(--card-bg); box-shadow: inset 0 0 0 1px var(--platinum); }

  /* Cards */
  .card { @apply rounded-2xl border p-4 overflow-hidden; background: var(--card-bg); border-color: var(--platinum); color: var(--body-text); box-shadow: var(--shadow-card); transition: box-shadow 0.2s ease, background-color 0.2s ease; }
  .card:hover { background-color: var(--seasalt-lighter); box-shadow: var(--shadow-card-hover); }

  /* Equal-height widget helper */
  .widget-eq { @apply min-h-[420px] h-full; }
  .widget-eq-body { @apply h-full; }
}


<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="37.07" height="36" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 198"><path fill="#41B883" d="M204.8 0H256L128 220.8L0 0h97.92L128 51.2L157.44 0h47.36Z"></path><path fill="#41B883" d="m0 0l128 220.8L256 0h-51.2L128 132.48L50.56 0H0Z"></path><path fill="#35495E" d="M50.56 0L128 133.12L204.8 0h-47.36L128 51.2L97.92 0H50.56Z"></path></svg>

<script setup>
import { useRoute, RouterLink, useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { useUIStore } from '@/stores/ui'
// RFMS icon is inlined as SVG for reliable theming
const auth = useAuthStore()
const ui = useUIStore()
const route = useRoute()
const router = useRouter()
const links = [
  { to: '/dashboard', label: 'Dashboard', icon: 'pi pi-home' },
  { to: '/logbook', label: 'Logbook', icon: 'pi pi-book' },
  { to: '/failures/new', label: 'Logbook Entry', icon: 'pi pi-plus-circle' },
  { to: '/analytics', label: 'Analytics', icon: 'pi pi-chart-line' },
  { to: '/reports-now', label: 'Reports Now', icon: 'pi pi-send' },
  { to: '/supervisor-movements', label: 'Supervisor Movements', icon: 'pi pi-users' },
]

const isActive = (to) => route.path.startsWith(to)

function onLogout() {
  // Frontend-only logout placeholder: navigate to /login
  try { auth.logout?.() } catch (_) {}
  router.push('/login')
}
</script>

<template>
  <aside class="h-full flex flex-col overflow-hidden sidebar" :data-collapsed="$pinia.state.value.ui?.sidebarCollapsed">
    <!-- Branding + collapse control -->
    <div class="px-3 py-2 flex items-center justify-start">
      <div
        class="flex items-center gap-2"
        :class="$pinia.state.value.ui?.sidebarCollapsed ? 'w-full justify-center' : ''"
      >
        <!-- Inline SVG for maximum reliability and theming via currentColor -->
        <svg
          class="inline-block h-8 w-8"
          :style="{ color: 'var(--sidebar-fg)' }"
          viewBox="0 0 21.24 25.23"
          role="img"
          aria-label="RFMS icon"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M14.39,17.38l-1.39-.03c.24.43.48.87.72,1.3H4.7c.24-.43.48-.87.72-1.3l-1.39.03c-1.34,2.38-2.68,4.76-4.03,7.15.11.62.8.89,1.13.56.32-.58.64-1.16.96-1.74h14.24c.32.58.64,1.16.96,1.74.33.33,1.02.06,1.13-.56-1.34-2.39-2.69-4.77-4.03-7.15ZM2.74,22.18c.44-.79.88-1.58,1.32-2.37h10.3c.44.79.88,1.58,1.32,2.37H2.74Z"/>
          <path d="M16.17,9.44c-.83,0-1.62-.24-2.28-.65-1.18-.72-1.99-1.99-2.08-3.45,0-.09,0-.18,0-.27,0-.97.32-1.87.86-2.59-.26-.04-.52-.07-.79-.09C7.17,1.93,1.43,2.67.35,4.64v11.14c0,.62.5,1.13,1.12,1.13h15.48c.62,0,1.12-.51,1.12-1.13v-6.78c-.57.28-1.22.44-1.9.44ZM3.43,14.33c-.86,0-1.56-.66-1.56-1.48s.7-1.48,1.56-1.48,1.55.66,1.55,1.48-.69,1.48-1.55,1.48ZM2.71,10.15c-.33,0-.6-.27-.6-.59v-3.63c0-.33.27-.59.6-.59h8.4c.09,1.87,1.19,3.47,2.78,4.27-.03.3-.29.54-.59.54H2.71ZM14.98,14.33c-.86,0-1.55-.66-1.55-1.48s.69-1.48,1.55-1.48,1.56.66,1.56,1.48-.7,1.48-1.56,1.48Z"/>
          <path d="M16.17,0c-1.82,0-3.41.95-4.3,2.39-.5.77-.78,1.69-.78,2.68,0,.09,0,.18.02.27.09,1.87,1.19,3.47,2.78,4.27.68.34,1.46.54,2.28.54.67,0,1.32-.13,1.9-.37,1.86-.76,3.17-2.58,3.17-4.71,0-2.8-2.27-5.07-5.07-5.07ZM18.07,9c-.57.28-1.22.44-1.9.44-.83,0-1.62-.24-2.28-.65-1.18-.72-1.99-1.99-2.08-3.45,0-.09,0-.18,0-.27,0-.97.32-1.87.86-2.59.79-1.08,2.07-1.77,3.51-1.77,2.41,0,4.36,1.95,4.36,4.36,0,1.73-1,3.23-2.46,3.93Z"/>
          <path d="M13.89,8.79v.82c-1.59-.8-2.69-2.4-2.78-4.27h.7c.09,1.46.9,2.73,2.08,3.45Z"/>
          <g>
            <rect x="13.41" y="4.31" width="3.37" height=".67" rx=".33" ry=".33" transform="translate(23.3 18.13) rotate(-138.42)"/>
            <rect x="15.56" y="4.31" width="4.46" height=".67" rx=".33" ry=".33" transform="translate(-.01 9.23) rotate(-29.09)"/>
          </g>
        </svg>
      
        <span class="font-semibold tracking-wide"
              :class="$pinia.state.value.ui?.sidebarCollapsed ? 'sr-only' : ''">RFMS</span>
      </div>
      
    </div>

    <template v-if="auth.user">
      <nav class="space-y-1" :class="$pinia.state.value.ui?.sidebarCollapsed ? 'px-0' : 'px-2'">
        <RouterLink
          v-for="l in links"
          :key="l.to"
          :to="l.to"
          class="group flex items-center rounded-lg text-base sidebar-link"
          :class="{
            'justify-center h-16 w-full': $pinia.state.value.ui?.sidebarCollapsed,
            'px-3 py-2 gap-2': !$pinia.state.value.ui?.sidebarCollapsed,
            'sidebar-link-active': isActive(l.to)
          }"
          :aria-label="l.label"
          :title="l.label"
          :data-active="isActive(l.to) ? 'true' : 'false'"
          :aria-current="isActive(l.to) ? 'page' : undefined"
          @click="$emit('navigate')"
        >
          <i :class="l.icon" class="text-[1.1rem] leading-none"></i>
          <span class="leading-none transition-all duration-150"
                :class="$pinia.state.value.ui?.sidebarCollapsed ? 'w-0 opacity-0 overflow-hidden' : 'w-auto opacity-100'">
            {{ l.label }}
          </span>
        </RouterLink>
      </nav>
      <!-- Sidebar footer / utilities -->
      <div class="mt-auto" :class="$pinia.state.value.ui?.sidebarCollapsed ? 'px-0' : 'px-2'">
        <div class="space-y-1">
          <RouterLink
            to="/settings/failure-id"
            class="group flex items-center rounded-lg text-base sidebar-link"
            :class="{
              'justify-center h-16 w-full': $pinia.state.value.ui?.sidebarCollapsed,
              'px-3 py-2 gap-2': !$pinia.state.value.ui?.sidebarCollapsed,
              'sidebar-link-active': isActive('/settings')
            }"
            aria-label="Settings" title="Settings"
          >
            <i class="pi pi-cog text-[1.1rem] leading-none"></i>
            <span class="leading-none transition-all duration-150"
                  :class="$pinia.state.value.ui?.sidebarCollapsed ? 'w-0 opacity-0 overflow-hidden' : 'w-auto opacity-100'">
              Settings
            </span>
          </RouterLink>
          <button
            class="group flex items-center rounded-lg text-base sidebar-link w-full text-left"
            :class="$pinia.state.value.ui?.sidebarCollapsed ? 'justify-center h-16 w-full' : 'px-3 py-2 gap-2'"
            aria-label="Logout" title="Logout"
            @click="onLogout"
          >
            <i class="pi pi-sign-out text-[1.1rem] leading-none"></i>
            <span class="leading-none transition-all duration-150"
                  :class="$pinia.state.value.ui?.sidebarCollapsed ? 'w-0 opacity-0 overflow-hidden' : 'w-auto opacity-100'">
              Logout
            </span>
          </button>
        </div>
        <div class="p-3 text-xs text-muted">v0.1 • Vue + Tailwind</div>
      </div>
    </template>

    <template v-else>
      <div class="px-4 text-sm text-muted">
        Please <RouterLink class="underline" to="/login">log in</RouterLink>.
      </div>
      <div class="mt-auto p-3 text-xs text-muted">v0.1 • Vue + Tailwind</div>
    </template>
  </aside>
</template>


<script setup>
import { useUIStore } from '@/stores/ui'
import { useAuthStore } from '@/stores/auth'
import { useRoute } from 'vue-router'
import { computed } from 'vue'
const emit = defineEmits(['toggleSidebar'])

const ui = useUIStore()
const auth = useAuthStore()
const route = useRoute()

const titleMap = {
  '/dashboard': 'Dashboard',
  '/logbook': 'Logbook',
  '/failures/new': 'Logbook Entry',
  '/analytics': 'Analytics Board',
}
const pageTitle = computed(() => {
  if (route.path.startsWith('/settings')) return 'Settings'
  return route.meta?.title
      || titleMap[route.path]
      || titleMap['/' + (route.path.split('/')[1] || '')]
      || 'RFMS'
})

const displayName = computed(() => auth.user?.name || auth.user?.username || '')

function doLogout() {
  auth.logout()
  ui.pushToast({ type: 'info', title: 'Signed out' })
}
</script>

<template>
  <header
    class="h-14 flex items-center justify-between px-4
           bg-[var(--sidebar-bg)] text-[var(--sidebar-fg)]
           rounded-none border-0 shadow-none relative z-10"
  >
    <div class="flex items-center gap-2">
      <!-- Toggle sidebar moved/kept on the LEFT, visible at all sizes -->
      <button
        class="inline-flex items-center justify-center w-9 h-9 rounded-lg
               text-[var(--sidebar-fg)]
               hover:bg-[color-mix(in_oklab,var(--sidebar-fg)/_12%,_transparent)]
               focus-visible:outline-none focus-visible:ring-2
               focus-visible:ring-[var(--sidebar-fg)]/40"
        @click="emit('toggleSidebar')"
        aria-label="Toggle sidebar"
        title="Toggle sidebar"
      >
        <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </button>
      <h1 class="text-base font-semibold">{{ pageTitle }}</h1>
    </div>

    <!-- Right side: show current user name -->
    <div class="flex items-center gap-2">
      <span v-if="displayName" class="text-sm opacity-90 truncate max-w-[200px]">{{ displayName }}</span>
    </div>
  </header>
</template>


<script setup>
import { computed } from 'vue'
import { Bar } from 'vue-chartjs'
import { Chart, BarElement, CategoryScale, LinearScale, Title, Tooltip, Legend, Filler } from 'chart.js'
import { colorsForDatasetLabel } from '@/lib/statusColors'

Chart.register(BarElement, CategoryScale, LinearScale, Title, Tooltip, Legend, Filler)

const props = defineProps({
  data: { type: Object, required: true },
  options: { type: Object, default: () => ({ responsive: true, maintainAspectRatio: false }) },
})

// Disable any plugin-driven color overrides to ensure our palette wins
const computedOptions = computed(() => {
  const base = JSON.parse(JSON.stringify(props.options || {}))
  base.plugins = base.plugins || {}
  base.plugins.colors = false
  return base
})

const normalized = computed(() => {
  const d = JSON.parse(JSON.stringify(props.data || { labels: [], datasets: [] }))
  if (!d || !Array.isArray(d.datasets)) return props.data
  d.datasets = d.datasets.map((ds) => {
    const out = { ...ds }
    const label = String(out.label ?? '')
    const mapped = colorsForDatasetLabel(label, 0.85)
    if (mapped) {
      out.backgroundColor = mapped.bg
      out.borderColor = mapped.border
      out.borderWidth = out.borderWidth ?? 1
      out.hoverBackgroundColor = mapped.bg
      out.hoverBorderColor = mapped.border
    }
    return out
  })
  return d
})
</script>

<template>
  <!-- Fill parent; keep a safe minimum for axes + legend -->
  <div class="relative w-full h-full min-h-[260px]">
    <Bar :data="normalized" :options="computedOptions" />
  </div>
  
</template>

<style scoped>
/* Important: do NOT force height:100% on the canvas */
:global(canvas) { width: 100% !important; }
</style>


<script setup>
import { computed } from 'vue'

const props = defineProps({
  modelValue: {
    type: Object,
    // { range: 'today' | '7d' | '30d', status: string[] }
    default: () => ({ range: 'today', status: ['Active','In Progress','Resolved','On Hold'] })
  },
  // New: render controls selectively so page header can place them
  showRanges: { type: Boolean, default: true },
  showStatuses: { type: Boolean, default: true },
})
const emit = defineEmits(['update:modelValue'])

const ranges = [
  { key: 'today', label: 'Today' },
  { key: '7d',    label: 'Last 7 days' },
  { key: '30d',   label: 'Last 30 days' },
  { key: 'custom',label: 'Custom' },
]

const statusOptions = [
  { key: 'Active',      label: 'Active' },
  { key: 'In Progress', label: 'In Progress' },
  { key: 'Resolved',    label: 'Resolved' },
  { key: 'On Hold',     label: 'On Hold' },
]

const selectedRange = computed(() => props.modelValue.range)
const selectedStatuses = computed(() => new Set(props.modelValue.status || []))

function setRange(key) {
  emit('update:modelValue', { ...props.modelValue, range: key })
}

function toggleStatus(key) {
  const set = new Set(selectedStatuses.value)
  set.has(key) ? set.delete(key) : set.add(key)
  emit('update:modelValue', { ...props.modelValue, status: Array.from(set) })
}

function setFrom(dateStr){
  emit('update:modelValue', { ...props.modelValue, from: dateStr || '' })
}
function setTo(dateStr){
  emit('update:modelValue', { ...props.modelValue, to: dateStr || '' })
}

function statusStyle(key) {
  if (!selectedStatuses.value.has(key)) return {}
  const style = { color: '#0b1b1f' } // --s-on-light
  switch (key) {
    case 'Resolved':
      style.backgroundColor = '#8FE0AD'
      break
    case 'Active':
      style.backgroundColor = '#FC9796'
      break
    case 'In Progress':
      style.backgroundColor = '#EEEE96'
      break
    case 'On Hold':
      style.backgroundColor = '#FFC08C'
      break
    default:
      return {}
  }
  return style
}
</script>

<template>
  <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
    <!-- Range pills -->
    <div v-if="showRanges" class="chip-group">
      <button
        v-for="r in ranges"
        :key="r.key"
        class="chip"
        :class="selectedRange === r.key ? 'selected-primary' : 'text-app hover-primary'"
        :aria-pressed="String(selectedRange === r.key)"
        @click="setRange(r.key)"
      >
        {{ r.label }}
      </button>
      <!-- Custom range inputs -->
      <span v-if="selectedRange==='custom'" class="inline-flex items-center gap-2 ml-2 align-middle">
        <input
          type="date"
          :value="props.modelValue.from || ''"
          @input="setFrom($event.target.value)"
          class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm"
        />
        <span class="text-sm text-muted">to</span>
        <input
          type="date"
          :value="props.modelValue.to || ''"
          @input="setTo($event.target.value)"
          class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm"
        />
      </span>
    </div>

    <!-- Status toggles (colored by status; no hover change when active) -->
    <div v-if="showStatuses" class="flex flex-wrap gap-2">
      <button
        v-for="s in statusOptions"
        :key="s.key"
        class="chip"
        :class="{ 'is-active': selectedStatuses.has(s.key), 'text-app hover-primary': !selectedStatuses.has(s.key) }"
        :style="statusStyle(s.key)"
        :aria-pressed="String(selectedStatuses.has(s.key))"
        @click="toggleStatus(s.key)"
      >
        {{ s.label }}
      </button>
    </div>
  </div>
</template>


<script setup>
import { computed } from 'vue'

const props = defineProps({
  columns: { type: Array, required: true },
  rows: { type: Array, required: true },
  sortKey: { type: String, default: '' },
  sortDir: { type: String, default: 'asc' },
})
const emit = defineEmits(['rowclick', 'sort'])

function handleSort(key, sortable = true) {
  if (!sortable) return
  emit('sort', key)
}
</script>

<template>
  <div class="overflow-x-auto rounded-2xl border-app bg-card text-app">
    <table class="min-w-full text-sm">
      <thead class="bg-card">
        <tr>
          <th v-for="c in columns" :key="c.key"
              :class="['font-semibold text-app px-4 py-3 select-none', c.align || 'text-left']"
              :style="c.width ? { width: c.width } : null"
              @click="handleSort(c.key, c.sortable !== false)"
              role="columnheader"
              :aria-sort="sortKey===c.key ? (sortDir==='asc'?'ascending':'descending') : 'none'">
            <div class="inline-flex items-center gap-1">
              <span>{{ c.label }}</span>
              <span v-if="c.sortable !== false" class="text-xs text-muted">
                <span v-if="sortKey!==c.key">↕</span>
                <span v-else>{{ sortDir==='asc' ? '▲' : '▼' }}</span>
              </span>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(r, i) in rows" :key="i" class="border-t hover-primary cursor-pointer"
            @click="emit('rowclick', r)">
          <td v-for="c in columns" :key="c.key" :class="['px-4 py-3', c.align || 'text-left']">
            <slot :name="c.key" :row="r">
              {{ r[c.key] }}
            </slot>
          </td>
        </tr>
        <tr v-if="rows.length === 0" class="border-t">
          <td :colspan="columns.length" class="px-4 py-6 text-center text-muted">
            No data
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount, watch, nextTick } from 'vue'
import Chart from 'chart.js/auto'

const props = defineProps({
  data: { type: Object, required: true },
  options: { type: Object, default: () => ({ responsive: true, maintainAspectRatio: false, cutout: '60%' }) },
})

const canvas = ref(null)
let chart

import { STATUS_ORDER, arrayForOrder } from '@/lib/statusColors'

function normalizeData(d) {
  try {
    const copy = JSON.parse(JSON.stringify(d || {}))
    const labels = copy?.labels || []
    const ds = copy?.datasets?.[0]
    if (ds && Array.isArray(labels) && labels.every(l => STATUS_ORDER.includes(String(l)))) {
      if (!Array.isArray(ds.backgroundColor) || ds.backgroundColor.length !== labels.length) {
        ds.backgroundColor = labels.map(l => arrayForOrder(STATUS_ORDER)[STATUS_ORDER.indexOf(l)])
      }
    }
    return copy
  } catch { return d }
}

async function render() {
  await nextTick()
  const el = canvas.value
  if (!el || !el.isConnected) return
  if (chart) { try { chart.destroy() } catch (_) {} }
  chart = new Chart(el, { type: 'doughnut', data: normalizeData(props.data), options: props.options })
}

onMounted(render)
watch(() => props.data, render, { deep: true })
watch(() => props.options, render, { deep: true })
onBeforeUnmount(() => { if (chart) try { chart.destroy() } catch (_) {} })
</script>

<template>
  <div class="h-full w-full">
    <canvas ref="canvas" class="h-full w-full"></canvas>
  </div>
</template>


<script setup>
import { ref, watch, computed } from 'vue';
import { useAttachmentStore } from '@/stores/attachments';
import { http } from '@/lib/http';
import { useUIStore } from '@/stores/ui';
import { Trash2 } from 'lucide-vue-next';

const props = defineProps({
  failureId: {
    type: [Number, String],
    required: true,
  },
});

const attachmentStore = useAttachmentStore();
const uiStore = useUIStore();
const attachments = computed(() => attachmentStore.attachments);

const fileInput = ref(null);
const selectedFile = ref(null);
const description = ref('');
const isLoading = ref(false);
const selectedGroupKeys = ref(['files']); // Default 'files' group is selected

watch(() => props.failureId, (newId) => {
  if (newId) {
    attachmentStore.fetchAttachments(newId);
  }
}, { immediate: true });

function handleFileSelect(event) {
  selectedFile.value = event.target.files[0] || null;
}

async function handleUpload() {
  if (!selectedFile.value || !props.failureId) {
    uiStore.pushToast({ type: 'error', title: 'Missing File', message: 'Please select a file to upload.' });
    return;
  }

  const formData = new FormData();
  formData.append('failure_id', props.failureId);
  formData.append('file', selectedFile.value);
  formData.append('group_keys', JSON.stringify(selectedGroupKeys.value));

  isLoading.value = true;
  try {
    // Use the new, direct-send endpoint
    await http.post('/failures/send-attachment-to-telegram/', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
    });

    uiStore.pushToast({ type: 'success', title: 'Success', message: 'File sent to Telegram.' });

    // Reset the form
    selectedFile.value = null;
    if (fileInput.value) {
      fileInput.value.value = '';
    }

  } catch (err) {
    const message = err.response?.data?.error || 'Could not send file to Telegram.';
    uiStore.pushToast({ type: 'error', title: 'Upload Failed', message });
    console.error(err);
  } finally {
    isLoading.value = false;
  }
}

async function handleDelete(attachmentId) {
  if (confirm('Are you sure you want to delete this attachment?')) {
    await attachmentStore.deleteAttachment(attachmentId, props.failureId);
  }
}

function getFileUrl(fileUrl) {
    if (fileUrl && !fileUrl.startsWith('http')) {
        // Assumes Vite dev server proxy is at /api
        const rootUrl = '/'; // Go to the root of the Django server
        return `${rootUrl}${fileUrl.startsWith('/') ? fileUrl.substring(1) : fileUrl}`;
    }
    return fileUrl;
}
</script>

<template>
  <div class="sm:col-span-2 space-y-4">
    <hr class="border-app/30 my-2" />
    <div>
      <h3 class="text-sm font-medium text-app mb-2">Attachments</h3>

      <div class="p-3 border border-dashed border-app/50 rounded-lg space-y-3">
        <div class="flex items-center justify-between gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Upload New File</label>
              <input type="file" ref="fileInput" @change="handleFileSelect" class="text-sm" />
            </div>
            <div class="self-end">
              <button @click="handleUpload" :disabled="!selectedFile || isLoading || selectedGroupKeys.length === 0" class="btn btn-secondary">
                {{ isLoading ? 'Uploading...' : 'Upload to Telegram' }}
              </button>
            </div>
        </div>

        <div class="flex items-center gap-4 pt-2">
            <span class="text-sm font-medium">Send to:</span>
            <label class="flex items-center gap-2">
                <input type="checkbox" value="alert" v-model="selectedGroupKeys" class="h-4 w-4 rounded" />
                <span>Alerts Group</span>
            </label>
            <label class="flex items-center gap-2">
                <input type="checkbox" value="files" v-model="selectedGroupKeys" class="h-4 w-4 rounded" />
                <span>Files Group</span>
            </label>
        </div>
      </div>

      <div class="mt-4 space-y-2">
        <div v-if="attachments.length === 0 && !attachmentStore.loading" class="text-xs text-app/60">
          No attachments for this entry.
        </div>
         <div v-if="attachmentStore.loading" class="text-xs text-app/60">
            Loading attachments...
        </div>
        <div v-for="att in attachments" :key="att.id" class="flex items-center justify-between p-2 rounded-lg bg-gray-100">
          <div class="flex-grow min-w-0">
            <a :href="getFileUrl(att.file)" target="_blank" class="text-sm font-medium text-blue-600 hover:underline truncate block">
              {{ att.file.split('/').pop() }}
            </a>
            <p class="text-xs text-gray-600 truncate">{{ att.description }}</p>
          </div>
          <button @click="handleDelete(att.id)" class="ml-4 p-2 text-red-500 hover:bg-red-100 rounded-full">
            <Trash2 class="w-4 h-4" />
          </button>
        </div>
      </div>
    </div>
  </div>
</template>


<script setup>
defineProps({
  item: { type: Object, required: true }, // { fail_id, status, severity, circuit, reported_at, assigned_to }
})
</script>

<template>
  <article class="card space-y-2">
    <div class="flex items-start justify-between gap-3">
      <h3 class="text-base font-semibold">{{ item.fail_id }}</h3>
      <span
        class="badge"
        :class="{
          'badge-danger': item.severity === 'Critical',
          'badge-warning': item.severity === 'High',
          'badge-neutral': item.severity === 'Low',
        }"
      >
        {{ item.severity }}
      </span>
    </div>

    <div class="text-xs text-muted">
      <span class="inline-block mr-3">
        <span class="font-medium text-app">Status:</span> {{ item.status }}
      </span>
      <span class="inline-block mr-3">
        <span class="font-medium text-app">Circuit:</span> {{ item.circuit }}
      </span>
    </div>

    <div class="text-xs text-muted">
      <span class="inline-block mr-3">
        <span class="font-medium text-app">Reported:</span> {{ item.reported_at }}
      </span>
      <span class="inline-block mr-3">
        <span class="font-medium text-app">Assigned:</span> {{ item.assigned_to }}
      </span>
    </div>

    <div class="pt-2">
      <button class="btn btn-outline btn-sm">View</button>
      <button class="btn btn-primary btn-sm ml-2">Update</button>
    </div>
  </article>
</template>


<script setup>
import { computed } from 'vue'

const props = defineProps({
  modelValue: { type: Boolean, default: false }, // open/close
  item: { type: Object, default: () => null },   // failure object
  showActions: { type: Boolean, default: true },
})
const emit = defineEmits(['update:modelValue', 'notify', 'edit', 'delete'])

function close() { emit('update:modelValue', false) }

// Correctly calculates duration from 'reported_at' and 'resolved_at'
const duration = computed(() => {
  const start = props.item?.reported_at;
  const end = props.item?.resolved_at;
  if (!start || !end) return '—'
  const diff = new Date(end) - new Date(start)
  if (diff < 0) return '—'
  const minutes = Math.floor(diff / 60000)
  if (minutes < 60) return `${minutes}m`
  const hours = Math.floor(minutes / 60)
  const mins = minutes % 60
  return `${hours}h ${mins}m`
})

function fmt(ts) { 
  return ts ? new Date(ts).toLocaleString('en-IN') : '—' 
}

function badgeClasses(s) {
  if (s === 'Active')       return 'badge-danger'
  if (s === 'In Progress')  return 'badge-warning'
  if (s === 'Resolved')     return 'badge-success'
  if (s === 'On Hold')      return 'badge-hold'
  if (s === 'Information')  return 'badge-neutral'
  return 'badge-neutral'
}

const depotCode = computed(() => {
    if (props.item?.station?.depot_name) return props.item.station.depot_name;
    if (props.item?.section?.depot_name) return props.item.section.depot_name;
    return '—';
});

const circuitTags = computed(() => {
    if (props.item?.circuit?.circuit_id) {
        return `#${props.item.circuit.circuit_id.replace(/\s+/g, '_')}`;
    }
    return '—';
});

</script>

<template>
  <div v-show="modelValue" class="fixed inset-0 z-50" aria-modal="true" role="dialog">
    <div class="absolute inset-0 bg-black/30" @click="close" />

    <div class="absolute inset-y-0 right-0 w-full max-w-md bg-card text-app shadow-xl border-l border-app flex flex-col">
      <div class="px-4 py-3 border-b border-app flex items-center justify-between">
        <div class="font-semibold">Failure Details</div>
        <button class="p-2 rounded-lg hover:bg-card" @click="close" aria-label="Close">
          <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M18.3 5.71L12 12l6.3 6.29l-1.41 1.42L10.59 13.4L4.29 19.7L2.88 18.3L9.17 12L2.88 5.71L4.29 4.29l6.3 6.3l6.29-6.3z"/></svg>
        </button>
      </div>

      <div v-if="item" class="p-4 space-y-4 overflow-auto">
        <div class="flex items-start justify-between">
          <div class="text-lg font-semibold">{{ item.fail_id || '—' }}</div>
          <span class="badge" :class="badgeClasses(item.current_status)">{{ item.current_status || '—' }}</span>
        </div>

        <div class="grid grid-cols-2 gap-x-4 gap-y-3 text-sm">
          <div>
            <div class="text-muted">Circuit</div>
            <div class="font-medium">{{ item.circuit?.circuit_id || '—' }}</div>
          </div>
          <div>
            <div class="text-muted">Severity</div>
            <div class="font-medium">{{ item.severity || '—' }}</div>
          </div>
          <div>
            <div class="text-muted">Depot</div>
            <div class="font-medium">{{ depotCode }}</div>
          </div>
           <div>
            <div class="text-muted">Station Code</div>
            <div class="font-medium">{{ item.station?.code || '—' }}</div>
          </div>
          <div>
            <div class="text-muted">Section</div>
            <div class="font-medium">{{ item.section?.name || '—' }}</div>
          </div>
          <div>
            <div class="text-muted">Sub Section</div>
            <div class="font-medium">{{ item.sub_section?.name || '—' }}</div>
          </div>
           <div>
            <div class="text-muted">Reported At</div>
            <div class="font-medium">{{ fmt(item.reported_at) }}</div>
          </div>
          <div>
            <div class="text-muted">Assigned To</div>
            <div class="font-medium">{{ item.assigned_to?.name || '—' }}</div>
          </div>
        </div>

        <div>
          <div class="text-muted text-sm mb-1">Remarks for Fail</div>
          <div class="rounded-lg border-app bg-gray-100 p-3 min-h-[60px] text-sm whitespace-pre-wrap">
            {{ item.remark_fail || 'No remarks.' }}
          </div>
        </div>
        
        <div class="border-t border-app pt-3 space-y-3">
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <div class="text-muted">Resolution Time</div>
                    <div class="font-medium">{{ fmt(item.resolved_at) }}</div>
                </div>
                <div>
                    <div class="text-muted">Duration</div>
                    <div class="font-medium">{{ duration }}</div>
                </div>
            </div>
            <div>
              <div class="text-muted text-sm mb-1">Remarks for Resolve</div>
              <div class="rounded-lg border-app bg-gray-100 p-3 min-h-[60px] text-sm whitespace-pre-wrap">
                {{ item.remark_right || 'No remarks.' }}
              </div>
            </div>
        </div>

        <div class="border-t border-app pt-3">
          <div class="text-muted text-sm mb-1">Circuit Tags</div>
          <div class="font-medium text-sm text-blue-700">{{ circuitTags }}</div>
        </div>
      </div>
      
      <div v-else class="p-6 text-center text-muted">Select an item to see details.</div>

      <div v-if="showActions" class="mt-auto px-4 py-3 border-t border-app flex items-center justify-between">
        <button class="btn btn-outline" @click="close">Close</button>
        <div class="flex items-center gap-2">
          <button class="btn" @click="$emit('notify', item)">Notify</button>
          <button class="btn" @click="$emit('edit', item)">Edit</button>
          <button class="btn btn-danger" @click="$emit('delete', item)">Delete</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed, watch } from 'vue'
import InputText from '@/components/form/InputText.vue'
import DateTime from '@/components/form/DateTime.vue'
import SearchSelect from '@/components/form/SearchSelect.vue'
import TagsInput from '@/components/form/TagsInput.vue'
import FailureAttachment from '@/components/FailureAttachment.vue'

const props = defineProps({
  modelValue: { type: Object, required: true },
  options: { type: Object, required: true },
  errors: { type: Object, default: () => ({}) },
  isEditMode: { type: Boolean, default: false },
})

const emit = defineEmits(['update:modelValue'])

const form = computed({
  get: () => props.modelValue,
  set: (value) => emit('update:modelValue', value)
})

const circuitOptionsForSelect = computed(() => {
  return (props.options.circuits || []).map(c => ({
    label: c.circuit_id,
    value: c.id
  }));
});

const selectedCircuitObject = computed(() => {
  if (!form.value.circuit || !props.options.circuits) return null;
  return props.options.circuits.find(c => c.id === form.value.circuit);
});

const selectedCircuitDescription = computed(() => {
  const circuit = selectedCircuitObject.value;
  if (!circuit) return '';

  let description = circuit.name || '';
  if (circuit.related_equipment) {
    description += ` (Equipment: ${circuit.related_equipment})`;
  }
  return description;
});

const selectedCircuitSeverity = computed(() => {
  return selectedCircuitObject.value ? selectedCircuitObject.value.severity : '';
});

const autoTags = computed(() => {
  const t = [];
  if (form.value.depot) { const depot = props.options.depots.find(d => d.value === form.value.depot); if (depot) t.push(`#${depot.label}`) }
  if (selectedCircuitObject.value) { t.push(`#${selectedCircuitObject.value.circuit_id.replace(/\s+/g, '_')}`) }
  
  // This is the line to change
  if (form.value.station) { const station = props.options.stations.find(s => s.id === form.value.station); if (station) t.push(`#${station.code}`) } 
  
  if (form.value.section) { const section = props.options.sections.find(s => s.id === form.value.section); if (section) t.push(`#${section.name}`) }
  if (form.value.sub_section) { const subSection = props.options.subSections.find(s => s.id === form.value.sub_section); if (subSection) t.push(`#${subSection.name}`) }
  return t
});

const stationOptions = computed(() => {
  if (!form.value.depot) return [];
  return props.options.stations
    .filter(s => s.depot === form.value.depot)
    .map(s => ({ label: s.code, value: s.id })); // <-- Change s.name to s.code
});
const sectionOptions = computed(() => {
    if (!form.value.depot) return [];
    return props.options.sections
        .filter(s => s.depot === form.value.depot)
        .map(s => ({ label: s.name, value: s.id }));
});

const subSectionOptions = computed(() => {
    if (!form.value.section) return [];
    return props.options.subSections
        .filter(s => s.section === form.value.section)
        .map(s => ({ label: s.name, value: s.id }));
});

watch(() => form.value.depot, () => { form.value.station = null; form.value.section = null; form.value.sub_section = null; });
watch(() => form.value.section, () => { form.value.sub_section = null; });
</script>

<template>
  <div class="grid gap-4 sm:grid-cols-2">
    <div class="sm:col-span-2 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
      <div>
        <span class="text-sm text-app">Entry Type</span>
        <div class="flex items-center gap-4 pt-2">
          <label class="flex items-center gap-2">
            <input type="radio" v-model="form.entry_type" value="item" class="radio" />
            <span>Failure</span>
          </label>
          <label class="flex items-center gap-2">
            <input type="radio" v-model="form.entry_type" value="message" class="radio" />
            <span>General Message</span>
          </label>
        </div>
      </div>
      <div>
        <label class="block space-y-1">
          <span class="text-sm text-app">Circuit</span>
          <SearchSelect v-model="form.circuit" :options="circuitOptionsForSelect" placeholder="Select circuit..." />
          
          <p v-if="selectedCircuitObject" class="text-xs text-blue-600 mt-1 min-h-[1rem]">
            {{ selectedCircuitDescription || '(No description provided for this circuit)' }}
          </p>
          <p v-if="errors.circuit" class="text-xs text-red-600">{{ errors.circuit }}</p>
        </label>
      </div>
      <div>
        <label class="block space-y-1">
          <span class="text-sm text-app">Circuit Severity</span>
          <input readonly :value="selectedCircuitSeverity" class="field bg-app-hover" />
        </label>
      </div>
    </div>
    <div class="sm:col-span-2">
      <label class="block space-y-1">
        <span class="text-sm text-app">Circuit Tags</span>
        <TagsInput v-model="form.userTags" :preset="autoTags" placeholder="Add tag and press Enter" />
        <p class="text-xs text-muted">Auto from selections; you can add/remove your own.</p>
      </label>
    </div>
    <div class="sm:col-span-2 grid gap-4 sm:grid-cols-2 md:grid-cols-4">
      <div>
        <label class="block space-y-1">
          <span class="text-sm text-app">Depot</span>
          <SearchSelect v-model="form.depot" :options="options.depots" placeholder="Select depot..." />
        </label>
      </div>
      <div>
        <label class="block space-y-1">
          <span class="text-sm text-app">Station</span>
          <SearchSelect v-model="form.station" :options="stationOptions" placeholder="Select station..." />
        </label>
      </div>
      <div>
        <label class="block space-y-1">
          <span class="text-sm text-app">Section</span>
          <SearchSelect v-model="form.section" :options="sectionOptions" placeholder="Select section..." />
        </label>
      </div>
      <div>
        <label class="block space-y-1">
          <span class="text-sm text-app">Sub Section</span>
          <SearchSelect v-model="form.sub_section" :options="subSectionOptions" placeholder="Select sub section..." />
        </label>
      </div>
    </div>
    <div class="sm:col-span-2 grid gap-4 grid-cols-1 md:grid-cols-3">
      <DateTime label="Reported At" v-model="form.reported_at" />
      <div>
        <label class="block space-y-1">
          <span class="text-sm text-app">Assigned To</span>
          <SearchSelect v-model="form.assigned_to" :options="options.supervisors" placeholder="Select assignee..." />
        </label>
      </div>
      <div>
        <label class="block space-y-1">
          <span class="text-sm text-app">Current Status</span>
          <SearchSelect
            v-model="form.current_status"
            :options="options.statuses"
            placeholder="Select status..."
            :disabled="form.entry_type === 'message'"/>
        </label>
      </div>
    </div>
    <div class="sm:col-span-2">
      <textarea v-model="form.remark_fail" rows="2" class="field-textarea" placeholder="Notes..."></textarea>
    </div>
    <template v-if="form.current_status === 'Resolved'">
      <DateTime label="Resolve At" v-model="form.resolved_at" />
      <InputText label="Duration (minutes)" v-model="form.duration_minutes" />
      <textarea v-model="form.remark_right" rows="2" class="sm:col-span-2 field-textarea" placeholder="Notes on resolution..."></textarea>
    </template>
    
    <FailureAttachment v-if="isEditMode && form.id" :failure-id="form.id" />
  </div>
</template>

<script setup>
import { ref } from 'vue'

defineProps({
  msg: String,
})

const count = ref(0)
</script>

<template>
  <h1>{{ msg }}</h1>

  <div class="card">
    <button type="button" @click="count++">count is {{ count }}</button>
    <p>
      Edit
      <code>components/HelloWorld.vue</code> to test HMR
    </p>
  </div>

  <p>
    Check out
    <a href="https://vuejs.org/guide/quick-start.html#local" target="_blank"
      >create-vue</a
    >, the official Vue + Vite starter
  </p>
  <p>
    Learn more about IDE Support for Vue in the
    <a
      href="https://vuejs.org/guide/scaling-up/tooling.html#ide-support"
      target="_blank"
      >Vue Docs Scaling up Guide</a
    >.
  </p>
  <p class="read-the-docs">Click on the Vite and Vue logos to learn more</p>
</template>

<style scoped>
.read-the-docs {
  color: #888;
}
</style>


<script setup>
import FailureCard from '@/components/FailureCard.vue'

defineProps({
  title: { type: String, required: true },
  items: { type: Array, default: () => [] },
})
</script>

<template>
  <section class="rounded-2xl border-app bg-card text-app p-3 flex flex-col gap-3">
    <header class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-app">{{ title }}</h3>
      <span class="text-xs text-muted">{{ items.length }}</span>
    </header>
    <div class="space-y-3">
      <FailureCard v-for="(it, i) in items" :key="i" :item="it" />
      <div v-if="items.length === 0" class="text-xs text-muted border-app bg-card rounded-lg p-3">
        No items
      </div>
    </div>
  </section>
</template>


<script setup>
const props = defineProps({
  label: String,
  value: [String, Number],
  sublabel: String,
  // NEW
  trendDir: { type: String, default: null },   // 'up' | 'down' | 'flat' | null
  trendLabel: { type: String, default: '' },
})
</script>

<template>
  <div class="card p-4 md:p-5 min-h-28 flex items-center justify-center text-center">
    <div class="flex flex-col items-center gap-1 w-full">
      <div class="text-sm text-app whitespace-nowrap overflow-hidden text-ellipsis" :title="label">{{ label }}</div>
      <div class="text-2xl font-semibold">{{ value }}</div>
      <div class="text-xs text-muted">{{ sublabel }}</div>

      <div
        v-if="trendDir"
        class="text-xs inline-flex items-center gap-1"
        :class="trendDir==='up' ? 'text-[var(--success)]' : trendDir==='down' ? 'text-[var(--danger)]' : 'text-muted'"
      >
        <svg v-if="trendDir==='up'" class="w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5l6 6h-4v8h-4v-8H6z"/></svg>
        <svg v-else-if="trendDir==='down'" class="w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M12 19l-6-6h4V5h4v8h4z"/></svg>
        <svg v-else class="w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M5 12h14v2H5z"/></svg>
        <span>{{ trendLabel }}</span>
      </div>
    </div>
  </div>
  
</template>


<script setup>
import { computed } from 'vue'
import { Line } from 'vue-chartjs'
import { Chart, LineElement, PointElement, CategoryScale, LinearScale, Title, Tooltip, Legend, Filler } from 'chart.js'
import { STATUS_ORDER, bgColor, borderColor } from '@/lib/statusColors'

Chart.register(LineElement, PointElement, CategoryScale, LinearScale, Title, Tooltip, Legend, Filler)

const props = defineProps({
  data: { type: Object, required: true },
  options: { type: Object, default: () => ({ responsive: true, maintainAspectRatio: false }) },
})

const normalized = computed(() => {
  const d = JSON.parse(JSON.stringify(props.data || { labels: [], datasets: [] }))
  if (!d || !Array.isArray(d.datasets)) return props.data
  d.datasets = d.datasets.map((ds) => {
    const out = { ...ds }
    const label = String(out.label ?? '')
    if (STATUS_ORDER.includes(label)) {
      if (!out.borderColor) out.borderColor = borderColor(label)
      if (!out.backgroundColor) out.backgroundColor = bgColor(label, 0.25)
      if (out.fill == null) out.fill = true
      if (out.tension == null) out.tension = 0.3
    }
    return out
  })
  return d
})
</script>

<template>
  <div class="relative w-full h-full min-h-[300px]">
    <Line :data="normalized" :options="options" />
  </div>
  
</template>

<style scoped>
:global(canvas) { width: 100% !important; }
</style>


<script setup>
import { useFailureStore } from '@/stores/failures';

const props = defineProps({
  modelValue: { type: Boolean, default: false },
  failure: { type: Object, default: null },
});
const emit = defineEmits(['update:modelValue']);

const failureStore = useFailureStore();

function close() {
  emit('update:modelValue', false);
}

async function sendNotification() {
  if (!props.failure) {
    return;
  }
  // Directly send to the 'alert' group
  await failureStore.sendFailureNotification(props.failure.id, ['alert']);
  close();
}
</script>

<template>
  <div v-if="modelValue && failure" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
    <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
      <h3 class="text-lg font-semibold">Confirm Notification</h3>
      <p>
        Send a reminder notification to the <strong>Alerts</strong> Telegram group for Event ID: <strong>{{ failure.fail_id }}</strong>?
      </p>
      
      <div class="flex justify-end gap-3 pt-4">
        <button @click="close" class="btn btn-outline">Cancel</button>
        <button 
          @click="sendNotification" 
          class="btn btn-primary" 
          :disabled="failureStore.loading">
          {{ failureStore.loading ? 'Sending...' : 'Send Reminder' }}
        </button>
      </div>
    </div>
  </div>
</template>

<script setup>
import BarChart from '@/components/BarChart.vue'
import LineChart from '@/components/LineChart.vue'
import PieChart from '@/components/PieChart.vue'
import DoughnutChart from '@/components/DoughnutChart.vue'
import RecentFailures from '@/components/RecentFailures.vue'
import { getCssVar, withAlpha } from '@/lib/theme'
import FailureBySeverityCard from '@/components/analytics/FailureBySeverityCard.vue'

const props = defineProps({
  panel: { type: Object, required: true },
  state: { type: Object, required: true },
  data:  { type: Object, required: true },
  chartOptions: { type: Object, required: true },
})
</script>

<template>
  <div class="h-full w-full p-3">
    <!-- Table -->
    <div v-if="state.type==='table'" class="h-full overflow-auto">
      <!-- Aggregation tables -->
      <table v-if="panel.kind!=='recent'" class="min-w-full text-sm">
        <thead>
          <tr class="bg-gray-50">
            <th class="px-3 py-2 text-left">Label</th>
            <th class="px-3 py-2 text-right">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr
            v-for="(v,i) in (data.datasets?.[0]?.data || [])"
            :key="i"
            class="border-t"
          >
            <td class="px-3 py-2">{{ data.labels?.[i] }}</td>
            <td class="px-3 py-2 text-right">{{ v }}</td>
          </tr>
          <tr v-if="!(data.labels?.length)" class="border-t">
            <td colspan="2" class="px-3 py-6 text-center text-gray-500">No data</td>
          </tr>
        </tbody>
      </table>

      <!-- Recent failures table -->
      <RecentFailures
        v-else
        :items="data.recent || []"
        :show-toolbar="false"
        :show-bottom-actions="false"
        :show-row-actions="true"
        :loading="false"
        storage-key="rf-analytics"
        @delete="$emit('delete', $event)"
      />
    </div>

    <!-- Charts -->
    <!-- Special: Failure by Severity card -->
    <div v-if="panel.kind==='failureSeverity' && state.type==='bar'" class="h-full">
      <FailureBySeverityCard :range="state.range" :records="data.records || []" :severity="state.severity || 'all'" />
    </div>
    
    <div v-else-if="state.type==='bar'" class="h-full">
      <BarChart
        :data="{
          labels: data.labels,
          datasets: [{
            ...data.datasets?.[0],
          }]
        }"
        :options="chartOptions"
      />
    </div>

    <div v-else-if="state.type==='line'" class="h-full">
      <LineChart
        :data="{
          labels: data.labels,
          datasets: [{
            ...data.datasets?.[0],
            fill: true,
            tension: 0.3,
            backgroundColor: withAlpha(getCssVar('--slate-gray', '#6c757d'), 0.2),
            borderColor: getCssVar('--slate-gray', '#6c757d')
          }]
        }"
        :options="chartOptions"
      />
    </div>

    <div v-else-if="state.type==='pie'" class="h-full">
      <PieChart
        :data="{ labels: data.labels, datasets: [{ ...data.datasets?.[0] }] }"
        :options="chartOptions"
      />
    </div>

    <div v-else-if="state.type==='doughnut'" class="h-full">
      <DoughnutChart
        :data="{ labels: data.labels, datasets: [{ ...data.datasets?.[0] }] }"
        :options="{ ...chartOptions, cutout: '60%' }"
      />
    </div>

    <!-- Fallback -->
    <div v-else class="h-full flex items-center justify-center text-sm text-gray-500">
      No content.
    </div>
  </div>
</template>


<script setup>
import { ref, onMounted, onBeforeUnmount, watch, nextTick } from 'vue'
import Chart from 'chart.js/auto'

const props = defineProps({
  data: { type: Object, required: true },
  options: { type: Object, default: () => ({ responsive: true, maintainAspectRatio: false }) },
})

const canvas = ref(null)
let chart

import { STATUS_ORDER, arrayForOrder } from '@/lib/statusColors'

function normalizeData(d) {
  try {
    const copy = JSON.parse(JSON.stringify(d || {}))
    const labels = copy?.labels || []
    const ds = copy?.datasets?.[0]
    if (ds && Array.isArray(labels) && labels.every(l => STATUS_ORDER.includes(String(l)))) {
      if (!Array.isArray(ds.backgroundColor) || ds.backgroundColor.length !== labels.length) {
        ds.backgroundColor = labels.map(l => arrayForOrder(STATUS_ORDER)[STATUS_ORDER.indexOf(l)])
      }
    }
    return copy
  } catch { return d }
}

async function render() {
  await nextTick()
  const el = canvas.value
  if (!el || !el.isConnected) return
  if (chart) { try { chart.destroy() } catch (_) {} }
  chart = new Chart(el, { type: 'pie', data: normalizeData(props.data), options: props.options })
}

onMounted(render)
watch(() => props.data, render, { deep: true })
watch(() => props.options, render, { deep: true })
onBeforeUnmount(() => { if (chart) try { chart.destroy() } catch (_) {} })
</script>

<template>
  <div class="h-full w-full">
    <canvas ref="canvas" class="h-full w-full"></canvas>
  </div>
</template>


<script setup>
import { ref, computed, watch, onMounted } from 'vue'
import { Bell, Pencil, Trash2, ChevronLeft, ChevronRight, FileSpreadsheet, FileText } from 'lucide-vue-next'
import NotificationModal from '@/components/NotificationModal.vue'
import { useTelegramStore } from '@/stores/telegram'
import FailureDetailsDrawer from '@/components/FailureDetailsDrawer.vue';

const drawerOpen = ref(false);
const activeItem = ref(null);

function openDetails(row) {
  activeItem.value = row;
  drawerOpen.value = true;
}

const telegramStore = useTelegramStore()

onMounted(() => {
  telegramStore.fetchTelegramGroups()
})

const isNotifyModalOpen = ref(false)
const failureToNotify = ref(null)

function openNotifyModal(row) {
  failureToNotify.value = row
  isNotifyModalOpen.value = true
}

const props = defineProps({
  items: { type: Array, default: () => [] },
  showToolbar: { type: Boolean, default: true },
  showBottomActions: { type: Boolean, default: true },
  showRowActions: { type: Boolean, default: true },
  loading: { type: Boolean, default: false },
  storageKey: { type: String, default: 'recentFailures' },
  showHeader: { type: Boolean, default: true },
  editingId: { type: [String, Number], default: null },
})

const emit = defineEmits(['view', 'edit', 'delete'])

const q = ref('')
const status = ref('all')
const statusTabs = ['all', 'Active', 'In Progress', 'Resolved', 'On Hold']

function statusTabVariant(tab) {
  if (tab === 'all') return 'chip-variant-all'
  if (tab === 'Active') return 'chip-variant-active'
  if (tab === 'In Progress') return 'chip-variant-inprog'
  if (tab === 'Resolved') return 'chip-variant-resolved'
  if (tab === 'On Hold') return 'chip-variant-onhold'
  return ''
}

const sortKey = ref('reported_at')
const sortDir = ref('desc')
function setSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc'
  } else {
    sortKey.value = key
    sortDir.value = (key === 'id' || key === 'reported_at' || key === 'resolved_at') ? 'desc' : 'asc'
  }
}
function cmp(a, b) {
  if (a == null && b == null) return 0
  if (a == null) return -1
  if (b == null) return 1
  const na = Number(a), nb = Number(b)
  if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb
  return String(a).localeCompare(String(b), undefined, { sensitivity: 'base', numeric: true })
}

const sourceRows = computed(() => {
  const base = (props.items?.length ? props.items : [])
  return base.filter(i => {
    const type = i?.entry_type || 'item';
    return type !== 'message';
  });
})

function toMs(ts) {
  if (ts == null) return null
  if (typeof ts === 'number') return ts
  const ms = new Date(ts).getTime()
  return Number.isNaN(ms) ? null : ms
}
function timeAgo(ts) {
  const ms = toMs(ts)
  if (ms == null) return '—'
  const diff = Date.now() - ms
  const m = Math.floor(diff / 60000)
  if (m < 1) return 'just now'
  if (m < 60) return `${m}m ago`
  const h = Math.floor(m / 60)
  if (h < 24) return `${h}h ago`
  const d = Math.floor(h / 24)
  return `${d}d ago`
}
function fmt(ts) {
  const ms = toMs(ts)
  return ms == null ? '—' : new Date(ms).toLocaleString()
}

const filteredSorted = computed(() => {
  const base = status.value !== 'all'
    ? sourceRows.value.filter(r => (r.current_status ?? r.status) === status.value)
    : sourceRows.value

  const term = q.value.trim().toLowerCase()
  const filtered = term
    ? base.filter(r => JSON.stringify(r).toLowerCase().includes(term))
    : base

  const key = sortKey.value
  const dir = sortDir.value === 'asc' ? 1 : -1

  const getSortValue = (row, sortKey) => {
    switch (sortKey) {
      case 'reported_at': return toMs(row.reported_at ?? row.reportedAt) ?? 0
      case 'resolved_at': return toMs(row.resolved_at ?? row.resolvedAt) ?? 0
      case 'id': return row.fail_id ?? row.id
      case 'circuit': return row.circuit?.name ?? row.circuit
      case 'station': return row.station?.name ?? row.station
      case 'section': return row.section?.name ?? row.section
      case 'status': return row.current_status ?? row.status
      default: return ''
    }
  }

  return [...filtered].sort((a, b) => {
    const av = getSortValue(a, key)
    const bv = getSortValue(b, key)
    return cmp(av, bv) * dir
  })
})

function loadState() {
  let st = null
  try { st = JSON.parse(localStorage.getItem(props.storageKey) || 'null') } catch (_) {}
  if (!st || typeof st !== 'object') return
  if (typeof st.q === 'string') q.value = st.q
  if (typeof st.status === 'string') status.value = st.status
  if (typeof st.sortKey === 'string') sortKey.value = st.sortKey
  if (st.sortDir === 'asc' || st.sortDir === 'desc') sortDir.value = st.sortDir
  if (typeof st.perPage === 'number' && st.perPage > 0) perPage.value = st.perPage
  if (typeof st.page === 'number' && st.page >= 0) page.value = st.page
}

const page = ref(0)
const perPage = ref(10)
const total = computed(() => filteredSorted.value.length)
const pageCount = computed(() => Math.max(1, Math.ceil(total.value / perPage.value)))
const pagedRows = computed(() => {
  const start = page.value * perPage.value
  return filteredSorted.value.slice(start, start + perPage.value)
})

loadState()

watch([q, status, sortKey, sortDir, perPage, page], ([Q, S, K, D, P, Pg]) => {
  localStorage.setItem(props.storageKey, JSON.stringify({
    q: Q, status: S, sortKey: K, sortDir: D, perPage: Number(P), page: Number(Pg),
  }))
})

watch([total, pageCount], () => { if (page.value > pageCount.value - 1) page.value = Math.max(0, pageCount.value - 1) })
const showingFrom = computed(() => (total.value ? page.value * perPage.value + 1 : 0))
const showingTo = computed(() => Math.min(total.value, (page.value + 1) * perPage.value))
function prevPage() { if (page.value > 0) page.value-- }
function nextPage() { if (page.value < pageCount.value - 1) page.value++ }

function onEdit(row)   { emit('edit', row.id) }
function onDelete(row) { emit('delete', row) }

function badgeClasses(s) {
  if (s === 'Active')       return 'badge-danger'
  if (s === 'In Progress')  return 'badge-warning'
  if (s === 'Resolved')     return 'badge-success'
  if (s === 'On Hold')      return 'badge-hold'
  return 'badge-neutral'
}

const hoveredIndex = ref(-1)
function rowBg(s, hovered = false) {
  const pct = hovered ? 65 : 50
  return (
    s === 'Active'       ? `color-mix(in srgb, var(--s-active) ${pct}%, white)` :
    s === 'In Progress'  ? `color-mix(in srgb, var(--s-inprogress) ${pct}%, white)` :
    s === 'Resolved'     ? `color-mix(in srgb, var(--s-resolved) ${pct}%, white)` :
    s === 'On Hold'      ? `color-mix(in srgb, var(--s-onhold) ${pct}%, white)` :
    'transparent'
  )
}

function exportToExcel() {
  const ids = pagedRows.value.map(row => row.id);
  if (ids.length === 0) {
    alert("No visible failures to export.");
    return;
  }
  const url = `/api/v1/failures/logs/export_excel/?ids=${ids.join(',')}`;
  window.open(url, '_blank');
}

function exportToPdf() {
  const ids = pagedRows.value.map(row => row.id);
  if (ids.length === 0) {
    alert("No visible failures to export.");
    return;
  }
  const url = `/api/v1/failures/logs/export_pdf/?ids=${ids.join(',')}`;
  window.open(url, '_blank');
}
</script>

<template>
  <div class="space-y-4">
    <div v-if="showHeader">
      <h2 class="text-xl font-semibold leading-tight">Recent Failure Logs</h2>
    </div>

    <div class="rounded-2xl border-app bg-card text-app p-4">
      <div v-if="showToolbar" class="p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between flex-wrap gap-2">
        <div class="chip-group">
          <button
            v-for="tab in statusTabs"
            :key="tab"
            class="chip capitalize"
            :class="status === tab ? statusTabVariant(tab) + ' is-active' : 'text-app hover-primary'"
            :aria-pressed="String(status === tab)"
            @click="status = tab"
          >
            {{ tab }}
          </button>
        </div>
        <input v-model="q" type="text" placeholder="Search..." class="h-10 w-full sm:w-64 max-w-full min-w-0 rounded-lg border-app bg-card text-app px-3 text-sm"/>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-card">
            <tr>
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none" :aria-sort="sortKey==='id' ? (sortDir==='asc'?'ascending':'descending') : 'none'" @click="setSort('id')">
                <div class="inline-flex items-center gap-1">EV ID <span v-if="sortKey==='id'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none" :aria-sort="sortKey==='circuit' ? (sortDir==='asc'?'ascending':'descending') : 'none'" @click="setSort('circuit')">
                <div class="inline-flex items-center gap-1">Circuit <span v-if="sortKey==='circuit'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none" :aria-sort="sortKey==='station' ? (sortDir==='asc'?'ascending':'descending') : 'none'" @click="setSort('station')">
                <div class="inline-flex items-center gap-1">Station <span v-if="sortKey==='station'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none" :aria-sort="sortKey==='section' ? (sortDir==='asc'?'ascending':'descending') : 'none'" @click="setSort('section')">
                <div class="inline-flex items-center gap-1">Section <span v-if="sortKey==='section'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none" :aria-sort="sortKey==='reported_at' ? (sortDir==='asc'?'ascending':'descending') : 'none'" @click="setSort('reported_at')">
                <div class="inline-flex items-center gap-1">Reported <span v-if="sortKey==='reported_at'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>
              <th v-if="showRowActions" class="text-center font-semibold text-app px-3 py-1.5">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="!loading && filteredSorted.length === 0">
              <td :colspan="showRowActions ? 6 : 5" class="px-4 py-6 text-center text-muted">No recent failures</td>
            </tr>
            <tr v-if="!loading" v-for="(r, i) in pagedRows" :key="r.id ?? i" class="cursor-pointer" role="button" tabindex="0" @click="openDetails(r)" @keydown.enter.space="emit('view', r)" @mouseenter="hoveredIndex = i" @mouseleave="hoveredIndex = -1" :style="{ backgroundColor: rowBg(r.current_status ?? r.status, hoveredIndex === i) }">
              <td class="px-3 py-1.5 text-center rounded-l-xl"><div class="truncate">{{ (r.fail_id ?? r.id)?.split('-').pop() ?? '—' }}</div></td>
              <td class="px-3 py-1.5 text-center"><div class="truncate">{{ r.circuit?.circuit_id ?? r.circuit ?? '—' }}</div></td>
              <td class="px-3 py-1.5 text-center"><div class="truncate">{{ r.station?.code ?? r.station ?? '—' }}</div></td>
              <td class="px-3 py-1.5 text-center"><div class="truncate">{{ r.section?.name ?? r.section ?? '—' }}</div></td>
              <td class="px-3 py-1.5 text-center">
                <span :title="fmt(r.reported_at ?? r.reportedAt)">{{ timeAgo(r.reported_at ?? r.reportedAt) }}</span>
              </td>
             <td v-if="showRowActions" class="px-3 py-1.5 text-center rounded-r-xl">
                <div class="inline-flex items-center justify-center gap-2">
                    <button class="btn-ghost border-app rounded-md hover-primary p-2" aria-label="Notify" title="Notify" @click.stop="$emit('notify', r)">
                        <Bell class="w-4 h-4" />
                    </button>
                    <button class="btn-ghost border-app rounded-md hover-primary p-2" aria-label="Edit" title="Edit" @click.stop="$emit('edit', r.id)">
                        <Pencil class="w-4 h-4" />
                    </button>
                    <button class="btn-ghost border-app rounded-md hover-primary p-2" aria-label="Delete" title="Delete" @click.stop="onDelete(r)">
                        <Trash2 class="w-4 h-4" />
                    </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <div class="mt-3 flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
          <div class="text-xs text-muted">
            Showing {{ showingFrom }}–{{ showingTo }} of {{ total }}
          </div>

          <div class="inline-flex items-center gap-2">
            <label class="text-sm text-app">Rows per page</label>
            <select v-model.number="perPage" class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm">
              <option :value="10">10</option>
              <option :value="20">20</option>
              <option :value="50">50</option>
            </select>

            <div class="ml-2 inline-flex items-center gap-2">
              <button class="btn-ghost border-app rounded-md hover-primary p-2 disabled:opacity-40" :disabled="page === 0" aria-label="Previous page" title="Previous" @click="prevPage">
                <ChevronLeft class="w-4 h-4" />
              </button>
              <span class="text-sm tabular-nums">{{ page + 1 }} / {{ pageCount }}</span>
              <button class="btn-ghost border-app rounded-md hover-primary p-2 disabled:opacity-40" :disabled="page >= pageCount - 1" aria-label="Next page" title="Next" @click="nextPage">
                <ChevronRight class="w-4 h-4" />
              </button>
            </div>
          </div>
        </div>
      </div>

      <div v-if="showBottomActions" class="flex justify-center gap-3 px-3 py-5">
        <button
          class="btn-ghost border-app rounded-md hover-primary p-2"
          aria-label="Export Excel"
          title="Export Excel"
          @click="exportToExcel"
        >
          <FileSpreadsheet class="w-4 h-4" />
        </button>
        <button
          class="btn-ghost border-app rounded-md hover-primary p-2"
          aria-label="Export PDF"
          title="Export PDF"
          @click="exportToPdf"
        >
          <FileText class="w-4 h-4" />
        </button>
      </div>
    </div>
    <NotificationModal v-model="isNotifyModalOpen" :failure="failureToNotify" />
    <FailureDetailsDrawer v-model="drawerOpen" :item="activeItem" :show-actions="false" />
  </div>
</template>

<script setup>
const props = defineProps({
  sections: { type: Array, default: () => [] },   // ['Section A', 'Section B', ...]
  modelValue: { type: Array, default: () => [] }, // selected sections
})
const emit = defineEmits(['update:modelValue'])

function setAll() {
  emit('update:modelValue', [...props.sections])
}
function clearAll() {
  emit('update:modelValue', [])
}
function toggle(s) {
  const set = new Set(props.modelValue || [])
  set.has(s) ? set.delete(s) : set.add(s)
  emit('update:modelValue', Array.from(set))
}
function isSelected(s) {
  return (props.modelValue || []).includes(s)
}
</script>

<template>
  <div class="chip-group flex-wrap items-center gap-2">
    <span class="text-sm text-muted mr-1">Sections:</span>

    <button
      class="chip text-xs"
      :class="(modelValue?.length || 0) === sections.length && sections.length
        ? 'selected-primary' : 'text-app hover-primary'"
      @click="setAll"
      title="Select all sections"
    >All</button>

    <button
      class="chip text-xs"
      :class="(modelValue?.length || 0) === 0
        ? 'selected-primary' : 'text-app hover-primary'"
      @click="clearAll"
      title="Clear all sections"
    >None</button>

    <button
      v-for="s in sections" :key="s"
      class="chip text-xs transition"
      :class="isSelected(s)
        ? 'selected-primary'
        : 'text-app hover-primary'"
      @click="toggle(s)"
    >{{ s }}</button>
  </div>
</template>


<script setup>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'

const props = defineProps({
  sections: { type: Array, default: () => [] },     // ['Section A', 'Section B', ...]
  modelValue: { type: Array, default: () => [] },   // selected sections
  maxInline: { type: Number, default: 6 },          // how many selected chips to preview on the button
  placeholder: { type: String, default: 'Filter sections...' },
})
const emit = defineEmits(['update:modelValue'])

const open = ref(false)
const query = ref('')
const host = ref(null)

const selected = computed(() => new Set(props.modelValue || []))
const filteredSections = computed(() => {
  const q = query.value.trim().toLowerCase()
  if (!q) return props.sections
  return props.sections.filter(s => String(s).toLowerCase().includes(q))
})
function toggle(s) {
  const next = new Set(selected.value)
  next.has(s) ? next.delete(s) : next.add(s)
  emit('update:modelValue', Array.from(next))
}
function setAll() { emit('update:modelValue', [...props.sections]) }
function clearAll() { emit('update:modelValue', []) }

const selectedList = computed(() => props.sections.filter(s => selected.value.has(s)))
const inlineChips = computed(() => selectedList.value.slice(0, props.maxInline))
const hiddenCount = computed(() => Math.max(0, selectedList.value.length - props.maxInline))

function onDocClick(e) {
  if (!open.value) return
  if (host.value && !host.value.contains(e.target)) open.value = false
}
onMounted(() => document.addEventListener('mousedown', onDocClick))
onBeforeUnmount(() => document.removeEventListener('mousedown', onDocClick))
</script>

<template>
  <div ref="host" class="relative">
    <!-- Trigger button -->
    <button
      type="button"
      class="w-full sm:w-auto inline-flex items-center gap-2 rounded-lg border-app bg-card text-app px-3 py-2 text-sm shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition"
      @click="open = !open"
      :title="selectedList.length ? selectedList.join(', ') : 'All sections selected'"
    >
      <svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M3 5h18v2H3zm0 6h12v2H3zm0 6h8v2H3z"/></svg>
      <span class="font-medium">Sections</span>

        <!-- selection preview -->
        <span v-if="selectedList.length === 0 || selectedList.length === props.sections.length" class="text-muted">
          • All
        </span>
        <span v-else class="flex flex-wrap gap-1">

        <span
          v-for="s in inlineChips"
          :key="s"
          class="px-2 py-0.5 rounded-full text-xs border-app bg-card"
        >{{ s }}</span>
        <span v-if="hiddenCount" class="text-muted text-xs">+{{ hiddenCount }}</span>
      </span>

      <svg viewBox="0 0 24 24" class="w-4 h-4 ml-1"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
    </button>

    <!-- Popover -->
    <div
      v-show="open"
      class="absolute z-50 mt-2 w-[min(90vw,28rem)] rounded-xl border-app bg-card text-app shadow-lg"
    >
      <!-- search + actions -->
      <div class="p-3 border-b border-app flex items-center gap-2">
        <svg viewBox="0 0 24 24" class="w-4 h-4 text-muted"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5l1.5-1.5l-5-5ZM9.5 14A4.5 4.5 0 1 1 14 9.5A4.5 4.5 0 0 1 9.5 14Z"/></svg>
        <input
          v-model="query"
          :placeholder="placeholder"
          class="flex-1 rounded-lg border-app bg-card text-app px-3 py-1.5 text-sm"
        />
        <button class="text-xs px-2 py-1 rounded-lg border-app bg-card shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition" @click="setAll">All</button>
        <button class="text-xs px-2 py-1 rounded-lg border-app bg-card shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition" @click="clearAll">None</button>
      </div>

      <!-- list -->
      <div class="max-h-72 overflow-auto p-2">
        <template v-if="filteredSections.length">
          <label
            v-for="s in filteredSections"
            :key="s"
            class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-card cursor-pointer"
          >
            <input type="checkbox" class="h-4 w-4" :checked="selected.has(s)" @change="toggle(s)" />
            <span class="text-sm">{{ s }}</span>
          </label>
        </template>
        <div v-else class="p-6 text-center text-sm text-muted">No matches</div>
      </div>

      <!-- footer -->
      <div class="p-2 border-t border-app flex items-center justify-end gap-2">
        <span class="text-xs text-muted mr-auto">
          {{ selectedList.length }} / {{ sections.length }} selected
        </span>
        <button class="text-sm px-2 py-1 rounded-lg border-app bg-card hover:bg-card" @click="open=false">Close</button>
      </div>
    </div>
  </div>
</template>


<script setup>
import { ref, onBeforeUnmount } from 'vue'

const props = defineProps({
  modelValue: { type: Number, default: 66 },   // left pane width in %
  minLeft:    { type: Number, default: 35 },
  maxLeft:    { type: Number, default: 80 },
})
const emit = defineEmits(['update:modelValue'])

const container = ref(null)
let dragging = false

function onPointerDown(e) {
  dragging = true
  window.addEventListener('pointermove', onPointerMove)
  window.addEventListener('pointerup', onPointerUp)
  e.preventDefault()
}
function onPointerMove(e) {
  if (!dragging || !container.value) return
  const rect = container.value.getBoundingClientRect()
  let pct = ((e.clientX - rect.left) / rect.width) * 100
  pct = Math.max(props.minLeft, Math.min(props.maxLeft, pct))
  emit('update:modelValue', Math.round(pct))
}
function onPointerUp() {
  dragging = false
  window.removeEventListener('pointermove', onPointerMove)
  window.removeEventListener('pointerup', onPointerUp)
}
onBeforeUnmount(() => onPointerUp())
</script>

<template>
  <!-- Stacks on small screens; draggable on lg+ -->
  <div ref="container" class="w-full">
    <div class="grid grid-cols-1 gap-4 lg:block">
      <div class="lg:flex">
        <!-- Left -->
        <div class="lg:shrink-0 lg:grow-0 lg:pr-3" :style="{ width: modelValue + '%' }">
          <slot name="left" />
        </div>

        <!-- Divider / handle -->
        <div
          class="hidden lg:block w-2 lg:shrink-0 lg:grow-0 cursor-col-resize"
          @pointerdown="onPointerDown"
          title="Drag to resize"
        >
          <div class="h-full mx-auto w-0.5 bg-[var(--border)] rounded hover:bg-[var(--text)]/30"></div>
        </div>

        <!-- Right -->
        <div class="lg:pl-3 lg:min-w-[280px]" :style="{ width: (100 - modelValue) + '%' }">
          <slot name="right" />
        </div>
      </div>
    </div>
  </div>
</template>


<script setup>
defineProps({
  item: { type: Object, required: true }, // { fail_id, status, severity, circuit, reported_at, assigned_to }
})

function statusBadge(s) {
  if (s === 'Resolved')     return 'badge-success'
  if (s === 'Active')       return 'badge-danger'
  if (s === 'In Progress')  return 'badge-warning'
  if (s === 'On Hold')      return 'badge-hold'
  return 'badge-neutral'
}
</script>

<template>
  <div class="relative pl-8">
    <!-- line -->
    <div class="absolute left-3 top-0 bottom-0 w-px bg-[var(--border)]"></div>
    <!-- dot -->
    <div class="absolute left-2 top-2 h-3 w-3 rounded-full"
         :class="{
           'bg-[var(--danger)]': item.severity === 'Critical',
           'bg-[var(--warning)]': item.severity === 'High',
           'bg-[var(--neutral)]': item.severity === 'Low'
         }"></div>

    <div class="rounded-xl border-app bg-card text-app p-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">{{ item.fail_id }}</div>
        <span class="badge"
              :class="statusBadge(item.status)">
          {{ item.status }}
        </span>
      </div>
      <div class="mt-1 text-xs text-muted">
        <span class="mr-3"><span class="font-medium text-app">Severity:</span> {{ item.severity }}</span>
        <span class="mr-3"><span class="font-medium text-app">Circuit:</span> {{ item.circuit }}</span>
      </div>
      <div class="mt-1 text-xs text-muted">
        <span class="mr-3"><span class="font-medium text-app">Reported:</span> {{ item.reported_at }}</span>
        <span class="mr-3"><span class="font-medium text-app">Assigned:</span> {{ item.assigned_to }}</span>
      </div>
    </div>
  </div>
</template>


<script setup>
import { computed } from 'vue'

const props = defineProps({
  // Make title optional so callers can omit it when header is hidden
  title: { type: String, default: '' },

  // v-models
  chartType: { type: String, default: 'bar' },              // 'bar' | 'line' | 'pie' | 'doughnut' | 'table'
  range:     { type: String, default: 'today' },            // 'today' | '7d' | '30d' | 'custom'

  // optional: show the small “…” action icons later
  dense: { type: Boolean, default: false },
  // allow hiding the entire header area (title + selector + chips)
  hideHeader: { type: Boolean, default: false },
})

const emit = defineEmits(['update:chartType', 'update:range', 'refresh'])

const ranges = [
  { key: 'today', label: 'Today' },
  { key: '7d',    label: 'Last 7 days' },
  { key: '30d',   label: 'Last 30 days' },
  { key: 'custom',label: 'Custom' },
]

const rangeLabel = computed(() => ranges.find(r => r.key === props.range)?.label ?? '')
function setRange(key){ emit('update:range', key) }
function setType(e){ emit('update:chartType', e.target.value) }
</script>

<template>
  <div class="rounded-2xl border bg-white p-3 md:p-4">
    <!-- Header -->
    <div v-if="!hideHeader" class="mb-3 flex items-center gap-2">
      <h3 class="text-lg md:text-xl font-semibold flex-1 leading-tight">{{ title }}</h3>

      <!-- Chart type selector -->
      <select
        :value="chartType"
        @change="setType"
        class="rounded-lg border px-2 py-1 text-sm bg-white"
        title="Chart type"
      >
        <option value="bar">Bar</option>
        <option value="line">Line</option>
        <option value="pie">Pie</option>
        <option value="doughnut">Doughnut</option>
        <option value="table">Table</option>
      </select>

      <!-- (optional action icons we can wire later)
      <button class="p-2 rounded-lg hover:bg-gray-100" title="Refresh" @click="$emit('refresh')">
        <i class="pi pi-refresh text-sm"></i>
      </button>
      -->
    </div>

    <!-- Time filters (chips) -->
    <div v-if="!hideHeader" class="mb-3 chip-group">
      <button
        v-for="r in ranges"
        :key="r.key"
        class="chip"
        :class="range === r.key ? 'selected-primary' : 'text-app hover-primary'"
        :aria-pressed="String(range === r.key)"
        @click="setRange(r.key)"
      >
        {{ r.label }}
      </button>
    </div>

    <!-- Body slot: give range & chartType to child -->
    <div class="min-h-[220px]">
      <slot :range="range" :chart-type="chartType" :rangeLabel="rangeLabel"></slot>
    </div>
  </div>
</template>


<script setup>
import { computed } from 'vue'
import BarChart from '@/components/BarChart.vue'
import { severityHex, severityBg, SEVERITY_ORDER } from '@/lib/severityColors'

const props = defineProps({
  range: { type: String, default: 'today' },
  records: { type: Array, default: () => [] },
  severity: { type: String, default: 'all' }, // 'all' | 'minor' | 'major' | 'critical'
})

// Normalize severity to title case used in palette
function normSeverity(s) {
  const m = String(s || '').toLowerCase()
  if (m === 'critical') return 'Critical'
  if (m === 'major') return 'Major'
  if (m === 'minor') return 'Minor'
  return 'Minor'
}

function recSeverity(rec) {
  // Map record.severity into Minor/Major/Critical; adapt here if model differs
  const raw = rec?.severity || rec?.Severity || rec?.sev || ''
  const n = String(raw).toLowerCase()
  if (n === 'critical') return 'Critical'
  if (n === 'major') return 'Major'
  if (n === 'minor') return 'Minor'
  // fallback mapping for datasets that only have 'Normal'
  if (n === 'normal') return 'Minor'
  return 'Minor'
}

function recTimeMs(rec) {
  const t = rec?.occurred_at || rec?.reportedAt || rec?.reported_at || rec?.ts
  const ms = typeof t === 'number' ? t : new Date(t).getTime()
  return Number.isFinite(ms) ? ms : 0
}

// Buckets for x-axis based on range
function buildBuckets(range) {
  const now = new Date()
  const labels = []
  const keys = []
  if (range === 'today') {
    // single-day bucket
    const key = now.toISOString().slice(0,10)
    labels.push('Today')
    keys.push(key)
  } else if (range === 'week') {
    for (let i=6;i>=0;i--) {
      const d = new Date(now)
      d.setDate(now.getDate() - i)
      labels.push(d.toLocaleDateString())
      keys.push(d.toISOString().slice(0,10))
    }
  } else if (range === 'month') {
    for (let i=29;i>=0;i--) {
      const d = new Date(now)
      d.setDate(now.getDate() - i)
      labels.push(d.toLocaleDateString())
      keys.push(d.toISOString().slice(0,10))
    }
  } else if (range === 'year') {
    for (let m=0;m<12;m++) {
      const d = new Date(now.getFullYear(), m, 1)
      labels.push(d.toLocaleString(undefined, { month: 'short' }))
      keys.push(`${d.getFullYear()}-${String(m+1).padStart(2,'0')}`)
    }
  } else {
    // default to last 7 days
    for (let i=6;i>=0;i--) {
      const d = new Date(now)
      d.setDate(now.getDate() - i)
      labels.push(d.toLocaleDateString())
      keys.push(d.toISOString().slice(0,10))
    }
  }
  return { labels, keys }
}

const includedSeverities = computed(() => {
  const s = String(props.severity || 'all').toLowerCase()
  return s === 'all' ? [...SEVERITY_ORDER] : [normSeverity(s)]
})

const chartData = computed(() => {
  const { labels, keys } = buildBuckets(props.range)
  // Aggregate counts per key per severity
  const buckets = new Map(keys.map(k => [k, { Critical: 0, Major: 0, Minor: 0 }]))
  for (const rec of props.records || []) {
    const ms = recTimeMs(rec)
    if (!ms) continue
    const d = new Date(ms)
    const dayKey = d.toISOString().slice(0,10)
    const monthKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`
    const key = keys.length === 1 ? dayKey : (keys.length === 12 ? monthKey : dayKey)
    if (!buckets.has(key)) continue
    const sev = recSeverity(rec)
    const row = buckets.get(key)
    row[sev] = (row[sev] || 0) + 1
  }

  const datasets = includedSeverities.value.map(sev => ({
    label: sev,
    data: keys.map(k => buckets.get(k)?.[sev] ?? 0),
    backgroundColor: severityBg(sev, 0.85),
    borderColor: severityHex(sev),
    borderWidth: 1,
    borderRadius: 6,
  }))

  return { labels, datasets }
})
</script>

<template>
  <div class="h-full w-full">
    <BarChart :data="chartData" :options="{ responsive: true, maintainAspectRatio: false, plugins: { colors: false } }" />
  </div>
</template>



<script setup>
defineProps({
  label: String,
  modelValue: String,   // ISO-ish: "2025-08-19T08:30"
  error: String,
})
defineEmits(['update:modelValue'])
</script>

<template>
  <label class="block space-y-1">
    <span class="text-sm text-app">{{ label }}</span>
    <input
      type="datetime-local"
      class="field"
      :value="modelValue"
      @input="$emit('update:modelValue', $event.target.value)"
    />
    <p v-if="error" class="text-xs text-red-600">{{ error }}</p>
  </label>
</template>


<script setup>
defineProps({
  label: String,
  modelValue: [String, Number],
  placeholder: String,
  error: String,
  type: { type: String, default: 'text' },
})
defineEmits(['update:modelValue'])
</script>

<template>
  <label class="block space-y-1">
    <span class="text-sm text-app">{{ label }}</span>
    <input
      :type="type"
      class="h-10 w-full rounded-lg border-app bg-card text-app px-3 text-sm"
      :placeholder="placeholder"
      :value="modelValue"
      @input="$emit('update:modelValue', $event.target.value)"
    />
    <p v-if="error" class="text-xs text-red-600">{{ error }}</p>
  </label>
</template>


<script setup>
import { ref, watch, computed, onMounted, onBeforeUnmount } from 'vue'

const props = defineProps({
  modelValue: [String, Number, Object, null],
  options: { type: Array, default: () => [] },
  placeholder: { type: String, default: 'Select…' },
  disabled: { type: Boolean, default: false },
  clearable: { type: Boolean, default: true },
  labelKey: { type: String, default: 'label' },
  valueKey: { type: String, default: 'value' },
})
const emit = defineEmits(['update:modelValue'])

const open = ref(false)
const query = ref('')
const hoverIndex = ref(-1)
const rootEl = ref(null)
const inputEl = ref(null)
const controlButton = ref(null)

// --- FLAG TO PREVENT IMMEDIATE REOPENING ---
let justClosed = false;

const selectedLabel = computed(() => {
  const val = props.modelValue
  if (val == null || val === '') return ''
  const found = props.options.find(o => (o[props.valueKey] === val) || (o === val))
  return found ? (found[props.labelKey] ?? String(found)) : String(val)
})

const filtered = computed(() => {
  const q = query.value.trim().toLowerCase()
  if (!q) return props.options
  return props.options.filter(o => String(o[props.labelKey] ?? o).toLowerCase().includes(q))
})

function toggleMenu() {
    if (justClosed) {
        return;
    }
    if (open.value) {
        closeMenu();
    } else {
        openMenu();
    }
}

function openMenu() {
  if (props.disabled) return
  open.value = true
  hoverIndex.value = -1
  requestAnimationFrame(() => inputEl.value?.focus())
}

function closeMenu() {
  open.value = false
}

function selectOption(opt) {
  const val = opt?.[props.valueKey] ?? opt
  emit('update:modelValue', val)
  closeMenu()
  controlButton.value?.blur()

  // --- SET FLAG AND CLEAR IT AFTER A SHORT DELAY ---
  justClosed = true;
  setTimeout(() => {
    justClosed = false;
  }, 150); // 150ms cooldown period
}

function clearSelection(e) {
  e?.stopPropagation()
  if (!props.clearable) return
  emit('update:modelValue', null)
  query.value = ''
  openMenu()
}

function onKeydown(e) {
  if (!open.value && (e.key === 'Enter' || e.key === 'ArrowDown' || e.key === ' ')) {
    e.preventDefault(); openMenu(); return
  }
  if (!open.value) return
  const max = filtered.value.length - 1
  if (e.key === 'ArrowDown') { e.preventDefault(); hoverIndex.value = Math.min(max, hoverIndex.value + 1) }
  else if (e.key === 'ArrowUp') { e.preventDefault(); hoverIndex.value = Math.max(0, hoverIndex.value - 1) }
  else if (e.key === 'Enter') { e.preventDefault(); if (filtered.value[hoverIndex.value]) selectOption(filtered.value[hoverIndex.value]) }
  else if (e.key === 'Escape') { e.preventDefault(); closeMenu() }
}

function onClickOutside(e) {
  if (!rootEl.value) return
  if (!rootEl.value.contains(e.target)) closeMenu()
}

onMounted(() => document.addEventListener('mousedown', onClickOutside))
onBeforeUnmount(() => document.removeEventListener('mousedown', onClickOutside))

watch(() => props.modelValue, (v) => {
  if (!open.value) query.value = ''
})
</script>

<template>
  <div ref="rootEl" class="relative">
    <button
      ref="controlButton" type="button"
      class="field-shell h-11 w-full text-left px-3 text-sm flex items-center justify-between gap-2"
      :class="disabled ? 'opacity-60 cursor-not-allowed' : ''"
      :aria-expanded="open"
      @click="toggleMenu"
      @keydown="onKeydown"
    >
      <span class="truncate" v-if="!open">
        <span v-if="selectedLabel" class="text-app">{{ selectedLabel }}</span>
        <span v-else class="text-muted">{{ placeholder }}</span>
      </span>
      <input
        v-else
        ref="inputEl"
        v-model="query"
        type="text"
        class="w-full outline-none bg-transparent text-app h-11"
        :placeholder="placeholder"
        @keydown.stop="onKeydown"
      />
      <span class="flex items-center gap-2 shrink-0">
        <button
          v-if="clearable && modelValue != null && modelValue !== ''"
          class="text-muted hover:text-app"
          title="Clear"
          @click.stop="clearSelection"
        >✕</button>
        <span class="text-muted">▾</span>
      </span>
    </button>
    <div
      v-if="open"
      class="absolute z-50 mt-1 w-full rounded-lg border bg-card text-app border-app shadow-lg max-h-60 overflow-auto"
      role="listbox"
    >
      <div
        v-for="(opt, i) in filtered"
        :key="opt[valueKey] ?? String(opt)"
        class="px-3 py-2 text-sm cursor-pointer flex items-center justify-between hover-primary"
        :class="[
          i === hoverIndex ? 'bg-primary-tint' : '',
          (opt[valueKey] ?? opt) === modelValue ? 'selected-primary' : ''
        ]"
        @mouseenter="hoverIndex = i"
        @mouseleave="hoverIndex = -1"
        @click.stop="selectOption(opt)"
      >
        <span class="truncate">{{ opt[labelKey] ?? String(opt) }}</span>
        <span v-if="(opt[valueKey] ?? opt) === modelValue" class="text-xs text-muted">✓</span>
      </div>
      <div v-if="filtered.length === 0" class="px-3 py-2 text-sm text-muted">No results</div>
    </div>
  </div>
</template>

<script setup>
defineProps({
  label: String,
  modelValue: [String, Number],
  options: { type: Array, default: () => [] }, // [{label, value}]
  error: String,
})
defineEmits(['update:modelValue'])
</script>

<template>
  <label class="block space-y-1">
    <span class="text-sm text-app">{{ label }}</span>
    <select
      class="field"
      :value="modelValue"
      @change="$emit('update:modelValue', $event.target.value)"
    >
      <option value="" disabled>Select…</option>
      <option v-for="o in options" :key="o.value" :value="o.value">{{ o.label }}</option>
    </select>
    <p v-if="error" class="text-xs text-red-600">{{ error }}</p>
  </label>
</template>


<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  modelValue: { type: Array, default: () => [] },   // user-added tags
  preset:     { type: Array, default: () => [] },   // auto tags (non-removable)
  placeholder:{ type: String, default: 'Add tag and press Enter' },
})
const emit = defineEmits(['update:modelValue'])

const input = ref('')
const local = ref([...props.modelValue])

watch(() => props.modelValue, v => { local.value = [...v] })

function normalize(t) {
  if (!t) return ''
  let v = String(t).trim()
  if (!v) return ''
  if (!v.startsWith('#')) v = '#' + v
  return v.replace(/\s+/g, '')                      // no spaces inside tags
}

function addFromInput() {
  const v = normalize(input.value)
  if (!v) return
  if (![...props.preset, ...local.value].includes(v)) {
    local.value.push(v)
    emit('update:modelValue', local.value)
  }
  input.value = ''
}

function removeTag(ix) {
  local.value.splice(ix, 1)
  emit('update:modelValue', local.value)
}

function onKeydown(e) {
  if (e.key === 'Enter' || e.key === ',' || e.key === 'Tab') {
    e.preventDefault(); addFromInput()
  } else if (e.key === 'Backspace' && !input.value && local.value.length) {
    // backspace to remove last
    local.value.pop(); emit('update:modelValue', local.value)
  }
}
</script>

<template>
  <div class="field-shell min-h-10 w-full px-2 py-1.5">
    <div class="flex flex-wrap items-center gap-1">
      <!-- preset (auto) tags – non-removable -->
      <span v-for="t in preset" :key="'p'+t"
            class="inline-flex items-center gap-1 rounded-full bg-[var(--border)]/30 text-app text-xs px-2 py-1">
        {{ t }}
      </span>

      <!-- user tags – removable -->
      <span v-for="(t, i) in local" :key="'u'+t"
            class="inline-flex items-center gap-1 rounded-full bg-[var(--secondary)] text-[var(--secondary-foreground)] text-xs px-2 py-1">
        {{ t }}
        <button class="ml-1 text-[var(--secondary-foreground)]/80 hover:text-[var(--secondary-foreground)]" @click="removeTag(i)" aria-label="Remove">✕</button>
      </span>

      <!-- input -->
      <input
        v-model="input"
        :placeholder="preset.length || local.length ? '' : placeholder"
        class="input-reset flex-1 min-w-[10ch] text-sm px-1 h-9"
        @keydown="onKeydown"
        @blur="addFromInput"
      />
    </div>
  </div>
</template>


<script setup>
defineProps({ size: { type: Number, default: 20 } })
</script>

<template>
  <svg class="animate-spin" :width="size" :height="size" viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="10" stroke="currentColor" class="opacity-20" stroke-width="4"/>
    <path d="M22 12a10 10 0 0 0-10-10" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
  </svg>
</template>


<script setup>
import { useUIStore } from '@/stores/ui'
const ui = useUIStore()

const typeStyles = (t) => ({
  info:    'bg-blue-600',
  success: 'bg-green-600',
  error:   'bg-red-600',
  warn:    'bg-amber-600',
}[t] || 'bg-gray-700')
</script>

<template>
  <div class="fixed inset-0 pointer-events-none z-[100]">
    <div class="absolute right-4 top-4 flex flex-col gap-2">
      <div v-for="t in ui.toasts" :key="t.id"
           class="pointer-events-auto w-80 rounded-xl shadow-lg text-white overflow-hidden"
           :class="typeStyles(t.type)">
        <div class="px-3 py-2 flex items-start justify-between gap-2">
          <div>
            <div class="text-sm font-semibold" v-if="t.title">{{ t.title }}</div>
            <div class="text-sm opacity-90" v-if="t.message">{{ t.message }}</div>
          </div>
          <button class="text-white/90 hover:text-white text-sm" @click="ui.removeToast(t.id)">✕</button>
        </div>
      </div>
    </div>
  </div>
</template>


// Generic debounce utility for Vue apps
// - Works with plain functions or Vue refs to functions
// - Delay can be a number or a Vue ref
// - Returns a wrapped function that carries a .cancel() method

import { isRef } from 'vue'

function toVal(v) {
  return isRef(v) ? v.value : v
}

export function useDebounce(fnOrRef, delayOrRef = 300) {
  let timer = null

  function getFn() {
    const fn = toVal(fnOrRef)
    if (typeof fn !== 'function') {
      throw new TypeError('useDebounce: expected a function or a ref to a function')
    }
    return fn
  }

  function getDelay() {
    const d = Number(toVal(delayOrRef))
    return Number.isFinite(d) ? d : 300
  }

  const debounced = function (...args) {
    if (timer) clearTimeout(timer)
    const ms = getDelay()
    return new Promise(resolve => {
      timer = setTimeout(() => {
        timer = null
        resolve(getFn().apply(this, args))
      }, ms)
    })
  }

  debounced.cancel = () => {
    if (timer) {
      clearTimeout(timer)
      timer = null
    }
  }

  return debounced
}



// src/data/mockFailures.js
const now = new Date()
const ms = (h) => h * 3600 * 1000
const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime()

export const failures = [
  // Today
  { id: 'RF001', section: 'Section A', status: 'Active',      severity: 'Critical', reportedAt: now.getTime() - ms(2) },
  { id: 'RF002', section: 'Section B', status: 'In Progress', severity: 'Major',    reportedAt: now.getTime() - ms(5) },
  { id: 'RF003', section: 'Section C', status: 'Resolved',    severity: 'Minor',    reportedAt: startOfToday - ms(6), resolvedAt: startOfToday + ms(2) },
  { id: 'RF004', section: 'Section D', status: 'Resolved',    severity: 'Major',    reportedAt: startOfToday - ms(12), resolvedAt: startOfToday + ms(6) },

  // Last 7 days
  { id: 'RF005', section: 'Section A', status: 'Active',      severity: 'Minor',    reportedAt: startOfToday - ms(24) * 2 },
  { id: 'RF006', section: 'Section B', status: 'On Hold',     severity: 'Major',    reportedAt: startOfToday - ms(24) * 3 },
  { id: 'RF007', section: 'Section C', status: 'Resolved',    severity: 'Critical', reportedAt: startOfToday - ms(24) * 4, resolvedAt: startOfToday - ms(24) * 3.5 },
  { id: 'RF008', section: 'Section D', status: 'Resolved',    severity: 'Minor',    reportedAt: startOfToday - ms(24) * 5, resolvedAt: startOfToday - ms(24) * 4.8 },

  // Last 30 days
  { id: 'RF009',  section: 'Section A', status: 'Resolved',    severity: 'Minor',    reportedAt: startOfToday - ms(24) * 10, resolvedAt: startOfToday - ms(24) * 9.7 },
  { id: 'RF010',  section: 'Section B', status: 'Resolved',    severity: 'Major',    reportedAt: startOfToday - ms(24) * 15, resolvedAt: startOfToday - ms(24) * 14.5 },
  { id: 'RF011',  section: 'Section C', status: 'Active',      severity: 'Major',    reportedAt: startOfToday - ms(24) * 18 },
  { id: 'RF012',  section: 'Section D', status: 'In Progress', severity: 'Minor',    reportedAt: startOfToday - ms(24) * 20 },
  { id: 'RF013',  section: 'Section B', status: 'Resolved',    severity: 'Critical', reportedAt: startOfToday - ms(24) * 22, resolvedAt: startOfToday - ms(24) * 21.4 },
  { id: 'RF014',  section: 'Section C', status: 'On Hold',     severity: 'Major',    reportedAt: startOfToday - ms(24) * 25 },
]


// frontend/src/lib/chartTheme.js
import { Chart, Filler } from 'chart.js'
import { currentThemeColors, withAlpha } from './theme'

export function applyChartTheme() {
  // Register missing plugins
  Chart.register(Filler)

  const c = currentThemeColors()

  // Base text color for labels/ticks
  Chart.defaults.color = c.text

  // Grid + ticks defaults
  const gridColor = withAlpha(c.border, 0.6)
  const tickColor = c.muted
  const borderColor = withAlpha(c.border, 0.8)

  // Apply to common scales
  ;['category','linear','logarithmic','time'].forEach(scale => {
    if (!Chart.defaults.scales[scale]) Chart.defaults.scales[scale] = {}
    Chart.defaults.scales[scale].grid = { color: gridColor }
    Chart.defaults.scales[scale].ticks = { color: tickColor }
    Chart.defaults.scales[scale].border = { color: borderColor }
  })

  // Legends and title
  Chart.defaults.plugins.legend = Chart.defaults.plugins.legend || {}
  Chart.defaults.plugins.legend.labels = { color: c.text }
  Chart.defaults.plugins.title = Chart.defaults.plugins.title || {}
  Chart.defaults.plugins.title.color = c.text

  // Tooltip to match card colors
  Chart.defaults.plugins.tooltip = {
    backgroundColor: withAlpha(c.card, 0.98),
    titleColor: c.text,
    bodyColor: c.text,
    borderColor: c.border,
    borderWidth: 1,
  }

  // Lines default to theme primary
  Chart.defaults.elements = Chart.defaults.elements || {}
  Chart.defaults.elements.line = {
    borderColor: c.primary,
    backgroundColor: withAlpha(c.primary, 0.2),
  }
  Chart.defaults.elements.bar = {
    borderColor: c.primary,
    backgroundColor: withAlpha(c.primary, 0.35),
  }
}

// Optional: re-apply on theme changes by observing the app container className
export function activateChartThemeAutoUpdate() {
  const app = document.getElementById('app')
  if (!app || typeof MutationObserver === 'undefined') return
  const obs = new MutationObserver(() => applyChartTheme())
  obs.observe(app, { attributes: true, attributeFilter: ['class'] })
}



import axios from 'axios';

// This creates an Axios instance that will correctly use the Vite proxy
// and handle Django's CSRF tokens automatically.
export const http = axios.create({
  baseURL: '/api/v1',
  timeout: 35000,
  withCredentials: true,
  xsrfCookieName: 'csrftoken',
  xsrfHeaderName: 'X-CSRFToken',
});

// Optional interceptor placeholders
http.interceptors.response.use(
  (r) => r,
  (err) => Promise.reject(err)
);

// Severity color helpers
export const SEVERITY_ORDER = ['Minor', 'Major', 'Critical']

export const SEVERITY_HEX = {
  Critical: '#FC9796',
  Major:    '#FFC08C',
  Minor:    '#8FE0AD',
}

export function hexToRgba(hex, alpha = 1) {
  let h = hex.replace('#', '').trim()
  if (h.length === 3) h = h.split('').map(c => c + c).join('')
  const r = parseInt(h.slice(0, 2), 16)
  const g = parseInt(h.slice(2, 4), 16)
  const b = parseInt(h.slice(4, 6), 16)
  const a = Math.max(0, Math.min(1, Number(alpha)))
  return `rgba(${r}, ${g}, ${b}, ${a})`
}

export function severityHex(label) {
  if (!label) return undefined
  const key = SEVERITY_ORDER.find(s => s.toLowerCase() === String(label).toLowerCase())
  return key ? SEVERITY_HEX[key] : undefined
}

export function severityBg(label, alpha = 0.85) {
  const hex = severityHex(label)
  return hex ? hexToRgba(hex, alpha) : undefined
}

export function paletteFor(labels = []) {
  return labels.map(l => severityHex(l) ?? '#9aa1a6')
}


export const STATUS_ORDER = ['Resolved', 'Active', 'In Progress', 'On Hold']

export const STATUS_COLORS = {
  Resolved: '#8FE0AD',
  Active: '#FC9796',
  'In Progress': '#EEEE96',
  'On Hold': '#FFC08C',
}

export function hexToRgba(hex, alpha = 1) {
  let h = hex.replace('#', '').trim()
  if (h.length === 3) h = h.split('').map(ch => ch + ch).join('')
  const r = parseInt(h.slice(0, 2), 16)
  const g = parseInt(h.slice(2, 4), 16)
  const b = parseInt(h.slice(4, 6), 16)
  const a = Math.max(0, Math.min(1, Number(alpha)))
  return `rgba(${r}, ${g}, ${b}, ${a})`
}

export function borderColor(status) {
  return STATUS_COLORS[status]
}

export function bgColor(status, alpha = 0.2) {
  return hexToRgba(STATUS_COLORS[status], alpha)
}

export function arrayForOrder(order = STATUS_ORDER) {
  return Array.from(order, s => STATUS_COLORS[s])
}

export function colorForLabel(label) {
  // case-insensitive exact match against known statuses
  const s = STATUS_ORDER.find(s => s.toLowerCase() === String(label).toLowerCase())
  return s ? STATUS_COLORS[s] : undefined
}

// Convenience: map any dataset label to strict status colors
export function colorsForDatasetLabel(label, bgAlpha = 0.85) {
  const hex = colorForLabel(label)
  if (!hex) return undefined
  return { border: hex, bg: hexToRgba(hex, bgAlpha) }
}


// frontend/src/lib/theme.js
/** Read a CSS variable (hex or rgb[a]) from the app root or document.
 * @param {string} name CSS var name like '--text'
 * @param {string} [fallback] fallback color
 * @returns {string}
 */
export function getCssVar(name, fallback = '') {
  const el = document.getElementById('app') || document.body || document.documentElement
  const val = getComputedStyle(el).getPropertyValue(name)?.trim()
  return val || fallback || '#000'
}

/** Convert a color to rgba string with given alpha.
 * Accepts hex (#rgb/#rrggbb) or rgb/rgba strings.
 * @param {string} color
 * @param {number} alpha 0..1
 */
export function withAlpha(color, alpha) {
  if (!color) return `rgba(0,0,0,${alpha})`
  if (color.startsWith('rgba(')) return color.replace(/rgba\(([^)]+)\)/, (_m, inner) => {
    const parts = inner.split(',').map(s => s.trim())
    return `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, ${alpha})`
  })
  if (color.startsWith('rgb(')) return color.replace(/rgb\(([^)]+)\)/, (_m, inner) => `rgba(${inner}, ${alpha})`)
  if (color.startsWith('#')) {
    const hex = color.slice(1)
    const to255 = h => parseInt(h, 16)
    let r, g, b
    if (hex.length === 3) {
      r = to255(hex[0] + hex[0]); g = to255(hex[1] + hex[1]); b = to255(hex[2] + hex[2])
    } else if (hex.length >= 6) {
      r = to255(hex.slice(0,2)); g = to255(hex.slice(2,4)); b = to255(hex.slice(4,6))
    } else {
      r = g = b = 0
    }
    return `rgba(${r}, ${g}, ${b}, ${alpha})`
  }
  // Fallback
  return color
}

export function currentThemeColors() {
  return {
    text: getCssVar('--body-text', '#2c3135'),
    muted: getCssVar('--french-gray-2', '#adb5bd'),
    border: getCssVar('--platinum', '#dee2e6'),
    card: getCssVar('--card-bg', '#f8f9fa'),
    // Chart accent defaults to slate-gray family
    primary: getCssVar('--slate-gray', '#6c757d'),
    primary600: getCssVar('--slate-gray-lighter', '#858e96'),
  }
}


// frontend/src/main.js
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import App from './App.vue'
import { router } from './router'   // ✅ named import to match your router file
import './assets/tailwind.css'
import './style.css'
import { applyChartTheme } from './lib/chartTheme'

const app = createApp(App)
const pinia = createPinia()
app.use(pinia)

// Hydrate auth store from localStorage
import { useAuthStore } from './stores/auth'
const authStore = useAuthStore()
authStore.initFromStorage()
app.use(router)
// Apply Chart.js theme defaults from CSS vars (single theme)
applyChartTheme()
app.mount('#app')


// Path: frontend/src/router/index.js
import { createRouter, createWebHistory } from 'vue-router'
import SettingsLayout from '@/views/settings/SettingsLayout.vue'
import EmailSettings from '@/views/settings/EmailSettings.vue'
import SectionManagement from '@/views/settings/SectionManagement.vue'
import ReportsManagement from '@/views/settings/ReportsManagement.vue'
import TelegramSettings from '@/views/settings/TelegramSettings.vue'
import ReportsNow from '@/views/ReportsNow.vue'
import SupervisorMovements from '@/views/SupervisorMovements.vue'
import ArchiveManagement from '@/views/settings/ArchiveManagement.vue'
const FailureIdSettings = () => import('@/views/settings/FailureIdSettings.vue')
const UsersRolesSettings = () => import('@/views/settings/UsersRolesSettings.vue')
const CircuitManagement = () => import('@/views/settings/CircuitManagement.vue')
const SupervisorManagement = () => import('@/views/settings/SupervisorManagement.vue')
const StationManagement = () => import('@/views/settings/StationManagement.vue')
const DepotManagement = () => import('@/views/settings/DepotManagement.vue')

const routes = [
  { path: '/login', component: () => import('../views/Login.vue'), meta: { public: true } },
  { path: '/', redirect: '/dashboard' },
  { path: '/dashboard', component: () => import('../views/Dashboard.vue'), meta: { requiresAuth: true, title: 'Dashboard' } },
  { path: '/logbook', component: () => import('../views/Logbook.vue'), meta: { requiresAuth: true, title: 'Logbook' } },
  { path: '/failures/new', name: 'LogbookEntry', alias: ['/logbook/new'], component: () => import('../views/FailureNew.vue'), meta: { requiresAuth: true, title: 'Logbook Entry' } },
  
  // This is the line that needs to be present and correct
  { path: '/failures/edit/:id', name: 'FailureEdit', component: () => import('@/views/FailureEdit.vue'), meta: { requiresAuth: true, title: 'Edit Failure' } },

  { path: '/reports-now', name: 'ReportsNow', component: ReportsNow, meta: { requiresAuth: true, title: 'Reports Now' } },
  { path: '/supervisor-movements', name: 'SupervisorMovements', component: SupervisorMovements, meta: { requiresAuth: true, title: 'Supervisor Movements' } },
  {
    path: '/settings',
    component: SettingsLayout,
    meta: { requiresAuth: true, title: 'Settings' },
    children: [
      { path: '', redirect: '/settings/reports' },
      { path: 'email', name: 'SettingsEmail', component: EmailSettings, meta: { title: 'Email Settings' } },
      { path: 'reports', name: 'SettingsReports', component: ReportsManagement, meta: { title: 'Reports Management' } },
      { path: 'failure-id', name: 'SettingsFailureId', component: FailureIdSettings, meta: { title: 'Failure ID Configuration' } },
      { path: 'telegram', name: 'SettingsTelegram', component: TelegramSettings, meta: { title: 'Telegram Integration Settings' } },
      { path: 'users-roles', name: 'SettingsUsersRoles', component: UsersRolesSettings, meta: { title: 'User and Role Management' } },
      { path: 'archive', name: 'SettingsArchive', component: ArchiveManagement, meta: { title: 'Archive Management' } },
      { path: 'circuits', name: 'SettingsCircuits', component: CircuitManagement, meta: { title: 'Circuit Management' } },
      { path: 'depots', name: 'SettingsDepots', component: DepotManagement, meta: { title: 'Depot Management' } },
      { path: 'supervisors', name: 'SettingsSupervisors', component: SupervisorManagement, meta: { title: 'Supervisor Management' } },
      { path: 'stations', name: 'SettingsStations', component: StationManagement, meta: { title: 'Station Management' } },
      { path: 'sections', name: 'SettingsSections', component: SectionManagement, meta: { title: 'Section Management' } },
    ],
  },
  { path: '/analytics', name: 'analytics', component: () => import('@/views/AnalyticsBoard.vue'), meta: { title: 'Analytics Board' } },
  { path: '/:pathMatch(.*)*', redirect: '/dashboard' },
]

export const router = createRouter({
  history: createWebHistory(),
  routes,
})

router.beforeEach((to, from, next) => {
  const authed = !!localStorage.getItem('auth_token')
  if (to.meta.requiresAuth && !authed) return next({ path: '/login', query: { next: to.fullPath } })
  next()
})

<script setup>
import { useUIStore } from '@/stores/ui'
import { ref } from 'vue'
import AppSidebar from './components/AppSidebar.vue'
import AppTopbar from './components/AppTopbar.vue'
import Toasts from '@/components/ui/Toasts.vue'
const ui = useUIStore()
// Default: open on md+ screens, closed on mobile
const sidebarOpen = ref(typeof window !== 'undefined' ? window.matchMedia('(min-width: 768px)').matches : false)

function onTopbarToggle() {
  const isDesktop = typeof window !== 'undefined' && window.matchMedia('(min-width: 768px)').matches
  if (isDesktop) {
    ui.toggleSidebarCollapsed()
  } else {
    sidebarOpen.value = !sidebarOpen.value
  }
}

// Sidebar drag-resize
let resizing = false
function onSidebarPointerDown(e){
  resizing = true
  window.addEventListener('pointermove', onSidebarPointerMove)
  window.addEventListener('pointerup', onSidebarPointerUp)
  e.preventDefault()
}
function onSidebarPointerMove(e){
  if (!resizing) return
  // sidebar anchored at left=0; use clientX as width
  ui.setSidebarWidth(e.clientX)
}
function onSidebarPointerUp(){
  resizing = false
  ui.snapSidebar()
  window.removeEventListener('pointermove', onSidebarPointerMove)
  window.removeEventListener('pointerup', onSidebarPointerUp)
}
</script>

<template>
  <div class="min-h-screen bg-app text-app" :style="{ '--sidebar-w': ui.computedSidebarWidth + 'px' }">
    <!-- Sidebar: fixed always; slide-in on mobile -->
    <div
      class="fixed inset-y-0 left-0 z-40 sidebar transform transition-transform transition-all duration-200 motion-reduce:transition-none"
      :class="sidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'"
      :style="{ width: ui.computedSidebarWidth + 'px' }"
      :data-collapsed="ui.sidebarCollapsed"
      :data-sidebar-width="ui.computedSidebarWidth"
    >
      <AppSidebar @navigate="sidebarOpen = false" />
      <!-- Drag handle -->
      <div
        class="absolute top-0 right-0 h-full w-2 cursor-col-resize bg-[var(--sidebar-bg)] focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--sidebar-fg)]/40 focus-visible:ring-offset-0"
        title="Drag to resize"
        tabindex="0"
        role="separator"
        aria-orientation="vertical"
        :aria-valuemin="ui.SIDEBAR_MIN"
        :aria-valuemax="ui.SIDEBAR_MAX"
        :aria-valuenow="ui.computedSidebarWidth"
        aria-label="Resize sidebar"
        @pointerdown="onSidebarPointerDown"
        @keydown.left.prevent="ui.setSidebarWidth(ui.sidebarWidth - 10)"
        @keydown.right.prevent="ui.setSidebarWidth(ui.sidebarWidth + 10)"
        @keydown.enter.prevent="ui.snapSidebar(ui.sidebarWidth)"
      />
    </div>

    <!-- Main content: shifted right on md+ -->
    <div class="min-h-screen flex flex-col ml-sidebar transition-all duration-200 motion-reduce:transition-none">
      <AppTopbar @toggleSidebar="onTopbarToggle" />
      <main class="p-6">
        <RouterView />
      </main>
    </div>

    <!-- Backdrop for mobile -->
    <div
      v-if="sidebarOpen"
      class="fixed inset-0 bg-black/30 z-30 md:hidden"
      @click="sidebarOpen = false"
    />
    <Toasts />
  </div>
</template>

<style scoped>
@media (min-width: 768px) {
  .ml-sidebar { margin-left: var(--sidebar-w, 256px); }
}
</style>


import axios from 'axios'

const api = axios.create({
  baseURL: '/api/v1', // Assuming your Django backend serves API at /api/v1
  headers: {
    'Content-Type': 'application/json',
  },
})

export default api


// src/api/mock.js
const demoData = [
  { fail_id: 'AA-0001', status: 'Active',   severity: 'High',     circuit: 'CIR-12', reported_at: '2025-08-19 08:20', resolved_at: null, assigned_to: 'Supervisor A', station: 'Bandra',  section: 'Western Line' },
  { fail_id: 'AB-0342', status: 'Resolved', severity: 'Low',      circuit: 'CIR-05', reported_at: '2025-08-19 06:05', resolved_at: '2025-08-19 07:00', assigned_to: 'Supervisor B', station: 'Andheri', section: 'Western Line' },
  { fail_id: 'AC-1010', status: 'Resolved',   severity: 'Critical', circuit: 'CIR-77', reported_at: '2025-08-18 23:41', resolved_at: '2025-08-19 01:30', assigned_to: 'Supervisor C', station: 'Dadar',   section: 'Central Line' },
  // add a few more rows so filtering feels real
  { fail_id: 'AD-2001', status: 'Active',   severity: 'Low',      circuit: 'CIR-33', reported_at: '2025-08-18 20:10', resolved_at: null, assigned_to: 'Supervisor D', station: 'Virar',   section: 'Western Line' },
  { fail_id: 'AE-3302', status: 'Resolved', severity: 'High',     circuit: 'CIR-12', reported_at: '2025-08-18 14:25', resolved_at: '2025-08-18 15:00', assigned_to: 'Supervisor E', station: 'Churchgate', section: 'Western Line' },
]

export async function listFailures(params = {}) {
  // simulate network latency
  await new Promise(r => setTimeout(r, 400))
  // ignore params for now; return everything
  return { count: demoData.length, results: demoData }
}


  export async function getCircuits() {
  await new Promise(r => setTimeout(r, 100))
  const circuits = [...new Set(demoData.map(d => d.circuit))]
  return circuits.map(c => ({ label: c, value: c }))
}

export async function getSections() {
  await new Promise(r => setTimeout(r, 100))
  const sections = [...new Set(demoData.map(d => d.section))]
  return sections.map(s => ({ label: s, value: s }))
}

export async function getStations() {
  await new Promise(r => setTimeout(r, 100))
  const stations = [...new Set(demoData.map(d => d.station))]
  return stations.map(s => ({ label: s, value: s }))
}

export async function getSupervisors() {
  await new Promise(r => setTimeout(r, 100))
  const supervisors = [...new Set(demoData.map(d => d.assigned_to))]
  return supervisors.map(s => ({ label: s, value: s }))
}

export async function getStatuses() {
  await new Promise(r => setTimeout(r, 100))
  const statuses = [...new Set(demoData.map(d => d.status))]
  return statuses.map(s => ({ label: s, value: s }))
}



<?xml version="1.0" encoding="UTF-8"?>
<svg id="Layer_2" data-name="Layer 2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 21.24 25.23">
  <path d="M14.39,17.38l-1.39-.03c.24.43.48.87.72,1.3H4.7c.24-.43.48-.87.72-1.3l-1.39.03c-1.34,2.38-2.68,4.76-4.03,7.15.11.62.8.89,1.13.56.32-.58.64-1.16.96-1.74h14.24c.32.58.64,1.16.96,1.74.33.33,1.02.06,1.13-.56-1.34-2.39-2.69-4.77-4.03-7.15ZM2.74,22.18c.44-.79.88-1.58,1.32-2.37h10.3c.44.79.88,1.58,1.32,2.37H2.74Z"/>
  <path d="M16.17,9.44c-.83,0-1.62-.24-2.28-.65-1.18-.72-1.99-1.99-2.08-3.45,0-.09,0-.18,0-.27,0-.97.32-1.87.86-2.59-.26-.04-.52-.07-.79-.09C7.17,1.93,1.43,2.67.35,4.64v11.14c0,.62.5,1.13,1.12,1.13h15.48c.62,0,1.12-.51,1.12-1.13v-6.78c-.57.28-1.22.44-1.9.44ZM3.43,14.33c-.86,0-1.56-.66-1.56-1.48s.7-1.48,1.56-1.48,1.55.66,1.55,1.48-.69,1.48-1.55,1.48ZM2.71,10.15c-.33,0-.6-.27-.6-.59v-3.63c0-.33.27-.59.6-.59h8.4c.09,1.87,1.19,3.47,2.78,4.27-.03.3-.29.54-.59.54H2.71ZM14.98,14.33c-.86,0-1.55-.66-1.55-1.48s.69-1.48,1.55-1.48,1.56.66,1.56,1.48-.7,1.48-1.56,1.48Z"/>
  <path d="M16.17,0c-1.82,0-3.41.95-4.3,2.39-.5.77-.78,1.69-.78,2.68,0,.09,0,.18.02.27.09,1.87,1.19,3.47,2.78,4.27.68.34,1.46.54,2.28.54.67,0,1.32-.13,1.9-.37,1.86-.76,3.17-2.58,3.17-4.71,0-2.8-2.27-5.07-5.07-5.07ZM18.07,9c-.57.28-1.22.44-1.9.44-.83,0-1.62-.24-2.28-.65-1.18-.72-1.99-1.99-2.08-3.45,0-.09,0-.18,0-.27,0-.97.32-1.87.86-2.59.79-1.08,2.07-1.77,3.51-1.77,2.41,0,4.36,1.95,4.36,4.36,0,1.73-1,3.23-2.46,3.93Z"/>
  <path d="M13.89,8.79v.82c-1.59-.8-2.69-2.4-2.78-4.27h.7c.09,1.46.9,2.73,2.08,3.45Z"/>
  <g>
    <rect x="13.41" y="4.31" width="3.37" height=".67" rx=".33" ry=".33" transform="translate(23.3 18.13) rotate(-138.42)"/>
    <rect x="15.56" y="4.31" width="4.46" height=".67" rx=".33" ry=".33" transform="translate(-.01 9.23) rotate(-29.09)"/>
  </g>
</svg>


/* Unified palette */
@import "@/styles/palettes.css";
@import "@/styles/status-palette.css";

@tailwind base;
@tailwind components;
@tailwind utilities;

/* Base: apply global colors to body and inputs */
@layer base {
  body { background-color: var(--bg-main); color: var(--body-text); }
  a { color: var(--slate-gray); }
  input, select, textarea { background-color: var(--input-bg); color: var(--body-text); border: 1px solid var(--french-gray); }
  :root { --text: var(--body-text); --border: var(--platinum); --card: var(--card-bg); }
}

/* Shared form controls */
@layer components {
  /* Shared form control style: matches Event ID look */
  .field {
    @apply w-full h-11 rounded-lg border bg-card text-app px-3 transition;
    border-color: var(--platinum);
  }
  .field::placeholder { color: color-mix(in srgb, var(--body-text) 50%, transparent); }
  .field:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--slate-gray);
    border-color: color-mix(in srgb, var(--slate-gray) 80%, #000 20%);
  }
  /* For multi-line */
  .field-textarea {
    @apply w-full min-h-[120px] rounded-lg border bg-card text-app p-3 transition;
    border-color: var(--platinum);
  }
  .field-textarea::placeholder { color: color-mix(in srgb, var(--body-text) 50%, transparent); }
  .field-textarea:focus {
    outline: none;
    box-shadow: 0 0 0 2px var(--slate-gray);
    border-color: color-mix(in srgb, var(--slate-gray) 80%, #000 20%);
  }
  /* For composite inputs (tags/search) needing focus on container */
  .field-shell {
    @apply w-full rounded-lg border bg-card text-app transition;
    border-color: var(--platinum);
  }
  .field-shell input::placeholder { color: color-mix(in srgb, var(--body-text) 50%, transparent); }
  /* Strip borders/rings from inner inputs placed inside .field-shell */
  .input-reset { @apply bg-transparent border-0 outline-none shadow-none; }
  .input-reset:focus { outline: none; box-shadow: none; border-color: transparent; }
  .field-shell:focus,
  .field-shell:focus-within {
    outline: none;
    box-shadow: 0 0 0 2px var(--slate-gray);
    border-color: color-mix(in srgb, var(--slate-gray) 80%, #000 20%);
  }

  /* Icon button + sidebar item helpers */
  .icon-btn {
    @apply inline-flex items-center justify-center h-10 w-10 rounded-lg text-app transition;
    background-color: transparent;
  }
  .icon-btn:hover { background-color: color-mix(in srgb, var(--card-bg) 92%, black 8%); }

  .side-item {
    @apply flex items-center gap-3 rounded-lg px-3 py-2 text-app transition;
  }
  .side-item:hover { background-color: color-mix(in srgb, var(--sidebar-bg) 92%, white 8%); }
}

/* Utilities bound to unified vars */
@layer utilities {
  /* Elevation */
  .shadow-card    { box-shadow: var(--shadow-card); }
  .shadow-popover { box-shadow: var(--shadow-hover); }

  /* Surfaces and text */
  .bg-app     { background-color: var(--bg-main); }
  .text-app   { color: var(--body-text); }
  .text-muted { color: var(--french-gray-2); }
  .bg-card    { background-color: var(--card-bg); }
  .border-app { border-color: var(--platinum); }
  .bg-surface { background-color: var(--card-bg); }
  .text-var   { color: var(--body-text); }
  .border-var { border-color: var(--platinum); }

  /* Shells */
  .navbar { background-color: var(--sidebar-bg); color: var(--sidebar-fg); }
  .sidebar { background-color: var(--sidebar-bg); color: var(--sidebar-fg); }

  /* Sidebar link styling */
  .sidebar-link { color: var(--sidebar-fg-muted); }
  .sidebar-link:hover { color: var(--sidebar-fg); background-color: color-mix(in srgb, var(--sidebar-fg) 8%, transparent); }
  .sidebar-link-active, .sidebar-link-active:hover { color: var(--sidebar-fg); background-color: color-mix(in srgb, var(--sidebar-fg) 12%, transparent); }

  /* Hover/selected state helpers */
  .hover-primary:not(.selected-primary):hover { background-color: var(--slate-gray-lighter); color: var(--seasalt); }
  .selected-primary { background-color: var(--slate-gray); color: var(--seasalt); border-color: var(--slate-gray); }
  /* Treat aria-pressed=true as active for neutral chips only.
     Do NOT override status-variant chips (they supply their own colors). */
  .chip[aria-pressed="true"]:not(.chip-variant-all):not(.chip-variant-active):not(.chip-variant-inprog):not(.chip-variant-resolved):not(.chip-variant-onhold):not(.is-active) {
    background-color: var(--slate-gray);
    color: var(--seasalt);
    border-color: var(--slate-gray);
    box-shadow: var(--shadow-resting);
  }
  /* Disable hover visual change when active; keep variant colors */
  .chip.selected-primary:hover,
  .chip[aria-pressed="true"]:not(.chip-variant-all):not(.chip-variant-active):not(.chip-variant-inprog):not(.chip-variant-resolved):not(.chip-variant-onhold):not(.is-active):hover {
    background-color: var(--slate-gray);
    color: var(--seasalt);
    border-color: var(--slate-gray);
    box-shadow: var(--shadow-resting);
  }

  /* Chips */
  /* Inactive/neutral pill with subtle elevation */
  .chip { @apply inline-flex items-center justify-center h-10 px-4 text-sm rounded-full transition;
    background-color: var(--card-bg);
    color: var(--body-text);
    box-shadow: var(--shadow-resting);
  }
  .chip:hover { box-shadow: var(--shadow-hover); background-color: var(--seasalt-lighter); }
  .chip:active { box-shadow: var(--shadow-resting); }
  .chip:focus-visible { outline: 2px solid color-mix(in srgb, var(--slate-gray) 40%, transparent); outline-offset: 0; }
  /* Compact transparent chip cluster (no background strip) */
  .chip-group { @apply inline-flex rounded-lg p-1 gap-2; }

  /* Status-colored chip variants (for Dashboard/New Failure filters) */
  .chip-variant-all       { background-color: var(--s-all);        color: var(--s-on-dark); }
  .chip-variant-active    { background-color: var(--s-active);     color: var(--s-on-light); }
  .chip-variant-inprog    { background-color: var(--s-inprogress); color: var(--s-on-light); }
  .chip-variant-resolved  { background-color: var(--s-resolved);   color: var(--s-on-light); }
  .chip-variant-onhold    { background-color: var(--s-onhold);     color: var(--s-on-light); }
  /* Remove hover change for any active status chip */
  .chip.is-active:hover { background: inherit; color: inherit; box-shadow: var(--shadow-resting); }

  /* Badges for statuses (use global status palette) */
  .badge { @apply inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium border; }
  .badge-success { background-color: var(--s-resolved);    color: var(--eerie-black); border-color: color-mix(in srgb, var(--s-resolved) 70%, transparent); }
  .badge-warning { background-color: var(--s-inprogress);  color: var(--eerie-black); border-color: color-mix(in srgb, var(--s-inprogress) 70%, transparent); }
  .badge-danger  { background-color: var(--s-active);      color: var(--eerie-black); border-color: color-mix(in srgb, var(--s-active) 70%, transparent); }
  .badge-hold    { background-color: var(--s-onhold);      color: var(--eerie-black); border-color: color-mix(in srgb, var(--s-onhold) 70%, transparent); }
  /* Neutral */
  .badge-neutral { background-color: var(--seasalt); color: var(--body-text); border-color: var(--platinum); }

  /* Status chip active fills */
  .chip-active-resolved    { background-color: var(--s-resolved);    color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .chip-active-inprogress  { background-color: var(--s-inprogress);  color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .chip-active-onhold      { background-color: var(--s-onhold);      color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .chip-active-active      { background-color: var(--s-active);      color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .chip-active-resolved:hover,
  .chip-active-inprogress:hover,
  .chip-active-onhold:hover,
  .chip-active-active:hover { box-shadow: var(--shadow-hover); }

  /* Buttons */
  .btn { @apply inline-flex items-center justify-center gap-2 h-10 px-4 rounded-lg text-sm font-medium transition; background-color: var(--button-primary); color: var(--seasalt); box-shadow: var(--shadow-resting); }
  .btn:hover { background-color: var(--button-hover); box-shadow: var(--shadow-hover); transform: translateY(-0.5px); }
  .btn:active { box-shadow: var(--shadow-resting); transform: translateY(0); }
  .btn:disabled { box-shadow: none; cursor: not-allowed; }
  .btn-sm { @apply h-8 px-3 text-xs; }

  .btn-primary, .button-primary { background-color: var(--button-primary); color: var(--seasalt); box-shadow: var(--shadow-resting); }
  .btn-primary:hover, .button-primary:hover { background-color: var(--button-hover); box-shadow: var(--shadow-hover); }

  .btn-secondary, .button-secondary { background-color: var(--french-gray); color: var(--eerie-black); box-shadow: var(--shadow-resting); }
  .btn-secondary:hover, .button-secondary:hover { background-color: var(--french-gray-lighter); box-shadow: var(--shadow-hover); }

  .btn-outline { background-color: transparent; color: var(--slate-gray); border: 1px solid var(--platinum); }
  .btn-outline:hover { background-color: var(--antiflash-white-lighter); }

  .btn-ghost { background-color: transparent; color: var(--body-text); }
  .btn-ghost:hover { background-color: var(--card-bg); box-shadow: inset 0 0 0 1px var(--platinum); }

  /* Cards */
  .card { @apply rounded-2xl border p-4 overflow-hidden; background: var(--card-bg); border-color: var(--platinum); color: var(--body-text); box-shadow: var(--shadow-card); transition: box-shadow 0.2s ease, background-color 0.2s ease; }
  .card:hover { background-color: var(--seasalt-lighter); box-shadow: var(--shadow-card-hover); }

  /* Equal-height widget helper */
  .widget-eq { @apply min-h-[420px] h-full; }
  .widget-eq-body { @apply h-full; }
}


<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="37.07" height="36" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 198"><path fill="#41B883" d="M204.8 0H256L128 220.8L0 0h97.92L128 51.2L157.44 0h47.36Z"></path><path fill="#41B883" d="m0 0l128 220.8L256 0h-51.2L128 132.48L50.56 0H0Z"></path><path fill="#35495E" d="M50.56 0L128 133.12L204.8 0h-47.36L128 51.2L97.92 0H50.56Z"></path></svg>

<script setup>
import { useRoute, RouterLink, useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { useUIStore } from '@/stores/ui'
// RFMS icon is inlined as SVG for reliable theming
const auth = useAuthStore()
const ui = useUIStore()
const route = useRoute()
const router = useRouter()
const links = [
  { to: '/dashboard', label: 'Dashboard', icon: 'pi pi-home' },
  { to: '/logbook', label: 'Logbook', icon: 'pi pi-book' },
  { to: '/failures/new', label: 'Logbook Entry', icon: 'pi pi-plus-circle' },
  { to: '/analytics', label: 'Analytics', icon: 'pi pi-chart-line' },
  { to: '/reports-now', label: 'Reports Now', icon: 'pi pi-send' },
  { to: '/supervisor-movements', label: 'Supervisor Movements', icon: 'pi pi-users' },
]

const isActive = (to) => route.path.startsWith(to)

function onLogout() {
  // Frontend-only logout placeholder: navigate to /login
  try { auth.logout?.() } catch (_) {}
  router.push('/login')
}
</script>

<template>
  <aside class="h-full flex flex-col overflow-hidden sidebar" :data-collapsed="$pinia.state.value.ui?.sidebarCollapsed">
    <!-- Branding + collapse control -->
    <div class="px-3 py-2 flex items-center justify-start">
      <div
        class="flex items-center gap-2"
        :class="$pinia.state.value.ui?.sidebarCollapsed ? 'w-full justify-center' : ''"
      >
        <!-- Inline SVG for maximum reliability and theming via currentColor -->
        <svg
          class="inline-block h-8 w-8"
          :style="{ color: 'var(--sidebar-fg)' }"
          viewBox="0 0 21.24 25.23"
          role="img"
          aria-label="RFMS icon"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M14.39,17.38l-1.39-.03c.24.43.48.87.72,1.3H4.7c.24-.43.48-.87.72-1.3l-1.39.03c-1.34,2.38-2.68,4.76-4.03,7.15.11.62.8.89,1.13.56.32-.58.64-1.16.96-1.74h14.24c.32.58.64,1.16.96,1.74.33.33,1.02.06,1.13-.56-1.34-2.39-2.69-4.77-4.03-7.15ZM2.74,22.18c.44-.79.88-1.58,1.32-2.37h10.3c.44.79.88,1.58,1.32,2.37H2.74Z"/>
          <path d="M16.17,9.44c-.83,0-1.62-.24-2.28-.65-1.18-.72-1.99-1.99-2.08-3.45,0-.09,0-.18,0-.27,0-.97.32-1.87.86-2.59-.26-.04-.52-.07-.79-.09C7.17,1.93,1.43,2.67.35,4.64v11.14c0,.62.5,1.13,1.12,1.13h15.48c.62,0,1.12-.51,1.12-1.13v-6.78c-.57.28-1.22.44-1.9.44ZM3.43,14.33c-.86,0-1.56-.66-1.56-1.48s.7-1.48,1.56-1.48,1.55.66,1.55,1.48-.69,1.48-1.55,1.48ZM2.71,10.15c-.33,0-.6-.27-.6-.59v-3.63c0-.33.27-.59.6-.59h8.4c.09,1.87,1.19,3.47,2.78,4.27-.03.3-.29.54-.59.54H2.71ZM14.98,14.33c-.86,0-1.55-.66-1.55-1.48s.69-1.48,1.55-1.48,1.56.66,1.56,1.48-.7,1.48-1.56,1.48Z"/>
          <path d="M16.17,0c-1.82,0-3.41.95-4.3,2.39-.5.77-.78,1.69-.78,2.68,0,.09,0,.18.02.27.09,1.87,1.19,3.47,2.78,4.27.68.34,1.46.54,2.28.54.67,0,1.32-.13,1.9-.37,1.86-.76,3.17-2.58,3.17-4.71,0-2.8-2.27-5.07-5.07-5.07ZM18.07,9c-.57.28-1.22.44-1.9.44-.83,0-1.62-.24-2.28-.65-1.18-.72-1.99-1.99-2.08-3.45,0-.09,0-.18,0-.27,0-.97.32-1.87.86-2.59.79-1.08,2.07-1.77,3.51-1.77,2.41,0,4.36,1.95,4.36,4.36,0,1.73-1,3.23-2.46,3.93Z"/>
          <path d="M13.89,8.79v.82c-1.59-.8-2.69-2.4-2.78-4.27h.7c.09,1.46.9,2.73,2.08,3.45Z"/>
          <g>
            <rect x="13.41" y="4.31" width="3.37" height=".67" rx=".33" ry=".33" transform="translate(23.3 18.13) rotate(-138.42)"/>
            <rect x="15.56" y="4.31" width="4.46" height=".67" rx=".33" ry=".33" transform="translate(-.01 9.23) rotate(-29.09)"/>
          </g>
        </svg>
      
        <span class="font-semibold tracking-wide"
              :class="$pinia.state.value.ui?.sidebarCollapsed ? 'sr-only' : ''">RFMS</span>
      </div>
      
    </div>

    <template v-if="auth.user">
      <nav class="space-y-1" :class="$pinia.state.value.ui?.sidebarCollapsed ? 'px-0' : 'px-2'">
        <RouterLink
          v-for="l in links"
          :key="l.to"
          :to="l.to"
          class="group flex items-center rounded-lg text-base sidebar-link"
          :class="{
            'justify-center h-16 w-full': $pinia.state.value.ui?.sidebarCollapsed,
            'px-3 py-2 gap-2': !$pinia.state.value.ui?.sidebarCollapsed,
            'sidebar-link-active': isActive(l.to)
          }"
          :aria-label="l.label"
          :title="l.label"
          :data-active="isActive(l.to) ? 'true' : 'false'"
          :aria-current="isActive(l.to) ? 'page' : undefined"
          @click="$emit('navigate')"
        >
          <i :class="l.icon" class="text-[1.1rem] leading-none"></i>
          <span class="leading-none transition-all duration-150"
                :class="$pinia.state.value.ui?.sidebarCollapsed ? 'w-0 opacity-0 overflow-hidden' : 'w-auto opacity-100'">
            {{ l.label }}
          </span>
        </RouterLink>
      </nav>
      <!-- Sidebar footer / utilities -->
      <div class="mt-auto" :class="$pinia.state.value.ui?.sidebarCollapsed ? 'px-0' : 'px-2'">
        <div class="space-y-1">
          <RouterLink
            to="/settings/failure-id"
            class="group flex items-center rounded-lg text-base sidebar-link"
            :class="{
              'justify-center h-16 w-full': $pinia.state.value.ui?.sidebarCollapsed,
              'px-3 py-2 gap-2': !$pinia.state.value.ui?.sidebarCollapsed,
              'sidebar-link-active': isActive('/settings')
            }"
            aria-label="Settings" title="Settings"
          >
            <i class="pi pi-cog text-[1.1rem] leading-none"></i>
            <span class="leading-none transition-all duration-150"
                  :class="$pinia.state.value.ui?.sidebarCollapsed ? 'w-0 opacity-0 overflow-hidden' : 'w-auto opacity-100'">
              Settings
            </span>
          </RouterLink>
          <button
            class="group flex items-center rounded-lg text-base sidebar-link w-full text-left"
            :class="$pinia.state.value.ui?.sidebarCollapsed ? 'justify-center h-16 w-full' : 'px-3 py-2 gap-2'"
            aria-label="Logout" title="Logout"
            @click="onLogout"
          >
            <i class="pi pi-sign-out text-[1.1rem] leading-none"></i>
            <span class="leading-none transition-all duration-150"
                  :class="$pinia.state.value.ui?.sidebarCollapsed ? 'w-0 opacity-0 overflow-hidden' : 'w-auto opacity-100'">
              Logout
            </span>
          </button>
        </div>
        <div class="p-3 text-xs text-muted">v0.1 • Vue + Tailwind</div>
      </div>
    </template>

    <template v-else>
      <div class="px-4 text-sm text-muted">
        Please <RouterLink class="underline" to="/login">log in</RouterLink>.
      </div>
      <div class="mt-auto p-3 text-xs text-muted">v0.1 • Vue + Tailwind</div>
    </template>
  </aside>
</template>


<script setup>
import { useUIStore } from '@/stores/ui'
import { useAuthStore } from '@/stores/auth'
import { useRoute } from 'vue-router'
import { computed } from 'vue'
const emit = defineEmits(['toggleSidebar'])

const ui = useUIStore()
const auth = useAuthStore()
const route = useRoute()

const titleMap = {
  '/dashboard': 'Dashboard',
  '/logbook': 'Logbook',
  '/failures/new': 'Logbook Entry',
  '/analytics': 'Analytics Board',
}
const pageTitle = computed(() => {
  if (route.path.startsWith('/settings')) return 'Settings'
  return route.meta?.title
      || titleMap[route.path]
      || titleMap['/' + (route.path.split('/')[1] || '')]
      || 'RFMS'
})

const displayName = computed(() => auth.user?.name || auth.user?.username || '')

function doLogout() {
  auth.logout()
  ui.pushToast({ type: 'info', title: 'Signed out' })
}
</script>

<template>
  <header
    class="h-14 flex items-center justify-between px-4
           bg-[var(--sidebar-bg)] text-[var(--sidebar-fg)]
           rounded-none border-0 shadow-none relative z-10"
  >
    <div class="flex items-center gap-2">
      <!-- Toggle sidebar moved/kept on the LEFT, visible at all sizes -->
      <button
        class="inline-flex items-center justify-center w-9 h-9 rounded-lg
               text-[var(--sidebar-fg)]
               hover:bg-[color-mix(in_oklab,var(--sidebar-fg)/_12%,_transparent)]
               focus-visible:outline-none focus-visible:ring-2
               focus-visible:ring-[var(--sidebar-fg)]/40"
        @click="emit('toggleSidebar')"
        aria-label="Toggle sidebar"
        title="Toggle sidebar"
      >
        <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
      </button>
      <h1 class="text-base font-semibold">{{ pageTitle }}</h1>
    </div>

    <!-- Right side: show current user name -->
    <div class="flex items-center gap-2">
      <span v-if="displayName" class="text-sm opacity-90 truncate max-w-[200px]">{{ displayName }}</span>
    </div>
  </header>
</template>


<script setup>
import { computed } from 'vue'
import { Bar } from 'vue-chartjs'
import { Chart, BarElement, CategoryScale, LinearScale, Title, Tooltip, Legend, Filler } from 'chart.js'
import { colorsForDatasetLabel } from '@/lib/statusColors'

Chart.register(BarElement, CategoryScale, LinearScale, Title, Tooltip, Legend, Filler)

const props = defineProps({
  data: { type: Object, required: true },
  options: { type: Object, default: () => ({ responsive: true, maintainAspectRatio: false }) },
})

// Disable any plugin-driven color overrides to ensure our palette wins
const computedOptions = computed(() => {
  const base = JSON.parse(JSON.stringify(props.options || {}))
  base.plugins = base.plugins || {}
  base.plugins.colors = false
  return base
})

const normalized = computed(() => {
  const d = JSON.parse(JSON.stringify(props.data || { labels: [], datasets: [] }))
  if (!d || !Array.isArray(d.datasets)) return props.data
  d.datasets = d.datasets.map((ds) => {
    const out = { ...ds }
    const label = String(out.label ?? '')
    const mapped = colorsForDatasetLabel(label, 0.85)
    if (mapped) {
      out.backgroundColor = mapped.bg
      out.borderColor = mapped.border
      out.borderWidth = out.borderWidth ?? 1
      out.hoverBackgroundColor = mapped.bg
      out.hoverBorderColor = mapped.border
    }
    return out
  })
  return d
})
</script>

<template>
  <!-- Fill parent; keep a safe minimum for axes + legend -->
  <div class="relative w-full h-full min-h-[260px]">
    <Bar :data="normalized" :options="computedOptions" />
  </div>
  
</template>

<style scoped>
/* Important: do NOT force height:100% on the canvas */
:global(canvas) { width: 100% !important; }
</style>


<script setup>
import { computed } from 'vue'

const props = defineProps({
  modelValue: {
    type: Object,
    // { range: 'today' | '7d' | '30d', status: string[] }
    default: () => ({ range: 'today', status: ['Active','In Progress','Resolved','On Hold'] })
  },
  // New: render controls selectively so page header can place them
  showRanges: { type: Boolean, default: true },
  showStatuses: { type: Boolean, default: true },
})
const emit = defineEmits(['update:modelValue'])

const ranges = [
  { key: 'today', label: 'Today' },
  { key: '7d',    label: 'Last 7 days' },
  { key: '30d',   label: 'Last 30 days' },
  { key: 'custom',label: 'Custom' },
]

const statusOptions = [
  { key: 'Active',      label: 'Active' },
  { key: 'In Progress', label: 'In Progress' },
  { key: 'Resolved',    label: 'Resolved' },
  { key: 'On Hold',     label: 'On Hold' },
]

const selectedRange = computed(() => props.modelValue.range)
const selectedStatuses = computed(() => new Set(props.modelValue.status || []))

function setRange(key) {
  emit('update:modelValue', { ...props.modelValue, range: key })
}

function toggleStatus(key) {
  const set = new Set(selectedStatuses.value)
  set.has(key) ? set.delete(key) : set.add(key)
  emit('update:modelValue', { ...props.modelValue, status: Array.from(set) })
}

function setFrom(dateStr){
  emit('update:modelValue', { ...props.modelValue, from: dateStr || '' })
}
function setTo(dateStr){
  emit('update:modelValue', { ...props.modelValue, to: dateStr || '' })
}

function statusStyle(key) {
  if (!selectedStatuses.value.has(key)) return {}
  const style = { color: '#0b1b1f' } // --s-on-light
  switch (key) {
    case 'Resolved':
      style.backgroundColor = '#8FE0AD'
      break
    case 'Active':
      style.backgroundColor = '#FC9796'
      break
    case 'In Progress':
      style.backgroundColor = '#EEEE96'
      break
    case 'On Hold':
      style.backgroundColor = '#FFC08C'
      break
    default:
      return {}
  }
  return style
}
</script>

<template>
  <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:justify-between">
    <!-- Range pills -->
    <div v-if="showRanges" class="chip-group">
      <button
        v-for="r in ranges"
        :key="r.key"
        class="chip"
        :class="selectedRange === r.key ? 'selected-primary' : 'text-app hover-primary'"
        :aria-pressed="String(selectedRange === r.key)"
        @click="setRange(r.key)"
      >
        {{ r.label }}
      </button>
      <!-- Custom range inputs -->
      <span v-if="selectedRange==='custom'" class="inline-flex items-center gap-2 ml-2 align-middle">
        <input
          type="date"
          :value="props.modelValue.from || ''"
          @input="setFrom($event.target.value)"
          class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm"
        />
        <span class="text-sm text-muted">to</span>
        <input
          type="date"
          :value="props.modelValue.to || ''"
          @input="setTo($event.target.value)"
          class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm"
        />
      </span>
    </div>

    <!-- Status toggles (colored by status; no hover change when active) -->
    <div v-if="showStatuses" class="flex flex-wrap gap-2">
      <button
        v-for="s in statusOptions"
        :key="s.key"
        class="chip"
        :class="{ 'is-active': selectedStatuses.has(s.key), 'text-app hover-primary': !selectedStatuses.has(s.key) }"
        :style="statusStyle(s.key)"
        :aria-pressed="String(selectedStatuses.has(s.key))"
        @click="toggleStatus(s.key)"
      >
        {{ s.label }}
      </button>
    </div>
  </div>
</template>


<script setup>
import { computed } from 'vue'

const props = defineProps({
  columns: { type: Array, required: true },
  rows: { type: Array, required: true },
  sortKey: { type: String, default: '' },
  sortDir: { type: String, default: 'asc' },
})
const emit = defineEmits(['rowclick', 'sort'])

function handleSort(key, sortable = true) {
  if (!sortable) return
  emit('sort', key)
}
</script>

<template>
  <div class="overflow-x-auto rounded-2xl border-app bg-card text-app">
    <table class="min-w-full text-sm">
      <thead class="bg-card">
        <tr>
          <th v-for="c in columns" :key="c.key"
              :class="['font-semibold text-app px-4 py-3 select-none', c.align || 'text-left']"
              :style="c.width ? { width: c.width } : null"
              @click="handleSort(c.key, c.sortable !== false)"
              role="columnheader"
              :aria-sort="sortKey===c.key ? (sortDir==='asc'?'ascending':'descending') : 'none'">
            <div class="inline-flex items-center gap-1">
              <span>{{ c.label }}</span>
              <span v-if="c.sortable !== false" class="text-xs text-muted">
                <span v-if="sortKey!==c.key">↕</span>
                <span v-else>{{ sortDir==='asc' ? '▲' : '▼' }}</span>
              </span>
            </div>
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(r, i) in rows" :key="i" class="border-t hover-primary cursor-pointer"
            @click="emit('rowclick', r)">
          <td v-for="c in columns" :key="c.key" :class="['px-4 py-3', c.align || 'text-left']">
            <slot :name="c.key" :row="r">
              {{ r[c.key] }}
            </slot>
          </td>
        </tr>
        <tr v-if="rows.length === 0" class="border-t">
          <td :colspan="columns.length" class="px-4 py-6 text-center text-muted">
            No data
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>

<script setup>
import { ref, onMounted, onBeforeUnmount, watch, nextTick } from 'vue'
import Chart from 'chart.js/auto'

const props = defineProps({
  data: { type: Object, required: true },
  options: { type: Object, default: () => ({ responsive: true, maintainAspectRatio: false, cutout: '60%' }) },
})

const canvas = ref(null)
let chart

import { STATUS_ORDER, arrayForOrder } from '@/lib/statusColors'

function normalizeData(d) {
  try {
    const copy = JSON.parse(JSON.stringify(d || {}))
    const labels = copy?.labels || []
    const ds = copy?.datasets?.[0]
    if (ds && Array.isArray(labels) && labels.every(l => STATUS_ORDER.includes(String(l)))) {
      if (!Array.isArray(ds.backgroundColor) || ds.backgroundColor.length !== labels.length) {
        ds.backgroundColor = labels.map(l => arrayForOrder(STATUS_ORDER)[STATUS_ORDER.indexOf(l)])
      }
    }
    return copy
  } catch { return d }
}

async function render() {
  await nextTick()
  const el = canvas.value
  if (!el || !el.isConnected) return
  if (chart) { try { chart.destroy() } catch (_) {} }
  chart = new Chart(el, { type: 'doughnut', data: normalizeData(props.data), options: props.options })
}

onMounted(render)
watch(() => props.data, render, { deep: true })
watch(() => props.options, render, { deep: true })
onBeforeUnmount(() => { if (chart) try { chart.destroy() } catch (_) {} })
</script>

<template>
  <div class="h-full w-full">
    <canvas ref="canvas" class="h-full w-full"></canvas>
  </div>
</template>


<script setup>
import { ref, watch, computed, onMounted } from 'vue';
import { useAttachmentStore } from '@/stores/attachments';
import { Trash2 } from 'lucide-vue-next';

const props = defineProps({
  failureId: {
    type: [Number, String],
    required: true,
  },
});

const attachmentStore = useAttachmentStore();
const attachments = computed(() => attachmentStore.attachments);

const fileInput = ref(null);
const selectedFile = ref(null);
const description = ref('');

watch(() => props.failureId, (newId) => {
  if (newId) {
    attachmentStore.fetchAttachments(newId);
  }
}, { immediate: true });

function handleFileSelect(event) {
  selectedFile.value = event.target.files[0] || null;
}

async function handleUpload() {
  if (!selectedFile.value || !props.failureId) {
    return;
  }
  await attachmentStore.uploadAttachment(props.failureId, selectedFile.value, description.value);
  // Reset form
  selectedFile.value = null;
  description.value = '';
  if (fileInput.value) {
    fileInput.value.value = '';
  }
}

async function handleDelete(attachmentId) {
  if (confirm('Are you sure you want to delete this attachment?')) {
    await attachmentStore.deleteAttachment(attachmentId, props.failureId);
  }
}

function getFileUrl(fileUrl) {
    // In development, the backend serves media files from a different port
    // This prepends the backend URL if the file path is relative.
    if (fileUrl && !fileUrl.startsWith('http')) {
        const baseUrl = import.meta.env.VITE_API_BASE_URL || '';
        // Remove '/api' from the base URL if it exists, to get to the root
        const rootUrl = baseUrl.replace('/api', '');
        return `${rootUrl}${fileUrl}`;
    }
    return fileUrl;
}
</script>

<template>
  <div class="sm:col-span-2 space-y-4">
    <hr class="border-app/30 my-2" />
    <div>
      <h3 class="text-sm font-medium text-app mb-2">Attachments</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-3 border border-dashed border-app/50 rounded-lg">
        <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Upload New File</label>
          <input type="file" ref="fileInput" @change="handleFileSelect" class="text-sm" />
        </div>
        <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Description (Optional)</label>
          <input v-model="description" class="field h-9" placeholder="e.g., Photo of damaged cable" />
        </div>
        <div class="self-end">
          <button @click="handleUpload" :disabled="!selectedFile || attachmentStore.loading" class="btn btn-secondary w-full">
            {{ attachmentStore.loading ? 'Uploading...' : 'Upload' }}
          </button>
        </div>
      </div>

      <div class="mt-4 space-y-2">
        <div v-if="attachments.length === 0" class="text-xs text-app/60">
          No attachments for this entry.
        </div>
        <div v-for="att in attachments" :key="att.id" class="flex items-center justify-between p-2 rounded-lg bg-gray-100">
          <div class="flex-grow min-w-0">
            <a :href="getFileUrl(att.file)" target="_blank" class="text-sm font-medium text-blue-600 hover:underline truncate block">
              {{ att.file.split('/').pop() }}
            </a>
            <p class="text-xs text-gray-600 truncate">{{ att.description }}</p>
          </div>
          <button @click="handleDelete(att.id)" class="ml-4 p-2 text-red-500 hover:bg-red-100 rounded-full">
            <Trash2 class="w-4 h-4" />
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
defineProps({
  item: { type: Object, required: true }, // { fail_id, status, severity, circuit, reported_at, assigned_to }
})
</script>

<template>
  <article class="card space-y-2">
    <div class="flex items-start justify-between gap-3">
      <h3 class="text-base font-semibold">{{ item.fail_id }}</h3>
      <span
        class="badge"
        :class="{
          'badge-danger': item.severity === 'Critical',
          'badge-warning': item.severity === 'High',
          'badge-neutral': item.severity === 'Low',
        }"
      >
        {{ item.severity }}
      </span>
    </div>

    <div class="text-xs text-muted">
      <span class="inline-block mr-3">
        <span class="font-medium text-app">Status:</span> {{ item.status }}
      </span>
      <span class="inline-block mr-3">
        <span class="font-medium text-app">Circuit:</span> {{ item.circuit }}
      </span>
    </div>

    <div class="text-xs text-muted">
      <span class="inline-block mr-3">
        <span class="font-medium text-app">Reported:</span> {{ item.reported_at }}
      </span>
      <span class="inline-block mr-3">
        <span class="font-medium text-app">Assigned:</span> {{ item.assigned_to }}
      </span>
    </div>

    <div class="pt-2">
      <button class="btn btn-outline btn-sm">View</button>
      <button class="btn btn-primary btn-sm ml-2">Update</button>
    </div>
  </article>
</template>


<script setup>
import { computed } from 'vue'

const props = defineProps({
  modelValue: { type: Boolean, default: false }, // open/close
  item: { type: Object, default: () => null },   // failure object
})
const emit = defineEmits(['update:modelValue', 'notify', 'edit', 'delete'])

function close() { emit('update:modelValue', false) }

const duration = computed(() => {
  const r = props.item?.reportedAt, x = props.item?.resolvedAt
  if (!r || !x) return '—'
  const ms = x - r
  const h = Math.floor(ms / 3600000)
  const m = Math.round((ms % 3600000) / 60000)
  return `${h}h ${m}m`
})
function fmt(ts) { return ts ? new Date(ts).toLocaleString() : '—' }

function badgeClasses(s) {
  if (s === 'Active')       return 'badge-danger'
  if (s === 'In Progress')  return 'badge-warning'
  if (s === 'Resolved')     return 'badge-success'
  if (s === 'On Hold')      return 'badge-hold'
  return 'badge-neutral'
}
</script>

<template>
  <!-- Overlay -->
  <div
    v-show="modelValue"
    class="fixed inset-0 z-50"
    aria-modal="true"
    role="dialog"
  >
    <div class="absolute inset-0 bg-black/30" @click="close" />

    <!-- Panel -->
    <div class="absolute inset-y-0 right-0 w-full max-w-md bg-card text-app shadow-xl border-l border-app flex flex-col">
      <!-- Header -->
      <div class="px-4 py-3 border-b border-app flex items-center justify-between">
        <div class="font-semibold">Failure Details</div>
        <button class="p-2 rounded-lg hover:bg-card" @click="close" aria-label="Close">
          <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M18.3 5.71L12 12l6.3 6.29l-1.41 1.42L10.59 13.4L4.29 19.7L2.88 18.3L9.17 12L2.88 5.71L4.29 4.29l6.3 6.3l6.29-6.3z"/></svg>
        </button>
      </div>

      <!-- Body -->
      <div class="p-4 space-y-4 overflow-auto">
        <div class="flex items-center justify-between">
          <div class="text-lg font-semibold">{{ item?.id ?? '—' }}</div>
          <span class="badge" :class="badgeClasses(item?.status)">{{ item?.status ?? '—' }}</span>
        </div>

        <div class="grid grid-cols-2 gap-3 text-sm">
          <div>
            <div class="text-muted">Section</div>
            <div class="font-medium">{{ item?.section ?? '—' }}</div>
          </div>
          <div>
            <div class="text-muted">Severity</div>
            <div class="font-medium">{{ item?.severity ?? '—' }}</div>
          </div>
          <div>
            <div class="text-muted">Station</div>
            <div class="font-medium">{{ item?.station ?? '—' }}</div>
          </div>
          <div>
            <div class="text-muted">Circuit</div>
            <div class="font-medium">{{ item?.circuit ?? '—' }}</div>
          </div>
          <div>
            <div class="text-muted">Reported</div>
            <div class="font-medium">{{ fmt(item?.reportedAt) }}</div>
          </div>
          <div>
            <div class="text-muted">Resolved</div>
            <div class="font-medium">{{ fmt(item?.resolvedAt) }}</div>
          </div>
          <div>
            <div class="text-muted">Resolution Time</div>
            <div class="font-medium">{{ duration }}</div>
          </div>
        </div>

        <div>
          <div class="text-muted text-sm mb-1">Notes</div>
          <div class="rounded-lg border-app bg-card text-app p-3 min-h-[72px] text-sm">
            {{ item?.notes ?? '—' }}
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="px-4 py-3 border-t border-app flex items-center justify-between">
        <button class="text-sm px-3 py-2 rounded-lg border-app bg-card hover:bg-card" @click="close">Close</button>
        <div class="flex items-center gap-2">
          <button class="text-sm px-3 py-2 rounded-lg border-app bg-card hover:bg-card" @click="$emit('notify', item)">Notify</button>
          <button class="text-sm px-3 py-2 rounded-lg border-app bg-card hover:bg-card" @click="$emit('edit', item)">Edit</button>
          <button class="text-sm px-3 py-2 rounded-lg border text-red-600 hover:bg-red-50 border-red-200" @click="$emit('delete', item)">Delete</button>
        </div>
      </div>
    </div>
  </div>
</template>


<script setup>
import { ref } from 'vue'

defineProps({
  msg: String,
})

const count = ref(0)
</script>

<template>
  <h1>{{ msg }}</h1>

  <div class="card">
    <button type="button" @click="count++">count is {{ count }}</button>
    <p>
      Edit
      <code>components/HelloWorld.vue</code> to test HMR
    </p>
  </div>

  <p>
    Check out
    <a href="https://vuejs.org/guide/quick-start.html#local" target="_blank"
      >create-vue</a
    >, the official Vue + Vite starter
  </p>
  <p>
    Learn more about IDE Support for Vue in the
    <a
      href="https://vuejs.org/guide/scaling-up/tooling.html#ide-support"
      target="_blank"
      >Vue Docs Scaling up Guide</a
    >.
  </p>
  <p class="read-the-docs">Click on the Vite and Vue logos to learn more</p>
</template>

<style scoped>
.read-the-docs {
  color: #888;
}
</style>


<script setup>
import FailureCard from '@/components/FailureCard.vue'

defineProps({
  title: { type: String, required: true },
  items: { type: Array, default: () => [] },
})
</script>

<template>
  <section class="rounded-2xl border-app bg-card text-app p-3 flex flex-col gap-3">
    <header class="flex items-center justify-between">
      <h3 class="text-sm font-semibold text-app">{{ title }}</h3>
      <span class="text-xs text-muted">{{ items.length }}</span>
    </header>
    <div class="space-y-3">
      <FailureCard v-for="(it, i) in items" :key="i" :item="it" />
      <div v-if="items.length === 0" class="text-xs text-muted border-app bg-card rounded-lg p-3">
        No items
      </div>
    </div>
  </section>
</template>


<script setup>
const props = defineProps({
  label: String,
  value: [String, Number],
  sublabel: String,
  // NEW
  trendDir: { type: String, default: null },   // 'up' | 'down' | 'flat' | null
  trendLabel: { type: String, default: '' },
})
</script>

<template>
  <div class="card p-4 md:p-5 min-h-28 flex items-center justify-center text-center">
    <div class="flex flex-col items-center gap-1 w-full">
      <div class="text-sm text-app whitespace-nowrap overflow-hidden text-ellipsis" :title="label">{{ label }}</div>
      <div class="text-2xl font-semibold">{{ value }}</div>
      <div class="text-xs text-muted">{{ sublabel }}</div>

      <div
        v-if="trendDir"
        class="text-xs inline-flex items-center gap-1"
        :class="trendDir==='up' ? 'text-[var(--success)]' : trendDir==='down' ? 'text-[var(--danger)]' : 'text-muted'"
      >
        <svg v-if="trendDir==='up'" class="w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5l6 6h-4v8h-4v-8H6z"/></svg>
        <svg v-else-if="trendDir==='down'" class="w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M12 19l-6-6h4V5h4v8h4z"/></svg>
        <svg v-else class="w-3 h-3" viewBox="0 0 24 24"><path fill="currentColor" d="M5 12h14v2H5z"/></svg>
        <span>{{ trendLabel }}</span>
      </div>
    </div>
  </div>
  
</template>


<script setup>
import { computed } from 'vue'
import { Line } from 'vue-chartjs'
import { Chart, LineElement, PointElement, CategoryScale, LinearScale, Title, Tooltip, Legend, Filler } from 'chart.js'
import { STATUS_ORDER, bgColor, borderColor } from '@/lib/statusColors'

Chart.register(LineElement, PointElement, CategoryScale, LinearScale, Title, Tooltip, Legend, Filler)

const props = defineProps({
  data: { type: Object, required: true },
  options: { type: Object, default: () => ({ responsive: true, maintainAspectRatio: false }) },
})

const normalized = computed(() => {
  const d = JSON.parse(JSON.stringify(props.data || { labels: [], datasets: [] }))
  if (!d || !Array.isArray(d.datasets)) return props.data
  d.datasets = d.datasets.map((ds) => {
    const out = { ...ds }
    const label = String(out.label ?? '')
    if (STATUS_ORDER.includes(label)) {
      if (!out.borderColor) out.borderColor = borderColor(label)
      if (!out.backgroundColor) out.backgroundColor = bgColor(label, 0.25)
      if (out.fill == null) out.fill = true
      if (out.tension == null) out.tension = 0.3
    }
    return out
  })
  return d
})
</script>

<template>
  <div class="relative w-full h-full min-h-[300px]">
    <Line :data="normalized" :options="options" />
  </div>
  
</template>

<style scoped>
:global(canvas) { width: 100% !important; }
</style>


<script setup>
import { ref, watch, computed } from 'vue';
import { useTelegramStore } from '@/stores/telegram';

const props = defineProps({
  modelValue: { type: Boolean, default: false }, // v-model for visibility
  failure: { type: Object, default: null },
});
const emit = defineEmits(['update:modelValue']);

const telegramStore = useTelegramStore();
const availableGroups = computed(() => telegramStore.groups);
const selectedGroupKeys = ref([]);

watch(() => props.failure, (newFailure) => {
  if (newFailure) {
    // Reset selection when a new failure is passed in
    selectedGroupKeys.value = [];
  }
});

function close() {
  emit('update:modelValue', false);
}

async function sendNotification() {
  if (!props.failure || selectedGroupKeys.value.length === 0) {
    return;
  }
  await telegramStore.sendFailureNotification(props.failure.id, selectedGroupKeys.value);
  close();
}
</script>

<template>
  <div v-if="modelValue && failure" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
    <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
      <h3 class="text-lg font-semibold">Notify via Telegram</h3>
      <p>
        Send a notification for Event ID: <strong>{{ failure.fail_id }}</strong>
      </p>
      
      <div class="space-y-2">
        <label class="block text-sm font-medium">Select Telegram Group(s):</label>
        <div v-if="availableGroups.length > 0" class="space-y-1">
          <label v-for="group in availableGroups" :key="group.key" class="flex items-center gap-2 p-2 rounded-lg hover:bg-gray-100 cursor-pointer">
            <input type="checkbox" :value="group.key" v-model="selectedGroupKeys" class="h-4 w-4" />
            <span>{{ group.name }}</span>
          </label>
        </div>
        <div v-else class="text-sm text-gray-500">
          No Telegram groups configured.
        </div>
      </div>
      
      <div class="flex justify-end gap-3 pt-4">
        <button @click="close" class="btn btn-outline">Cancel</button>
        <button 
          @click="sendNotification" 
          class="btn btn-primary" 
          :disabled="selectedGroupKeys.length === 0 || telegramStore.loading">
          {{ telegramStore.loading ? 'Sending...' : 'Send' }}
        </button>
      </div>
    </div>
  </div>
</template>

<script setup>
import BarChart from '@/components/BarChart.vue'
import LineChart from '@/components/LineChart.vue'
import PieChart from '@/components/PieChart.vue'
import DoughnutChart from '@/components/DoughnutChart.vue'
import RecentFailures from '@/components/RecentFailures.vue'
import { getCssVar, withAlpha } from '@/lib/theme'
import FailureBySeverityCard from '@/components/analytics/FailureBySeverityCard.vue'

const props = defineProps({
  panel: { type: Object, required: true },
  state: { type: Object, required: true },
  data:  { type: Object, required: true },
  chartOptions: { type: Object, required: true },
})
</script>

<template>
  <div class="h-full w-full p-3">
    <!-- Table -->
    <div v-if="state.type==='table'" class="h-full overflow-auto">
      <!-- Aggregation tables -->
      <table v-if="panel.kind!=='recent'" class="min-w-full text-sm">
        <thead>
          <tr class="bg-gray-50">
            <th class="px-3 py-2 text-left">Label</th>
            <th class="px-3 py-2 text-right">Value</th>
          </tr>
        </thead>
        <tbody>
          <tr
            v-for="(v,i) in (data.datasets?.[0]?.data || [])"
            :key="i"
            class="border-t"
          >
            <td class="px-3 py-2">{{ data.labels?.[i] }}</td>
            <td class="px-3 py-2 text-right">{{ v }}</td>
          </tr>
          <tr v-if="!(data.labels?.length)" class="border-t">
            <td colspan="2" class="px-3 py-6 text-center text-gray-500">No data</td>
          </tr>
        </tbody>
      </table>

      <!-- Recent failures table -->
      <RecentFailures
        v-else
        :items="data.recent || []"
        :show-toolbar="false"
        :show-bottom-actions="false"
        :show-row-actions="true"
        :loading="false"
        storage-key="rf-analytics"
        @delete="$emit('delete', $event)"
      />
    </div>

    <!-- Charts -->
    <!-- Special: Failure by Severity card -->
    <div v-if="panel.kind==='failureSeverity' && state.type==='bar'" class="h-full">
      <FailureBySeverityCard :range="state.range" :records="data.records || []" :severity="state.severity || 'all'" />
    </div>
    
    <div v-else-if="state.type==='bar'" class="h-full">
      <BarChart
        :data="{
          labels: data.labels,
          datasets: [{
            ...data.datasets?.[0],
          }]
        }"
        :options="chartOptions"
      />
    </div>

    <div v-else-if="state.type==='line'" class="h-full">
      <LineChart
        :data="{
          labels: data.labels,
          datasets: [{
            ...data.datasets?.[0],
            fill: true,
            tension: 0.3,
            backgroundColor: withAlpha(getCssVar('--slate-gray', '#6c757d'), 0.2),
            borderColor: getCssVar('--slate-gray', '#6c757d')
          }]
        }"
        :options="chartOptions"
      />
    </div>

    <div v-else-if="state.type==='pie'" class="h-full">
      <PieChart
        :data="{ labels: data.labels, datasets: [{ ...data.datasets?.[0] }] }"
        :options="chartOptions"
      />
    </div>

    <div v-else-if="state.type==='doughnut'" class="h-full">
      <DoughnutChart
        :data="{ labels: data.labels, datasets: [{ ...data.datasets?.[0] }] }"
        :options="{ ...chartOptions, cutout: '60%' }"
      />
    </div>

    <!-- Fallback -->
    <div v-else class="h-full flex items-center justify-center text-sm text-gray-500">
      No content.
    </div>
  </div>
</template>


<script setup>
import { ref, onMounted, onBeforeUnmount, watch, nextTick } from 'vue'
import Chart from 'chart.js/auto'

const props = defineProps({
  data: { type: Object, required: true },
  options: { type: Object, default: () => ({ responsive: true, maintainAspectRatio: false }) },
})

const canvas = ref(null)
let chart

import { STATUS_ORDER, arrayForOrder } from '@/lib/statusColors'

function normalizeData(d) {
  try {
    const copy = JSON.parse(JSON.stringify(d || {}))
    const labels = copy?.labels || []
    const ds = copy?.datasets?.[0]
    if (ds && Array.isArray(labels) && labels.every(l => STATUS_ORDER.includes(String(l)))) {
      if (!Array.isArray(ds.backgroundColor) || ds.backgroundColor.length !== labels.length) {
        ds.backgroundColor = labels.map(l => arrayForOrder(STATUS_ORDER)[STATUS_ORDER.indexOf(l)])
      }
    }
    return copy
  } catch { return d }
}

async function render() {
  await nextTick()
  const el = canvas.value
  if (!el || !el.isConnected) return
  if (chart) { try { chart.destroy() } catch (_) {} }
  chart = new Chart(el, { type: 'pie', data: normalizeData(props.data), options: props.options })
}

onMounted(render)
watch(() => props.data, render, { deep: true })
watch(() => props.options, render, { deep: true })
onBeforeUnmount(() => { if (chart) try { chart.destroy() } catch (_) {} })
</script>

<template>
  <div class="h-full w-full">
    <canvas ref="canvas" class="h-full w-full"></canvas>
  </div>
</template>


<script setup>
import { ref, computed, watch, onMounted } from 'vue'
import { Bell, Pencil, Trash2, ChevronLeft, ChevronRight, History, FileSpreadsheet, FileText } from 'lucide-vue-next'
import NotificationModal from '@/components/NotificationModal.vue'
import { useTelegramStore } from '@/stores/telegram'

const telegramStore = useTelegramStore()

onMounted(() => {
  telegramStore.fetchTelegramGroups()
})

const isNotifyModalOpen = ref(false)
const failureToNotify = ref(null)

function openNotifyModal(row) {
  failureToNotify.value = row
  isNotifyModalOpen.value = true
}


/* -------- Props -------- */
const props = defineProps({
  items: { type: Array, default: () => [] },
  showToolbar: { type: Boolean, default: true },
  showBottomActions: { type: Boolean, default: true },
  showRowActions: { type: Boolean, default: true },
  // NEW:
  loading: { type: Boolean, default: false },
  // add this prop
  storageKey: { type: String, default: 'recentFailures' },
  // allow hiding the component's own title when embedded in dashboards
  showHeader: { type: Boolean, default: true },
  editingId: { type: [String, Number], default: null },

})


/* -------- Emits -------- */
const emit = defineEmits(['view', 'edit', 'delete'])

/* -------- Local UI state -------- */
const q = ref('')
const status = ref('all') // 'all' | 'Active' | 'In Progress' | 'Resolved' | 'On Hold'
const statusTabs = ['all', 'Active', 'In Progress', 'Resolved', 'On Hold']

function statusTabVariant(tab) {
  if (tab === 'all') return 'chip-variant-all'
  if (tab === 'Active') return 'chip-variant-active'
  if (tab === 'In Progress') return 'chip-variant-inprog'
  if (tab === 'Resolved') return 'chip-variant-resolved'
  if (tab === 'On Hold') return 'chip-variant-onhold'
  return ''
}

/* -------- Sorting -------- */
const sortKey = ref('reported_at') // 'id' | 'circuit' | 'station' | 'section' | 'status' | 'reported_at' | 'resolved_at'
const sortDir = ref('desc')       // 'asc' | 'desc'
function setSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc'
  } else {
    sortKey.value = key
    sortDir.value = (key === 'id' || key === 'reported_at' || key === 'resolved_at') ? 'desc' : 'asc'
  }
}
function cmp(a, b) {
  if (a == null && b == null) return 0
  if (a == null) return -1
  if (b == null) return 1
  const na = Number(a), nb = Number(b)
  if (!Number.isNaN(na) && !Number.isNaN(nb)) return na - nb
  return String(a).localeCompare(String(b), undefined, { sensitivity: 'base', numeric: true })
}

/* -------- Data source (props fallback safe) -------- */
const fallbackRows = [
  { fail_id: 'RF001', circuit: 'CKT-001', station: 'Bandra',  section: 'Western Line',  current_status: 'Active',      reported_at: Date.now() - 3600_000 },
  { fail_id: 'RF002', circuit: 'CKT-002', station: 'Andheri', section: 'Western Line',  current_status: 'In Progress', reported_at: Date.now() - 7200_000 },
  { fail_id: 'RF003', circuit: 'CKT-003', station: 'Dadar',   section: 'Central Line',  current_status: 'Resolved',    reported_at: Date.now() - 8600_000, resolved_at: Date.now() - 1800_000 },
  { fail_id: 'RF004', circuit: 'CKT-004', station: 'Virar',   section: 'Western Line',  current_status: 'On Hold',     reported_at: Date.now() - 9300_000 },
]
// Filter out UI-only 'message' entries from the dashboard list
const sourceRows = computed(() => {
  const base = (props.items?.length ? props.items : fallbackRows)
  return base.filter(i => {
    const t = i?.entry_type ?? i?.entryType ?? i?.type ?? i?.kind ?? i?.severity ?? ''
    return String(t).toLowerCase() !== 'message'
  })
})

/* -------- Time helpers (robust: numbers or ISO strings) -------- */
function toMs(ts) {
  if (ts == null) return null
  if (typeof ts === 'number') return ts
  const ms = new Date(ts).getTime()
  return Number.isNaN(ms) ? null : ms
}
function timeAgo(ts) {
  const ms = toMs(ts)
  if (ms == null) return '—'
  const diff = Date.now() - ms
  const m = Math.floor(diff / 60000)
  if (m < 1) return 'just now'
  if (m < 60) return `${m}m ago`
  const h = Math.floor(m / 60)
  if (h < 24) return `${h}h ago`
  const d = Math.floor(h / 24)
  return `${d}d ago`
}
function fmt(ts) {
  const ms = toMs(ts)
  return ms == null ? '—' : new Date(ms).toLocaleString()
}

/* -------- Filter + Sort -------- */
const filteredSorted = computed(() => {
  const base = status.value !== 'all'
    ? sourceRows.value.filter(r => (r.current_status ?? r.status) === status.value)
    : sourceRows.value

  const term = q.value.trim().toLowerCase()
  const filtered = term
    ? base.filter(r => JSON.stringify(r).toLowerCase().includes(term))
    : base

  const key = sortKey.value
  const dir = sortDir.value === 'asc' ? 1 : -1

  const getSortValue = (row, sortKey) => {
    switch (sortKey) {
      case 'reported_at': return toMs(row.reported_at ?? row.reportedAt) ?? 0
      case 'resolved_at': return toMs(row.resolved_at ?? row.resolvedAt) ?? 0
      case 'id': return row.fail_id ?? row.id
      case 'circuit': return row.circuit?.name ?? row.circuit
      case 'station': return row.station?.name ?? row.station
      case 'section': return row.section?.name ?? row.section
      case 'status': return row.current_status ?? row.status
      default: return ''
    }
  }

  return [...filtered].sort((a, b) => {
    const av = getSortValue(a, key)
    const bv = getSortValue(b, key)
    return cmp(av, bv) * dir
  })
})
// ---- Load persisted table UI (safe parse) ----
function loadState() {
  let st = null
  try { st = JSON.parse(localStorage.getItem(props.storageKey) || 'null') } catch (_) {}
  if (!st || typeof st !== 'object') return
  if (typeof st.q === 'string') q.value = st.q
  if (typeof st.status === 'string') status.value = st.status
  if (typeof st.sortKey === 'string') sortKey.value = st.sortKey
  if (st.sortDir === 'asc' || st.sortDir === 'desc') sortDir.value = st.sortDir
  if (typeof st.perPage === 'number' && st.perPage > 0) perPage.value = st.perPage
  if (typeof st.page === 'number' && st.page >= 0) page.value = st.page
}

/* -------- Pagination -------- */
const page = ref(0)
const perPage = ref(10)
const total = computed(() => filteredSorted.value.length)
const pageCount = computed(() => Math.max(1, Math.ceil(total.value / perPage.value)))
const pagedRows = computed(() => {
  const start = page.value * perPage.value
  return filteredSorted.value.slice(start, start + perPage.value)
})

loadState()


// ---- Persist table UI whenever it changes ----
watch([q, status, sortKey, sortDir, perPage, page], ([Q, S, K, D, P, Pg]) => {
  localStorage.setItem(props.storageKey, JSON.stringify({
    q: Q, status: S, sortKey: K, sortDir: D, perPage: Number(P), page: Number(Pg),
  }))
})

watch([total, pageCount], () => { if (page.value > pageCount.value - 1) page.value = Math.max(0, pageCount.value - 1) })
const showingFrom = computed(() => (total.value ? page.value * perPage.value + 1 : 0))
const showingTo = computed(() => Math.min(total.value, (page.value + 1) * perPage.value))
function prevPage() { if (page.value > 0) page.value-- }
function nextPage() { if (page.value < pageCount.value - 1) page.value++ }

/* -------- Row-action helpers -------- */
function onEdit(row)   { emit('edit', row.id) }
function onDelete(row) { emit('delete', row) }

/* -------- UI helpers -------- */
function badgeClasses(s) {
  if (s === 'Active')       return 'badge-danger'
  if (s === 'In Progress')  return 'badge-warning'
  if (s === 'Resolved')     return 'badge-success'
  if (s === 'On Hold')      return 'badge-hold'
  return 'badge-neutral'
}

// For Dashboard: status pill sized to text, text hidden
function statusPillClass(s) {
  if (s === 'Active')       return 'bg-[var(--s-active)]'
  if (s === 'In Progress')  return 'bg-[var(--s-inprogress)]'
  if (s === 'Resolved')     return 'bg-[var(--s-resolved)]'
  if (s === 'On Hold')      return 'bg-[var(--s-onhold)]'
  return 'bg-[var(--platinum)]'
}

// Light row tint based on status color (new global palette)
// Hover handling for rows to intensify background tint slightly
const hoveredIndex = ref(-1)
function rowBg(s, hovered = false) {
  const pct = hovered ? 65 : 50
  return (
    s === 'Active'       ? `color-mix(in srgb, var(--s-active) ${pct}%, white)` :
    s === 'In Progress'  ? `color-mix(in srgb, var(--s-inprogress) ${pct}%, white)` :
    s === 'Resolved'     ? `color-mix(in srgb, var(--s-resolved) ${pct}%, white)` :
    s === 'On Hold'      ? `color-mix(in srgb, var(--s-onhold) ${pct}%, white)` :
    'transparent'
  )
}

</script>

<template>
  <div class="space-y-4">
    <div class="text-center" v-if="showHeader">
      <h2 class="text-2xl font-semibold leading-tight">Recent Failure Logs</h2>
    </div>

    <div class="rounded-2xl border-app bg-card text-app p-4">
      <!-- Toolbar -->
      <div v-if="showToolbar" class="p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between flex-wrap gap-2">
        <div class="chip-group">
          <button
            v-for="tab in statusTabs"
            :key="tab"
            class="chip capitalize"
            :class="status === tab ? statusTabVariant(tab) + ' is-active' : 'text-app hover-primary'"
            :aria-pressed="String(status === tab)"
            @click="status = tab"
          >
            {{ tab }}
          </button>
        </div>

        <input
          v-model="q"
          type="text"
          placeholder="Search..."
          class="h-10 w-full sm:w-64 max-w-full min-w-0 rounded-lg border-app bg-card text-app px-3 text-sm"
        />
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-card">
            <tr>
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none"
                  :aria-sort="sortKey==='id' ? (sortDir==='asc'?'ascending':'descending') : 'none'"                  @click="setSort('id')">
                <div class="inline-flex items-center gap-1">EV ID <span v-if="sortKey==='id'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none"
                  :aria-sort="sortKey==='circuit' ? (sortDir==='asc'?'ascending':'descending') : 'none'"
                  @click="setSort('circuit')">
                <div class="inline-flex items-center gap-1">Circuit <span v-if="sortKey==='circuit'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none"
                  :aria-sort="sortKey==='station' ? (sortDir==='asc'?'ascending':'descending') : 'none'"
                  @click="setSort('station')">
                <div class="inline-flex items-center gap-1">Station <span v-if="sortKey==='station'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none"
                  :aria-sort="sortKey==='section' ? (sortDir==='asc'?'ascending':'descending') : 'none'"
                  @click="setSort('section')">
                <div class="inline-flex items-center gap-1">Section <span v-if="sortKey==='section'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>

              <!-- NEW: Reported (sortable) -->
              <th class="text-center font-semibold text-app px-3 py-1.5 cursor-pointer select-none"
                  :aria-sort="sortKey==='reported_at' ? (sortDir==='asc'?'ascending':'descending') : 'none'"
                  @click="setSort('reported_at')">
                <div class="inline-flex items-center gap-1">Reported <span v-if="sortKey==='reported_at'">{{ sortDir==='asc' ? '▲' : '▼' }}</span></div>
              </th>

              <th v-if="showRowActions" class="text-center font-semibold text-app px-3 py-1.5">Actions</th>
            </tr>
          </thead>

          <tbody>
            <!-- Rows -->
             <!-- SKELETON ROWS (show while loading) -->
          <tr v-if="!loading && filteredSorted.length === 0">
            <td class="px-4 py-3"><div class="h-4 rounded bg-[var(--border)]/40 animate-pulse mx-auto w-20" /></td>
            <td class="px-4 py-3"><div class="h-4 rounded bg-[var(--border)]/40 animate-pulse mx-auto w-24" /></td>
            <td class="px-4 py-3"><div class="h-4 rounded bg-[var(--border)]/40 animate-pulse mx-auto w-24" /></td>
            <td class="px-4 py-3"><div class="h-4 rounded bg-[var(--border)]/40 animate-pulse mx-auto w-28" /></td>
            <td class="px-4 py-3"><div class="h-4 rounded bg-[var(--border)]/40 animate-pulse mx-auto w-20" /></td>
            <td v-if="showRowActions" class="px-4 py-3"> 
              <div class="h-4 rounded bg-[var(--border)]/40 animate-pulse mx-auto w-24" />
            </td>
            <td :colspan="showRowActions ? 6 : 5" class="px-4 py-6 text-center text-muted"></td>
          </tr>

            <tr
              v-if="!loading" v-for="(r, i) in pagedRows"
              :key="r.id ?? i"
              class="cursor-pointer"
              role="button"
              tabindex="0"
              @click="emit('view', r)"
              @keydown.enter.space="emit('view', r)"
              @mouseenter="hoveredIndex = i"
              @mouseleave="hoveredIndex = -1"
              :style="{ backgroundColor: rowBg(r.current_status ?? r.status, hoveredIndex === i) }"
            >
              <td class="px-3 py-1.5 text-center rounded-l-xl"><div class="truncate">{{ (r.fail_id ?? r.id)?.split('-').pop() ?? '—' }}</div></td>
              <td class="px-3 py-1.5 text-center"><div class="truncate">{{ r.circuit?.circuit_id ?? r.circuit ?? '—' }}</div></td>
              <td class="px-3 py-1.5 text-center"><div class="truncate">{{ r.station?.code ?? r.station ?? '—' }}</div></td>
              <td class="px-3 py-1.5 text-center"><div class="truncate">{{ r.section?.name ?? r.section ?? '—' }}</div></td>

              <!-- NEW: Reported cell (relative text + PrimeVue tooltip + native title) -->
              <td class="px-3 py-1.5 text-center">
                <span
                
                  :title="fmt(r.reported_at ?? r.reportedAt)"
                >
                  {{ timeAgo(r.reported_at ?? r.reportedAt) }}
                </span>
              </td>

              <!-- PrimeVue black action buttons -->
             <td v-if="showRowActions" class="px-3 py-1.5 text-center rounded-r-xl">
              <div class="inline-flex items-center justify-center gap-2">
                <button
                  class="btn-ghost border-app rounded-md hover-primary p-2"
                  aria-label="Notify" title="Notify" @click.stop="openNotifyModal(r)" disabled>
                  <Bell class="w-4 h-4" />
                </button>
                <button
                  class="btn-ghost border-app rounded-md hover-primary p-2"
                  aria-label="Edit" title="Edit" @click.stop="$emit('edit', r.id)">
                  <Pencil class="w-4 h-4" />
                </button>
                <button
                  class="btn-ghost border-app rounded-md hover-primary p-2"
                  aria-label="Delete" title="Delete" @click.stop="onDelete(r)">
                  <Trash2 class="w-4 h-4" />
                </button>
              </div>
            </td>
            <td v-else class="px-3 py-1.5 text-center rounded-r-xl"></td>
            </tr>

            <!-- Empty state -->
            <tr v-if="!loading && filteredSorted.length === 0" class="rounded-xl overflow-hidden">
              <td :colspan="showRowActions ? 6 : 5" class="px-4 py-6 text-center text-muted">
                No recent failures
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Pager -->
        <div class="mt-3 flex flex-col sm:flex-row sm:items-center gap-3 justify-between">
          <div class="text-xs text-muted">
            Showing {{ showingFrom }}–{{ showingTo }} of {{ total }}
          </div>

          <div class="inline-flex items-center gap-2">
            <label class="text-sm text-app">Rows per page</label>
            <select v-model.number="perPage" class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm">
              <option :value="10">10</option>
              <option :value="20">20</option>
              <option :value="50">50</option>
            </select>

            <div class="ml-2 inline-flex items-center gap-2">
              <button
                class="btn-ghost border-app rounded-md hover-primary p-2 disabled:opacity-40"
                :disabled="page === 0"
                aria-label="Previous page" title="Previous" @click="prevPage">
                <ChevronLeft class="w-4 h-4" />
              </button>

              <span class="text-sm tabular-nums">{{ page + 1 }} / {{ pageCount }}</span>

              <button
                class="btn-ghost border-app rounded-md hover-primary p-2 disabled:opacity-40"
                :disabled="page >= pageCount - 1"
                aria-label="Next page" title="Next" @click="nextPage">
                <ChevronRight class="w-4 h-4" />
              </button>

            </div>
          </div>
        </div>
      </div>

      <!-- Bottom actions (Dashboard hides via prop) -->
      <div v-if="showBottomActions" class="flex justify-center gap-3 px-3 py-5">
        <button
          class="btn-ghost border-app rounded-md hover-primary p-2"
          aria-label="Retrieve Drafts"
          title="Retrieve Drafts"
        >
          <History class="w-4 h-4" />
        </button>
        <button
          class="btn-ghost border-app rounded-md hover-primary p-2"
          aria-label="Export CSV"
          title="Export CSV"
        >
          <FileSpreadsheet class="w-4 h-4" />
        </button>
        <button
          class="btn-ghost border-app rounded-md hover-primary p-2"
          aria-label="Export PDF"
          title="Export PDF"
        >
          <FileText class="w-4 h-4" />
        </button>
      </div>
    </div>
    <NotificationModal v-model="isNotifyModalOpen" :failure="failureToNotify" />
  </div>
</template>
  

<script setup>
const props = defineProps({
  sections: { type: Array, default: () => [] },   // ['Section A', 'Section B', ...]
  modelValue: { type: Array, default: () => [] }, // selected sections
})
const emit = defineEmits(['update:modelValue'])

function setAll() {
  emit('update:modelValue', [...props.sections])
}
function clearAll() {
  emit('update:modelValue', [])
}
function toggle(s) {
  const set = new Set(props.modelValue || [])
  set.has(s) ? set.delete(s) : set.add(s)
  emit('update:modelValue', Array.from(set))
}
function isSelected(s) {
  return (props.modelValue || []).includes(s)
}
</script>

<template>
  <div class="chip-group flex-wrap items-center gap-2">
    <span class="text-sm text-muted mr-1">Sections:</span>

    <button
      class="chip text-xs"
      :class="(modelValue?.length || 0) === sections.length && sections.length
        ? 'selected-primary' : 'text-app hover-primary'"
      @click="setAll"
      title="Select all sections"
    >All</button>

    <button
      class="chip text-xs"
      :class="(modelValue?.length || 0) === 0
        ? 'selected-primary' : 'text-app hover-primary'"
      @click="clearAll"
      title="Clear all sections"
    >None</button>

    <button
      v-for="s in sections" :key="s"
      class="chip text-xs transition"
      :class="isSelected(s)
        ? 'selected-primary'
        : 'text-app hover-primary'"
      @click="toggle(s)"
    >{{ s }}</button>
  </div>
</template>


<script setup>
import { ref, computed, onMounted, onBeforeUnmount } from 'vue'

const props = defineProps({
  sections: { type: Array, default: () => [] },     // ['Section A', 'Section B', ...]
  modelValue: { type: Array, default: () => [] },   // selected sections
  maxInline: { type: Number, default: 6 },          // how many selected chips to preview on the button
  placeholder: { type: String, default: 'Filter sections...' },
})
const emit = defineEmits(['update:modelValue'])

const open = ref(false)
const query = ref('')
const host = ref(null)

const selected = computed(() => new Set(props.modelValue || []))
const filteredSections = computed(() => {
  const q = query.value.trim().toLowerCase()
  if (!q) return props.sections
  return props.sections.filter(s => String(s).toLowerCase().includes(q))
})
function toggle(s) {
  const next = new Set(selected.value)
  next.has(s) ? next.delete(s) : next.add(s)
  emit('update:modelValue', Array.from(next))
}
function setAll() { emit('update:modelValue', [...props.sections]) }
function clearAll() { emit('update:modelValue', []) }

const selectedList = computed(() => props.sections.filter(s => selected.value.has(s)))
const inlineChips = computed(() => selectedList.value.slice(0, props.maxInline))
const hiddenCount = computed(() => Math.max(0, selectedList.value.length - props.maxInline))

function onDocClick(e) {
  if (!open.value) return
  if (host.value && !host.value.contains(e.target)) open.value = false
}
onMounted(() => document.addEventListener('mousedown', onDocClick))
onBeforeUnmount(() => document.removeEventListener('mousedown', onDocClick))
</script>

<template>
  <div ref="host" class="relative">
    <!-- Trigger button -->
    <button
      type="button"
      class="w-full sm:w-auto inline-flex items-center gap-2 rounded-lg border-app bg-card text-app px-3 py-2 text-sm shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition"
      @click="open = !open"
      :title="selectedList.length ? selectedList.join(', ') : 'All sections selected'"
    >
      <svg viewBox="0 0 24 24" class="w-4 h-4"><path fill="currentColor" d="M3 5h18v2H3zm0 6h12v2H3zm0 6h8v2H3z"/></svg>
      <span class="font-medium">Sections</span>

        <!-- selection preview -->
        <span v-if="selectedList.length === 0 || selectedList.length === props.sections.length" class="text-muted">
          • All
        </span>
        <span v-else class="flex flex-wrap gap-1">

        <span
          v-for="s in inlineChips"
          :key="s"
          class="px-2 py-0.5 rounded-full text-xs border-app bg-card"
        >{{ s }}</span>
        <span v-if="hiddenCount" class="text-muted text-xs">+{{ hiddenCount }}</span>
      </span>

      <svg viewBox="0 0 24 24" class="w-4 h-4 ml-1"><path fill="currentColor" d="M7 10l5 5 5-5z"/></svg>
    </button>

    <!-- Popover -->
    <div
      v-show="open"
      class="absolute z-50 mt-2 w-[min(90vw,28rem)] rounded-xl border-app bg-card text-app shadow-lg"
    >
      <!-- search + actions -->
      <div class="p-3 border-b border-app flex items-center gap-2">
        <svg viewBox="0 0 24 24" class="w-4 h-4 text-muted"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 5l1.5-1.5l-5-5ZM9.5 14A4.5 4.5 0 1 1 14 9.5A4.5 4.5 0 0 1 9.5 14Z"/></svg>
        <input
          v-model="query"
          :placeholder="placeholder"
          class="flex-1 rounded-lg border-app bg-card text-app px-3 py-1.5 text-sm"
        />
        <button class="text-xs px-2 py-1 rounded-lg border-app bg-card shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition" @click="setAll">All</button>
        <button class="text-xs px-2 py-1 rounded-lg border-app bg-card shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition" @click="clearAll">None</button>
      </div>

      <!-- list -->
      <div class="max-h-72 overflow-auto p-2">
        <template v-if="filteredSections.length">
          <label
            v-for="s in filteredSections"
            :key="s"
            class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-card cursor-pointer"
          >
            <input type="checkbox" class="h-4 w-4" :checked="selected.has(s)" @change="toggle(s)" />
            <span class="text-sm">{{ s }}</span>
          </label>
        </template>
        <div v-else class="p-6 text-center text-sm text-muted">No matches</div>
      </div>

      <!-- footer -->
      <div class="p-2 border-t border-app flex items-center justify-end gap-2">
        <span class="text-xs text-muted mr-auto">
          {{ selectedList.length }} / {{ sections.length }} selected
        </span>
        <button class="text-sm px-2 py-1 rounded-lg border-app bg-card hover:bg-card" @click="open=false">Close</button>
      </div>
    </div>
  </div>
</template>


<script setup>
import { ref, onBeforeUnmount } from 'vue'

const props = defineProps({
  modelValue: { type: Number, default: 66 },   // left pane width in %
  minLeft:    { type: Number, default: 35 },
  maxLeft:    { type: Number, default: 80 },
})
const emit = defineEmits(['update:modelValue'])

const container = ref(null)
let dragging = false

function onPointerDown(e) {
  dragging = true
  window.addEventListener('pointermove', onPointerMove)
  window.addEventListener('pointerup', onPointerUp)
  e.preventDefault()
}
function onPointerMove(e) {
  if (!dragging || !container.value) return
  const rect = container.value.getBoundingClientRect()
  let pct = ((e.clientX - rect.left) / rect.width) * 100
  pct = Math.max(props.minLeft, Math.min(props.maxLeft, pct))
  emit('update:modelValue', Math.round(pct))
}
function onPointerUp() {
  dragging = false
  window.removeEventListener('pointermove', onPointerMove)
  window.removeEventListener('pointerup', onPointerUp)
}
onBeforeUnmount(() => onPointerUp())
</script>

<template>
  <!-- Stacks on small screens; draggable on lg+ -->
  <div ref="container" class="w-full">
    <div class="grid grid-cols-1 gap-4 lg:block">
      <div class="lg:flex">
        <!-- Left -->
        <div class="lg:shrink-0 lg:grow-0 lg:pr-3" :style="{ width: modelValue + '%' }">
          <slot name="left" />
        </div>

        <!-- Divider / handle -->
        <div
          class="hidden lg:block w-2 lg:shrink-0 lg:grow-0 cursor-col-resize"
          @pointerdown="onPointerDown"
          title="Drag to resize"
        >
          <div class="h-full mx-auto w-0.5 bg-[var(--border)] rounded hover:bg-[var(--text)]/30"></div>
        </div>

        <!-- Right -->
        <div class="lg:pl-3 lg:min-w-[280px]" :style="{ width: (100 - modelValue) + '%' }">
          <slot name="right" />
        </div>
      </div>
    </div>
  </div>
</template>


<script setup>
defineProps({
  item: { type: Object, required: true }, // { fail_id, status, severity, circuit, reported_at, assigned_to }
})

function statusBadge(s) {
  if (s === 'Resolved')     return 'badge-success'
  if (s === 'Active')       return 'badge-danger'
  if (s === 'In Progress')  return 'badge-warning'
  if (s === 'On Hold')      return 'badge-hold'
  return 'badge-neutral'
}
</script>

<template>
  <div class="relative pl-8">
    <!-- line -->
    <div class="absolute left-3 top-0 bottom-0 w-px bg-[var(--border)]"></div>
    <!-- dot -->
    <div class="absolute left-2 top-2 h-3 w-3 rounded-full"
         :class="{
           'bg-[var(--danger)]': item.severity === 'Critical',
           'bg-[var(--warning)]': item.severity === 'High',
           'bg-[var(--neutral)]': item.severity === 'Low'
         }"></div>

    <div class="rounded-xl border-app bg-card text-app p-3">
      <div class="flex items-center justify-between">
        <div class="text-sm font-semibold">{{ item.fail_id }}</div>
        <span class="badge"
              :class="statusBadge(item.status)">
          {{ item.status }}
        </span>
      </div>
      <div class="mt-1 text-xs text-muted">
        <span class="mr-3"><span class="font-medium text-app">Severity:</span> {{ item.severity }}</span>
        <span class="mr-3"><span class="font-medium text-app">Circuit:</span> {{ item.circuit }}</span>
      </div>
      <div class="mt-1 text-xs text-muted">
        <span class="mr-3"><span class="font-medium text-app">Reported:</span> {{ item.reported_at }}</span>
        <span class="mr-3"><span class="font-medium text-app">Assigned:</span> {{ item.assigned_to }}</span>
      </div>
    </div>
  </div>
</template>


<script setup>
import { computed } from 'vue'

const props = defineProps({
  // Make title optional so callers can omit it when header is hidden
  title: { type: String, default: '' },

  // v-models
  chartType: { type: String, default: 'bar' },              // 'bar' | 'line' | 'pie' | 'doughnut' | 'table'
  range:     { type: String, default: 'today' },            // 'today' | '7d' | '30d' | 'custom'

  // optional: show the small “…” action icons later
  dense: { type: Boolean, default: false },
  // allow hiding the entire header area (title + selector + chips)
  hideHeader: { type: Boolean, default: false },
})

const emit = defineEmits(['update:chartType', 'update:range', 'refresh'])

const ranges = [
  { key: 'today', label: 'Today' },
  { key: '7d',    label: 'Last 7 days' },
  { key: '30d',   label: 'Last 30 days' },
  { key: 'custom',label: 'Custom' },
]

const rangeLabel = computed(() => ranges.find(r => r.key === props.range)?.label ?? '')
function setRange(key){ emit('update:range', key) }
function setType(e){ emit('update:chartType', e.target.value) }
</script>

<template>
  <div class="rounded-2xl border bg-white p-3 md:p-4">
    <!-- Header -->
    <div v-if="!hideHeader" class="mb-3 flex items-center gap-2">
      <h3 class="text-lg md:text-xl font-semibold flex-1 leading-tight">{{ title }}</h3>

      <!-- Chart type selector -->
      <select
        :value="chartType"
        @change="setType"
        class="rounded-lg border px-2 py-1 text-sm bg-white"
        title="Chart type"
      >
        <option value="bar">Bar</option>
        <option value="line">Line</option>
        <option value="pie">Pie</option>
        <option value="doughnut">Doughnut</option>
        <option value="table">Table</option>
      </select>

      <!-- (optional action icons we can wire later)
      <button class="p-2 rounded-lg hover:bg-gray-100" title="Refresh" @click="$emit('refresh')">
        <i class="pi pi-refresh text-sm"></i>
      </button>
      -->
    </div>

    <!-- Time filters (chips) -->
    <div v-if="!hideHeader" class="mb-3 chip-group">
      <button
        v-for="r in ranges"
        :key="r.key"
        class="chip"
        :class="range === r.key ? 'selected-primary' : 'text-app hover-primary'"
        :aria-pressed="String(range === r.key)"
        @click="setRange(r.key)"
      >
        {{ r.label }}
      </button>
    </div>

    <!-- Body slot: give range & chartType to child -->
    <div class="min-h-[220px]">
      <slot :range="range" :chart-type="chartType" :rangeLabel="rangeLabel"></slot>
    </div>
  </div>
</template>


<script setup>
import { computed } from 'vue'
import BarChart from '@/components/BarChart.vue'
import { severityHex, severityBg, SEVERITY_ORDER } from '@/lib/severityColors'

const props = defineProps({
  range: { type: String, default: 'today' },
  records: { type: Array, default: () => [] },
  severity: { type: String, default: 'all' }, // 'all' | 'minor' | 'major' | 'critical'
})

// Normalize severity to title case used in palette
function normSeverity(s) {
  const m = String(s || '').toLowerCase()
  if (m === 'critical') return 'Critical'
  if (m === 'major') return 'Major'
  if (m === 'minor') return 'Minor'
  return 'Minor'
}

function recSeverity(rec) {
  // Map record.severity into Minor/Major/Critical; adapt here if model differs
  const raw = rec?.severity || rec?.Severity || rec?.sev || ''
  const n = String(raw).toLowerCase()
  if (n === 'critical') return 'Critical'
  if (n === 'major') return 'Major'
  if (n === 'minor') return 'Minor'
  // fallback mapping for datasets that only have 'Normal'
  if (n === 'normal') return 'Minor'
  return 'Minor'
}

function recTimeMs(rec) {
  const t = rec?.occurred_at || rec?.reportedAt || rec?.reported_at || rec?.ts
  const ms = typeof t === 'number' ? t : new Date(t).getTime()
  return Number.isFinite(ms) ? ms : 0
}

// Buckets for x-axis based on range
function buildBuckets(range) {
  const now = new Date()
  const labels = []
  const keys = []
  if (range === 'today') {
    // single-day bucket
    const key = now.toISOString().slice(0,10)
    labels.push('Today')
    keys.push(key)
  } else if (range === 'week') {
    for (let i=6;i>=0;i--) {
      const d = new Date(now)
      d.setDate(now.getDate() - i)
      labels.push(d.toLocaleDateString())
      keys.push(d.toISOString().slice(0,10))
    }
  } else if (range === 'month') {
    for (let i=29;i>=0;i--) {
      const d = new Date(now)
      d.setDate(now.getDate() - i)
      labels.push(d.toLocaleDateString())
      keys.push(d.toISOString().slice(0,10))
    }
  } else if (range === 'year') {
    for (let m=0;m<12;m++) {
      const d = new Date(now.getFullYear(), m, 1)
      labels.push(d.toLocaleString(undefined, { month: 'short' }))
      keys.push(`${d.getFullYear()}-${String(m+1).padStart(2,'0')}`)
    }
  } else {
    // default to last 7 days
    for (let i=6;i>=0;i--) {
      const d = new Date(now)
      d.setDate(now.getDate() - i)
      labels.push(d.toLocaleDateString())
      keys.push(d.toISOString().slice(0,10))
    }
  }
  return { labels, keys }
}

const includedSeverities = computed(() => {
  const s = String(props.severity || 'all').toLowerCase()
  return s === 'all' ? [...SEVERITY_ORDER] : [normSeverity(s)]
})

const chartData = computed(() => {
  const { labels, keys } = buildBuckets(props.range)
  // Aggregate counts per key per severity
  const buckets = new Map(keys.map(k => [k, { Critical: 0, Major: 0, Minor: 0 }]))
  for (const rec of props.records || []) {
    const ms = recTimeMs(rec)
    if (!ms) continue
    const d = new Date(ms)
    const dayKey = d.toISOString().slice(0,10)
    const monthKey = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`
    const key = keys.length === 1 ? dayKey : (keys.length === 12 ? monthKey : dayKey)
    if (!buckets.has(key)) continue
    const sev = recSeverity(rec)
    const row = buckets.get(key)
    row[sev] = (row[sev] || 0) + 1
  }

  const datasets = includedSeverities.value.map(sev => ({
    label: sev,
    data: keys.map(k => buckets.get(k)?.[sev] ?? 0),
    backgroundColor: severityBg(sev, 0.85),
    borderColor: severityHex(sev),
    borderWidth: 1,
    borderRadius: 6,
  }))

  return { labels, datasets }
})
</script>

<template>
  <div class="h-full w-full">
    <BarChart :data="chartData" :options="{ responsive: true, maintainAspectRatio: false, plugins: { colors: false } }" />
  </div>
</template>



<script setup>
defineProps({
  label: String,
  modelValue: String,   // ISO-ish: "2025-08-19T08:30"
  error: String,
})
defineEmits(['update:modelValue'])
</script>

<template>
  <label class="block space-y-1">
    <span class="text-sm text-app">{{ label }}</span>
    <input
      type="datetime-local"
      class="field"
      :value="modelValue"
      @input="$emit('update:modelValue', $event.target.value)"
    />
    <p v-if="error" class="text-xs text-red-600">{{ error }}</p>
  </label>
</template>


<script setup>
defineProps({
  label: String,
  modelValue: [String, Number],
  placeholder: String,
  error: String,
  type: { type: String, default: 'text' },
})
defineEmits(['update:modelValue'])
</script>

<template>
  <label class="block space-y-1">
    <span class="text-sm text-app">{{ label }}</span>
    <input
      :type="type"
      class="h-10 w-full rounded-lg border-app bg-card text-app px-3 text-sm"
      :placeholder="placeholder"
      :value="modelValue"
      @input="$emit('update:modelValue', $event.target.value)"
    />
    <p v-if="error" class="text-xs text-red-600">{{ error }}</p>
  </label>
</template>


<script setup>
import { ref, watch, computed, onMounted, onBeforeUnmount } from 'vue'

const props = defineProps({
  modelValue: [String, Number, Object, null],
  options: { type: Array, default: () => [] },
  placeholder: { type: String, default: 'Select…' },
  disabled: { type: Boolean, default: false },
  clearable: { type: Boolean, default: true },
  labelKey: { type: String, default: 'label' },
  valueKey: { type: String, default: 'value' },
})
const emit = defineEmits(['update:modelValue'])

const open = ref(false)
const query = ref('')
const hoverIndex = ref(-1)
const rootEl = ref(null)
const inputEl = ref(null)
const controlButton = ref(null)

// --- FLAG TO PREVENT IMMEDIATE REOPENING ---
let justClosed = false;

const selectedLabel = computed(() => {
  const val = props.modelValue
  if (val == null || val === '') return ''
  const found = props.options.find(o => (o[props.valueKey] === val) || (o === val))
  return found ? (found[props.labelKey] ?? String(found)) : String(val)
})

const filtered = computed(() => {
  const q = query.value.trim().toLowerCase()
  if (!q) return props.options
  return props.options.filter(o => String(o[props.labelKey] ?? o).toLowerCase().includes(q))
})

function toggleMenu() {
    if (justClosed) {
        return;
    }
    if (open.value) {
        closeMenu();
    } else {
        openMenu();
    }
}

function openMenu() {
  if (props.disabled) return
  open.value = true
  hoverIndex.value = -1
  requestAnimationFrame(() => inputEl.value?.focus())
}

function closeMenu() {
  open.value = false
}

function selectOption(opt) {
  const val = opt?.[props.valueKey] ?? opt
  emit('update:modelValue', val)
  closeMenu()
  controlButton.value?.blur()

  // --- SET FLAG AND CLEAR IT AFTER A SHORT DELAY ---
  justClosed = true;
  setTimeout(() => {
    justClosed = false;
  }, 150); // 150ms cooldown period
}

function clearSelection(e) {
  e?.stopPropagation()
  if (!props.clearable) return
  emit('update:modelValue', null)
  query.value = ''
  openMenu()
}

function onKeydown(e) {
  if (!open.value && (e.key === 'Enter' || e.key === 'ArrowDown' || e.key === ' ')) {
    e.preventDefault(); openMenu(); return
  }
  if (!open.value) return
  const max = filtered.value.length - 1
  if (e.key === 'ArrowDown') { e.preventDefault(); hoverIndex.value = Math.min(max, hoverIndex.value + 1) }
  else if (e.key === 'ArrowUp') { e.preventDefault(); hoverIndex.value = Math.max(0, hoverIndex.value - 1) }
  else if (e.key === 'Enter') { e.preventDefault(); if (filtered.value[hoverIndex.value]) selectOption(filtered.value[hoverIndex.value]) }
  else if (e.key === 'Escape') { e.preventDefault(); closeMenu() }
}

function onClickOutside(e) {
  if (!rootEl.value) return
  if (!rootEl.value.contains(e.target)) closeMenu()
}

onMounted(() => document.addEventListener('mousedown', onClickOutside))
onBeforeUnmount(() => document.removeEventListener('mousedown', onClickOutside))

watch(() => props.modelValue, (v) => {
  if (!open.value) query.value = ''
})
</script>

<template>
  <div ref="rootEl" class="relative">
    <button
      ref="controlButton" type="button"
      class="field-shell h-11 w-full text-left px-3 text-sm flex items-center justify-between gap-2"
      :class="disabled ? 'opacity-60 cursor-not-allowed' : ''"
      :aria-expanded="open"
      @click="toggleMenu"
      @keydown="onKeydown"
    >
      <span class="truncate" v-if="!open">
        <span v-if="selectedLabel" class="text-app">{{ selectedLabel }}</span>
        <span v-else class="text-muted">{{ placeholder }}</span>
      </span>
      <input
        v-else
        ref="inputEl"
        v-model="query"
        type="text"
        class="w-full outline-none bg-transparent text-app h-11"
        :placeholder="placeholder"
        @keydown.stop="onKeydown"
      />
      <span class="flex items-center gap-2 shrink-0">
        <button
          v-if="clearable && modelValue != null && modelValue !== ''"
          class="text-muted hover:text-app"
          title="Clear"
          @click.stop="clearSelection"
        >✕</button>
        <span class="text-muted">▾</span>
      </span>
    </button>
    <div
      v-if="open"
      class="absolute z-50 mt-1 w-full rounded-lg border bg-card text-app border-app shadow-lg max-h-60 overflow-auto"
      role="listbox"
    >
      <div
        v-for="(opt, i) in filtered"
        :key="opt[valueKey] ?? String(opt)"
        class="px-3 py-2 text-sm cursor-pointer flex items-center justify-between hover-primary"
        :class="[
          i === hoverIndex ? 'bg-primary-tint' : '',
          (opt[valueKey] ?? opt) === modelValue ? 'selected-primary' : ''
        ]"
        @mouseenter="hoverIndex = i"
        @mouseleave="hoverIndex = -1"
        @click.stop="selectOption(opt)"
      >
        <span class="truncate">{{ opt[labelKey] ?? String(opt) }}</span>
        <span v-if="(opt[valueKey] ?? opt) === modelValue" class="text-xs text-muted">✓</span>
      </div>
      <div v-if="filtered.length === 0" class="px-3 py-2 text-sm text-muted">No results</div>
    </div>
  </div>
</template>

<script setup>
defineProps({
  label: String,
  modelValue: [String, Number],
  options: { type: Array, default: () => [] }, // [{label, value}]
  error: String,
})
defineEmits(['update:modelValue'])
</script>

<template>
  <label class="block space-y-1">
    <span class="text-sm text-app">{{ label }}</span>
    <select
      class="field"
      :value="modelValue"
      @change="$emit('update:modelValue', $event.target.value)"
    >
      <option value="" disabled>Select…</option>
      <option v-for="o in options" :key="o.value" :value="o.value">{{ o.label }}</option>
    </select>
    <p v-if="error" class="text-xs text-red-600">{{ error }}</p>
  </label>
</template>


<script setup>
import { ref, watch } from 'vue'

const props = defineProps({
  modelValue: { type: Array, default: () => [] },   // user-added tags
  preset:     { type: Array, default: () => [] },   // auto tags (non-removable)
  placeholder:{ type: String, default: 'Add tag and press Enter' },
})
const emit = defineEmits(['update:modelValue'])

const input = ref('')
const local = ref([...props.modelValue])

watch(() => props.modelValue, v => { local.value = [...v] })

function normalize(t) {
  if (!t) return ''
  let v = String(t).trim()
  if (!v) return ''
  if (!v.startsWith('#')) v = '#' + v
  return v.replace(/\s+/g, '')                      // no spaces inside tags
}

function addFromInput() {
  const v = normalize(input.value)
  if (!v) return
  if (![...props.preset, ...local.value].includes(v)) {
    local.value.push(v)
    emit('update:modelValue', local.value)
  }
  input.value = ''
}

function removeTag(ix) {
  local.value.splice(ix, 1)
  emit('update:modelValue', local.value)
}

function onKeydown(e) {
  if (e.key === 'Enter' || e.key === ',' || e.key === 'Tab') {
    e.preventDefault(); addFromInput()
  } else if (e.key === 'Backspace' && !input.value && local.value.length) {
    // backspace to remove last
    local.value.pop(); emit('update:modelValue', local.value)
  }
}
</script>

<template>
  <div class="field-shell min-h-10 w-full px-2 py-1.5">
    <div class="flex flex-wrap items-center gap-1">
      <!-- preset (auto) tags – non-removable -->
      <span v-for="t in preset" :key="'p'+t"
            class="inline-flex items-center gap-1 rounded-full bg-[var(--border)]/30 text-app text-xs px-2 py-1">
        {{ t }}
      </span>

      <!-- user tags – removable -->
      <span v-for="(t, i) in local" :key="'u'+t"
            class="inline-flex items-center gap-1 rounded-full bg-[var(--secondary)] text-[var(--secondary-foreground)] text-xs px-2 py-1">
        {{ t }}
        <button class="ml-1 text-[var(--secondary-foreground)]/80 hover:text-[var(--secondary-foreground)]" @click="removeTag(i)" aria-label="Remove">✕</button>
      </span>

      <!-- input -->
      <input
        v-model="input"
        :placeholder="preset.length || local.length ? '' : placeholder"
        class="input-reset flex-1 min-w-[10ch] text-sm px-1 h-9"
        @keydown="onKeydown"
        @blur="addFromInput"
      />
    </div>
  </div>
</template>


<script setup>
defineProps({ size: { type: Number, default: 20 } })
</script>

<template>
  <svg class="animate-spin" :width="size" :height="size" viewBox="0 0 24 24" fill="none">
    <circle cx="12" cy="12" r="10" stroke="currentColor" class="opacity-20" stroke-width="4"/>
    <path d="M22 12a10 10 0 0 0-10-10" stroke="currentColor" stroke-width="4" stroke-linecap="round"/>
  </svg>
</template>


<script setup>
import { useUIStore } from '@/stores/ui'
const ui = useUIStore()

const typeStyles = (t) => ({
  info:    'bg-blue-600',
  success: 'bg-green-600',
  error:   'bg-red-600',
  warn:    'bg-amber-600',
}[t] || 'bg-gray-700')
</script>

<template>
  <div class="fixed inset-0 pointer-events-none z-[100]">
    <div class="absolute right-4 top-4 flex flex-col gap-2">
      <div v-for="t in ui.toasts" :key="t.id"
           class="pointer-events-auto w-80 rounded-xl shadow-lg text-white overflow-hidden"
           :class="typeStyles(t.type)">
        <div class="px-3 py-2 flex items-start justify-between gap-2">
          <div>
            <div class="text-sm font-semibold" v-if="t.title">{{ t.title }}</div>
            <div class="text-sm opacity-90" v-if="t.message">{{ t.message }}</div>
          </div>
          <button class="text-white/90 hover:text-white text-sm" @click="ui.removeToast(t.id)">✕</button>
        </div>
      </div>
    </div>
  </div>
</template>


// Generic debounce utility for Vue apps
// - Works with plain functions or Vue refs to functions
// - Delay can be a number or a Vue ref
// - Returns a wrapped function that carries a .cancel() method

import { isRef } from 'vue'

function toVal(v) {
  return isRef(v) ? v.value : v
}

export function useDebounce(fnOrRef, delayOrRef = 300) {
  let timer = null

  function getFn() {
    const fn = toVal(fnOrRef)
    if (typeof fn !== 'function') {
      throw new TypeError('useDebounce: expected a function or a ref to a function')
    }
    return fn
  }

  function getDelay() {
    const d = Number(toVal(delayOrRef))
    return Number.isFinite(d) ? d : 300
  }

  const debounced = function (...args) {
    if (timer) clearTimeout(timer)
    const ms = getDelay()
    return new Promise(resolve => {
      timer = setTimeout(() => {
        timer = null
        resolve(getFn().apply(this, args))
      }, ms)
    })
  }

  debounced.cancel = () => {
    if (timer) {
      clearTimeout(timer)
      timer = null
    }
  }

  return debounced
}



// src/data/mockFailures.js
const now = new Date()
const ms = (h) => h * 3600 * 1000
const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime()

export const failures = [
  // Today
  { id: 'RF001', section: 'Section A', status: 'Active',      severity: 'Critical', reportedAt: now.getTime() - ms(2) },
  { id: 'RF002', section: 'Section B', status: 'In Progress', severity: 'Major',    reportedAt: now.getTime() - ms(5) },
  { id: 'RF003', section: 'Section C', status: 'Resolved',    severity: 'Minor',    reportedAt: startOfToday - ms(6), resolvedAt: startOfToday + ms(2) },
  { id: 'RF004', section: 'Section D', status: 'Resolved',    severity: 'Major',    reportedAt: startOfToday - ms(12), resolvedAt: startOfToday + ms(6) },

  // Last 7 days
  { id: 'RF005', section: 'Section A', status: 'Active',      severity: 'Minor',    reportedAt: startOfToday - ms(24) * 2 },
  { id: 'RF006', section: 'Section B', status: 'On Hold',     severity: 'Major',    reportedAt: startOfToday - ms(24) * 3 },
  { id: 'RF007', section: 'Section C', status: 'Resolved',    severity: 'Critical', reportedAt: startOfToday - ms(24) * 4, resolvedAt: startOfToday - ms(24) * 3.5 },
  { id: 'RF008', section: 'Section D', status: 'Resolved',    severity: 'Minor',    reportedAt: startOfToday - ms(24) * 5, resolvedAt: startOfToday - ms(24) * 4.8 },

  // Last 30 days
  { id: 'RF009',  section: 'Section A', status: 'Resolved',    severity: 'Minor',    reportedAt: startOfToday - ms(24) * 10, resolvedAt: startOfToday - ms(24) * 9.7 },
  { id: 'RF010',  section: 'Section B', status: 'Resolved',    severity: 'Major',    reportedAt: startOfToday - ms(24) * 15, resolvedAt: startOfToday - ms(24) * 14.5 },
  { id: 'RF011',  section: 'Section C', status: 'Active',      severity: 'Major',    reportedAt: startOfToday - ms(24) * 18 },
  { id: 'RF012',  section: 'Section D', status: 'In Progress', severity: 'Minor',    reportedAt: startOfToday - ms(24) * 20 },
  { id: 'RF013',  section: 'Section B', status: 'Resolved',    severity: 'Critical', reportedAt: startOfToday - ms(24) * 22, resolvedAt: startOfToday - ms(24) * 21.4 },
  { id: 'RF014',  section: 'Section C', status: 'On Hold',     severity: 'Major',    reportedAt: startOfToday - ms(24) * 25 },
]


// frontend/src/lib/chartTheme.js
import { Chart, Filler } from 'chart.js'
import { currentThemeColors, withAlpha } from './theme'

export function applyChartTheme() {
  // Register missing plugins
  Chart.register(Filler)

  const c = currentThemeColors()

  // Base text color for labels/ticks
  Chart.defaults.color = c.text

  // Grid + ticks defaults
  const gridColor = withAlpha(c.border, 0.6)
  const tickColor = c.muted
  const borderColor = withAlpha(c.border, 0.8)

  // Apply to common scales
  ;['category','linear','logarithmic','time'].forEach(scale => {
    if (!Chart.defaults.scales[scale]) Chart.defaults.scales[scale] = {}
    Chart.defaults.scales[scale].grid = { color: gridColor }
    Chart.defaults.scales[scale].ticks = { color: tickColor }
    Chart.defaults.scales[scale].border = { color: borderColor }
  })

  // Legends and title
  Chart.defaults.plugins.legend = Chart.defaults.plugins.legend || {}
  Chart.defaults.plugins.legend.labels = { color: c.text }
  Chart.defaults.plugins.title = Chart.defaults.plugins.title || {}
  Chart.defaults.plugins.title.color = c.text

  // Tooltip to match card colors
  Chart.defaults.plugins.tooltip = {
    backgroundColor: withAlpha(c.card, 0.98),
    titleColor: c.text,
    bodyColor: c.text,
    borderColor: c.border,
    borderWidth: 1,
  }

  // Lines default to theme primary
  Chart.defaults.elements = Chart.defaults.elements || {}
  Chart.defaults.elements.line = {
    borderColor: c.primary,
    backgroundColor: withAlpha(c.primary, 0.2),
  }
  Chart.defaults.elements.bar = {
    borderColor: c.primary,
    backgroundColor: withAlpha(c.primary, 0.35),
  }
}

// Optional: re-apply on theme changes by observing the app container className
export function activateChartThemeAutoUpdate() {
  const app = document.getElementById('app')
  if (!app || typeof MutationObserver === 'undefined') return
  const obs = new MutationObserver(() => applyChartTheme())
  obs.observe(app, { attributes: true, attributeFilter: ['class'] })
}



import axios from 'axios'

// Read from env; fallback to same-origin /api
const baseURL = import.meta.env.VITE_API_BASE_URL || '/api'

export const http = axios.create({
  baseURL,
  timeout: 15000,
})

// Optional interceptor placeholders
http.interceptors.response.use(
  (r) => r,
  (err) => Promise.reject(err)
)


// Severity color helpers
export const SEVERITY_ORDER = ['Minor', 'Major', 'Critical']

export const SEVERITY_HEX = {
  Critical: '#FC9796',
  Major:    '#FFC08C',
  Minor:    '#8FE0AD',
}

export function hexToRgba(hex, alpha = 1) {
  let h = hex.replace('#', '').trim()
  if (h.length === 3) h = h.split('').map(c => c + c).join('')
  const r = parseInt(h.slice(0, 2), 16)
  const g = parseInt(h.slice(2, 4), 16)
  const b = parseInt(h.slice(4, 6), 16)
  const a = Math.max(0, Math.min(1, Number(alpha)))
  return `rgba(${r}, ${g}, ${b}, ${a})`
}

export function severityHex(label) {
  if (!label) return undefined
  const key = SEVERITY_ORDER.find(s => s.toLowerCase() === String(label).toLowerCase())
  return key ? SEVERITY_HEX[key] : undefined
}

export function severityBg(label, alpha = 0.85) {
  const hex = severityHex(label)
  return hex ? hexToRgba(hex, alpha) : undefined
}

export function paletteFor(labels = []) {
  return labels.map(l => severityHex(l) ?? '#9aa1a6')
}


export const STATUS_ORDER = ['Resolved', 'Active', 'In Progress', 'On Hold']

export const STATUS_COLORS = {
  Resolved: '#8FE0AD',
  Active: '#FC9796',
  'In Progress': '#EEEE96',
  'On Hold': '#FFC08C',
}

export function hexToRgba(hex, alpha = 1) {
  let h = hex.replace('#', '').trim()
  if (h.length === 3) h = h.split('').map(ch => ch + ch).join('')
  const r = parseInt(h.slice(0, 2), 16)
  const g = parseInt(h.slice(2, 4), 16)
  const b = parseInt(h.slice(4, 6), 16)
  const a = Math.max(0, Math.min(1, Number(alpha)))
  return `rgba(${r}, ${g}, ${b}, ${a})`
}

export function borderColor(status) {
  return STATUS_COLORS[status]
}

export function bgColor(status, alpha = 0.2) {
  return hexToRgba(STATUS_COLORS[status], alpha)
}

export function arrayForOrder(order = STATUS_ORDER) {
  return Array.from(order, s => STATUS_COLORS[s])
}

export function colorForLabel(label) {
  // case-insensitive exact match against known statuses
  const s = STATUS_ORDER.find(s => s.toLowerCase() === String(label).toLowerCase())
  return s ? STATUS_COLORS[s] : undefined
}

// Convenience: map any dataset label to strict status colors
export function colorsForDatasetLabel(label, bgAlpha = 0.85) {
  const hex = colorForLabel(label)
  if (!hex) return undefined
  return { border: hex, bg: hexToRgba(hex, bgAlpha) }
}


// frontend/src/lib/theme.js
/** Read a CSS variable (hex or rgb[a]) from the app root or document.
 * @param {string} name CSS var name like '--text'
 * @param {string} [fallback] fallback color
 * @returns {string}
 */
export function getCssVar(name, fallback = '') {
  const el = document.getElementById('app') || document.body || document.documentElement
  const val = getComputedStyle(el).getPropertyValue(name)?.trim()
  return val || fallback || '#000'
}

/** Convert a color to rgba string with given alpha.
 * Accepts hex (#rgb/#rrggbb) or rgb/rgba strings.
 * @param {string} color
 * @param {number} alpha 0..1
 */
export function withAlpha(color, alpha) {
  if (!color) return `rgba(0,0,0,${alpha})`
  if (color.startsWith('rgba(')) return color.replace(/rgba\(([^)]+)\)/, (_m, inner) => {
    const parts = inner.split(',').map(s => s.trim())
    return `rgba(${parts[0]}, ${parts[1]}, ${parts[2]}, ${alpha})`
  })
  if (color.startsWith('rgb(')) return color.replace(/rgb\(([^)]+)\)/, (_m, inner) => `rgba(${inner}, ${alpha})`)
  if (color.startsWith('#')) {
    const hex = color.slice(1)
    const to255 = h => parseInt(h, 16)
    let r, g, b
    if (hex.length === 3) {
      r = to255(hex[0] + hex[0]); g = to255(hex[1] + hex[1]); b = to255(hex[2] + hex[2])
    } else if (hex.length >= 6) {
      r = to255(hex.slice(0,2)); g = to255(hex.slice(2,4)); b = to255(hex.slice(4,6))
    } else {
      r = g = b = 0
    }
    return `rgba(${r}, ${g}, ${b}, ${alpha})`
  }
  // Fallback
  return color
}

export function currentThemeColors() {
  return {
    text: getCssVar('--body-text', '#2c3135'),
    muted: getCssVar('--french-gray-2', '#adb5bd'),
    border: getCssVar('--platinum', '#dee2e6'),
    card: getCssVar('--card-bg', '#f8f9fa'),
    // Chart accent defaults to slate-gray family
    primary: getCssVar('--slate-gray', '#6c757d'),
    primary600: getCssVar('--slate-gray-lighter', '#858e96'),
  }
}


// frontend/src/main.js
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import App from './App.vue'
import { router } from './router'   // ✅ named import to match your router file
import './assets/tailwind.css'
import './style.css'
import { applyChartTheme } from './lib/chartTheme'

const app = createApp(App)
const pinia = createPinia()
app.use(pinia)

// Hydrate auth store from localStorage
import { useAuthStore } from './stores/auth'
const authStore = useAuthStore()
authStore.initFromStorage()
app.use(router)
// Apply Chart.js theme defaults from CSS vars (single theme)
applyChartTheme()
app.mount('#app')


import { createRouter, createWebHistory } from 'vue-router'
import SettingsLayout from '@/views/settings/SettingsLayout.vue'
import EmailSettings from '@/views/settings/EmailSettings.vue'
import SectionManagement from '@/views/settings/SectionManagement.vue'
import ReportsManagement from '@/views/settings/ReportsManagement.vue'
// Correct the import to point to the renamed file
import TelegramSettings from '@/views/settings/TelegramSettings.vue'
import ReportsNow from '@/views/ReportsNow.vue'
import SupervisorMovements from '@/views/SupervisorMovements.vue'
const FailureIdSettings = () => import('@/views/settings/FailureIdSettings.vue')
const UsersRolesSettings = () => import('@/views/settings/UsersRolesSettings.vue')
const CircuitManagement = () => import('@/views/settings/CircuitManagement.vue')
const SupervisorManagement = () => import('@/views/settings/SupervisorManagement.vue')
const StationManagement = () => import('@/views/settings/StationManagement.vue')
const DepotManagement = () => import('@/views/settings/DepotManagement.vue')

const routes = [
  { path: '/login', component: () => import('../views/Login.vue'), meta: { public: true } },
  { path: '/', redirect: '/dashboard' },
  { path: '/dashboard', component: () => import('../views/Dashboard.vue'), meta: { requiresAuth: true, title: 'Dashboard' } },
  { path: '/logbook', component: () => import('../views/Logbook.vue'), meta: { requiresAuth: true, title: 'Logbook' } },
  { path: '/failures/new', name: 'LogbookEntry', alias: ['/logbook/new'], component: () => import('../views/FailureNew.vue'), meta: { requiresAuth: true, title: 'Logbook Entry' } },
  { path: '/failures/edit/:id', name: 'FailureEdit', component: () => import('@/views/FailureEdit.vue'), meta: { requiresAuth: true, title: 'Edit Failure' } },
  { path: '/reports-now', name: 'ReportsNow', component: ReportsNow, meta: { requiresAuth: true, title: 'Reports Now' } },
  { path: '/supervisor-movements', name: 'SupervisorMovements', component: SupervisorMovements, meta: { requiresAuth: true, title: 'Supervisor Movements' } },
  { path: '/:pathMatch(.*)*', redirect: '/dashboard' },
  {
    path: '/settings',
    component: SettingsLayout,
    meta: { requiresAuth: true, title: 'Settings' },
    children: [
      // Default → Reports
      { path: '', redirect: '/settings/reports' },
      { path: 'email', name: 'SettingsEmail', component: EmailSettings, meta: { title: 'Email Settings' } },
      // 1) Reports Management
      { path: 'reports', name: 'SettingsReports', component: ReportsManagement, meta: { title: 'Reports Management' } },
      // 2) Failure ID Configuration
      { path: 'failure-id', name: 'SettingsFailureId', component: FailureIdSettings, meta: { title: 'Failure ID Configuration' } },
      // 3) Telegram Integration Settings
      // Update the component reference here
      { path: 'telegram', name: 'SettingsTelegram', component: TelegramSettings, meta: { title: 'Telegram Integration Settings' } },
      // 4) User and Role Management
      { path: 'users-roles', name: 'SettingsUsersRoles', component: UsersRolesSettings, meta: { title: 'User and Role Management' } },
      // 5) Circuit Management
      { path: 'circuits', name: 'SettingsCircuits', component: CircuitManagement, meta: { title: 'Circuit Management' } },
      // 6) Depot Management
      { path: 'depots', name: 'SettingsDepots', component: DepotManagement, meta: { title: 'Depot Management' } },
      // 7) Supervisor Management
      { path: 'supervisors', name: 'SettingsSupervisors', component: SupervisorManagement, meta: { title: 'Supervisor Management' } },
      // 8) Station Management
      { path: 'stations', name: 'SettingsStations', component: StationManagement, meta: { title: 'Station Management' } },
      // 9) Section Management
      { path: 'sections', name: 'SettingsSections', component: SectionManagement, meta: { title: 'Section Management' } },
      { path: 'stations-sections', redirect: '/settings/stations' },
    ],
  },
  { path: '/analytics', name: 'analytics', component: () => import('@/views/AnalyticsBoard.vue'), meta: { title: 'Analytics Board' } },
]

export const router = createRouter({
  history: createWebHistory(),
  routes,
})

// simple guard using localStorage (store isn't guaranteed here yet)
router.beforeEach((to, from, next) => {
  const authed = !!localStorage.getItem('auth_token')
  if (to.meta.requiresAuth && !authed) return next({ path: '/login', query: { next: to.fullPath } })
  next()
})

import { defineStore } from 'pinia'

export const useAppStore = defineStore('app', {
  state: () => ({
    appName: 'Railway Failure System',
  }),
  actions: {
    setAppName(name) { this.appName = name }
  }
})


import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useAttachmentStore = defineStore('attachments', {
  state: () => ({
    attachments: [],
    loading: false,
    error: null,
  }),
  actions: {
    async fetchAttachments(failureId) {
      if (!failureId) {
        this.attachments = [];
        return;
      }
      this.loading = true;
      this.error = null;
      try {
        const response = await http.get(`/failures/attachments/?failure=${failureId}`);
        this.attachments = response.data.results || response.data;
      } catch (err) {
        this.error = 'Failed to fetch attachments.';
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async uploadAttachment(failureId, file, description) {
      const uiStore = useUIStore();
      const formData = new FormData();
      formData.append('failure', failureId);
      formData.append('file', file);
      formData.append('description', description);

      this.loading = true;
      try {
        await http.post('/failures/attachments/', formData, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'File uploaded.' });
        await this.fetchAttachments(failureId); // Refresh the list
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Upload Failed', message: 'Could not upload file.' });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async deleteAttachment(attachmentId, failureId) {
      const uiStore = useUIStore();
      this.loading = true;
      try {
        await http.delete(`/failures/attachments/${attachmentId}/`);
        uiStore.pushToast({ type: 'success', title: 'Deleted', message: 'Attachment removed.' });
        await this.fetchAttachments(failureId); // Refresh the list
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove attachment.' });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
  },
});

import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    user: null,   // { username }
    token: null,  // placeholder until backend
  }),
  actions: {
    initFromStorage() {
      const token = localStorage.getItem('auth_token')
      const userRaw = localStorage.getItem('auth_user')
      if (token) this.token = token
      if (userRaw) this.user = JSON.parse(userRaw)
    },
    async login({ username, password }) {
      if (!username || !password) throw new Error('Missing credentials')
      // Mock success; later replace with real API call
      this.user = { username }
      this.token = 'dev-token'
      localStorage.setItem('auth_token', this.token)
      localStorage.setItem('auth_user', JSON.stringify(this.user))
    },
    logout() {
      this.user = null
      this.token = null
      localStorage.removeItem('auth_token')
      localStorage.removeItem('auth_user')
    }
  }
})


import { defineStore } from 'pinia'
import { ref } from 'vue'
import { http } from '@/lib/http'
import { useUIStore } from './ui'

export const useCoreSettingsStore = defineStore('coreSettings', () => {
  const failureIdSettings = ref({
    prefix: 'RF',
    padding: 4,
    reset_cycle: 'yearly',
  })
  const loading = ref(false)

  async function fetchFailureIdSettings() {
    loading.value = true
    const uiStore = useUIStore()
    try {
      // The backend list view for the singleton returns the object directly.
      const response = await http.get('/core/failure-id-settings/')
      // The response for a list is often nested, but our custom view returns the object directly.
      // However, a standard ViewSet list view would return { results: [...] }
      // So we handle both cases.
      if (response.data && response.data.results) {
         // This handles the case where the default list view is used.
         // Since we expect only one, we take the first.
        if (response.data.results.length > 0) {
            failureIdSettings.value = response.data.results[0];
        }
      } else {
        // This handles our custom list view that returns a single object.
        failureIdSettings.value = response.data
      }
    } catch (err) {
      console.error('Failed to fetch Failure ID settings:', err)
      uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not load Failure ID settings.' })
    } finally {
      loading.value = false
    }
  }

  async function saveFailureIdSettings(payload) {
    loading.value = true
    const uiStore = useUIStore()
    try {
      // The singleton is always at pk=1, so we update it there.
      const response = await http.patch('/core/failure-id-settings/1/', payload)
      failureIdSettings.value = response.data
      uiStore.pushToast({ type: 'success', title: 'Success', message: 'Failure ID settings saved.' })
    } catch (err) {
      console.error('Failed to save Failure ID settings:', err)
      uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not save Failure ID settings.' })
    } finally {
      loading.value = false
    }
  }

  return {
    failureIdSettings,
    loading,
    fetchFailureIdSettings,
    saveFailureIdSettings,
  }
})

import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useEmailStore = defineStore('email', {
  state: () => ({
    settings: {
      host: '',
      port: 587,
      encryption: 'STARTTLS',
      username: '',
      password: '',
      from_name: 'RFMS Notifications',
      from_address: 'no-reply@rfms.local',
      recipients: {
        to: [],
        cc: [],
        bcc: [],
      },
    },
    loading: false,
    error: null,
  }),
  actions: {
    async fetchSettings() {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        const response = await http.get('/notifications/settings/email/');
        const recipients = response.data.recipients || {};
        // Ensure recipients object and its arrays exist
        this.settings = {
          ...response.data,
          recipients: {
            to: recipients.to || [],
            cc: recipients.cc || [],
            bcc: recipients.bcc || [],
          }
        };
      } catch (err) {
        this.error = 'Failed to fetch email settings.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
    async saveSettings() {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        // Create a payload to send, omitting the password if it's blank
        const payload = { ...this.settings };
        if (payload.password === '') {
          delete payload.password;
        }
        
        const response = await http.put('/notifications/settings/email/', payload);
        const recipients = response.data.recipients || {};
        this.settings = {
          ...response.data,
          recipients: {
            to: recipients.to || [],
            cc: recipients.cc || [],
            bcc: recipients.bcc || [],
          }
        };
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Email settings saved.' });
      } catch (err) {
        this.error = 'Failed to save email settings.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
    async sendTestEmail(toEmail) {
      if (!toEmail) {
        useUIStore().pushToast({ type: 'error', title: 'Input Required', message: 'Please enter a recipient for the test email.' });
        return;
      }
      this.loading = true;
      const uiStore = useUIStore();
      try {
        const response = await http.post('/notifications/settings/email/test/', { to_email: toEmail });
        uiStore.pushToast({ type: 'success', title: 'Success', message: response.data.message });
      } catch (err) {
        const message = err.response?.data?.error || 'An unknown error occurred.';
        uiStore.pushToast({ type: 'error', title: 'Test Failed', message: message, duration: 8000 });
        console.error(err);
      } finally {
        this.loading = false;
      }
    }
  },
});



// Path: frontend/src/stores/failures.js
import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useFailureStore = defineStore('failure', {
  state: () => ({
    failures: [],
    currentFailure: null,
    loading: false,
    error: null,
  }),
  actions: {
    async fetchFailures() {
      this.loading = true;
      this.error = null;
      try {
        const response = await http.get('/failures/logs/');
        this.failures = response.data.results || response.data;
      } catch (err) {
        this.error = 'Failed to fetch failure logs.';
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async fetchFailure(id) {
      this.loading = true;
      this.error = null;
      try {
        const response = await http.get(`/failures/logs/${id}/`);
        this.currentFailure = response.data;
      } catch (err) {
        this.error = 'Failed to fetch failure log.';
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async addFailure(payload) {
      const uiStore = useUIStore();
      this.loading = true;
      this.error = null;
      try {
        await http.post('/failures/logs/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Failure log created.' });
        this.fetchFailures();
        return true;
      } catch (err) {
        const message = err.response?.data ? JSON.stringify(err.response.data) : 'Failed to create failure log.';
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Error', message });
        console.error(err);
        return false;
      } finally {
        this.loading = false;
      }
    },

    async updateFailure(id, payload) {
      const uiStore = useUIStore();
      this.loading = true;
      this.error = null;
      try {
        await http.patch(`/failures/logs/${id}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Failure log updated.' });
        this.fetchFailures();
      } catch (err) {
        const message = err.response?.data ? JSON.stringify(err.response.data) : 'Failed to update failure log.';
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Error', message });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async archiveFailure(id, reason) {
      const uiStore = useUIStore();
      this.loading = true;
      this.error = null;
      try {
        await http.post(`/failures/logs/${id}/archive/`, { reason });
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Failure log archived.' });
        await this.fetchFailures();
      } catch (err) {
        const message = err.response?.data ? JSON.stringify(err.response.data) : 'Failed to archive failure log.';
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Error', message });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async sendFailureNotification(failureId, groupKeys) {
      const uiStore = useUIStore();
      this.loading = true;
      this.error = null;
      try {
        const response = await http.post(`/failures/logs/${failureId}/notify/`, { groups: groupKeys });
        uiStore.pushToast({ type: 'success', title: 'Success', message: response.data.message });
      } catch (err) {
        const message = err.response?.data?.error || 'Failed to send notification.';
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Error', message });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
  },
});

// Path: frontend/src/stores/infrastructure.js

import { defineStore } from 'pinia'
import { http } from '@/lib/http'
import { useUIStore } from './ui'

export const useInfrastructureStore = defineStore('infrastructure', {
  state: () => ({
    depots: [],
    stations: [],
    sections: [],
    circuits: [],
    supervisors: [],
    subSections: [],
    loading: {
      depots: false,
      stations: false,
      sections: false,
      circuits: false,
      supervisors: false,
    },
    error: null,
  }),
  actions: {
    async fetchDepots() {
      this.loading.depots = true
      this.error = null
      try {
        const response = await http.get('/infrastructure/depots/')
        this.depots = response.data.results || response.data
      } catch (err) {
        this.error = 'Failed to fetch depots.'
        console.error(err)
      } finally {
        this.loading.depots = false
      }
    },
    async fetchStations() {
      this.loading.stations = true
      this.error = null
      try {
        const response = await http.get('/infrastructure/stations/')
        this.stations = response.data.results || response.data
      } catch (err) {
        this.error = 'Failed to fetch stations.'
        console.error(err)
      } finally {
        this.loading.stations = false
      }
    },
    async fetchSupervisors() {
      this.loading.supervisors = true
      this.error = null
      try {
        const response = await http.get('/infrastructure/supervisors/')
        this.supervisors = response.data.results || response.data
      } catch (err) {
        this.error = 'Failed to fetch supervisors.'
        console.error(err)
      } finally {
        this.loading.supervisors = false
      }
    },
    async fetchSections() {
      this.loading.sections = true
      this.error = null
      try {
        const response = await http.get('/infrastructure/sections/')
        this.sections = response.data.results || response.data
      } catch (err) {
        this.error = 'Failed to fetch sections.'
        console.error(err)
      } finally {
        this.loading.sections = false
      }
    },
    async fetchSubSections() {
      this.loading.sections = true; // Can share loading state with sections
      this.error = null;
      try {
        const response = await http.get('/infrastructure/subsections/');
        this.subSections = response.data.results || response.data;
      } catch (err) {
        this.error = 'Failed to fetch sub-sections.';
        console.error(err);
      } finally {
        this.loading.sections = false;
      }
    },
    async fetchCircuits() {
      this.loading.circuits = true
      this.error = null
      try {
        const response = await http.get('/infrastructure/circuits/')
        this.circuits = response.data.results || response.data
      } catch (err) {
        this.error = 'Failed to fetch circuits.'
        console.error(err)
      } finally {
        this.loading.circuits = false
      }
    },
    async addDepot(payload) {
      this.loading.depots = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.post('/infrastructure/depots/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Depot added.' });
        await this.fetchDepots();
      } catch (err) {
        this.error = 'Failed to add depot.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.depots = false;
      }
    },
    async updateDepot(depotId, payload) {
      this.loading.depots = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.patch(`/infrastructure/depots/${depotId}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Depot updated.' });
        await this.fetchDepots();
      } catch (err) {
        this.error = 'Failed to update depot.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.depots = false;
      }
    },
    async removeDepot(depotId) {
      this.loading.depots = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.delete(`/infrastructure/depots/${depotId}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Depot removed.' });
        await this.fetchDepots();
      } catch (err) {
        this.error = 'Failed to remove depot.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.depots = false;
      }
    },
    async uploadDepotsFile(file) {
      this.loading.depots = true;
      this.error = null;
      const uiStore = useUIStore();

      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await http.post('/infrastructure/depots/import/', formData, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });

        const { depots_processed, equipment_created, errors } = response.data;
        let message = `Import successful! Depots: ${depots_processed}, Equipment: ${equipment_created}.`;
        if (errors && errors.length) {
            message += ` Errors: ${errors.length}.`;
        }
        uiStore.pushToast({ type: 'success', title: 'Import Complete', message });

        await this.fetchDepots();
      } catch (err) {
        const message = err.response?.data?.error || 'File upload failed.';
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Import Failed', message });
        console.error(err);
      } finally {
        this.loading.depots = false;
      }
    },
     async addEquipment(payload) {
      const uiStore = useUIStore();
      try {
        await http.post('/infrastructure/equipments/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Equipment added.' });
      } catch (err) {
        console.error("Failed to add equipment:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not add equipment.' });
      }
    },
    async updateEquipment(equipmentId, payload) {
       const uiStore = useUIStore();
      try {
        await http.patch(`/infrastructure/equipments/${equipmentId}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Equipment updated.' });
      } catch (err) {
        console.error("Failed to update equipment:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not update equipment.' });
      }
    },
    async removeEquipment(equipmentId) {
       const uiStore = useUIStore();
      try {
        await http.delete(`/infrastructure/equipments/${equipmentId}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Equipment removed.' });
      } catch (err) {
        console.error("Failed to remove equipment:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove equipment.' });
      }
    },
    async addSection(payload) {
      this.loading.sections = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.post('/infrastructure/sections/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Section added.' });
        await this.fetchSections(); // Refresh the list
      } catch (err) {
        this.error = 'Failed to add section.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.sections = false;
      }
    },
     async updateSection(sectionId, payload) {
      this.loading.sections = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.patch(`/infrastructure/sections/${sectionId}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Section updated.' });
        await this.fetchSections();
      } catch (err) {
        this.error = 'Failed to update section.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.sections = false;
      }
    },
    async removeSection(sectionId) {
      this.loading.sections = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.delete(`/infrastructure/sections/${sectionId}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Section removed.' });
        await this.fetchSections(); // Refresh the list
      } catch (err) {
        this.error = 'Failed to remove section.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.sections = false;
      }
    },
     async uploadSectionsFile(file) {
      this.loading.sections = true;
      this.error = null;
      const uiStore = useUIStore();
      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await http.post('/infrastructure/sections/import/', formData, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });
        uiStore.pushToast({ type: 'success', title: 'Import Complete', message: response.data.message });
        await this.fetchSections();
      } catch (err) {
        const errorData = err.response?.data;
        let message = 'File upload failed.';
        if (errorData && errorData.error) {
            message = errorData.error;
        }
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Import Failed', message });
        console.error(err);
      } finally {
        this.loading.sections = false;
      }
    },
    async addStation(payload) {
      this.loading.stations = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.post('/infrastructure/stations/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Station added.' });
        await this.fetchStations(); 
      } catch (err) {
        this.error = 'Failed to add station.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.stations = false;
      }
    },
    async updateStation(stationId, payload) {
      this.loading.stations = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.patch(`/infrastructure/stations/${stationId}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Station updated.' });
        await this.fetchStations();
      } catch (err) {
        this.error = 'Failed to update station.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.stations = false;
      }
    },
    async removeStation(stationId) {
      this.loading.stations = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.delete(`/infrastructure/stations/${stationId}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Station removed.' });
        await this.fetchStations();
      } catch (err) {
        this.error = 'Failed to remove station.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.stations = false;
      }
    },
    async uploadStationsFile(file) {
      this.loading.stations = true;
      this.error = null;
      const uiStore = useUIStore();
      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await http.post('/infrastructure/stations/import/', formData, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });
        uiStore.pushToast({ type: 'success', title: 'Import Complete', message: response.data.message });
        await this.fetchStations();
        await this.fetchDepots(); // Also refresh depots in case new ones were created
      } catch (err) {
        const errorData = err.response?.data;
        let message = 'File upload failed.';
        if (errorData) {
            if (errorData.error && errorData.details) {
                message = `${errorData.error} ${errorData.details.join('; ')}`;
            } else if (errorData.error) {
                message = errorData.error;
            } else if (errorData.errors) {
                message = `${errorData.message} ${errorData.errors.join('; ')}`;
            }
        }
        
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Import Failed', message: message, duration: 10000 });
        console.error(err);
      } finally {
        this.loading.stations = false;
      }
    },
    async addStationEquipment(payload) {
      const uiStore = useUIStore();
      try {
        await http.post('/infrastructure/station-equipments/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Equipment added.' });
      } catch (err) {
        console.error("Failed to add station equipment:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not add equipment.' });
      }
    },
    async updateStationEquipment(equipmentId, payload) {
       const uiStore = useUIStore();
      try {
        await http.patch(`/infrastructure/station-equipments/${equipmentId}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Equipment updated.' });
      } catch (err) {
        console.error("Failed to update station equipment:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not update equipment.' });
      }
    },
    async removeStationEquipment(equipmentId) {
       const uiStore = useUIStore();
      try {
        await http.delete(`/infrastructure/station-equipments/${equipmentId}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Equipment removed.' });
      } catch (err) {
        console.error("Failed to remove station equipment:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove equipment.' });
      }
    },
    async addSubSection(payload) {
      const uiStore = useUIStore();
      try {
        const response = await http.post('/infrastructure/subsections/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Sub-section added.' });
        return response.data;
      } catch (err) {
        console.error("Failed to add sub-section:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not add sub-section.' });
      }
    },
    async updateSubSection(subSectionId, payload) {
      const uiStore = useUIStore();
      try {
        await http.patch(`/infrastructure/subsections/${subSectionId}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Sub-section updated.' });
      } catch (err) {
        console.error("Failed to update sub-section:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not update sub-section.' });
      }
    },
    async removeSubSection(subSectionId) {
      const uiStore = useUIStore();
      try {
        await http.delete(`/infrastructure/subsections/${subSectionId}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Sub-section removed.' });
      } catch (err) {
        console.error("Failed to remove sub-section:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove sub-section.' });
      }
    },
    async addAsset(payload) {
      const uiStore = useUIStore();
      try {
        await http.post('/infrastructure/assets/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Asset added.' });
      } catch (err) {
        console.error("Failed to add asset:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not add asset.' });
      }
    },
    async updateAsset(assetId, payload) {
      const uiStore = useUIStore();
      try {
        await http.patch(`/infrastructure/assets/${assetId}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Asset updated.' });
      } catch (err) {
        console.error("Failed to update asset:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not update asset.' });
      }
    },
    async removeAsset(assetId) {
      const uiStore = useUIStore();
      try {
        await http.delete(`/infrastructure/assets/${assetId}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Asset removed.' });
      } catch (err) {
        console.error("Failed to remove asset:", err);
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove asset.' });
      }
    },
    async addSupervisor(payload) {
      this.loading.supervisors = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.post('/infrastructure/supervisors/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Supervisor added.' });
        await this.fetchSupervisors();
      } catch (err) {
        this.error = 'Failed to add supervisor.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.supervisors = false;
      }
    },
    async removeSupervisor(supervisorId) {
      this.loading.supervisors = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.delete(`/infrastructure/supervisors/${supervisorId}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Supervisor removed.' });
        await this.fetchSupervisors();
      } catch (err) {
        this.error = 'Failed to remove supervisor.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.supervisors = false;
      }
    },
    async updateSupervisor(supervisorId, payload) {
      this.loading.supervisors = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.patch(`/infrastructure/supervisors/${supervisorId}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Supervisor updated.' });
        await this.fetchSupervisors();
      } catch (err) {
        this.error = 'Failed to update supervisor.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading.supervisors = false;
      }
    },
    // --- Circuit Actions ---
    async addCircuit(payload) {
      this.loading.circuits = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.post('/infrastructure/circuits/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Circuit added.' });
        await this.fetchCircuits();
      } catch (err) {
        this.error = 'Failed to add circuit.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Failed to add circuit.' });
        console.error(err);
      } finally {
        this.loading.circuits = false;
      }
    },
    async updateCircuit(circuitId, payload) {
      this.loading.circuits = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.patch(`/infrastructure/circuits/${circuitId}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Circuit updated.' });
        await this.fetchCircuits();
      } catch (err) {
        this.error = 'Failed to update circuit.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Failed to update circuit.' });
        console.error(err);
      } finally {
        this.loading.circuits = false;
      }
    },
    async uploadCircuitsFile(file) {
      this.loading.circuits = true;
      this.error = null;
      const uiStore = useUIStore();
      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await http.post('/infrastructure/circuits/import/', formData, {
          headers: { 'Content-Type': 'multipart/form-data' },
        });
        const { created, updated, errors } = response.data;
        let message = `Import successful! Created: ${created}, Updated: ${updated}.`;
        if (errors.length) {
            message += ` Errors: ${errors.length}.`;
        }
        uiStore.pushToast({ type: 'success', title: 'Import Complete', message });
        await this.fetchCircuits();
      } catch (err) {
        const message = err.response?.data?.error || 'File upload failed.';
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Import Failed', message });
        console.error(err);
      } finally {
        this.loading.circuits = false;
      }
    },
    async removeCircuit(circuitId) {
      this.loading.circuits = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.delete(`/infrastructure/circuits/${circuitId}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Circuit removed.' });
        await this.fetchCircuits();
      } catch (err) {
        this.error = 'Failed to remove circuit.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Failed to remove circuit.' });
        console.error(err);
      } finally {
        this.loading.circuits = false;
      }
    },
  },
})



    import { defineStore } from 'pinia';
    import { http } from '@/lib/http';
    import { useUIStore } from './ui';

    export const useReportsStore = defineStore('reports', {
      state: () => ({
        schedules: [],
        loading: false,
        error: null,
      }),
      actions: {
        async fetchSchedules() {
          this.loading = true;
          this.error = null;
          try {
            const response = await http.get('/reports/schedules/');
            this.schedules = response.data.results || response.data;
          } catch (err) {
            this.error = 'Failed to fetch report schedules.';
            console.error(err);
          } finally {
            this.loading = false;
          }
        },
        async addSchedule(payload) {
          const uiStore = useUIStore();
          try {
            await http.post('/reports/schedules/', payload);
            uiStore.pushToast({ type: 'success', title: 'Success', message: 'Report schedule added.' });
            await this.fetchSchedules();
          } catch (err) {
            console.error('Failed to add schedule:', err);
            uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not add report schedule.' });
          }
        },
        async updateSchedule(scheduleId, payload) {
          const uiStore = useUIStore();
          // The backend now expects 'telegram_group_keys'
          const apiPayload = { ...payload };
          delete apiPayload.id; // Don't send the ID in the body of a PATCH request

          try {
            await http.patch(`/reports/schedules/${scheduleId}/`, apiPayload);
            uiStore.pushToast({ type: 'success', title: 'Saved', message: 'Report schedule updated.' });
            await this.fetchSchedules(); // Refresh list to get latest state
          } catch (err) {
            console.error('Failed to update schedule:', err);
            uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not update schedule.' });
          }
        },
        async removeSchedule(scheduleId) {
          const uiStore = useUIStore();
          try {
            await http.delete(`/reports/schedules/${scheduleId}/`);
            uiStore.pushToast({ type: 'success', title: 'Deleted', message: 'Report schedule removed.' });
            await this.fetchSchedules();
          } catch (err) {
            console.error('Failed to remove schedule:', err);
            uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove schedule.' });
          }
        },
        async uploadTemplate(scheduleId, file) {
          const uiStore = useUIStore();
          const formData = new FormData();
          formData.append('template', file);
          this.loading = true;
          try {
            await http.post(`/reports/schedules/${scheduleId}/upload_template/`, formData, {
              headers: { 'Content-Type': 'multipart/form-data' },
            });
            uiStore.pushToast({ type: 'success', title: 'Success', message: 'Template uploaded.' });
            await this.fetchSchedules();
          } catch (err) {
            console.error('Failed to upload template:', err);
            uiStore.pushToast({ type: 'error', title: 'Upload Failed', message: 'Could not upload template.' });
          } finally {
            this.loading = false;
          }
        },
      },
    });
    


import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useSupervisorMovementsStore = defineStore('supervisorMovements', {
  state: () => ({
    // This will now store the list of supervisors with their nested movement data
    dailyMovements: [],
    loading: false,
    error: null,
  }),
  actions: {
    /**
     * Fetches all supervisors and their movements for a specific date.
     * @param {string} date - The date in 'YYYY-MM-DD' format.
     */
    async fetchMovementsByDate(date) {
      if (!date) return;
      this.loading = true;
      this.error = null;
      try {
        const response = await http.get(`/operations/by-date/?date=${date}`);
        this.dailyMovements = response.data;
      } catch (err) {
        this.error = 'Failed to fetch movements for the selected date.';
        this.dailyMovements = [];
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    /**
     * Creates or updates a movement record.
     * @param {object} payload - The full movement object.
     */
    async saveMovement(payload) {
      const uiStore = useUIStore();
      this.loading = true;
      this.error = null;
      try {
        if (payload.id) {
          // If it has an ID, it's an update (PATCH)
          await http.patch(`/operations/movements/${payload.id}/`, payload);
          uiStore.pushToast({ type: 'success', title: 'Success', message: 'Movement updated.' });
        } else {
          // Otherwise, it's a new record (POST)
          await http.post('/operations/movements/', payload);
          uiStore.pushToast({ type: 'success', title: 'Success', message: 'Movement saved.' });
        }
        // Refresh the data for the current date to show the change
        await this.fetchMovementsByDate(payload.date);
      } catch (err) {
        this.error = 'Failed to save movement.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
     /**
     * Deletes a movement record.
     * @param {number} movementId - The ID of the movement record to delete.
     * @param {string} date - The date for which to refresh data after deletion.
     */
    async deleteMovement(movementId, date) {
        if (!movementId) return;
        const uiStore = useUIStore();
        this.loading = true;
        this.error = null;
        try {
            await http.delete(`/operations/movements/${movementId}/`);
            uiStore.pushToast({ type: 'success', title: 'Success', message: 'Movement entry deleted.' });
            await this.fetchMovementsByDate(date);
        } catch (err) {
            this.error = 'Failed to delete movement.';
            uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
            console.error(err);
        } finally {
            this.loading = false;
        }
    },

    async sendMovementReport(date) {
      const uiStore = useUIStore();
      this.loading = true;
      this.error = null;
      try {
        await http.post('/operations/send-report/', { date });
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Report sent successfully.' });
      } catch (err) {
        const message = err.response?.data?.error || 'Failed to send report.';
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Error', message });
        console.error(err);
      } finally {
        this.loading = false;
      }
    }
  },
});

import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useTelegramStore = defineStore('telegram', {
  state: () => ({
    settings: {
      bot_token: '',
    },
    groups: [],
    loading: false,
    error: null,
  }),

  getters: {
    // A getter to easily access the list of groups
    list: (state) => state.groups,
  },

  actions: {
    async fetchTelegramSettings() {
      this.loading = true;
      try {
        const response = await http.get('/notifications/settings/telegram/');
        this.settings = response.data;
      } catch (err) {
        console.error('Failed to fetch Telegram settings', err);
        useUIStore().pushToast({ type: 'error', title: 'Error', message: 'Could not load Telegram settings.' });
      } finally {
        this.loading = false;
      }
    },

    async saveTelegramSettings() {
      this.loading = true;
      const uiStore = useUIStore();
      try {
        const response = await http.patch('/notifications/settings/telegram/1/', this.settings);
        this.settings = response.data;
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Bot Token saved.' });
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not save Bot Token.' });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async fetchTelegramGroups() {
      this.loading = true;
      try {
        const response = await http.get('/notifications/telegram-groups/');
        this.groups = response.data.results || response.data;
      } catch (err) {
        console.error('Failed to fetch Telegram groups', err);
        useUIStore().pushToast({ type: 'error', title: 'Error', message: 'Could not load Telegram groups.' });
      } finally {
        this.loading = false;
      }
    },

    async updateTelegramGroup(group) {
      this.loading = true;
      const uiStore = useUIStore();
      try {
        await http.patch(`/notifications/telegram-groups/${group.id}/`, group);
        uiStore.pushToast({ type: 'success', title: 'Success', message: `Group "${group.name}" updated.` });
        await this.fetchTelegramGroups();
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not update group.' });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async sendTestMessage(group) {
      this.loading = true;
      const uiStore = useUIStore();
      try {
        const response = await http.post('/notifications/telegram-groups/test/', { group_id: group.id });
        uiStore.pushToast({ type: 'success', title: 'Success', message: response.data.message });
      } catch (err) {
        const message = err.response?.data?.error || 'Failed to send test message.';
        uiStore.pushToast({ type: 'error', title: 'Test Failed', message });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
  },
});

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useUIStore = defineStore('ui', () => {
  // No theme switching — single unified palette

  // --- SIDEBAR ---
  const SIDEBAR_MIN = 56
  const SIDEBAR_COLLAPSED = 64
  const SIDEBAR_MAX = 360
  const SNAP_THRESHOLD = 80 // px

  const sidebarWidth = ref(Number(localStorage.getItem('sidebarWidth') || 256))
  if (isNaN(sidebarWidth.value)) sidebarWidth.value = 256
  const sidebarCollapsed = ref(localStorage.getItem('sidebarCollapsed') === 'true')

  const computedSidebarWidth = computed(() => (sidebarCollapsed.value ? SIDEBAR_COLLAPSED : sidebarWidth.value))
  function setSidebarWidth(px) {
    const n = Math.round(Number(px))
    if (Number.isFinite(n)) {
      const clamped = Math.max(SIDEBAR_MIN, Math.min(SIDEBAR_MAX, n))
      sidebarWidth.value = clamped
      localStorage.setItem('sidebarWidth', String(clamped))
    }
  }
  function setSidebarCollapsed(v) {
    sidebarCollapsed.value = !!v
    localStorage.setItem('sidebarCollapsed', String(sidebarCollapsed.value))
  }
  function toggleSidebarCollapsed() { setSidebarCollapsed(!sidebarCollapsed.value) }
  function snapSidebar(currentPx) {
    const w = Number(currentPx ?? sidebarWidth.value)
    if (w <= SNAP_THRESHOLD) {
      setSidebarCollapsed(true)
      setSidebarWidth(SIDEBAR_COLLAPSED)
    } else {
      setSidebarCollapsed(false)
    }
  }

  // --- TOASTS (unchanged API) ---
  const toasts = ref([])
  let idSeq = 1
  /**
   * Push a toast notification to the queue.
   * @param {{ type?: string, title?: string, message?: string }} [opts]
   * @returns {void}
   */
  function pushToast({ type = 'info', title = '', message = '' } = {}) {
    const id = idSeq++
    toasts.value.push({ id, type, title, message })
    setTimeout(() => removeToast(id), 4000)
  }
  /**
   * Remove a toast by its id.
   * @param {number} id
   * @returns {void}
   */
  function removeToast(id) {
    toasts.value = toasts.value.filter(t => t.id !== id)
  }
  function clearToasts() {
    toasts.value = []
  }

  return {
    // sidebar
    sidebarWidth, sidebarCollapsed, computedSidebarWidth,
    setSidebarWidth, setSidebarCollapsed, toggleSidebarCollapsed, snapSidebar,
    // toasts
    toasts, pushToast, removeToast, clearToasts,
    // constants (optional export for tests)
    SIDEBAR_MIN, SIDEBAR_COLLAPSED, SIDEBAR_MAX, SNAP_THRESHOLD,
  }
})


import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useUserStore = defineStore('users', {
  state: () => ({
    users: [],
    loading: false,
    error: null,
  }),
  actions: {
    /**
     * Fetches the list of all users from the backend API.
     */
    async fetchUsers() {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        const response = await http.get('/users/');
        this.users = response.data.results || response.data;
      } catch (err) {
        this.error = 'Failed to fetch users.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error('Error fetching users:', err);
      } finally {
        this.loading = false;
      }
    },

    /**
     * Adds a new user via the backend API.
     * @param {object} userData - The new user's data.
     */
    async addUser(userData) {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.post('/users/', userData);
        uiStore.pushToast({
          type: 'success',
          title: 'User Added',
          message: `User "${userData.username}" has been created.`,
        });
        await this.fetchUsers(); // Refresh the user list
      } catch (err) {
        this.error = 'Failed to add user.';
        const errorMessage = err.response?.data ? JSON.stringify(err.response.data) : this.error;
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorMessage });
        console.error('Error adding user:', err);
      } finally {
        this.loading = false;
      }
    },

    /**
     * Updates an existing user via the backend API.
     * @param {number} userId - The ID of the user to update.
     * @param {object} userData - The updated user data.
     */
    async updateUser(userId, userData) {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        // Remove password from payload if it's empty
        const payload = { ...userData };
        if (!payload.password) {
          delete payload.password;
        }
          
        await http.patch(`/users/${userId}/`, payload);
        uiStore.pushToast({
          type: 'success',
          title: 'User Updated',
          message: `User "${userData.username}" has been updated.`,
        });
        await this.fetchUsers(); // Refresh the user list
      } catch (err) {
        this.error = 'Failed to update user.';
        const errorMessage = err.response?.data ? JSON.stringify(err.response.data) : this.error;
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorMessage });
        console.error('Error updating user:', err);
      } finally {
        this.loading = false;
      }
    },

    /**
     * Deletes a user via the backend API.
     * @param {number} userId - The ID of the user to delete.
     */
    async deleteUser(userId) {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.delete(`/users/${userId}/`);
        uiStore.pushToast({
          type: 'success',
          title: 'User Deleted',
          message: `User with ID #${userId} has been deleted.`,
        });
        await this.fetchUsers(); // Refresh the user list
      } catch (err) {
        this.error = 'Failed to delete user.';
        const errorMessage = err.response?.data ? JSON.stringify(err.response.data) : this.error;
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorMessage });
        console.error('Error deleting user:', err);
      } finally {
        this.loading = false;
      }
    },
  },
});

/* Trim default Vite styles to avoid conflicting with Tailwind + token-based theming. */
/* palettes */
@import "@/styles/palettes.css";
/* status palette */
@import "@/styles/status-palette.css";
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;
  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body { margin: 0; }

/* Base button reset; color comes from utility classes (.btn, etc.) */
button {
  font-family: inherit;
  cursor: pointer;
}

/* .card styles live in Tailwind layer; do not override here */


/* Unified global palette and shadows (grayscale scheme) */
:root {
  /* Base Palette */
  --seasalt: #f8f9fa;
  --antiflash-white: #e9ecef;
  --platinum: #dee2e6;
  --french-gray: #ced4da;
  --french-gray-2: #adb5bd;
  --slate-gray: #6c757d;
  --outer-space: #495057;
  --onyx: #343a40;
  --eerie-black: #212529;

  /* Nearby Shades */
  --seasalt-lighter: #ffffff;
  --antiflash-white-lighter: #f2f4f6;
  --platinum-lighter: #e7ebed;
  --french-gray-lighter: #d7dde3;
  --french-gray-2-lighter: #b6bec6;
  --slate-gray-lighter: #858e96;
  --outer-space-lighter: #626b73;
  --onyx-lighter: #4d5359;
  --eerie-black-lighter: #3a3e42;
  --off-white: #f5f5f5;
  --body-text: #2c3135;

  /* Component Assignments */
  --bg-main: var(--antiflash-white);
  --navbar-bg: var(--outer-space); /* keep for compatibility but unified with sidebar */
  --sidebar-bg: var(--outer-space);
  --sidebar-fg: var(--seasalt);
  --sidebar-fg-muted: var(--french-gray-2);
  --button-primary: var(--slate-gray);
  --button-hover: var(--slate-gray-lighter);
  --card-bg: var(--seasalt);
  --input-bg: var(--off-white);
  --error: var(--slate-gray);

  /* Status Colors (hex-mapped) */
  --status-green: #BBD9AD; /* Resolved */
  --status-yellow: #F2D194; /* In Progress */
  --status-amber: #D98236; /* On Hold */
  --status-red: #F2A0A0; /* Active */
  --on-status-green: #1F2937; /* gray-800 for readability */
  --on-status-yellow: #1F2937;
  --on-status-amber: #FFFFFF;
  --on-status-red: #1F2937;

  /* Shadow Variables */
  --shadow-resting: 0 2px 4px rgba(0, 0, 0, 0.1);
  --shadow-hover: 0 4px 8px rgba(0, 0, 0, 0.15);
  --shadow-card: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-card-hover: 0 6px 12px rgba(0, 0, 0, 0.15);
}


:root {
  /* status solids */
  --s-resolved:   #8FE0AD;
  --s-active:     #FC9796;
  --s-inprogress: #EEEE96;
  --s-onhold:     #FFC08C;
  --s-all:        #237FB7;

  /* readable text colors over those backgrounds */
  --s-on-dark:    #ffffff;
  --s-on-light:   #0b1b1f;

  /* Weak/tint variants for subtle row/card backgrounds */
  --s-active-weak:     color-mix(in oklab, var(--s-active) 18%, transparent);
  --s-inprogress-weak: color-mix(in oklab, var(--s-inprogress) 18%, transparent);
  --s-resolved-weak:   color-mix(in oklab, var(--s-resolved) 18%, transparent);
  --s-onhold-weak:     color-mix(in oklab, var(--s-onhold) 18%, transparent);
}


<template>
  <div class="p-6 space-y-6">
    <div class="flex items-baseline justify-between">
      <div>
        <h2 class="text-2xl font-semibold">Analytics Board</h2>
        <!-- helper text removed per request -->
      </div>

      <div class="flex items-center gap-2 text-sm">
        <label class="flex items-center gap-2 text-app">
          <input type="checkbox" v-model="liveToday" class="h-4 w-4 rounded border-app" />
          Live: Today’s Failures
        </label>
        <label class="flex items-center gap-2 text-app">
          <input type="checkbox" v-model="liveRecent" class="h-4 w-4 rounded border-app" />
          Live: Recent Failures
        </label>
      </div>
    </div>

    <!-- Global filters: ranges + statuses -->
    <DashboardFilterBar v-model="filters" />

    <!-- Board grid -->
    <section class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
      <div
        v-for="(p, idx) in panels"
        :key="p.id"
        class="rounded-2xl border-app bg-card text-app overflow-hidden shadow-card"
        :class="fullscreen === p.id ? 'fixed inset-6 z-50' : 'relative'"
        draggable="true"
        @dragstart="onDragStart(idx)"
        @dragover.prevent
        @drop="onDrop(idx)"
      >
        <!-- Header -->
        <div class="px-4 pt-3 pb-2 flex items-center gap-2 border-b border-app">
          <h3 class="font-semibold text-app flex-1 truncate">{{ p.title }}</h3>

          <!-- chart type -->
          <select v-model="state[p.id].type" class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm">
            <option value="bar">Bar</option>
            <option value="line">Line</option>
            <option value="table">Table</option>
            <option value="pie">Pie</option>
            <option value="doughnut">Doughnut</option>
          </select>

          <!-- Fullscreen / close fullscreen -->
          <button class="p-1.5 rounded hover:bg-card" title="Toggle fullscreen" @click="toggleFullscreen(p.id)">
            <svg v-if="fullscreen !== p.id" class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M4 10V4h6v2H6v4H4Zm10-4V4h6v6h-2V6h-4ZM6 14H4v6h6v-2H6v-4Zm14 0h-2v4h-4v2h6v-6Z"/></svg>
            <svg v-else class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M14 10V6h4V4h-6v6h2ZM6 10V6h4V4H4v6h2Zm8 8v-4h2v6h-6v-2h4ZM6 14H4v6h6v-2H6v-4Z"/></svg>
          </button>

          <!-- Remove button hidden as per request -->
        </div>

        <!-- Toolbar (per-card filters): show only in fullscreen -->
        <div v-if="fullscreen === p.id" class="px-4 pt-2 pb-3 flex flex-wrap items-center gap-2">
          <!-- Time range pills -->
          <button
            v-for="r in ranges"
            :key="r.key"
            class="px-3 py-1.5 text-sm rounded-lg border"
            :class="state[p.id].range === r.key ? 'selected-primary' : 'bg-card text-app border-app hover-primary'"
            @click="setRange(p.id, r.key)"
          >
            {{ r.label }}
          </button>

          <!-- Custom dates -->
          <div v-if="state[p.id].range === 'custom'" class="ml-auto flex items-center gap-2">
            <input type="date" v-model="state[p.id].from" class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm" />
            <span class="text-muted text-sm">to</span>
            <input type="date" v-model="state[p.id].to" class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm" />
            <button class="px-3 py-1.5 text-sm rounded-lg border-app bg-card hover:bg-card" @click="applyCustom(p.id)">Apply</button>
          </div>
          <div v-else class="ml-auto"></div>

          <!-- Status chips (NEW) -->
          <div class="w-full mt-2 flex flex-wrap items-center gap-2">
            <span class="text-xs text-muted mr-1">Status:</span>

            <button
              v-for="s in statuses"
              :key="s"
              class="px-2.5 py-1 text-xs rounded-full border"
              :class="(state[p.id].statuses || []).includes(s) ? 'selected-primary' : 'bg-card text-app border-app hover-primary'"
              @click="togglePanelStatus(p.id, s)"
            >
              {{ s }}
            </button>

            <button
              class="ml-auto px-2.5 py-1 text-xs rounded-full border-app bg-card hover-primary"
              title="Select all statuses"
              @click="clearPanelStatuses(p.id)"
            >
              All
            </button>

            <!-- Severity filter (only for Failure card) -->
            <div v-if="p.kind==='failureSeverity'" class="ml-2 inline-flex items-center gap-2">
              <label class="text-xs text-muted">Severity</label>
              <select v-model="state[p.id].severity" class="rounded border-app bg-card text-app px-2 py-1 text-xs">
                <option value="all">All</option>
                <option value="minor">Minor</option>
                <option value="major">Major</option>
                <option value="critical">Critical</option>
              </select>
            </div>
          </div>
        </div>

        
        <!-- Body (resizable) -->
        <div class="px-4 pb-4">
          <div class="relative rounded-xl border-app bg-card text-app overflow-auto" style="min-height: 240px; resize: both;">
            <PanelBody
              :key="'panel-' + p.id"
              :panel="p"
              :state="state[p.id]"
              :data="panelData(p)"
              :chart-options="chartOptions"
            />
          </div>
        </div>
      </div>
    </section>

    <!-- Restore button when all removed -->
    <div v-if="panels.length === 0" class="text-center text-sm text-muted">
      All panels removed. <button class="underline" @click="restoreDefault">Restore defaults</button>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, watch, onMounted, onBeforeUnmount, computed } from 'vue'
import { useUIStore } from '@/stores/ui'
const ui = useUIStore()
import PanelBody from '@/components/PanelBody.vue'
import DashboardFilterBar from '@/components/DashboardFilterBar.vue'
import { useFailureStore } from '@/stores/failures'

const failureStore = useFailureStore()

onMounted(() => {
  failureStore.fetchFailures(); // Initial data load
});

const statuses = ['Active', 'In Progress', 'Resolved', 'On Hold', 'Draft'];

/* ------------------- sample data generator ------------------- */


/* ------------------- board + per-panel state ------------------- */
const panels = ref([
  { id: 'today',       title: "Failure",                    kind: 'count' },
  { id: 'failureSeverity', title: 'Failure',                 kind: 'failureSeverity' },
  { id: 'avgtime',     title: 'Avg. Resolution Time',      kind: 'avgTime' },
  { id: 'bysection',   title: 'Failures by Section',       kind: 'bySection' },
  { id: 'bycircuit',   title: 'Failures by Circuit',       kind: 'byCircuit' },
  { id: 'statusdist',  title: 'Status Distribution',       kind: 'statusDistribution' },
  { id: 'bysuper',     title: 'Failure Count by Supervisor', kind: 'bySupervisor' },
])

const defaultState = () => ({
  type: 'bar',
  range: 'today',
  from: '',
  to: '',
  statuses: [...statuses], // select all by default
  severity: 'all',
})

function togglePanelStatus(id, s) {
  const arr = state[id].statuses || []
  const set = new Set(arr)
  set.has(s) ? set.delete(s) : set.add(s)
  state[id].statuses = Array.from(set)
}
function clearPanelStatuses(id) {
  state[id].statuses = [...statuses] // back to “All”
}


const state = reactive(Object.fromEntries(panels.value.map(p => [p.id, defaultState()])))
state.bysection.range = 'month'
state.bycircuit.range = 'month'
state.statusdist.range = 'month'
state.avgtime.range = 'month'

const liveToday = ref(true)
const liveRecent = ref(true)

// Global Analytics filters (UI only for now)
const filters = ref({ range: 'today', status: ['Active','In Progress','Resolved','On Hold'] })

// ---- persistence (localStorage) ----
const STORAGE_KEY = 'analyticsBoard.v1'

function serializeState() {
  const out = {}
  for (const id of Object.keys(state)) out[id] = { ...state[id] }
  return out
}

function saveBoard() {
  try {
    const payload = {
      panels: panels.value.map(p => ({ id: p.id, title: p.title, kind: p.kind })),
      state: serializeState(),
      liveToday: !!liveToday.value,
      liveRecent: !!liveRecent.value,
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload))
  } catch (e) {
    console.warn('saveBoard failed', e)
  }
}

function loadBoard() {
  let saved = null
  try { saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') } catch (_) {}
  if (!saved || typeof saved !== 'object') return

  if (Array.isArray(saved.panels) && saved.panels.length) {
    panels.value = saved.panels
      .filter(p => p && p.id && p.kind && p.title)
      // Remove deprecated KPI panels per spec
      .filter(p => !['week','pending','recent'].includes(p.id))
      // Rename today's panel to "Failure"
      .map(p => p.id === 'today' ? { ...p, title: 'Failure' } : p)
    // Ensure new Failure-by-Severity card exists
    if (!panels.value.some(p => p.id === 'failureSeverity')) {
      panels.value.splice(1, 0, { id: 'failureSeverity', title: 'Failure', kind: 'failureSeverity' })
    }
  }

  const rebuilt = {}
  for (const p of panels.value) {
    rebuilt[p.id] = { ...defaultState(), ...(saved.state?.[p.id] || {}) }
  }
  Object.keys(state).forEach(k => delete state[k])
  Object.assign(state, rebuilt)

  if (typeof saved.liveToday === 'boolean')  liveToday.value  = saved.liveToday
  if (typeof saved.liveRecent === 'boolean') liveRecent.value = saved.liveRecent
}

// Load any saved layout/settings (now safe)
loadBoard()

// Save whenever layout or settings change
watch(panels, saveBoard, { deep: true })
watch(state,  saveBoard, { deep: true })
watch([liveToday, liveRecent], saveBoard)


/* ------------------- time ranges ------------------- */
const ranges = [
  { key: 'today',  label: 'Today' },
  { key: 'week',   label: 'This Week' },
  { key: 'month',  label: 'This Month' },
  { key: 'year',   label: 'This Year' },
  { key: 'custom', label: 'Custom' },
]
function startOfDay(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return d.getTime() }
function startOfWeek(ts){ const d=new Date(ts); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d.getTime() }
function startOfMonth(ts){ const d=new Date(ts); d.setDate(1); d.setHours(0,0,0,0); return d.getTime() }
function startOfYear(ts){ const d=new Date(ts); d.setMonth(0,1); d.setHours(0,0,0,0); return d.getTime() }
function bounds(rangeKey, from='', to=''){
  const now = Date.now()
  if(rangeKey==='today') return { start: startOfDay(now), end: now }
  if(rangeKey==='week')  return { start: startOfWeek(now), end: now }
  if(rangeKey==='month') return { start: startOfMonth(now), end: now }
  if(rangeKey==='year')  return { start: startOfYear(now), end: now }
  const s = from ? new Date(from).getTime() : startOfDay(now)
  const e = to ? (new Date(to).getTime() + 86399999) : now
  return { start: s, end: e }
}
function setRange(id, key){ state[id].range = key }
function applyCustom(_id){ /* state already holds from/to */ }

/* ------------------- data shaping helpers ------------------- */
const nf = new Intl.NumberFormat('en-IN')
function filterRange(rows, b){ return rows.filter(r => r.reported_at >= b.start && r.reported_at <= b.end) }
function countBy(rows, key){ 
  const m=new Map();
  rows.forEach(r=>{
    let val = r;
    // Handle nested properties like 'section.name'
    if (key.includes('.')) {
      const parts = key.split('.');
      for (const part of parts) {
        val = val ? val[part] : undefined;
      }
    } else {
      val = r[key];
    }
    if (val !== undefined) {
      m.set(val, (m.get(val)||0)+1);
    }
  });
  return m
 }
function toChart(m){ const labels=[...m.keys()]; const data=labels.map(l=>m.get(l)); return {labels, data} }
function avgResolutionMs(rows){
  const done = rows.filter(r => r.current_status==='Resolved' && r.resolved_at && r.reported_at)
  if(!done.length) return 0
  return Math.round(done.reduce((s,r)=>s+(r.resolved_at - r.reported_at),0) / done.length)
}
function fmtDuration(ms){
  if(!ms) return '—'
  const m = Math.round(ms/60000)
  const h = Math.floor(m/60)
  const mm = m%60
  return h? `${h}h ${mm}m` : `${mm}m`
}

/* ------------------- per-panel data ------------------- */
function panelData(p){
  const st = state[p.id]
  const { start, end } = bounds(st.range, st.from, st.to)
  const baseRows = filterRange(failureStore.failures, { start, end })
  const selected = (st.statuses && st.statuses.length) ? new Set(st.statuses) : new Set(statuses)
  const rows = baseRows.filter(r => selected.has(r.current_status))


  switch(p.kind){
    case 'failureSeverity': {
      // provide raw records for the card to aggregate by severity
      return { records: rows }
    }
    case 'count': {
      const byDay = new Map()
      rows.forEach(r=>{
        const d = new Date(r.reported_at); d.setHours(0,0,0,0)
        const k = d.toISOString().slice(0,10)
        byDay.set(k, (byDay.get(k)||0)+1)
      })
      const labels = [...byDay.keys()].sort()
      const data = labels.map(k=>byDay.get(k))
      return { labels, datasets: [{ label: 'Failure Count', data }] }
    }
    case 'pending': {
      const pending = rows.filter(r => r.current_status==='Active' || r.current_status==='In Progress' || r.current_status==='On Hold')
      const m = countBy(pending, 'current_status')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Pending', data }] }
    }
    case 'avgTime': {
      const val = avgResolutionMs(rows)
      return { labels: ['Avg'], datasets: [{ label: fmtDuration(val), data: [Math.round(val/60000)] }], pretty: fmtDuration(val) }
    }
    case 'bySection': {
      const m = countBy(rows, 'section.name')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Failures', data }] }
    }
    case 'byCircuit': {
      const m = countBy(rows, 'circuit')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Failures', data }] }
    }
    case 'statusDistribution': {
      const m = countBy(rows, 'current_status')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Status', data }] }
    }
    case 'bySupervisor': {
      const m = countBy(rows, 'supervisor')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Failures', data }] }
    }
    case 'recent': {
      const recent = [...rows].sort((a,b)=>b.reported_at - a.reported_at).slice(0, 10)
      return { recent }
    }
    default:
      return { labels: [], datasets: [{ label: 'N/A', data: [] }] }
  }
}

/* ------------------- chart options ------------------- */
const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  resizeDelay: 150,
  plugins: {
    legend: { position: 'bottom' },
    tooltip: {
      callbacks: {
        title(ctx){ return ctx?.[0]?.label ?? '' },
        label(ctx){ const v = ctx.parsed?.y ?? ctx.parsed ?? 0; return `${ctx.dataset?.label ?? 'Value'}: ${nf.format(v)}` },
      }
    }
  },
  scales: { y: { beginAtZero: true, ticks: { callback: v => nf.format(v) } } }
}

/* ------------------- drag & drop reorder ------------------- */
let dragFrom = -1
function onDragStart(i){ dragFrom = i }
function onDrop(i){
  if(dragFrom < 0 || dragFrom === i) return
  const arr = panels.value
  const [moved] = arr.splice(dragFrom, 1)
  arr.splice(i, 0, moved)
  dragFrom = -1
}

/* ------------------- fullscreen toggle ------------------- */
const fullscreen = ref(null)
function toggleFullscreen(id){ fullscreen.value = (fullscreen.value === id ? null : id) }
function removePanel(id){
  const i = panels.value.findIndex(p=>p.id===id)
  if(i>=0) panels.value.splice(i,1)
}
function restoreDefault(){
  panels.value = [
    { id: 'today',       title: "Failure",                    kind: 'count' },
    { id: 'failureSeverity', title: 'Failure',                 kind: 'failureSeverity' },
    { id: 'avgtime',     title: 'Avg. Resolution Time',      kind: 'avgTime' },
    { id: 'bysection',   title: 'Failures by Section',       kind: 'bySection' },
    { id: 'bycircuit',   title: 'Failures by Circuit',       kind: 'byCircuit' },
    { id: 'statusdist',  title: 'Status Distribution',       kind: 'statusDistribution' },
    { id: 'bysuper',     title: 'Failure Count by Supervisor', kind: 'bySupervisor' },
  ]
    // reset state for the new set
  const rebuilt = {}
  for (const p of panels.value) rebuilt[p.id] = defaultState()
  Object.keys(state).forEach(k => delete state[k])
  Object.assign(state, rebuilt)
  // clear saved board
  localStorage.removeItem(STORAGE_KEY)
}


</script>

<style scoped>
[draggable="true"] { cursor: move; }
</style>


<script setup>
import { ref, computed, watch, onMounted, onBeforeUnmount } from 'vue';
import { useRouter } from 'vue-router';
import { useFailureStore } from '@/stores/failures';
import { useInfrastructureStore } from '@/stores/infrastructure';
import SplitPane from '@/components/SplitPane.vue';
import KpiCard from '@/components/KpiCard.vue';
import BarChart from '@/components/BarChart.vue';
import LineChart from '@/components/LineChart.vue';
import DashboardFilterBar from '@/components/DashboardFilterBar.vue';
import RecentFailures from '@/components/RecentFailures.vue';
import SectionPicker from '@/components/SectionPicker.vue';
import FailureDetailsDrawer from '@/components/FailureDetailsDrawer.vue';
import { borderColor } from '@/lib/statusColors';
import { withAlpha } from '@/lib/theme';

// --- Store and Router setup ---
const failureStore = useFailureStore();
const infrastructureStore = useInfrastructureStore();
const router = useRouter();

// --- UI Controls & State ---
const topNMode = ref(true);
const topN = ref(10);
const autoRefresh = ref(false);
const intervalMs = ref(30000);
const chartsSplit = ref(60);
const cumulativeMode = ref(true);
const lastUpdated = ref(Date.now());
const isLoading = ref(false);
let refreshTimer = null;
const drawerOpen = ref(false);
const activeItem = ref(null);
const filters = ref({
  range: '30d',
  status: ['Active', 'In Progress', 'Resolved', 'On Hold', 'Draft'],
  sections: [],
});
const split = ref(Number(localStorage.getItem('dashSplit') || 66));

// --- Data Fetching ---
onMounted(() => {
  refresh(); // Initial data load
  startTimer();
});

onBeforeUnmount(() => {
  stopTimer();
});

// --- Helper Functions ---
function toMs(ts) {
  if (ts == null) return null;
  if (typeof ts === 'number') return ts;
  const ms = new Date(ts).getTime();
  return Number.isNaN(ms) ? null : ms;
}

function rangeStart(key) {
  const now = new Date();
  if (key === 'today') return new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
  if (key === '7d') { const d = new Date(now); d.setDate(d.getDate() - 6); d.setHours(0,0,0,0); return d.getTime(); }
  if (key === '30d'){ const d = new Date(now); d.setDate(d.getDate() - 29); d.setHours(0,0,0,0); return d.getTime(); }
  return 0;
}

const nf = new Intl.NumberFormat('en-IN');
const formatInt = n => (typeof n === 'number' ? nf.format(n) : n);

function timeAgo(ts) {
  const ms = toMs(ts);
  if (ms == null) return '—';
  const diff = Date.now() - ms;
  const m = Math.floor(diff / 60000);
  if (m < 1) return 'just now';
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  const d = Math.floor(h / 24);
  return `${d}d ago`;
}

function fmtDuration(ms) {
  if (!ms || ms < 0) return '—';
  const h = Math.floor(ms / 3600000);
  const m = Math.round((ms % 3600000) / 60000);
  return `${h}h ${m}m`;
}

// --- Computed Properties ---
const allSectionsMaster = computed(() =>
  (infrastructureStore.sections || []).map(s => s.name).sort()
);

const startTs = computed(() => rangeStart(filters.value.range));

const filtered = computed(() => {
  const allowedStatus = new Set(filters.value.status);
  const allowedSections = new Set(filters.value.sections || []);
  const ts0 = startTs.value;
  
  return failureStore.failures.filter(f => {
    if (!f) return false;
    if (allowedSections.size && !allowedSections.has(f.section?.name)) return false;
    if (!allowedStatus.has(f.current_status)) return false;
    
    const ts = f.current_status === 'Resolved' ? (toMs(f.resolved_at) ?? toMs(f.reported_at)) : toMs(f.reported_at);
    if (!ts) return false;
    return ts >= ts0;
  });
});

// KPIs
const kpiActive = computed(() => filtered.value.filter(f => f.current_status === 'Active').length);
const kpiResolved = computed(() => filtered.value.filter(f => f.current_status === 'Resolved').length);
const kpiCritical = computed(() => filtered.value.filter(f => f.severity === 'Critical').length);

const avgResolution = computed(() => {
  const res = filtered.value.filter(f => f.current_status === 'Resolved' && f.resolved_at && f.reported_at);
  if (!res.length) return '—';
  const avgMs = res.reduce((sum, f) => sum + (toMs(f.resolved_at) - toMs(f.reported_at)), 0) / res.length;
  return fmtDuration(avgMs);
});

const kpis = computed(() => ([
  { label: 'Active Failures', value: formatInt(kpiActive.value), sublabel: 'in range' },
  { label: 'Resolved', value: formatInt(kpiResolved.value), sublabel: 'in range' },
  { label: 'Avg Resolution Time', value: avgResolution.value, sublabel: 'for range' },
  { label: 'Critical Alerts', value: formatInt(kpiCritical.value), sublabel: 'filtered' },
]));

const recent = computed(() =>
  [...failureStore.failures]
    .sort((a,b) => (toMs(b.reported_at) ?? 0) - (toMs(a.reported_at) ?? 0))
    .slice(0, 8)
);

// --- Chart Specific Computeds ---
const allSectionsInFiltered = computed(() => Array.from(new Set(filtered.value.map(f => f.section?.name))).filter(name => name).sort());

function countBy(sectionName, status) {
  return filtered.value.filter(f => f.section?.name === sectionName && f.current_status === status).length;
}

const statusBySection = computed(() => {
  const labels = allSectionsInFiltered.value;
  const active = labels.map(s => countBy(s, 'Active'));
  const resolved = labels.map(s => countBy(s, 'Resolved'));

  return {
    labels,
    datasets: [
      { label: 'Active', data: active, borderRadius: 6 },
      { label: 'Resolved', data: resolved, borderRadius: 6 },
    ],
  };
});

function buildBuckets() {
  const now = new Date();
  const start = new Date(startTs.value);
  const ends = [];
  const labels = [];
  if (filters.value.range === 'today') {
    for (const h of [0, 4, 8, 12, 16, 20, 23]) {
      const t = new Date(start);
      t.setHours(h, 59, 59, 999);
      if (t.getTime() <= now.getTime() + 3 * 3600 * 1000) {
        ends.push(t.getTime());
        labels.push(new Date(t).toLocaleTimeString([], { hour: '2-digit' }));
      }
    }
  } else {
    const d = new Date(start);
    while (d.getTime() <= now.getTime()) {
      const end = new Date(d);
      end.setHours(23, 59, 59, 999);
      ends.push(end.getTime());
      labels.push(d.toLocaleDateString([], { month: 'short', day: '2-digit' }));
      d.setDate(d.getDate() + 1);
    }
  }
  return { ends, labels };
}

const resolvedOverTime = computed(() => {
  if (!filters.value.status.includes('Resolved')) {
    return { labels: [''], datasets: [{ label: 'Resolved', data: [0] }] };
  }
  const { ends, labels } = buildBuckets();
  const times = filtered.value
    .filter(f => f.current_status === 'Resolved' && f.resolved_at)
    .map(f => toMs(f.resolved_at))
    .filter(ts => ts && ts >= startTs.value)
    .sort((a, b) => a - b);

  const cum = [];
  let i = 0;
  for (const end of ends) {
    while (i < times.length && times[i] <= end) i++;
    cum.push(i);
  }

  const per = cum.map((v, idx) => (idx === 0 ? v : v - cum[idx - 1]));
  const series = cumulativeMode.value ? cum : per;
  const primary = borderColor('Resolved');

  return {
    labels,
    datasets: [{
      label: cumulativeMode.value ? 'Resolved (cumulative)' : 'Resolved (per interval)',
      data: series,
      tension: 0.3,
      fill: true,
      borderColor: primary,
      backgroundColor: withAlpha(primary, 0.2),
    }],
  };
});

const hasBarData = computed(() => {
  const ds = statusBySection.value?.datasets || [];
  return ds.some(d => Array.isArray(d.data) && d.data.some(v => Number(v) > 0));
});

const hasLineData = computed(() => {
  const ds = resolvedOverTime.value?.datasets || [];
  return ds.some(d => Array.isArray(d.data) && d.data.some(v => Number(v) > 0));
});

const rangeLabel = computed(() =>
  filters.value.range === 'today' ? 'today' :
  filters.value.range === '7d' ? 'last 7 days' : 'last 30 days'
);

// --- Action Methods ---
function openDetails(item) {
  activeItem.value = item;
  drawerOpen.value = true;
}

function handleEdit(id) {
    router.push(`/failures/edit/${id}`);
}

function refresh() {
  isLoading.value = true;
  Promise.all([
    failureStore.fetchFailures(),
    infrastructureStore.fetchSections(),
  ]).finally(() => {
    setTimeout(() => {
      lastUpdated.value = Date.now();
      isLoading.value = false;
    }, 600);
  });
}

function startTimer() {
  stopTimer();
  if (autoRefresh.value) {
    refreshTimer = setInterval(refresh, Number(intervalMs.value) || 30000);
  }
}

function stopTimer() {
  if (refreshTimer) {
    clearInterval(refreshTimer);
    refreshTimer = null;
  }
}

function resetFilters() {
    filters.value = { 
        range: '30d', 
        status: ['Active','In Progress','Resolved','On Hold', 'Draft'], 
        sections: [] 
    };
    lastUpdated.value = Date.now();
}

// --- Watchers ---
watch([autoRefresh, intervalMs], startTimer);
watch(split, v => localStorage.setItem('dashSplit', String(v)));

</script>

<template>
  <div class="space-y-6">
    <div class="mt-3 mb-3 flex flex-wrap items-center justify-between gap-3">
      <div class="flex flex-wrap items-center gap-2">
          <DashboardFilterBar v-model="filters" :show-statuses="false" />
          <SectionPicker v-model="filters.sections" :sections="allSectionsMaster" :max-inline="1" placeholder="Search sections…" />
      </div>
      <div class="flex flex-wrap items-center gap-2 shrink-0">
        <select v-model="intervalMs" class="h-10 rounded-lg border-app bg-card text-app px-2 text-sm" title="Auto-refresh interval">
          <option :value="10000">10s</option>
          <option :value="30000">30s</option>
          <option :value="60000">1m</option>
          <option :value="300000">5m</option>
        </select>
        <label class="h-10 inline-flex items-center gap-2 text-sm text-app px-2">
          <input type="checkbox" v-model="autoRefresh" class="h-4 w-4 rounded border-app align-middle" />
          <span class="align-middle">Auto-refresh</span>
        </label>
        <button @click="refresh" :disabled="isLoading" class="h-10 inline-flex items-center gap-2 rounded-lg border-app bg-card text-app px-3 text-sm shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition disabled:opacity-60 disabled:cursor-not-allowed" title="Refresh now">
          <svg viewBox="0 0 24 24" class="w-4 h-4 shrink-0 align-middle"><path fill="currentColor" d="M12 6V3l-4 4l4 4V8c2.76 0 5 2.24 5 5a5 5 0 0 1-8.66 3.54a1 1 0 1 0-1.41 1.41A7 7 0 0 0 19 13c0-3.87-3.13-7-7-7Z"/></svg>
          <span class="leading-none">Refresh</span>
        </button>
        <button @click="resetFilters" :disabled="isLoading" class="h-10 inline-flex items-center gap-2 rounded-lg border-app bg-card text-app px-3 text-sm shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition disabled:opacity-60 disabled:cursor-not-allowed" title="Reset Filters">
          <svg viewBox="0 0 24 24" class="w-4 h-4 shrink-0 align-middle"><path fill="currentColor" d="M12 5a7 7 0 1 1-6.71 9H3a1 1 0 0 1 0-2h4v4a1 1 0 1 1-2 0v-1.52A9 9 0 1 0 12 3a1 1 0 1 1 0 2Z"/></svg>
          <span class="leading-none">Reset</span>
        </button>
      </div>
    </div>
      
    <DashboardFilterBar v-model="filters" :show-ranges="false" />

    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <KpiCard v-for="(kpi, index) in kpis" :key="index" :label="kpi.label" :value="kpi.value" :sublabel="kpi.sublabel" />
    </div>
 
    <SplitPane v-model="split">
      <template #left>
        <SplitPane v-model="chartsSplit" :min-left="35" :max-left="80" class="widget-eq">
          <template #left>
            <div class="rounded-2xl border-app bg-card text-app p-4 relative overflow-hidden shadow-card mr-2 widget-eq-body">
              <div class="mb-2 text-sm font-semibold text-app flex items-center justify-between">
                <span>Status by Section</span>
                <div class="flex items-center gap-2 text-xs font-normal">
                  <label class="inline-flex items-center gap-1">
                    <input type="checkbox" v-model="topNMode" class="h-3.5 w-3.5 rounded border-app" />
                    Top-N
                  </label>
                  <select v-model="topN" :disabled="!topNMode" class="rounded border-app bg-card text-app px-1.5 py-1 disabled:opacity-50" title="How many sections to show">
                    <option :value="5">5</option><option :value="10">10</option><option :value="15">15</option><option :value="20">20</option>
                  </select>
                </div>
              </div>
              <div v-if="!hasBarData && !isLoading" class="h-64 md:h-80 flex items-center justify-center text-sm text-muted">No data for current filters</div>
              <div v-else class="relative h-[300px]"><div class="absolute inset-0"><BarChart :data="statusBySection" /></div></div>
              <div class="mt-2 text-xs text-muted">Last updated: {{ timeAgo(lastUpdated) }}</div>
              <div v-if="isLoading" class="absolute inset-0 bg-card/70 flex items-center justify-center rounded-2xl">
                <svg class="animate-spin h-6 w-6 text-app" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z"/></svg>
              </div>
            </div>
          </template>
          <template #right>
            <div class="rounded-2xl border-app bg-card text-app p-4 relative overflow-hidden shadow-card ml-2 widget-eq-body">
              <div class="mb-2 text-sm font-semibold text-app flex items-center justify-between">
                <span>Resolved over Time ({{ rangeLabel }})</span>
                <label class="inline-flex items-center gap-1 text-xs font-normal">
                  <input type="checkbox" v-model="cumulativeMode" class="h-3.5 w-3.5 rounded border-app" />
                  Cumulative
                </label>
              </div>
              <div v-if="!hasLineData && !isLoading" class="h-64 md:h-80 flex items-center justify-center text-sm text-muted">No data for current filters</div>
              <div v-else class="relative h-[320px]"><div class="absolute inset-0"><LineChart :data="resolvedOverTime" /></div></div>
              <div v-if="isLoading" class="absolute inset-0 bg-card/70 flex items-center justify-center rounded-2xl">
                <svg class="animate-spin h-6 w-6 text-app" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z"/></svg>
              </div>
            </div>
          </template>
        </SplitPane>
      </template>
      <template #right>
        <div class="rounded-2xl border-app bg-card text-app overflow-hidden shadow-card widget-eq">
          <div class="px-4 py-3 border-b border-app text-sm font-semibold">Recent Failures</div>
          <div class="p-2">
            <RecentFailures 
                :items="recent" 
                :show-toolbar="false" 
                :show-bottom-actions="false" 
                :show-row-actions="true" 
                :loading="isLoading" 
                :show-header="false" 
                storage-key="rf-dashboard" 
                @view="openDetails" 
                @edit="handleEdit" 
            />
            <FailureDetailsDrawer v-model="drawerOpen" :item="activeItem" />
          </div>
        </div>
      </template>
    </SplitPane>
  </div>
</template>

<script setup>
import { useRoute } from 'vue-router';
const route = useRoute();
const failureId = route.params.id;
</script>

<template>
  <div class="space-y-4 max-w-4xl mx-auto">
    <div class="text-center">
      <h2 class="text-2xl font-semibold leading-tight">
        Edit Failure Log #{{ failureId }}
      </h2>
      <p class="text-sm text-app/70">
        (WIP: The form will be populated with data in the next step.)
      </p>
    </div>
    <div class="card min-h-[400px]">
      </div>
  </div>
</template>

<script setup>
import { reactive, ref, computed, watch, onMounted } from 'vue'
import InputText from '@/components/form/InputText.vue'
import SelectBox from '@/components/form/SelectBox.vue'
import DateTime from '@/components/form/DateTime.vue'
import SearchSelect from '@/components/form/SearchSelect.vue'
import TagsInput from '@/components/form/TagsInput.vue'
import { useUIStore } from '@/stores/ui'
import RecentFailures from '@/components/RecentFailures.vue'
import NotificationModal from '@/components/NotificationModal.vue' // New import
import { useInfrastructureStore } from '@/stores/infrastructure'
import { useFailureStore } from '@/stores/failures'
import { useTelegramStore } from '@/stores/telegram' // New import
import FailureAttachment from '@/components/FailureAttachment.vue'

const ui = useUIStore()
const infrastructureStore = useInfrastructureStore()
const failureStore = useFailureStore()
const telegramStore = useTelegramStore() // Initialize telegram store

const editingFailureId = ref(null)
const isArchiveModalOpen = ref(false)
const failureToArchive = ref(null)
const archiveReason = ref('')

// New refs for notification modal
const isNotifyModalOpen = ref(false)
const failureToNotify = ref(null)

onMounted(() => {
  Promise.all([
    infrastructureStore.fetchDepots(),
    infrastructureStore.fetchCircuits(),
    infrastructureStore.fetchStations(),
    infrastructureStore.fetchSections(),
    infrastructureStore.fetchSubSections(),
    infrastructureStore.fetchSupervisors(),
    failureStore.fetchFailures(),
    telegramStore.fetchTelegramGroups(), // Fetch Telegram groups on mount
  ])
})

// New function to open notification modal
function openNotifyModal(row) {
  failureToNotify.value = row
  isNotifyModalOpen.value = true
}

const split = ref(50)
const dragging = ref(false)
const splitWrap = ref(null)

function onDragStart(e) {
  dragging.value = true
  window.addEventListener('mousemove', onDrag)
  window.addEventListener('mouseup', onDragEnd)
}
function onDrag(e) {
  if (!splitWrap.value) return
  const rect = splitWrap.value.getBoundingClientRect()
  let pct = ((e.clientX - rect.left) / rect.width) * 100
  pct = Math.max(25, Math.min(75, pct))
  split.value = Math.round(pct)
}
function onDragEnd() {
  dragging.value = false
  window.removeEventListener('mousemove', onDrag)
  window.removeEventListener('mouseup', onDragEnd)
}

const depotOptions = computed(() =>
  infrastructureStore.depots.map(d => ({ label: d.name, value: d.id }))
)
const circuitOptions = computed(() =>
  infrastructureStore.circuits.map(c => ({ label: c.name, value: c.id }))
)
const stationOptions = computed(() =>
  form.depot
    ? infrastructureStore.stations
        .filter(s => s.depot === form.depot)
        .map(s => ({ label: s.name, value: s.id }))
    : []
)
const sectionOptions = computed(() =>
  form.depot
    ? infrastructureStore.sections
        .filter(s => s.depot === form.depot)
        .map(s => ({ label: s.name, value: s.id }))
    : []
)
const subSectionOptions = computed(() =>
  form.section
    ? infrastructureStore.subSections
        .filter(s => s.section === form.section)
        .map(s => ({ label: s.name, value: s.id }))
    : []
)
const supervisorOptions = computed(() =>
  infrastructureStore.supervisors.map(s => ({ label: s.name, value: s.id }))
)

const selectedCircuitSeverity = computed(() => {
  if (!form.circuit) return ''
  const circuit = infrastructureStore.circuits.find(c => c.id === form.circuit)
  return circuit ? circuit.severity : ''
})

const statusOptions = [
  { label: 'Draft', value: 'Draft' },
  { label: 'Active', value: 'Active' },
  { label: 'In Progress', value: 'In Progress' },
  { label: 'Resolved', value: 'Resolved' },
  { label: 'On Hold', value: 'On Hold' },
]

const initialFormState = {
  fail_id: '',
  depot: null,
  circuit: null,
  entry_type: 'item',
  station: null,
  section: null,
  sub_section: null,
  reported_at: new Date().toISOString().slice(0, 16),
  assigned_to: null,
  current_status: 'Active',
  remark_fail: '',
  resolved_at: '',
  duration_minutes: '',
  remark_right: '',
}

const form = reactive({ ...initialFormState })

const errors = reactive({})

const autoTags = computed(() => {
  const t = []
  if (form.depot) {
    const depot = infrastructureStore.depots.find(d => d.id === form.depot)
    if (depot) t.push(`#${depot.name}`)
  }
  if (form.circuit) {
    const circuit = infrastructureStore.circuits.find(c => c.id === form.circuit)
    if (circuit) t.push(`#${circuit.name}`)
  }
  if (form.station) {
    const station = infrastructureStore.stations.find(s => s.id === form.station)
    if (station) t.push(`#${station.name}`)
  }
  if (form.section) {
    const section = infrastructureStore.sections.find(s => s.id === form.section)
    if (section) t.push(`#${section.name}`)
  }
  if (form.sub_section) {
    const subSection = infrastructureStore.subSections.find(s => s.id === form.sub_section)
    if (subSection) t.push(`#${subSection.name}`)
  }
  return t
})

const userTags = ref([])
const allTags = computed(() => [...autoTags.value, ...userTags.value])

function validate() {
  errors.circuit = form.circuit ? '' : 'Required'
  return Object.values(errors).every(v => !v)
}

function nowLocalISO() {
  return new Date(Date.now() - new Date().getSeconds() * 1000 - new Date().getMilliseconds())
    .toISOString()
    .slice(0, 16)
}
function calcDurationMinutes(startISO, endISO) {
  if (!startISO || !endISO) return ''
  const ms = new Date(endISO) - new Date(startISO)
  if (isNaN(ms) || ms < 0) return ''
  return Math.round(ms / 60000)
}

watch(() => form.current_status, v => {
  if (v === 'Resolved' && !form.resolved_at) form.resolved_at = nowLocalISO()
})
watch(() => [form.reported_at, form.resolved_at], ([rep, res]) => {
  form.duration_minutes = calcDurationMinutes(rep, res)
})
watch(() => form.depot, () => {
  form.section = null
  form.station = null
  form.sub_section = null
})
watch(() => form.section, () => {
  form.sub_section = null
})

watch(() => failureStore.currentFailure, (failure) => {
  if (failure) {
    form.fail_id = failure.fail_id
    form.depot = failure.depot?.id
    form.circuit = failure.circuit?.id
    form.entry_type = failure.entry_type
    form.station = failure.station?.id
    form.section = failure.section?.id
    form.sub_section = failure.sub_section?.id
    form.reported_at = failure.reported_at ? new Date(failure.reported_at).toISOString().slice(0, 16) : ''
    form.assigned_to = failure.assigned_to?.id
    form.current_status = failure.current_status
    form.remark_fail = failure.remark_fail
    form.resolved_at = failure.resolved_at ? new Date(failure.resolved_at).toISOString().slice(0, 16) : ''
    form.duration_minutes = failure.duration_minutes
    form.remark_right = failure.remark_right
  }
})

async function saveAsDraft() {
  form.current_status = 'Draft'
  await submit()
}

async function submit() {
  if (!validate()) {
    ui.pushToast({ type: 'error', title: 'Missing fields', message: 'Circuit is required.' })
    return
  }
  const payload = {
    entry_type: form.entry_type,
    current_status: form.current_status,
    circuit: form.circuit,
    station: form.station,
    section: form.section,
    sub_section: form.sub_section,
    assigned_to: form.assigned_to,
    reported_at: form.reported_at,
    resolved_at: form.resolved_at || null,
    remark_fail: form.remark_fail,
    remark_right: form.remark_right,
  }

  if (editingFailureId.value) {
    await failureStore.updateFailure(editingFailureId.value, payload)
    if (!failureStore.error) {
      ui.pushToast({ type: 'success', title: 'Success', message: 'Logbook entry updated.' })
      resetForm()
    }
  } else {
    await failureStore.addFailure(payload)
    if (!failureStore.error) {
      ui.pushToast({ type: 'success', title: 'Success', message: 'Logbook entry saved.' })
      resetForm()
    }
  }
}

function resetForm() {
  Object.assign(form, initialFormState)
  form.reported_at = new Date().toISOString().slice(0, 16)
  userTags.value = []
  editingFailureId.value = null
}

function handleEditRequest(id) {
  editingFailureId.value = id
  failureStore.fetchFailure(id)
}

function openArchiveModal(failure) {
  failureToArchive.value = failure
  isArchiveModalOpen.value = true
  archiveReason.value = ''
}

async function confirmArchive() {
  if (failureToArchive.value) {
    await failureStore.archiveFailure(failureToArchive.value.id, archiveReason.value)
    failureToArchive.value = null
    isArchiveModalOpen.value = false
  }
}

function handleArchiveRequest(failure) {
  openArchiveModal(failure)
}

const recentFailures = computed(() => failureStore.failures)
</script>

<template>
  <div class="flex-1 flex flex-col gap-4 p-4 overflow-y-auto">
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold">New Logbook Entry</h1>
    </div>

    <div ref="splitWrap" class="flex-1 flex gap-2" :class="dragging ? 'cursor-col-resize select-none' : ''">
      <div class="space-y-4" :style="{ width: split + '%' }">
        <div class="card">
          <div class="grid gap-4 sm:grid-cols-2">
            <div class="sm:col-span-2 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
              <div>
                <span class="text-sm text-app">Entry Type</span>
                <div class="flex items-center gap-4 pt-2">
                  <label class="flex items-center gap-2">
                    <input type="radio" v-model="form.entry_type" value="item" class="radio" />
                    <span>Failure</span>
                  </label>
                  <label class="flex items-center gap-2">
                    <input type="radio" v-model="form.entry_type" value="message" class="radio" />
                    <span>General Message</span>
                  </label>
                </div>
              </div>
              <div>
                <label class="block space-y-1">
                  <span class="text-sm text-app">Circuit</span>
                  <SearchSelect v-model="form.circuit" :options="circuitOptions" placeholder="Select circuit..." />
                  <p v-if="errors.circuit" class="text-xs text-red-600">{{ errors.circuit }}</p>
                </label>
              </div>
              <div>
                <label class="block space-y-1">
                  <span class="text-sm text-app">Circuit Severity</span>
                  <input readonly :value="selectedCircuitSeverity" class="field bg-app-hover" />
                </label>
              </div>
            </div>
            <div class="sm:col-span-2">
              <label class="block space-y-1">
                <span class="text-sm text-app">Circuit Tags</span>
                <TagsInput v-model="userTags" :preset="autoTags" placeholder="Add tag and press Enter" />
                <p class="text-xs text-muted">Auto from selections; you can add/remove your own.</p>
              </label>
            </div>
            <div class="sm:col-span-2 grid gap-4 sm:grid-cols-2 md:grid-cols-4">
              <div>
                <label class="block space-y-1">
                  <span class="text-sm text-app">Depot</span>
                  <SearchSelect v-model="form.depot" :options="depotOptions" placeholder="Select depot..." />
                </label>
              </div>
              <div>
                <label class="block space-y-1">
                  <span class="text-sm text-app">Station</span>
                  <SearchSelect v-model="form.station" :options="stationOptions" placeholder="Select station..." />
                </label>
              </div>
              <div>
                <label class="block space-y-1">
                  <span class="text-sm text-app">Section</span>
                  <SearchSelect v-model="form.section" :options="sectionOptions" placeholder="Select section..." />
                </label>
              </div>
              <div>
                <label class="block space-y-1">
                  <span class="text-sm text-app">Sub Section</span>
                  <SearchSelect v-model="form.sub_section" :options="subSectionOptions" placeholder="Select sub section..." />
                </label>
              </div>
            </div>
            <div class="sm:col-span-2 grid gap-4 grid-cols-1 md:grid-cols-3">
              <DateTime label="Reported At" v-model="form.reported_at" />
              <div>
                <label class="block space-y-1">
                  <span class="text-sm text-app">Assigned To</span>
                  <SearchSelect v-model="form.assigned_to" :options="supervisorOptions" placeholder="Select assignee..." />
                </label>
              </div>
              <div>
                <label class="block space-y-1">
                  <span class="text-sm text-app">Current Status</span>
                  <SearchSelect v-model="form.current_status" :options="statusOptions" placeholder="Select status..." />
                </label>
              </div>
            </div>
            <div class="sm:col-span-2">
              <textarea v-model="form.remark_fail" rows="2" class="field-textarea" placeholder="Notes..."></textarea>
            </div>
            <template v-if="form.current_status === 'Resolved'">
              <DateTime label="Resolve At" v-model="form.resolved_at" />
              <InputText label="Duration (minutes)" v-model="form.duration_minutes" />
              <textarea v-model="form.remark_right" rows="2" class="sm:col-span-2 field-textarea" placeholder="Notes on resolution..."></textarea>
            </template>
            <FailureAttachment v-if="editingFailureId" :failure-id="editingFailureId" />
            <div class="sm:col-span-2 flex items-center justify-between pt-2">
              <button type="button" class="btn btn-solid" @click="saveAsDraft">
                Save as Draft
              </button>
              <div class="flex gap-3">
                <button type="button" class="btn btn-outline" @click="resetForm">{{ editingFailureId ? 'Cancel Edit' : 'Reset' }}</button>
                <button type="button" class="btn btn-primary" @click="submit">{{ editingFailureId ? 'Save Changes' : 'Submit' }}</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div
        class="w-1 self-stretch bg-[var(--border)] hover:bg-[var(--text)]/30 cursor-col-resize rounded"
        :class="dragging ? 'bg-[var(--text)]/40' : ''"
        @mousedown="onDragStart"
      />

      <div class="space-y-4" :style="{ width: 100 - split + '%' }">
        <RecentFailures
          :items="recentFailures"
          storage-key="rf-newfailure"
          :editing-id="editingFailureId"
          @view="row => console.log('open details', row)"
          @notify="openNotifyModal"
          @edit="handleEditRequest"
          @delete="handleArchiveRequest"
        />
      </div>
    </div>

    <!-- Notification Modal -->
    <NotificationModal v-model="isNotifyModalOpen" :failure="failureToNotify" />

    <!-- Archive Confirmation Modal -->
    <div v-if="isArchiveModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div class="bg-card rounded-lg p-6 shadow-xl w-full max-w-md">
        <h3 class="text-lg font-bold">Confirm Archival</h3>
        <p class="mt-2">
          Are you sure you want to archive failure log
          <span class="font-semibold">{{ failureToArchive?.fail_id }}</span>?
        </p>
        <div class="mt-4">
          <label for="archiveReason" class="block text-sm font-medium text-app">Reason for archiving</label>
          <textarea v-model="archiveReason" id="archiveReason" rows="3" class="field-textarea mt-1"></textarea>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button @click="isArchiveModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmArchive" class="btn btn-danger">Archive</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import DataTable from '@/components/DataTable.vue'
import FailureDetailsDrawer from '@/components/FailureDetailsDrawer.vue'
import Spinner from '@/components/ui/Spinner.vue'
import SearchSelect from '@/components/form/SearchSelect.vue'
import { Bell, Pencil, Trash2, FileDown, FileText, ChevronLeft, ChevronRight, ChevronsLeft, ChevronsRight } from 'lucide-vue-next'
import { useFailureStore } from '@/stores/failures'
import { useInfrastructureStore } from '@/stores/infrastructure'

// --- Store setup ---
const failureStore = useFailureStore()
const infrastructureStore = useInfrastructureStore()
const router = useRouter()

// --- UI State ---
const drawerOpen = ref(false)
const activeItem = ref(null)
const isArchiveModalOpen = ref(false)
const failureToArchive = ref(null)
const archiveReason = ref('')

// --- Filtering, Sorting, and Pagination State ---
const query = ref('')
const selectedCircuits = ref([])
const selectedSections = ref([])
const selectedStations = ref([])
const selectedSupervisors = ref([])
const selectedStatuses = ref([])
const sortKey = ref('reported_at')
const sortDir = ref('desc')
const currentPage = ref(1)
const rowsPerPage = ref(20)

// --- Data Fetching ---
onMounted(() => {
  failureStore.fetchFailures()
  // Fetch data for filter dropdowns if not already loaded
  if (infrastructureStore.circuits.length === 0) infrastructureStore.fetchCircuits()
  if (infrastructureStore.sections.length === 0) infrastructureStore.fetchSections()
  if (infrastructureStore.stations.length === 0) infrastructureStore.fetchStations()
  if (infrastructureStore.supervisors.length === 0) infrastructureStore.fetchSupervisors()
})

// --- Computed Data for UI ---
const loading = computed(() => failureStore.loading)
const error = computed(() => failureStore.error)

// --- Options for Filter Dropdowns ---
const circuitOptions = computed(() => infrastructureStore.circuits.map(c => ({ label: `${c.circuit_id} (${c.name})`, value: c.id })))
const sectionOptions = computed(() => infrastructureStore.sections.map(s => ({ label: s.name, value: s.id })))
const stationOptions = computed(() => infrastructureStore.stations.map(s => ({ label: s.name, value: s.id })))
const supervisorOptions = computed(() => infrastructureStore.supervisors.map(s => ({ label: s.name, value: s.id })))
const statusOptions = computed(() => ([
    { label: 'Active', value: 'Active' }, { label: 'In Progress', value: 'In Progress' },
    { label: 'Resolved', value: 'Resolved' }, { label: 'On Hold', value: 'On Hold' },
]))

// --- Filtering & Sorting Logic ---
const filteredRows = computed(() => {
  const q = query.value.trim().toLowerCase()
  return failureStore.failures.filter(row => {
    if (!row) return false;
    // Check against text query
    const inQuery = q ? JSON.stringify(row).toLowerCase().includes(q) : true
    // Check against dropdown filters (IDs)
    const inCircuits = selectedCircuits.value.length ? selectedCircuits.value.includes(row.circuit?.id) : true
    const inSections = selectedSections.value.length ? selectedSections.value.includes(row.section?.id) : true
    const inStations = selectedStations.value.length ? selectedStations.value.includes(row.station?.id) : true
    const inSupervisors = selectedSupervisors.value.length ? selectedSupervisors.value.includes(row.assigned_to?.id) : true
    const inStatuses = selectedStatuses.value.length ? selectedStatuses.value.includes(row.current_status) : true
    
    return inQuery && inCircuits && inSections && inStations && inSupervisors && inStatuses
  })
})

const sortedRows = computed(() => {
    const data = [...filteredRows.value];
    if (!sortKey.value) return data;

    return data.sort((a, b) => {
        let valA, valB;

        // Handle nested properties for sorting
        switch (sortKey.value) {
            case 'circuit':
                valA = a.circuit?.name;
                valB = b.circuit?.name;
                break;
            case 'station':
                valA = a.station?.name;
                valB = b.station?.name;
                break;
            case 'section':
                valA = a.section?.name;
                valB = b.section?.name;
                break;
            case 'assigned_to':
                valA = a.assigned_to?.name;
                valB = b.assigned_to?.name;
                break;
            default:
                valA = a[sortKey.value];
                valB = b[sortKey.value];
        }
          
        const dir = sortDir.value === 'asc' ? 1 : -1;
        
        // Handle nulls by sorting them to the bottom
        if (valA == null) return 1 * dir;
        if (valB == null) return -1 * dir;
        if (valA < valB) return -1 * dir;
        if (valA > valB) return 1 * dir;
        return 0;
    });
});


const totalPages = computed(() => Math.ceil(sortedRows.value.length / rowsPerPage.value))
const paginatedRows = computed(() => {
  const start = (currentPage.value - 1) * rowsPerPage.value
  const end = start + rowsPerPage.value
  return sortedRows.value.slice(start, end)
})

// --- Methods ---
function toggleSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc'
  } else {
    sortKey.value = key
    sortDir.value = 'desc' // Default to descending for new sort keys
  }
}

function openDetails(row) {
  activeItem.value = row
  drawerOpen.value = true
}

function editFailure(row) {
  router.push(`/failures/edit/${row.id}`)
}

function openArchiveModal(row) {
  failureToArchive.value = row
  isArchiveModalOpen.value = true
  archiveReason.value = ''
}

async function confirmArchive() {
  if (failureToArchive.value) {
    await failureStore.archiveFailure(failureToArchive.value.id, archiveReason.value)
    failureToArchive.value = null
    isArchiveModalOpen.value = false
  }
}

function formatDuration(start, end) {
  if (!start || !end) return '–'
  const diff = new Date(end) - new Date(start)
  if (diff < 0) return '–'
  const minutes = Math.floor(diff / 60000)
  if (minutes < 60) return `${minutes}m`
  const hours = Math.floor(minutes / 60)
  const mins = minutes % 60
  return `${hours}h ${mins}m`
}

const columns = [
  { key: 'reported_at', label: 'Reported', sortable: true },
  { key: 'resolved_at', label: 'Resolved', sortable: true },
  { key: 'duration',    label: 'Duration', sortable: false, align: 'text-center' },
  { key: 'fail_id',     label: 'Event ID', sortable: true },
  { key: 'circuit',     label: 'Circuit', sortable: true },
  { key: 'station',     label: 'Station', sortable: true },
  { key: 'section',     label: 'Section', sortable: true },
  { key: 'assigned_to', label: 'Assigned', sortable: true },
  { key: 'current_status', label: 'Status', sortable: true },
  { key: 'actions',     label: 'Actions', sortable: false, align: 'text-center', width: '120px' },
]

function badgeClasses(status) {
    if (status === 'Resolved') return 'badge-success'
    if (status === 'Active') return 'badge-danger'
    if (status === 'In Progress') return 'badge-warning'
    if (status === 'On Hold') return 'badge-hold'
    return 'badge-neutral'
}

// --- Pagination Methods ---
function goToFirstPage() { currentPage.value = 1 }
function goToLastPage() { currentPage.value = totalPages.value }
function goToNextPage() { if (currentPage.value < totalPages.value) currentPage.value++ }
function goToPreviousPage() { if (currentPage.value > 1) currentPage.value-- }
</script>

<template>
  <div class="space-y-4">
    <div class="text-center">
      <h2 class="text-2xl font-semibold">Logbook</h2>
    </div>

    <!-- Filter Bar -->
    <div class="sticky top-0 z-10 bg-app py-4 card">
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
        <input v-model="query" type="search" placeholder="Search anything..." class="h-11 w-full rounded-lg border-app bg-card text-app px-3 text-sm" />
        <SearchSelect v-model="selectedCircuits" :options="circuitOptions" placeholder="Filter by Circuit" multiple />
        <SearchSelect v-model="selectedSections" :options="sectionOptions" placeholder="Filter by Section" multiple />
        <SearchSelect v-model="selectedStations" :options="stationOptions" placeholder="Filter by Station" multiple />
        <SearchSelect v-model="selectedSupervisors" :options="supervisorOptions" placeholder="Filter by Supervisor" multiple />
        <SearchSelect v-model="selectedStatuses" :options="statusOptions" placeholder="Filter by Status" multiple />
      </div>
    </div>

    <div v-if="loading" class="text-center p-6"><Spinner /></div>
    <div v-else-if="error" class="card p-6 text-center text-red-500">{{ error }}</div>

    <div v-else>
      <div class="card p-4">
        <DataTable
          :columns="columns"
          :rows="paginatedRows"
          :sort-key="sortKey"
          :sort-dir="sortDir"
          @sort="toggleSort"
          @rowclick="openDetails"
        >
          <template #body-cell-comp="{ row, column }">
            <tr :class="{ 'opacity-60': row.is_archived }">
              <component :is="column.cell" :row="row" />
            </tr>
          </template>
          <template #reported_at="{ row }">{{ new Date(row.reported_at).toLocaleString() }}</template>
          <template #resolved_at="{ row }">{{ row.resolved_at ? new Date(row.resolved_at).toLocaleString() : '–' }}</template>
          <template #duration="{ row }">{{ formatDuration(row.reported_at, row.resolved_at) }}</template>
          <template #circuit="{ row }">{{ row.circuit?.name || '–' }}</template>
          <template #station="{ row }">{{ row.station?.name || '–' }}</template>
          <template #section="{ row }">{{ row.section?.name || '–' }}</template>
          <template #assigned_to="{ row }">{{ row.assigned_to?.name || '–' }}</template>
          <template #current_status="{ row }"><span class="badge" :class="badgeClasses(row.current_status)">{{ row.current_status }}</span></template>
          <template #actions="{ row }">
            <div class="flex items-center justify-center gap-1.5">
              <button class="btn-ghost border-app rounded-md hover-primary p-2" title="Notify" @click.stop disabled><Bell class="w-4 h-4" /></button>
              <button class="btn-ghost border-app rounded-md hover-primary p-2" title="Edit" @click.stop="editFailure(row)"><Pencil class="w-4 h-4" /></button>
              <button class="btn-ghost border-app rounded-md hover-primary p-2" title="Archive" @click.stop="openArchiveModal(row)"><Trash2 class="w-4 h-4" /></button>
            </div>
          </template>
        </DataTable>
      </div>
        
      <!-- Pagination Controls -->
      <div class="mt-4 flex items-center justify-between">
        <div class="flex items-center justify-center gap-2 p-2 rounded-lg">
          <button class="btn btn-outline btn-sm gap-2"><FileDown class="w-4 h-4" /><span>Export CSV</span></button>
          <button class="btn btn-outline btn-sm gap-2"><FileText class="w-4 h-4" /><span>Export PDF</span></button>
        </div>
        <div class="flex items-center justify-end gap-2 p-2 rounded-lg">
          <button @click="goToFirstPage" :disabled="currentPage === 1" class="btn-ghost p-2" title="First"><ChevronsLeft class="w-4 h-4" /></button>
          <button @click="goToPreviousPage" :disabled="currentPage === 1" class="btn-ghost p-2" title="Previous"><ChevronLeft class="w-4 h-4" /></button>
          <span class="text-sm text-muted">Page {{ currentPage }} of {{ totalPages }}</span>
          <button @click="goToNextPage" :disabled="currentPage >= totalPages" class="btn-ghost p-2" title="Next"><ChevronRight class="w-4 h-4" /></button>
          <button @click="goToLastPage" :disabled="currentPage >= totalPages" class="btn-ghost p-2" title="Last"><ChevronsRight class="w-4 h-4" /></button>
        </div>
      </div>
    </div>

    <FailureDetailsDrawer v-model="drawerOpen" :item="activeItem" />

    <!-- Archive Confirmation Modal -->
    <div v-if="isArchiveModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div class="bg-card rounded-lg p-6 shadow-xl w-full max-w-md">
        <h3 class="text-lg font-bold">Confirm Archival</h3>
        <p class="mt-2">
          Are you sure you want to archive failure log
          <span class="font-semibold">{{ failureToArchive?.fail_id }}</span>?
        </p>
        <div class="mt-4">
          <label for="archiveReason" class="block text-sm font-medium text-app">Reason for archiving</label>
          <textarea v-model="archiveReason" id="archiveReason" rows="3" class="field-textarea mt-1"></textarea>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button @click="isArchiveModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmArchive" class="btn btn-danger">Archive</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { reactive } from 'vue'
import InputText from '@/components/form/InputText.vue'
import { useRouter, useRoute } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { useUIStore } from '@/stores/ui'

const router = useRouter()
const route = useRoute()
const auth = useAuthStore()
const ui = useUIStore()

const form = reactive({ username: '', password: '' })
const errors = reactive({ username: '', password: '' })

function validate() {
  errors.username = form.username ? '' : 'Required'
  errors.password = form.password ? '' : 'Required'
  return !errors.username && !errors.password
}

async function submit() {
  if (!validate()) return ui.pushToast({ type: 'error', title: 'Missing fields', message: 'Enter username & password.' })
  try {
    await auth.login(form) // mock for now
    ui.pushToast({ type: 'success', title: 'Welcome', message: `Logged in as ${auth.user.username}` })
    const next = (route.query.next && String(route.query.next)) || '/dashboard'
    router.push(next)
  } catch (e) {
    ui.pushToast({ type: 'error', title: 'Login failed', message: e?.message || 'Try again.' })
  }
}
</script>

<template>
  <div class="min-h-[60vh] flex items-center justify-center p-6">
    <div class="w-full max-w-sm rounded-2xl border bg-white p-6">
      <div>
        <h2 class="text-xl font-semibold">Sign in</h2>
        <p class="text-sm text-gray-500">Demo auth — will connect to Django later.</p>
      </div>
      <form class="space-y-4 mt-4" @submit.prevent="submit">
        <div class="space-y-3">
          <InputText label="Username" v-model="form.username" :error="errors.username" placeholder="e.g. admin" />
          <InputText label="Password" v-model="form.password" :error="errors.password" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
        <button type="submit" class="btn w-full">Sign in</button>
      </form>
    </div>
  </div>
</template>


<script setup>
import WidgetShell from '@/components/WidgetShell.vue'
import { computed, ref } from 'vue'
import { useReportsStore } from '@/stores/reports.js'
import { useTelegramStore } from '@/stores/telegram.js'

const reports = useReportsStore()
const tg = useTelegramStore()
const rows = computed(() => reports.items)
const tgOptions = computed(() => tg.list)

const sendingIds = ref(new Set())

function sendNow(row) {
  const payload = {
    id: row.id,
    name: row.name,
    templateName: row.templateName,
    sendEmail: row.sendEmail ?? false,
    sendTelegram: row.sendTelegram ?? false,
    telegramGroupKey: row.telegramGroupKey ?? 'reports',
  }
  sendingIds.value.add(row.id)
  setTimeout(() => {
    console.log('[ReportsNow] SEND NOW payload:', payload)
    alert(`Queued send for “${row.name}”\nEmail: ${payload.sendEmail}\nTelegram: ${payload.sendTelegram} (${payload.telegramGroupKey})`)
    sendingIds.value.delete(row.id)
  }, 400)
}
</script>

<template>
  <div class="p-4 md:p-6 space-y-4">
    <h1 class="text-xl md:text-2xl font-semibold">Reports Now</h1>

    <WidgetShell :hideHeader="true">
      <div class="space-y-3">
        <p class="text-sm opacity-80">Trigger any defined report immediately. (Frontend-only mock)</p>

        <div class="overflow-x-auto">
          <table class="min-w-[960px] w-full text-sm">
            <thead>
              <tr class="text-left border-b border-[var(--surface-3)]">
                <th class="py-2 pr-3 w-[280px]">Report</th>
                <th class="py-2 pr-3 w-[220px]">Template</th>
                <th class="py-2 pr-3 w-[140px]">Email</th>
                <th class="py-2 pr-3 w-[240px]">Telegram</th>
                <th class="py-2 pr-0  w-[120px]">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="r in rows" :key="r.id" class="border-b border-[var(--surface-2)]">
                <td class="py-2 pr-3">
                  <div class="font-medium">{{ r.name || '—' }}</div>
                  <div class="text-xs opacity-70">ID: {{ r.id.slice(0,8) }}</div>
                </td>
                <td class="py-2 pr-3">
                  <span class="opacity-80">{{ r.templateName || 'No file chosen' }}</span>
                </td>
                <td class="py-2 pr-3">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" v-model="r.sendEmail" />
                    <span>Send Email</span>
                  </label>
                </td>
                <td class="py-2 pr-3">
                  <div class="flex flex-wrap items-center gap-2">
                    <label class="inline-flex items-center gap-2">
                      <input type="checkbox" v-model="r.sendTelegram" />
                      <span>Telegram</span>
                    </label>
                    <select
                      class="chip"
                      :disabled="!r.sendTelegram"
                      :value="r.telegramGroupKey ?? 'reports'"
                      @change="reports.update(r.id, { telegramGroupKey: $event.target.value })"
                    >
                      <option v-for="g in tgOptions" :key="g.key" :value="g.key">{{ g.name }}</option>
                    </select>
                  </div>
                </td>
                <td class="py-2 pr-0">
                  <button
                    class="chip selected-primary"
                    :disabled="sendingIds.has(r.id) || (!r.sendEmail && !r.sendTelegram)"
                    @click="sendNow(r)"
                  >
                    {{ sendingIds.has(r.id) ? 'Sending…' : 'Send Now' }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <p class="text-xs opacity-70">
          Note: backend/bot wiring comes later; this page logs a mock payload.
        </p>
      </div>
    </WidgetShell>
  </div>
</template>

<style scoped></style>



<script setup>
import InputText from '@/components/form/InputText.vue'
import SelectBox from '@/components/form/SelectBox.vue'
import { reactive } from 'vue'
import { useAppStore } from '@/stores/app'
import { useUIStore } from '@/stores/ui'

const app = useAppStore()
const ui = useUIStore()

// demo form state (later we’ll load/save via API)
const form = reactive({
  appName: app.appName,

  realtimeIntervalSec: '30',
  failIdSeparator: '-',
})

const intervalOptions = [
  { label: '10 sec', value: '10' },
  { label: '20 sec', value: '20' },
  { label: '30 sec', value: '30' },
  { label: '60 sec', value: '60' },
]

function save() {
  // for now, just update the store for app name and toast
  app.setAppName(form.appName || 'Railway Failure System')
  ui.pushToast({ type: 'success', title: 'Saved', message: 'Settings updated (local only).' })
}
</script>

<template>
  <div class="space-y-6 max-w-3xl">
    <div>
      <h2 class="text-2xl font-semibold">Settings</h2>
      <p class="text-sm text-gray-500">UI-only for now. We’ll wire to Django later.</p>
    </div>
    <div class="rounded-2xl border bg-white p-4 space-y-6">
      <section class="space-y-3">
        <h3 class="text-sm font-semibold text-gray-700">General</h3>
        <InputText label="Application Name" v-model="form.appName" placeholder="Railway Failure System" />
        <SelectBox label="Realtime Update Interval" v-model="form.realtimeIntervalSec" :options="intervalOptions" />
      </section>

      <section class="space-y-3">
        <h3 class="text-sm font-semibold text-gray-700">Event ID</h3>
        <InputText label="Separator" v-model="form.failIdSeparator" placeholder="-" />
      </section>

      <div class="flex gap-2">
        <button @click="save" class="btn">Save</button>
        <button
          @click="Object.assign(form,{ appName:'Railway Failure System', realtimeIntervalSec:'30', failIdSeparator:'-' })"
          class="btn btn-outline"
        >
          Reset
        </button>
      </div>
    </div>
    <div class="rounded-2xl border bg-white p-4 mt-6">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Buttons Preview</h3>
        <div class="flex flex-wrap gap-3">
          <button class="btn">Primary</button>
          <button class="btn btn-secondary">Secondary</button>
          <button class="btn btn-outline">Outline</button>
          <button class="btn btn-ghost">Ghost</button>
        </div>
    </div>
  </div>
</template>


<script setup>
import { ref, computed, onMounted, watch } from 'vue';
import { useSupervisorMovementsStore } from '@/stores/supervisorMovements';
import { useInfrastructureStore } from '@/stores/infrastructure';
import { Save, Send } from 'lucide-vue-next';

// --- Store Setup ---
const movementsStore = useSupervisorMovementsStore();
const infrastructureStore = useInfrastructureStore();

// --- State ---
const today = new Date().toISOString().slice(0, 10);
const selectedDate = ref(today);
const supervisorData = computed(() => movementsStore.dailyMovements);
const supervisorOptions = computed(() => infrastructureStore.supervisors.map(s => ({ value: s.id, label: s.name })));

const editableData = ref([]);
const dirtyRows = ref(new Set());
const sortKey = ref('name');
const sortDir = ref('asc');

// --- Data Fetching ---
onMounted(() => {
  movementsStore.fetchMovementsByDate(selectedDate.value);
  infrastructureStore.fetchSupervisors();
});

// --- Sorting Logic ---
const sortedData = computed(() => {
    const data = [...editableData.value];
    if (!sortKey.value) return data;
    return data.sort((a, b) => {
        let valA, valB;
        if (['location', 'purpose'].includes(sortKey.value)) {
            valA = a.movement?.[sortKey.value] || '';
            valB = b.movement?.[sortKey.value] || '';
        } else {
            valA = a[sortKey.value] || '';
            valB = b[sortKey.value] || '';
        }
        
        const modifier = sortDir.value === 'asc' ? 1 : -1;
        if (valA < valB) return -1 * modifier;
        if (valA > valB) return 1 * modifier;
        return 0;
    });
});

function toggleSort(key) {
    if (sortKey.value === key) {
        sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
    } else {
        sortKey.value = key;
        sortDir.value = 'asc';
    }
}


// --- Main Logic ---
watch(selectedDate, (newDate) => {
  if (newDate) {
    movementsStore.fetchMovementsByDate(newDate);
    dirtyRows.value.clear();
  }
});

watch(supervisorData, (newData) => {
  editableData.value = JSON.parse(JSON.stringify(newData || [])).map(supervisor => {
    if (!supervisor.movement) {
      supervisor.movement = {
        location: '', on_leave: false, leave_from: null,
        leave_to: null, look_after: null, purpose: '',
      };
    }
    return supervisor;
  });
}, { deep: true, immediate: true });


function markAsDirty(supervisorId) {
  dirtyRows.value.add(supervisorId);
}

async function handleSaveAll() {
  const promises = [];
  for (const supervisorId of dirtyRows.value) {
    const supervisorRow = editableData.value.find(s => s.id === supervisorId);
    if (supervisorRow && supervisorRow.movement) {
      const payload = {
        id: supervisorRow.movement.id,
        date: selectedDate.value,
        supervisor: supervisorRow.id,
        location: supervisorRow.movement.location || '',
        on_leave: supervisorRow.movement.on_leave || false,
        leave_from: supervisorRow.movement.leave_from || null,
        leave_to: supervisorRow.movement.leave_to || null,
        look_after: supervisorRow.movement.look_after || null,
        purpose: supervisorRow.movement.purpose || '',
      };
      if (!payload.on_leave) {
        payload.leave_from = null;
        payload.leave_to = null;
        payload.look_after = null;
      }
      promises.push(movementsStore.saveMovement(payload));
    }
  }
  await Promise.all(promises);
  dirtyRows.value.clear();
}

async function handleSendReport() {
    movementsStore.sendMovementReport(selectedDate.value);
}
</script>

<template>
  <div class="space-y-4">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <h1 class="text-2xl font-bold">Supervisor Movements</h1>
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <label for="movement-date" class="text-sm font-medium">Date:</label>
                <input type="date" id="movement-date" v-model="selectedDate" class="field h-10 w-48" />
            </div>
            <div class="flex items-center gap-2">
                 <button 
                    @click="handleSaveAll" 
                    class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" 
                    :disabled="dirtyRows.size === 0 || movementsStore.loading" 
                    title="Save All Changes">
                    <Save class="w-5 h-5" />
                </button>
                <button 
                    @click="handleSendReport" 
                    class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--french-gray)] text-[var(--eerie-black)] hover:bg-[var(--french-gray-lighter)] transition"
                    :disabled="movementsStore.loading"
                    title="Send Report">
                    <Send class="w-5 h-5" />
                </button>
            </div>
        </div>
    </div>

    <div v-if="movementsStore.loading" class="text-center py-10 text-muted">Loading...</div>
    <div v-else-if="movementsStore.error" class="text-center py-10 text-red-500">{{ movementsStore.error }}</div>

    <div v-else class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <colgroup>
            <col class="w-[15%]" />
            <col class="w-[15%]" />
            <col class="w-[15%]" />
            <col class="w-[10%]" />
            <col class="w-[10%]" />
            <col class="w-[20%]" />
            <col class="w-[15%]" />
          </colgroup>
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('depot_name')" class="py-2.5 px-3 cursor-pointer select-none">Depot <span v-if="sortKey === 'depot_name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('name')" class="py-2.5 px-3 cursor-pointer select-none">Name <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('designation')" class="py-2.5 px-3 cursor-pointer select-none">Designation <span v-if="sortKey === 'designation'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('location')" class="py-2.5 px-3 cursor-pointer select-none">Location <span v-if="sortKey === 'location'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3">On Leave</th>
              <th class="py-2.5 px-3">Leave Details</th>
              <th class="py-2.5 px-3">Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="row in sortedData" :key="row.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-top font-semibold">{{ row.depot_name || 'N/A' }}</td>
              <td class="py-2 px-3 align-top">{{ row.name }}</td>
              <td class="py-2 px-3 align-top text-muted">{{ row.designation }}</td>
              <td class="py-2 px-3 align-top">
                <input v-model="row.movement.location" class="field h-9" placeholder="Location" @change="markAsDirty(row.id)" />
              </td>
              <td class="py-2 px-3 align-top">
                <label class="inline-flex items-center gap-2 mt-2">
                  <input type="checkbox" v-model="row.movement.on_leave" class="h-4 w-4" @change="markAsDirty(row.id)" />
                </label>
              </td>
              <td class="py-2 px-3 align-top">
                <div v-if="row.movement.on_leave" class="space-y-2">
                  <div class="grid grid-cols-2 gap-2">
                    <input type="date" v-model="row.movement.leave_from" class="field h-9" title="Leave From" @change="markAsDirty(row.id)" />
                    <input type="date" v-model="row.movement.leave_to" class="field h-9" title="Leave To" @change="markAsDirty(row.id)" />
                  </div>
                  <select v-model="row.movement.look_after" class="field h-9" title="Looked After By" @change="markAsDirty(row.id)">
                    <option :value="null">-- Looked After By --</option>
                    <option v-for="opt in supervisorOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                  </select>
                </div>
              </td>
              <td class="py-2 px-3 align-top">
                 <input type="text" v-model="row.movement.purpose" class="field h-9" placeholder="Purpose / Remarks..." @change="markAsDirty(row.id)" maxlength="100" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>


<script setup>
import { onMounted, computed, ref } from 'vue'
import { useInfrastructureStore } from '@/stores/infrastructure.js'
import { Trash2 } from 'lucide-vue-next'

const infrastructureStore = useInfrastructureStore()

const rows = computed(() => infrastructureStore.circuits)

// --- Sorting State ---
const sortKey = ref('circuit_id');
const sortDir = ref('asc');

const sortedRows = computed(() => {
  const data = [...rows.value];
  data.sort((a, b) => {
    let valA = a[sortKey.value] || '';
    let valB = b[sortKey.value] || '';
    const modifier = sortDir.value === 'asc' ? 1 : -1;
    if (valA < valB) return -1 * modifier;
    if (valA > valB) return 1 * modifier;
    return 0;
  });
  return data;
});

function toggleSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
  } else {
    sortKey.value = key;
    sortDir.value = 'asc';
  }
}

onMounted(() => {
  infrastructureStore.fetchCircuits()
})

const severityOptions = ['Minor', 'Major', 'Critical']

// --- Modal State ---
const isModalOpen = ref(false)
const currentCircuit = ref(null)
const isDeleteModalOpen = ref(false)
const circuitToDelete = ref(null)

// --- File Upload State ---
const selectedFile = ref(null)
const fileInput = ref(null)

function handleFileSelect(event) {
  const target = event.target;
  if (target.files && target.files[0]) {
    selectedFile.value = target.files[0];
  }
}

function triggerFileInput() {
  fileInput.value?.click();
}

async function handleFileUpload() {
  if (!selectedFile.value) {
    alert('Please select a file to upload.');
    return;
  }
  await infrastructureStore.uploadCircuitsFile(selectedFile.value);
  selectedFile.value = null;
  if(fileInput.value) fileInput.value.value = '';
}


function openAddModal() {
  currentCircuit.value = {
    circuit_id: '',
    name: '',
    related_equipment: '',
    severity: 'Minor',
    details: ''
  };
  isModalOpen.value = true;
}

function openEditModal(circuit) {
  currentCircuit.value = { ...circuit }; // Create a copy for editing
  isModalOpen.value = true;
}

async function saveChanges() {
  if (!currentCircuit.value) return;
  if (currentCircuit.value.id) {
    // Update existing
    await infrastructureStore.updateCircuit(currentCircuit.value.id, currentCircuit.value);
  } else {
    // Create new
    await infrastructureStore.addCircuit(currentCircuit.value);
  }
  isModalOpen.value = false;
}

function openDeleteModal(circuit) {
  circuitToDelete.value = circuit;
  isDeleteModalOpen.value = true;
}

async function confirmDelete() {
  if (!circuitToDelete.value) return;
  await infrastructureStore.removeCircuit(circuitToDelete.value.id);
  isDeleteModalOpen.value = false;
}

</script>

<template>
  <div class="space-y-4">
    <div class="flex justify-between items-center">
        <p class="text-app/80 text-sm">Manage circuits with severity and equipment mapping.</p>
        <button class="btn btn-primary" @click="openAddModal">+ Add Circuit</button>
    </div>

    <!-- Table -->
    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('circuit_id')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none">Circuit ID <span v-if="sortKey === 'circuit_id'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('name')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none">Circuit Name <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('related_equipment')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none">Related Equipment <span v-if="sortKey === 'related_equipment'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('severity')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none">Severity <span v-if="sortKey === 'severity'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3 whitespace-nowrap">Details</th>
              <th class="py-2.5 px-3 w-40 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="infrastructureStore.loading.circuits && sortedRows.length === 0">
              <td colspan="6" class="py-6 px-3 text-center text-muted">Loading circuits...</td>
            </tr>
            <tr v-else-if="infrastructureStore.error">
              <td colspan="6" class="py-6 px-3 text-center text-red-500">{{ infrastructureStore.error }}</td>
            </tr>
             <tr v-else-if="sortedRows.length === 0">
              <td colspan="6" class="py-6 px-3 text-center text-app/60">No circuits defined. Add one above.</td>
            </tr>
            <tr v-for="r in sortedRows" :key="r.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-top">{{ r.circuit_id }}</td>
              <td class="py-2 px-3 align-top">{{ r.name }}</td>
              <td class="py-2 px-3 align-top">{{ r.related_equipment }}</td>
              <td class="py-2 px-3 align-top">{{ r.severity }}</td>
              <td class="py-2 px-3 align-top">{{ r.details }}</td>
              <td class="py-2 px-3 align-top text-center">
                 <div class="flex items-center justify-center gap-2">
                    <button @click="openEditModal(r)" class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" title="Edit Circuit">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                        </svg>
                    </button>
                    <button class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition" title="Remove row" @click="openDeleteModal(r)">
                      <Trash2 class="w-6 h-6" />
                    </button>
                 </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bottom action bar -->
    <div class="mt-3 flex justify-end">
        <div class="flex items-center gap-2">
            <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
            <button class="btn" @click="triggerFileInput">Choose File</button>
            <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
            <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="infrastructureStore.loading.circuits">
                {{ infrastructureStore.loading.circuits ? 'Uploading...' : 'Upload' }}
            </button>
        </div>
    </div>

     <!-- Add/Edit Modal -->
    <div v-if="isModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-3xl space-y-4">
        <h3 class="text-lg font-semibold">{{ currentCircuit.id ? 'Edit' : 'Add' }} Circuit</h3>
        <div v-if="currentCircuit" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Circuit ID</label>
            <input v-model="currentCircuit.circuit_id" class="field h-9" placeholder="e.g., CKT-001" />
          </div>
           <div>
            <label class="block text-sm font-medium mb-1">Circuit Name</label>
            <input v-model="currentCircuit.name" class="field h-9" placeholder="e.g., Feeder Line A" />
          </div>
           <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Related Equipment</label>
            <input v-model="currentCircuit.related_equipment" class="field h-9" placeholder="e.g., Breaker-12, XFMR-3" />
          </div>
           <div>
            <label class="block text-sm font-medium mb-1">Severity</label>
            <select v-model="currentCircuit.severity" class="field h-9">
              <option v-for="s in severityOptions" :key="s" :value="s">{{ s }}</option>
            </select>
          </div>
           <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Details</label>
            <textarea v-model="currentCircuit.details" class="field-textarea min-h-[80px]" placeholder="Notes / details..."></textarea>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveChanges" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the circuit "{{ circuitToDelete?.name }}"? This action cannot be undone.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;">Delete</button>
        </div>
      </div>
    </div>
  </div>
</template>



<script setup>
import { reactive, ref, onMounted, computed } from 'vue'
import { useInfrastructureStore } from '@/stores/infrastructure.js'
import { Trash2 } from 'lucide-vue-next'

const clone = (o) => JSON.parse(JSON.stringify(o))

// Store state
const depotStore = useInfrastructureStore()

// --- Sorting State ---
const sortKey = ref('name');
const sortDir = ref('asc');

const sortedDepots = computed(() => {
  const data = [...depotStore.depots];
  data.sort((a, b) => {
    let valA = a[sortKey.value];
    let valB = b[sortKey.value];
    const modifier = sortDir.value === 'asc' ? 1 : -1;
    if (valA < valB) return -1 * modifier;
    if (valA > valB) return 1 * modifier;
    return 0;
  });
  return data;
});

function toggleSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
  } else {
    sortKey.value = key;
    sortDir.value = 'asc';
  }
}

// --- State for file upload ---
const selectedFile = ref(null)
const fileInput = ref(null)

// Fetch data when the component is first mounted
onMounted(() => {
  depotStore.fetchDepots()
})


// New depot inline form
const newDepot = reactive({ name: '', code: '', location: '' })

// --- State for Modals ---
const isDeleteModalOpen = ref(false)
const depotToDelete = ref(null)
const isEquipmentModalOpen = ref(false)
const selectedDepot = ref(null)
const tempEquipments = reactive([])
const originalEquipments = ref([])

// --- Edit Modal State ---
const isEditModalOpen = ref(false);
const depotToEdit = ref(null);

function openEditModal(depot) {
  depotToEdit.value = { ...depot };
  isEditModalOpen.value = true;
}

async function saveDepotChanges() {
  if (!depotToEdit.value) return;
  await depotStore.updateDepot(depotToEdit.value.id, depotToEdit.value);
  isEditModalOpen.value = false;
  depotToEdit.value = null;
}


function addDepot() {
  if (!newDepot.name.trim()) return
  depotStore.addDepot({
    name: newDepot.name.trim(),
    code: newDepot.code.trim(),
    location: newDepot.location.trim(),
  })
  newDepot.name = ''; newDepot.code = ''; newDepot.location = ''
}

function openDeleteModal(depot) {
  depotToDelete.value = depot;
  isDeleteModalOpen.value = true;
}

async function confirmDelete() {
  if (!depotToDelete.value) return;
  await depotStore.removeDepot(depotToDelete.value.id);
  isDeleteModalOpen.value = false;
  depotToDelete.value = null;
}

function handleFileSelect(event) {
  const target = event.target;
  if (target.files && target.files[0]) {
    selectedFile.value = target.files[0];
  }
}

function triggerFileInput() {
  fileInput.value?.click();
}

async function handleFileUpload() {
  if (!selectedFile.value) {
    alert('Please select a file to upload.');
    return;
  }
  await depotStore.uploadDepotsFile(selectedFile.value);
  selectedFile.value = null;
  if(fileInput.value) fileInput.value.value = '';
}


// --- Equipment Modal Functions ---

function openManageModal(depot) {
  selectedDepot.value = depot
  const equipments = depot.equipments || []
  originalEquipments.value = clone(equipments)
  tempEquipments.splice(0, tempEquipments.length, ...clone(equipments))
  isEquipmentModalOpen.value = true
}

function closeManageModal() {
  isEquipmentModalOpen.value = false
  selectedDepot.value = null
  tempEquipments.splice(0)
  originalEquipments.value = []
}

async function saveEquipmentChanges() {
    if (!selectedDepot.value) return;

    const originalIds = new Set(originalEquipments.value.map(e => e.id));
    const currentIds = new Set(tempEquipments.filter(e => e.id).map(e => e.id));

    const promises = [];

    for (const original of originalEquipments.value) {
        if (!currentIds.has(original.id)) {
            promises.push(depotStore.removeEquipment(original.id));
        }
    }

    for (const current of tempEquipments) {
        if (current.id) { 
            const original = originalEquipments.value.find(o => o.id === current.id);
            if (JSON.stringify(original) !== JSON.stringify(current)) {
                promises.push(depotStore.updateEquipment(current.id, current));
            }
        } else { 
            const payload = { ...current, depot: selectedDepot.value.id };
            promises.push(depotStore.addEquipment(payload));
        }
    }

    await Promise.all(promises);
    await depotStore.fetchDepots();
    closeManageModal();
}

function addEquipmentRow() {
  tempEquipments.push({
    name: '',
    model_type: '',
    asset_id: '',
    location_in_depot: '',
    notes: ''
  })
}

function removeEquipmentRow(index) {
  tempEquipments.splice(index, 1)
}
</script>

<template>
  <div class="space-y-5">
    <p class="text-app/80 text-sm">Add depots, upload depot/equipment lists from Excel, or manage equipment for each depot.</p>

    <!-- New Depot form -->
    <div class="card">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Depot Name</label>
          <input v-model="newDepot.name" class="field" placeholder="e.g., West Yard" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Depot Code</label>
          <input v-model="newDepot.code" class="field" placeholder="e.g., WY-01" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Location</label>
          <input v-model="newDepot.location" class="field" placeholder="e.g., Sector 12" />
        </div>
      </div>
      <div class="mt-3 flex justify-end">
        <button class="btn btn-primary" @click="addDepot">Add Depot</button>
      </div>
    </div>

     <!-- Bottom action bar -->
    <div class="mt-3 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
        <button class="btn" @click="triggerFileInput">Choose Depot File</button>
        <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
        <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="depotStore.loading.depots">
          {{ depotStore.loading.depots ? 'Uploading...' : 'Upload' }}
        </button>
      </div>
    </div>

    <!-- Depots list -->
    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
           <colgroup>
            <col class="w-[25%]">
            <col class="w-[20%]">
            <col class="w-[25%]">
            <col class="w-[15%]">
            <col class="w-[15%]">
          </colgroup>
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('name')" class="py-2.5 px-3 cursor-pointer select-none text-center">Depot Name <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('code')" class="py-2.5 px-3 cursor-pointer select-none text-center">Code <span v-if="sortKey === 'code'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('location')" class="py-2.5 px-3 cursor-pointer select-none text-center">Location <span v-if="sortKey === 'location'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3 text-center">Equipment Count</th>
              <th class="py-2.5 px-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="depotStore.loading.depots && sortedDepots.length === 0">
                <td colspan="5" class="px-3 py-6 text-center text-muted">Loading...</td>
            </tr>
            <tr v-else-if="depotStore.error">
                <td colspan="5" class="px-3 py-6 text-center text-red-500">{{ depotStore.error }}</td>
            </tr>
            <tr v-else-if="sortedDepots.length === 0">
                <td colspan="5" class="px-3 py-6 text-app/60 text-center">No depots yet — add one above.</td>
            </tr>
            <tr v-for="d in sortedDepots" :key="d.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-middle text-center">{{ d.name }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ d.code || '—' }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ d.location || '—' }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ d.equipments?.length || 0 }}</td>
              <td class="py-2 px-3 align-middle">
                <div class="flex flex-wrap items-center justify-center gap-2">
                  <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openEditModal(d)" title="Edit Depot">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                  </button>
                  <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openManageModal(d)" title="Manage Equipment">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z" />
                    </svg>
                  </button>
                  <button
                    class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app ring-1 ring-app/60 hover:bg-black/10 transition"
                    title="Remove depot"
                    @click="openDeleteModal(d)"
                  >
                    <Trash2 class="w-6 h-6" />
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Edit Depot Modal -->
    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">Edit Depot</h3>
        <div v-if="depotToEdit" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Depot Name</label>
            <input v-model="depotToEdit.name" class="field" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Depot Code</label>
            <input v-model="depotToEdit.code" class="field" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Location</label>
            <input v-model="depotToEdit.location" class="field" />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveDepotChanges" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>


     <!-- Delete Confirmation Modal -->
    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the depot "{{ depotToDelete?.name }}"? This may affect associated supervisors and stations.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;">Delete</button>
        </div>
      </div>
    </div>

    <!-- Equipment Modal -->
    <div v-if="isEquipmentModalOpen" class="fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40" @click="closeManageModal" />
      <div class="absolute inset-0 grid place-items-center p-4">
        <section class="w-full max-w-6xl rounded-2xl border-app bg-card text-app shadow-2xl overflow-hidden flex flex-col">
          <!-- Modal header -->
          <header class="flex items-center justify-between px-4 py-3 border-b border-app/40">
            <div class="min-w-0">
              <h3 class="font-semibold truncate">
                Manage Measuring Equipment — {{ selectedDepot?.name }}
              </h3>
              <p class="text-xs text-app/70">Add, edit, or remove measuring equipment (e.g., Multimeter, OTDR) for this depot.</p>
            </div>
            <button class="icon-btn" title="Close" @click="closeManageModal">
              <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M6.4 4.99L5 6.4L10.6 12L5 17.6L6.4 19L12 13.4L17.6 19l1.4-1.4L13.4 12L19 6.4L17.6 4.99L12 10.6z"/></svg>
            </button>
          </header>

          <!-- Equipment table -->
          <div class="p-3 flex-1 overflow-y-auto">
            <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-left border-b border-app/40">
                      <th class="py-2.5 px-3 whitespace-nowrap">Measuring Equipment</th>
                      <th class="py-2.5 px-3 whitespace-nowrap">Model / Type</th>
                      <th class="py-2.5 px-3 whitespace-nowrap">Asset / Serial ID</th>
                      <th class="py-2.5 px-3 whitespace-nowrap">Location in Depot</th>
                      <th class="py-2.5 px-3 whitespace-nowrap">Notes</th>
                      <th class="py-2.5 px-3 w-16 text-center">Remove</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="tempEquipments.length===0">
                      <td colspan="6" class="px-3 py-6 text-app/60 text-center">No equipment yet — add a row below.</td>
                    </tr>
                    <tr v-for="(r, i) in tempEquipments" :key="r.id || i" class="border-t border-app/30">
                      <td class="py-2 px-3 align-top">
                        <input v-model="r.name" class="field h-9" placeholder="e.g., Multimeter" />
                      </td>
                      <td class="py-2 px-3 align-top">
                        <input v-model="r.model_type" class="field h-9" placeholder="e.g., Fluke 117" />
                      </td>
                      <td class="py-2 px-3 align-top">
                        <input v-model="r.asset_id" class="field h-9" placeholder="e.g., SN-123456" />
                      </td>
                      <td class="py-2 px-3 align-top">
                        <input v-model="r.location_in_depot" class="field h-9" placeholder="e.g., Bay 3, Shelf A" />
                      </td>
                      <td class="py-2 px-3 align-top">
                        <textarea v-model="r.notes" class="field-textarea min-h-[44px]" placeholder="Calibration due..."></textarea>
                      </td>
                      <td class="py-2 px-3 align-top text-center">
                        <button
                          class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app ring-1 ring-app/60
                                 hover:bg-[color-mix(in_oklab,_var(--surface),_#000_12%)] transition"
                          title="Remove row"
                          @click="removeEquipmentRow(i)"
                        >
                          <span class="sr-only">Remove row</span>
                          <svg viewBox="0 0 24 24" class="w-6 h-6" aria-hidden="true">
                            <path fill="currentColor" d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm3.11 13.11l-1 1L12 13l-2.11 3.11l-1-1L11 12L8.89 9.89l1-1L12 11l2.11-2.11l1 1L13 12z"/>
                          </svg>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Bottom actions inside modal -->
            <div class="mt-3 grid grid-cols-[1fr_auto_1fr] items-center">
              <div></div>
              <div class="justify-self-center">
                <button class="btn" @click="addEquipmentRow">+ Add Row</button>
              </div>
              <div class="justify-self-end flex items-center gap-2">
                <button class="btn btn-primary" @click="saveEquipmentChanges">Submit</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</template>



<script setup>
import { onMounted, reactive, computed, ref } from 'vue';
import { useEmailStore } from '@/stores/email';

const emailStore = useEmailStore();

const settings = computed(() => emailStore.settings);
const loading = computed(() => emailStore.loading);
const testEmail = ref('');

// Local state for the "add recipient" input fields
const add = reactive({ to: '', cc: '', bcc: '' });

// Fetch settings when the component is mounted
onMounted(() => {
  emailStore.fetchSettings().then(() => {
    // Pre-fill test email with first recipient if available
    if (settings.value.recipients?.to?.length > 0) {
      testEmail.value = settings.value.recipients.to[0];
    }
  });
});

function addRecipient(kind) {
  const email = (add[kind] || '').trim();
  if (!email) return;

  // Ensure the array exists before pushing
  if (!settings.value.recipients[kind]) {
    settings.value.recipients[kind] = [];
  }
  
  if (!settings.value.recipients[kind].includes(email)) {
    settings.value.recipients[kind].push(email);
  }
  add[kind] = ''; // Clear the input field
}

function removeRecipient(kind, email) {
  if (settings.value.recipients[kind]) {
    settings.value.recipients[kind] = settings.value.recipients[kind].filter(e => e !== email);
  }
}

function onSave() {
  emailStore.saveSettings();
}

function onTest() {
  emailStore.sendTestEmail(testEmail.value);
}
</script>

<template>
  <div class="space-y-4">
    <p class="text-app/80 text-sm">
      Configure the SMTP server for sending automated emails and set default recipients.
    </p>

    <!-- SMTP Section -->
    <div class="card">
      <h2 class="text-lg font-semibold mb-3">SMTP Server</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Host</label>
          <input class="field" v-model="settings.host" placeholder="smtp.example.com" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Port</label>
          <input type="number" class="field" v-model.number="settings.port" placeholder="587" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Encryption</label>
          <select class="field" v-model="settings.encryption">
            <option value="STARTTLS">STARTTLS</option>
            <option value="SSL/TLS">SSL/TLS</option>
            <option value="None">None</option>
          </select>
        </div>
        <div></div>
        <div>
          <label class="block text-sm font-medium mb-1">Username</label>
          <input class="field" v-model="settings.username" placeholder="user@example.com" autocomplete="username" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Password</label>
          <input type="password" class="field" v-model="settings.password" autocomplete="new-password" placeholder="Leave blank to keep unchanged" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">From Name</label>
          <input class="field" v-model="settings.from_name" placeholder="RFMS Notifications" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">From Address</label>
          <input class="field" v-model="settings.from_address" placeholder="no-reply@example.com" />
        </div>
      </div>
    </div>

    <!-- Recipients Section -->
    <div class="card">
       <h2 class="text-lg font-semibold mb-3">Default Recipients</h2>
       <div class="space-y-3">
          <!-- TO -->
          <div>
            <label class="block text-sm font-medium mb-1">To</label>
            <div class="flex gap-2 mb-2">
              <input class="field" v-model="add.to" @keydown.enter.prevent="addRecipient('to')" placeholder="Add recipient email and press Enter"/>
              <button class="btn btn-secondary" @click="addRecipient('to')">+</button>
            </div>
            <div class="flex flex-wrap gap-2" v-if="settings.recipients.to && settings.recipients.to.length">
              <span v-for="r in settings.recipients.to" :key="r" class="inline-flex items-center gap-2 px-2 py-1 rounded-lg border text-sm bg-gray-100">
                {{ r }}
                <button class="text-xs opacity-70 hover:opacity-100" @click="removeRecipient('to', r)">×</button>
              </span>
            </div>
          </div>
          <!-- CC -->
          <div>
            <label class="block text-sm font-medium mb-1">CC</label>
            <div class="flex gap-2 mb-2">
              <input class="field" v-model="add.cc" @keydown.enter.prevent="addRecipient('cc')" placeholder="Add CC email and press Enter" />
              <button class="btn btn-secondary" @click="addRecipient('cc')">+</button>
            </div>
             <div class="flex flex-wrap gap-2" v-if="settings.recipients.cc && settings.recipients.cc.length">
              <span v-for="r in settings.recipients.cc" :key="r" class="inline-flex items-center gap-2 px-2 py-1 rounded-lg border text-sm bg-gray-100">
                {{ r }}
                <button class="text-xs opacity-70 hover:opacity-100" @click="removeRecipient('cc', r)">×</button>
              </span>
            </div>
          </div>
          <!-- BCC -->
          <div>
            <label class="block text-sm font-medium mb-1">BCC</label>
            <div class="flex gap-2 mb-2">
              <input class="field" v-model="add.bcc" @keydown.enter.prevent="addRecipient('bcc')" placeholder="Add BCC email and press Enter"/>
              <button class="btn btn-secondary" @click="addRecipient('bcc')">+</button>
            </div>
            <div class="flex flex-wrap gap-2" v-if="settings.recipients.bcc && settings.recipients.bcc.length">
              <span v-for="r in settings.recipients.bcc" :key="r" class="inline-flex items-center gap-2 px-2 py-1 rounded-lg border text-sm bg-gray-100">
                {{ r }}
                <button class="text-xs opacity-70 hover:opacity-100" @click="removeRecipient('bcc', r)">×</button>
              </span>
            </div>
          </div>
       </div>
    </div>
    
    <!-- Actions -->
    <div class="flex items-center justify-end gap-3">
        <input v-model="testEmail" class="field w-64" placeholder="Enter test email address" />
        <button class="btn" @click="onTest" :disabled="loading || !testEmail">
          {{ loading ? 'Sending...' : 'Send Test Email' }}
        </button>
        <button class="btn btn-primary" @click="onSave" :disabled="loading">
          {{ loading ? 'Saving...' : 'Save Changes' }}
        </button>
    </div>
  </div>
</template>



<script setup>
import { onMounted, computed } from 'vue'
import { useCoreSettingsStore } from '@/stores/coreSettings'

const coreSettingsStore = useCoreSettingsStore()

// A computed property to easily access the settings object from the store
const settings = computed(() => coreSettingsStore.failureIdSettings)

// Fetch the settings from the backend when the component is first loaded
onMounted(() => {
  coreSettingsStore.fetchFailureIdSettings()
})

// Function to call the store action to save the current settings
function saveSettings() {
  // We pass the current state of the settings object to the action
  coreSettingsStore.saveFailureIdSettings(settings.value)
}

// A computed property to generate a live preview of the Failure ID format
const previewId = computed(() => {
  // Return a placeholder if settings haven't loaded yet
  if (!settings.value || !settings.value.prefix) {
    return '...';
  }
  
  const prefix = settings.value.prefix;
  const padding = settings.value.padding_digits || 4;
  const year = new Date().getFullYear();
  const month = String(new Date().getMonth() + 1).padStart(2, '0');
  const number = '1'.padStart(padding, '0');

  let datePart = '';
  if (settings.value.reset_cycle === 'yearly') {
    datePart = `-${year}`;
  } else if (settings.value.reset_cycle === 'monthly') {
    datePart = `-${year}${month}`;
  }

  return `${prefix}${datePart}-${number}`;
});
</script>

<template>
  <div class="space-y-4">
    <p class="text-app/80 text-sm">Configure Event ID/sequence rules, prefixes, padding, and resets.</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">Prefix</label>
        <input class="field" v-model="settings.prefix" placeholder="e.g., RF" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Padding (digits)</label>
        <input class="field" type="number" min="1" max="10" v-model.number="settings.padding_digits" placeholder="4" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Reset Cycle</label>
        <select class="field" v-model="settings.reset_cycle">
          <option value="never">Never</option>
          <option value="yearly">Yearly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Preview</label>
        <input class="field" :value="previewId" readonly />
      </div>
    </div>

    <div class="flex gap-2">
      <button class="btn btn-primary" @click="saveSettings" :disabled="coreSettingsStore.loading">
        {{ coreSettingsStore.loading ? 'Saving...' : 'Save' }}
      </button>
    </div>
  </div>
</template>

    <script setup>
    import { computed, onMounted, onBeforeUnmount, ref } from 'vue';
    import { useReportsStore } from '@/stores/reports.js';
    import { useTelegramStore } from '@/stores/telegram.js';
    import { Save, Trash2 } from 'lucide-vue-next';

    const reportsStore = useReportsStore();
    const telegramStore = useTelegramStore();

    const schedules = computed(() => reportsStore.schedules);
    const tgOptions = computed(() => telegramStore.groups);
    const fileInputs = ref({});

    // For multi-select dropdown state
    const activeDropdownId = ref(null);

    onMounted(() => {
      reportsStore.fetchSchedules();
      if (telegramStore.groups.length === 0) {
        telegramStore.fetchTelegramGroups();
      }
      // Close dropdown if user clicks outside
      document.addEventListener('click', closeDropdowns);
    });

    onBeforeUnmount(() => {
        document.removeEventListener('click', closeDropdowns);
    });

    function closeDropdowns(event) {
        if (event.target.closest('[data-dropdown-host]')) return;
        activeDropdownId.value = null;
    }

    const freqOptions = [
      { label: 'Daily', value: 'daily' },
      { label: 'Weekly', value: 'weekly' },
      { label: 'Monthly', value: 'monthly' },
    ];
    const dowOptions = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const domOptions = Array.from({ length: 31 }, (_, i) => String(i + 1));

    function addReport() {
      const newReport = {
        name: 'New Report',
        frequency: 'daily',
        day_of_week: 'Mon',
        day_of_month: 1,
        time: '09:00',
        send_email: false,
        send_telegram: false,
        telegram_group_keys: [], // Use the correct key and initialize as an array
      };
      reportsStore.addSchedule(newReport);
    }

    function updateSchedule(schedule) {
      reportsStore.updateSchedule(schedule.id, schedule);
    }

    function removeSchedule(id) {
      if (confirm('Are you sure you want to delete this report schedule?')) {
        reportsStore.removeSchedule(id);
      }
    }

    function triggerFileInput(id) {
        fileInputs.value[id]?.click();
    }

    async function onTemplatePicked(id, event) {
      const file = event.target.files?.[0];
      if (file) {
        await reportsStore.uploadTemplate(id, file);
        if(event.target) event.target.value = '';
      }
    }

    function toggleTelegramGroup(schedule, groupKey) {
        const selectedKeys = new Set(schedule.telegram_group_keys || []);
        if (selectedKeys.has(groupKey)) {
            selectedKeys.delete(groupKey);
        } else {
            selectedKeys.add(groupKey);
        }
        schedule.telegram_group_keys = Array.from(selectedKeys);
    }

    function getSelectedGroupsText(keys) {
        if (!keys || keys.length === 0) return '-- Select --';
        if (keys.length === 1) {
            const group = tgOptions.value.find(g => g.key === keys[0]);
            return group ? group.name : keys[0];
        }
        return `${keys.length} groups selected`;
    }
    </script>

    <template>
      <div class="space-y-4">
        <div class="flex justify-between items-center">
            <p class="text-app/80 text-sm">
              Configure scheduled report emails and Telegram deliveries.
            </p>
            <button class="btn btn-primary" @click="addReport">+ Add Report</button>
        </div>
        
        <div v-if="reportsStore.loading && schedules.length === 0" class="text-center py-10 text-muted">
            Loading schedules...
        </div>
        <div v-else-if="reportsStore.error" class="text-center py-10 text-red-500">
            {{ reportsStore.error }}
        </div>
         <div v-else-if="schedules.length === 0" class="text-center py-10 text-muted">
            No report schedules found. Click "Add Report" to create one.
        </div>

        <div v-else class="overflow-x-auto">
          <table class="min-w-full w-full text-sm">
            <thead>
              <tr class="text-left border-b border-app/40">
                <th class="py-2.5 px-3 w-[220px]">Report Name</th>
                <th class="py-2.5 px-3 w-[260px]">Report Template (Excel)</th>
                <th class="py-2.5 px-3 w-[300px]">Schedule</th>
                <th class="py-2.5 px-3 w-[120px]">Emails</th>
                <th class="py-2.5 px-3 w-[220px]">Telegram Group</th>
                <th class="py-2.5 px-3 w-[140px] text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="r in schedules" :key="r.id" class="border-b border-app/30">
                <!-- Report Name -->
                <td class="py-2 px-3 align-top">
                  <input
                    class="field h-9"
                    v-model="r.name"
                    placeholder="e.g., Daily Failure Summary"
                  />
                </td>

                <!-- Template -->
                <td class="py-2 px-3 align-top">
                  <div class="flex items-center gap-2">
                    <input
                      type="file"
                      accept=".xlsx,.xls"
                      class="hidden"
                      :ref="el => fileInputs[r.id] = el"
                      @change="e => onTemplatePicked(r.id, e)"
                    />
                    <button class="btn btn-sm" @click="triggerFileInput(r.id)">Choose…</button>
                    <span class="opacity-80 truncate max-w-[180px]" :title="r.template_name || 'No file chosen'">
                      {{ r.template_name || 'No file chosen' }}
                    </span>
                  </div>
                </td>

                <!-- Schedule -->
                <td class="py-2 px-3 align-top">
                  <div class="flex flex-wrap items-center gap-2">
                    <select class="field h-9" v-model="r.frequency">
                      <option v-for="o in freqOptions" :key="o.value" :value="o.value">{{ o.label }}</option>
                    </select>

                    <select v-if="r.frequency === 'weekly'" class="field h-9" v-model="r.day_of_week">
                      <option v-for="d in dowOptions" :key="d" :value="d">{{ d }}</option>
                    </select>

                    <select v-if="r.frequency === 'monthly'" class="field h-9 w-20" v-model.number="r.day_of_month">
                      <option v-for="d in domOptions" :key="d" :value="d">{{ d }}</option>
                    </select>

                    <input type="time" class="field h-9" v-model="r.time" />
                  </div>
                </td>

                <!-- Emails -->
                <td class="py-2 px-3 align-top">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" v-model="r.send_email" class="h-4 w-4" />
                    <span>Enable</span>
                  </label>
                </td>

                <!-- Telegram Multi-Select -->
                <td class="py-2 px-3 align-top">
                    <div class="flex flex-wrap items-center gap-2">
                        <label class="inline-flex items-center gap-2">
                            <input type="checkbox" v-model="r.send_telegram" class="h-4 w-4" />
                            <span>Enable</span>
                        </label>
                        <div class="relative w-full" data-dropdown-host>
                            <button
                                class="field h-9 w-full text-left flex items-center justify-between pr-2"
                                :disabled="!r.send_telegram"
                                @click.stop="activeDropdownId = activeDropdownId === r.id ? null : r.id"
                            >
                                <span class="truncate">{{ getSelectedGroupsText(r.telegram_group_keys) }}</span>
                                <span class="text-muted">▾</span>
                            </button>
                            <div v-if="activeDropdownId === r.id" class="absolute z-10 mt-1 w-full rounded-lg border bg-card text-app border-app shadow-lg max-h-48 overflow-auto">
                                <label v-for="g in tgOptions" :key="g.key" class="flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" :checked="(r.telegram_group_keys || []).includes(g.key)" @change="toggleTelegramGroup(r, g.key)" class="h-4 w-4" />
                                    <span>{{ g.name }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </td>

                <!-- Actions -->
                <td class="py-2 px-3 align-top text-center">
                    <div class="flex items-center justify-center gap-2">
                        <button
                          class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition"
                          @click="updateSchedule(r)"
                          :disabled="reportsStore.loading"
                          title="Save Changes"
                        >
                            <Save class="w-5 h-5" />
                        </button>
                        <button
                          class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition"
                          @click="removeSchedule(r.id)"
                          title="Delete Schedule"
                        >
                            <Trash2 class="w-5 h-5" />
                        </button>
                    </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </template>
    


<script setup>
import { reactive, ref, computed, onMounted } from 'vue'
import { useInfrastructureStore } from '@/stores/infrastructure.js'
import { useUIStore } from '@/stores/ui'
import { Wrench, Trash2 } from 'lucide-vue-next'

const infrastructureStore = useInfrastructureStore()
const uiStore = useUIStore()

const depotOptions = computed(() =>
  infrastructureStore.depots.map(d => ({ value: d.id, label: d.name + (d.code ? ` (${d.code})` : '') }))
)
const sections = computed(() => infrastructureStore.sections)

// --- Sorting State ---
const sortKey = ref('name');
const sortDir = ref('asc');

const sortedSections = computed(() => {
  const data = [...sections.value];
  data.sort((a, b) => {
    let valA = a[sortKey.value];
    let valB = b[sortKey.value];
    const modifier = sortDir.value === 'asc' ? 1 : -1;

    if (sortKey.value === 'depot_name') {
        valA = a.depot_name || '';
        valB = b.depot_name || '';
    }

    if (valA < valB) return -1 * modifier;
    if (valA > valB) return 1 * modifier;
    return 0;
  });
  return data;
});

function toggleSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
  } else {
    sortKey.value = key;
    sortDir.value = 'asc';
  }
}

onMounted(() => {
  if (infrastructureStore.depots.length === 0) {
    infrastructureStore.fetchDepots()
  }
  infrastructureStore.fetchSections()
})

// --- Form for adding a new section ---
const newSection = reactive({
  name: '',
  depot: null,
})

async function addSection() {
  if (!newSection.name || !newSection.depot) {
    uiStore.pushToast({type: 'error', title: 'Missing Fields', message: 'Please provide a section name and select a depot.'})
    return
  }
  await infrastructureStore.addSection({ ...newSection });
  newSection.name = '';
  newSection.depot = null;
}

// --- Edit Modal State ---
const isEditModalOpen = ref(false);
const sectionToEdit = ref(null);

function openEditModal(section) {
  sectionToEdit.value = { ...section };
  isEditModalOpen.value = true;
}

async function saveSectionChanges() {
  if (!sectionToEdit.value) return;
  await infrastructureStore.updateSection(sectionToEdit.value.id, sectionToEdit.value);
  isEditModalOpen.value = false;
  sectionToEdit.value = null;
}


// --- Delete confirmation modal ---
const isDeleteModalOpen = ref(false);
const sectionToDelete = ref(null);

function openDeleteModal(section) {
  sectionToDelete.value = section;
  isDeleteModalOpen.value = true;
}

async function confirmDelete() {
  if (!sectionToDelete.value) return;
  await infrastructureStore.removeSection(sectionToDelete.value.id);
  isDeleteModalOpen.value = false;
  sectionToDelete.value = null;
}

// --- File Upload ---
const selectedFile = ref(null);
const fileInput = ref(null);

function handleFileSelect(event) {
    const target = event.target;
    if (target.files && target.files[0]) {
        selectedFile.value = target.files[0];
    }
}

function triggerFileInput() {
    fileInput.value?.click();
}

async function handleFileUpload() {
    if (!selectedFile.value) {
        uiStore.pushToast({ type: 'error', title: 'No File', message: 'Please select a file to upload.' });
        return;
    }
    await infrastructureStore.uploadSectionsFile(selectedFile.value);
    selectedFile.value = null;
    if (fileInput.value) fileInput.value.value = '';
}


// --- Sub-sections & Assets Modal ---
const clone = (o) => JSON.parse(JSON.stringify(o))
const isSubSectionModalOpen = ref(false)
const selectedSection = ref(null)
const tempSubsections = reactive([])
const originalSubsections = ref([])

function openSubsectionsModal(section) {
  selectedSection.value = section;
  const subsections = section.subsections || [];
  originalSubsections.value = clone(subsections);
  tempSubsections.splice(0, tempSubsections.length, ...clone(subsections.map(ss => ({ ...ss, assets: ss.assets || [] }))));
  isSubSectionModalOpen.value = true;
}

function closeSubsectionsModal() {
  isSubSectionModalOpen.value = false;
  selectedSection.value = null;
  originalSubsections.value = [];
  tempSubsections.splice(0);
}

async function saveSubsectionsAndAssets() {
    if (!selectedSection.value) return;
    const promises = [];

    for (const currentSub of tempSubsections) {
        if (currentSub.id) { 
            const originalSub = originalSubsections.value.find(o => o.id === currentSub.id);
            if (originalSub && originalSub.name !== currentSub.name) {
                promises.push(infrastructureStore.updateSubSection(currentSub.id, { name: currentSub.name }));
            }
            
            const originalAssets = originalSub?.assets || [];
            const currentAssets = currentSub.assets || [];

            for (const currentAsset of currentAssets) {
                if (currentAsset.id) { 
                    const originalAsset = originalAssets.find(oa => oa.id === currentAsset.id);
                    if(originalAsset && JSON.stringify(originalAsset) !== JSON.stringify(currentAsset)) {
                       promises.push(infrastructureStore.updateAsset(currentAsset.id, currentAsset));
                    }
                } else { 
                    const payload = { ...currentAsset, subsection: currentSub.id };
                    promises.push(infrastructureStore.addAsset(payload));
                }
            }
            for (const originalAsset of originalAssets) {
                 if (!currentAssets.some(ca => ca.id === originalAsset.id)) {
                    promises.push(infrastructureStore.removeAsset(originalAsset.id));
                }
            }

        } else { 
             const newSub = await infrastructureStore.addSubSection({ 
                name: currentSub.name, 
                section: selectedSection.value.id 
            });
            if (newSub && newSub.id) {
                for(const asset of currentSub.assets) {
                    const assetPayload = { ...asset, subsection: newSub.id };
                    promises.push(infrastructureStore.addAsset(assetPayload));
                }
            }
        }
    }

    for (const originalSub of originalSubsections.value) {
        if (!tempSubsections.some(ts => ts.id === originalSub.id)) {
            promises.push(infrastructureStore.removeSubSection(originalSub.id));
        }
    }

    await Promise.all(promises);
    await infrastructureStore.fetchSections();
    closeSubsectionsModal();
}


function addSubSectionRow() {
  tempSubsections.push({ name: '', assets: [] });
}

function removeSubSectionRow(index) {
  tempSubsections.splice(index, 1);
}

function addAssetRow(subSection) {
    if (!subSection.assets) {
        subSection.assets = [];
    }
    subSection.assets.push({ name: '', quantity: 1, unit: '' });
}

function removeAssetRow(subSection, assetIndex) {
    subSection.assets.splice(assetIndex, 1);
}

</script>

<template>
  <div class="space-y-5">
    <p class="text-app/80 text-sm">Define Sections per Depot, manage Sub-sections and their Assets, or upload a master file with the complete hierarchy.</p>
    
    <!-- Add Section Form -->
    <div class="card">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Depot</label>
          <select v-model="newSection.depot" class="field h-9">
            <option :value="null" disabled>Select Depot</option>
            <option v-for="opt in depotOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">New Section Name</label>
          <input v-model="newSection.name" class="field h-9" placeholder="e.g., Central Line" />
        </div>
        <div class="self-end">
          <button class="btn btn-primary w-full" @click="addSection" :disabled="infrastructureStore.loading.sections">
            {{ infrastructureStore.loading.sections ? 'Adding...' : 'Add Section' }}
          </button>
        </div>
      </div>
    </div>
    
    <!-- Master Upload Card -->
     <div class="card">
       <div class="flex items-end gap-4">
          <div class="flex-grow">
            <label class="block text-sm font-medium mb-1">Upload Master Infrastructure File</label>
             <p class="text-xs text-app/60 mb-2">Excel file with columns: Depot, Section, Sub-section, Asset, Quantity, Unit. Depots must exist.</p>
             <div class="flex items-center gap-2">
                <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
                <button class="btn" @click="triggerFileInput">Choose File...</button>
                <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
             </div>
          </div>
          <div>
            <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="infrastructureStore.loading.sections">
              {{ infrastructureStore.loading.sections ? 'Uploading...' : 'Upload Master File' }}
            </button>
          </div>
       </div>
    </div>


    <!-- Sections table -->
    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('depot_name')" class="py-2.5 px-3 text-left cursor-pointer select-none">Depot <span v-if="sortKey === 'depot_name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('name')" class="py-2.5 px-3 text-center cursor-pointer select-none">Section <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3 text-center">Sub-sections</th>
              <th class="py-2.5 px-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="infrastructureStore.loading.sections && sortedSections.length === 0">
              <td colspan="4" class="px-3 py-6 text-center text-muted">Loading sections...</td>
            </tr>
            <tr v-else-if="infrastructureStore.error">
              <td colspan="4" class="px-3 py-6 text-center text-red-500">{{ infrastructureStore.error }}</td>
            </tr>
            <tr v-else-if="sortedSections.length === 0">
              <td colspan="4" class="px-3 py-6 text-app/60 text-center">No sections yet — add one above.</td>
            </tr>
            <tr v-for="s in sortedSections" :key="s.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-middle text-left">{{ s.depot_name }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.name }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.subsections?.length || 0 }}</td>
              <td class="py-2 px-3 align-middle">
                <div class="flex flex-wrap items-center justify-center gap-2">
                   <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openEditModal(s)" title="Edit Section">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                  </button>
                   <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openSubsectionsModal(s)" title="Manage Sub-sections & Assets">
                     <Wrench class="w-6 h-6" />
                  </button>
                  <button class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-black/10 transition" title="Remove Section" @click="openDeleteModal(s)">
                    <Trash2 class="w-6 h-6" />
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Edit Section Modal -->
    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Edit Section</h3>
        <div v-if="sectionToEdit" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Section Name</label>
            <input v-model="sectionToEdit.name" class="field h-9" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Depot</label>
            <select v-model="sectionToEdit.depot" class="field h-9">
              <option v-for="opt in depotOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
            </select>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveSectionChanges" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>


    <!-- Delete Confirmation Modal -->
     <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the section "{{ sectionToDelete?.name }}"? This will also delete its sub-sections and assets.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;">Delete</button>
        </div>
      </div>
    </div>


    <!-- Sub-sections & Assets Modal -->
    <div v-if="isSubSectionModalOpen" class="fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40" @click="closeSubsectionsModal"></div>
      <div class="absolute inset-0 grid place-items-center p-4">
        <section class="w-full max-w-4xl rounded-2xl border-app bg-card text-app shadow-2xl overflow-hidden flex flex-col" style="max-height: 90vh;">
          <header class="flex items-center justify-between px-4 py-3 border-b border-app/40">
            <div class="min-w-0">
              <h3 class="font-semibold truncate">Manage Sub-sections & Assets for "{{ selectedSection?.name }}"</h3>
            </div>
            <button class="icon-btn" title="Close" @click="closeSubsectionsModal">
              <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M6.4 4.99L5 6.4L10.6 12L5 17.6L6.4 19L12 13.4L17.6 19l1.4-1.4L13.4 12L19 6.4L17.6 4.99L12 10.6z"/></svg>
            </button>
          </header>

          <div class="p-3 flex-1 overflow-y-auto space-y-3">
            <div v-if="tempSubsections.length === 0" class="text-center py-10 text-muted">No sub-sections yet. Add one below.</div>
            
            <div v-for="(sub, subIndex) in tempSubsections" :key="sub.id || subIndex" class="card">
                <div class="flex items-center gap-2">
                    <input v-model="sub.name" class="field h-9 flex-grow" placeholder="Enter sub-section name"/>
                    <button
                        class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition"
                        title="Remove Sub-section"
                        @click="removeSubSectionRow(subIndex)">
                        <Trash2 class="w-5 h-5" />
                    </button>
                </div>
                
                <div class="mt-3 pl-4 border-l-2 border-app/40">
                    <h4 class="text-xs font-semibold text-app/80 mb-2">Assets in this Sub-section</h4>
                    <table class="w-full text-sm">
                        <tr v-for="(asset, assetIndex) in sub.assets" :key="asset.id || assetIndex">
                            <td class="py-1 pr-2"><input v-model="asset.name" class="field h-8" placeholder="Asset Name"></td>
                            <td class="py-1 pr-2 w-28"><input v-model.number="asset.quantity" type="number" class="field h-8" placeholder="Qty"></td>
                            <td class="py-1 pr-2 w-28"><input v-model="asset.unit" class="field h-8" placeholder="Unit"></td>
                            <td class="py-1 w-10 text-center">
                                <button @click="removeAssetRow(sub, assetIndex)" class="text-app/50 hover:text-red-500">&times;</button>
                            </td>
                        </tr>
                    </table>
                     <button @click="addAssetRow(sub)" class="text-xs btn btn-sm mt-2">+ Add Asset</button>
                </div>
            </div>

          </div>
          <footer class="p-3 border-t border-app/40 grid grid-cols-[1fr_auto_1fr] items-center">
            <div></div>
            <div class="justify-self-center">
                <button class="btn" @click="addSubSectionRow">+ Add Sub-section</button>
            </div>
            <div class="justify-self-end">
                <button class="btn btn-primary" @click="saveSubsectionsAndAssets">Save All Changes</button>
            </div>
          </footer>
        </section>
      </div>
    </div>
  </div>
</template>



<script setup>
import { computed } from 'vue'
import { useRoute } from 'vue-router'
const route = useRoute()
const links = [
  // 1) Reports Management
  { to: '/settings/reports',           label: 'Reports Management',             icon: 'reports' },
  // 2) Failure ID Configuration
  { to: '/settings/failure-id',        label: 'Failure ID Configuration',       icon: 'failure-id' },
  // 3) Telegram Integration Settings
  { to: '/settings/telegram',          label: 'Telegram Integration Settings',  icon: 'telegram' },
  { to: '/settings/email',             label: 'Email Settings',                 icon: 'email' },
  // 4) User and Role Management
  { to: '/settings/users-roles',       label: 'User and Role Management',       icon: 'users-roles' },
  // 5) Circuit Management
  { to: '/settings/circuits',          label: 'Circuit Management',             icon: 'circuits' },
  // 6) Depot Management
  { to: '/settings/depots',            label: 'Depot Management',               icon: 'depot' },
  // 7) Supervisor Management
  { to: '/settings/supervisors',       label: 'Supervisor Management',          icon: 'supervisors' },
  // 8) Station Management
  { to: '/settings/stations',          label: 'Station Management',             icon: 'stations' },
  // 9) Section Management
  { to: '/settings/sections',          label: 'Section Management',             icon: 'sections' },
]
const title = computed(() => route.meta?.title ?? 'Settings')
</script>

<template>
  <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-4">
    <!-- In-page nav -->
    <aside class="rounded-2xl border-app bg-card text-app p-2 h-fit border">
      <nav class="flex flex-col gap-1">
        <RouterLink
          v-for="link in links" :key="link.to" :to="link.to"
          :class="[
            'flex items-center gap-3 rounded-lg px-3 py-2 transition',
            ($route.path === link.to)
              ? 'bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-primary)] hover:text-[var(--seasalt)]'
              : 'hover:bg-[var(--seasalt-lighter)] hover:shadow-popover'
          ]"
        >
          <span class="w-5 h-5 flex items-center justify-center" aria-hidden="true">
            <!-- Monochrome, inherits current color -->
            <svg v-if="link.icon==='failure-id'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M10 2a2 2 0 0 0-2 2v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2V4a2 2 0 0 0-2-2zm0 4V4h4v2zM8 12h8v2H8zm0 4h5v2H8z"/></svg>
            <svg v-else-if="link.icon==='telegram'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M9.03 14.86 8.7 18.6a.75.75 0 0 0 1.18.68l2.11-1.52l3.94 2.88c.58.43 1.41.11 1.58-.6l3.2-13.22c.18-.75-.5-1.4-1.23-1.16L2.7 10.03c-.83.28-.8 1.46.04 1.7l5.1 1.44l9.24-6.2z"/></svg>
            <svg v-else-if="link.icon==='users-roles'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5a5 5 0 0 0 5 5m-7 8a7 7 0 0 1 14 0v1H5z"/></svg>
            <svg v-else-if="link.icon==='circuits'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M7 3h2v4h6V3h2v4h2a2 2 0 0 1 2 2v3h-2V9H5v9h12v-2h2v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2z"/></svg>
            <svg v-else-if="link.icon==='supervisors'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M12 12a4 4 0 1 0-4-4a4 4 0 0 0 4 4m6 8v-1a5 5 0 0 0-5-5H7a5 5 0 0 0-5 5v1z"/></svg>
            <svg v-else-if="link.icon==='stations'" viewBox="0 0 24 24" class="w-5 h-5">
              <path fill="currentColor" d="M12 2c3.9 0 7 3.1 7 7c0 5.3-7 13-7 13S5 14.3 5 9c0-3.9 3.1-7 7-7m0 9a2 2 0 1 0-2-2a2 2 0 0 0 2 2"/>
            </svg>
            <svg v-else-if="link.icon==='sections'" viewBox="0 0 24 24" class="w-5 h-5">
              <path fill="currentColor" d="M12 2l8 4l-8 4l-8-4zm0 6l8 4l-8 4l-8-4zm0 6l8 4l-8 4l-8-4z"/>
            </svg>
            <svg v-else-if="link.icon==='depot'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M3 10.5L12 6l9 4.5V20a1 1 0 0 1-1 1h-6v-6H10v6H4a1 1 0 0 1-1-1z"/></svg>
            <svg v-else-if="link.icon==='reports'" viewBox="0 0 24 24" class="w-5 h-5">
              <path fill="currentColor" d="M6 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h9l5-5V4a2 2 0 0 0-2-2H6zm9 18v-3a2 2 0 0 1 2-2h3l-5 5zM8 7h8v2H8V7zm0 4h8v2H8v-2zm0 4h5v2H8v-2z"/>
            </svg>
            <svg v-else viewBox="0 0 24 24" class="w-5 h-5"><circle cx="12" cy="12" r="5" fill="currentColor"/></svg>
          </span>
          <span class="truncate">{{ link.label }}</span>
        </RouterLink>
      </nav>
    </aside>

    <!-- Content -->
    <section class="space-y-3">
      <header class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">{{ title }}</h1>
      </header>
      <div class="card">
        <RouterView />
      </div>
    </section>
  </div>
  
</template>


<script setup>
import { reactive, ref, computed, onMounted } from 'vue'
import { useInfrastructureStore } from '@/stores/infrastructure.js'
import { useUIStore } from '@/stores/ui'
// Wrench and Pencil are no longer needed
import { Trash2 } from 'lucide-vue-next';

const infrastructureStore = useInfrastructureStore()
const uiStore = useUIStore()

const depotOptions = computed(() =>
  infrastructureStore.depots.map(d => ({ value: d.id, label: d.name + (d.code ? ` (${d.code})` : '') }))
)
const stations = computed(() => infrastructureStore.stations)

// --- Sorting State ---
const sortKey = ref('name');
const sortDir = ref('asc');

const sortedStations = computed(() => {
  const data = [...stations.value];
  data.sort((a, b) => {
    let valA = a[sortKey.value];
    let valB = b[sortKey.value];
    const modifier = sortDir.value === 'asc' ? 1 : -1;

    // Handle nested properties like depot_name
    if (sortKey.value === 'depot_name') {
        valA = a.depot_name;
        valB = b.depot_name;
    }

    if (valA < valB) return -1 * modifier;
    if (valA > valB) return 1 * modifier;
    return 0;
  });
  return data;
});

function toggleSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
  } else {
    sortKey.value = key;
    sortDir.value = 'asc';
  }
}


// --- State for file upload ---
const selectedFile = ref(null)
const fileInput = ref(null)

onMounted(() => {
  if (infrastructureStore.depots.length === 0) {
    infrastructureStore.fetchDepots()
  }
  infrastructureStore.fetchStations()
})

// Form for creating a new station
const newStation = reactive({
  name: '',
  code: '',
  category: '',
  depot: null,
})

function addStation() {
  if (!newStation.name || !newStation.depot) {
    uiStore.pushToast({type: 'error', title: 'Missing Fields', message: 'Please provide a station name and select a depot.'})
    return
  }
  infrastructureStore.addStation({ ...newStation })
  // Reset the form
  newStation.name = ''
  newStation.code = ''
  newStation.category = ''
  newStation.depot = null
}

// --- Edit Modal State ---
const isEditModalOpen = ref(false);
const stationToEdit = ref(null);

function openEditModal(station) {
  stationToEdit.value = { ...station }; // Create a copy to edit
  isEditModalOpen.value = true;
}

async function saveStationChanges() {
  if (!stationToEdit.value) return;
  await infrastructureStore.updateStation(stationToEdit.value.id, stationToEdit.value);
  isEditModalOpen.value = false;
  stationToEdit.value = null;
}


// --- Delete confirmation modal state ---
const isDeleteModalOpen = ref(false);
const stationToDelete = ref(null);

function openDeleteModal(station) {
  stationToDelete.value = station;
  isDeleteModalOpen.value = true;
}

async function confirmDelete() {
  if (!stationToDelete.value) return;
  await infrastructureStore.removeStation(stationToDelete.value.id);
  isDeleteModalOpen.value = false;
  stationToDelete.value = null;
}

// --- File Upload Logic ---
function handleFileSelect(event) {
  const target = event.target;
  if (target.files && target.files[0]) {
    selectedFile.value = target.files[0];
  }
}

function triggerFileInput() {
  fileInput.value?.click();
}

async function handleFileUpload() {
  if (!selectedFile.value) {
    alert('Please select a file to upload.');
    return;
  }
  await infrastructureStore.uploadStationsFile(selectedFile.value);
  selectedFile.value = null;
  if (fileInput.value) fileInput.value.value = '';
}


// --- Logic for the "Manage Equipment" Modal ---
const clone = (o) => JSON.parse(JSON.stringify(o))
const showModal = ref(false)
const selectedStation = ref(null)
const tempEquipments = reactive([])
const originalEquipments = ref([]) // To compare for changes


function openManage(station) {
  selectedStation.value = station
  const equipments = station.equipments || []
  originalEquipments.value = clone(equipments); // Store original state
  tempEquipments.splice(0, tempEquipments.length, ...clone(equipments))
  showModal.value = true
}
function closeModal() {
  showModal.value = false
  selectedStation.value = null
  tempEquipments.splice(0)
  originalEquipments.value = []
}

async function saveEquipments() {
    if (!selectedStation.value) return;

    const originalIds = new Set(originalEquipments.value.map(eq => eq.id));
    const currentIds = new Set(tempEquipments.map(eq => eq.id).filter(id => id));

    for (const originalEq of originalEquipments.value) {
        if (!currentIds.has(originalEq.id)) {
            await infrastructureStore.removeStationEquipment(originalEq.id);
        }
    }

    for (const tempEq of tempEquipments) {
        if (tempEq.id) { 
            const originalEq = originalEquipments.value.find(eq => eq.id === tempEq.id);
            if (JSON.stringify(originalEq) !== JSON.stringify(tempEq)) {
                await infrastructureStore.updateStationEquipment(tempEq.id, tempEq);
            }
        } else {
            const payload = { ...tempEq, station: selectedStation.value.id };
            await infrastructureStore.addStationEquipment(payload);
        }
    }
    
    await infrastructureStore.fetchStations();
    closeModal();
}

function addEquipmentRow() {
  tempEquipments.push({ 
    category: '',
    name: '',
    make_modal: '',
    address: '',
    location_in_station: '',
    quantity: 1,
  })
}
function removeEquipmentRow(i) {
  tempEquipments.splice(i, 1)
}
</script>

<template>
  <div class="space-y-5">
    <p class="text-app/80 text-sm">Map stations to depots, manage communication equipment, or upload a complete list via Excel.</p>

    <!-- Form for creating a new station -->
    <div class="card">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Depot</label>
          <select v-model="newStation.depot" class="field h-9">
            <option :value="null" disabled>Select Depot</option>
            <option v-for="opt in depotOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
          </select>
        </div>
        <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Station Name</label>
          <input v-model="newStation.name" class="field h-9" placeholder="e.g., Dadar" />
        </div>
        <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Station Code</label>
          <input v-model="newStation.code" class="field h-9" placeholder="e.g., DDR" />
        </div>
         <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Station Category</label>
          <input v-model="newStation.category" class="field h-9" placeholder="e.g., NSG6" />
        </div>
      </div>
       <div class="mt-3 flex justify-end">
          <button class="btn btn-primary" @click="addStation">Add Station</button>
      </div>
    </div>
    
    <!-- File Upload Section -->
    <div class="card">
       <div class="flex items-end gap-4">
          <div class="flex-grow">
            <label class="block text-sm font-medium mb-1">Upload Stations & Equipment File</label>
             <p class="text-xs text-app/60 mb-2">Select an Excel file with Depot, Station Name, Code, Category, and Equipment details.</p>
             <div class="flex items-center gap-2">
                <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
                <button class="btn" @click="triggerFileInput">Choose File...</button>
                <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
             </div>
          </div>
          <div>
            <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="infrastructureStore.loading.stations">
              {{ infrastructureStore.loading.stations ? 'Uploading...' : 'Upload' }}
            </button>
          </div>
       </div>
    </div>

    <!-- Stations List Table -->
    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <colgroup>
            <col class="w-[20%]">
            <col class="w-[20%]">
            <col class="w-[15%]">
            <col class="w-[15%]">
            <col class="w-[15%]">
            <col class="w-[15%]">
          </colgroup>
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('depot_name')" class="py-2.5 px-3 cursor-pointer select-none text-left">Depot <span v-if="sortKey === 'depot_name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('name')" class="py-2.5 px-3 cursor-pointer select-none text-center">Station Name <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('code')" class="py-2.5 px-3 cursor-pointer select-none text-center">Station Code <span v-if="sortKey === 'code'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('category')" class="py-2.5 px-3 cursor-pointer select-none text-center">Category <span v-if="sortKey === 'category'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3 text-center">Equipment Count</th>
              <th class="py-2.5 px-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="infrastructureStore.loading.stations && sortedStations.length === 0">
              <td colspan="6" class="px-3 py-6 text-center text-muted">Loading...</td>
            </tr>
            <tr v-else-if="infrastructureStore.error">
              <td colspan="6" class="px-3 py-6 text-center text-red-500">{{ infrastructureStore.error }}</td>
            </tr>
            <tr v-else-if="sortedStations.length === 0">
              <td colspan="6" class="px-3 py-6 text-app/60 text-center">No stations yet — add one above or upload a file.</td>
            </tr>
            <tr v-for="s in sortedStations" :key="s.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-middle text-left">{{ s.depot_name }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.name }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.code }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.category }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.equipments?.length || 0 }}</td>
              <td class="py-2 px-3 align-middle">
                <div class="flex flex-wrap items-center justify-center gap-2">
                  <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openEditModal(s)" title="Edit Station">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                  </button>
                  <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openManage(s)" title="Manage Equipment">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z" />
                    </svg>
                  </button>
                  <button
                    class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app ring-1 ring-app/60 hover:bg-black/10 transition"
                    title="Remove station" @click="openDeleteModal(s)">
                    <Trash2 class="w-6 h-6" />
                  </button>
                </div>
              </td>

            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Edit Station Modal -->
    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">Edit Station</h3>
        <div v-if="stationToEdit" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Depot</label>
            <select v-model="stationToEdit.depot" class="field h-9">
              <option v-for="opt in depotOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Station Name</label>
            <input v-model="stationToEdit.name" class="field h-9" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Station Code</label>
            <input v-model="stationToEdit.code" class="field h-9" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Station Category</label>
            <input v-model="stationToEdit.category" class="field h-9" />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveStationChanges" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete station "{{ stationToDelete?.name }}"? This action cannot be undone.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;">Delete</button>
        </div>
      </div>
    </div>

    <!-- Manage Equipment Modal -->
    <div v-if="showModal" class="fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40" @click="closeModal"></div>
      <div class="absolute inset-0 grid place-items-center p-4">
        <section class="w-full max-w-7xl rounded-2xl border-app bg-card text-app shadow-2xl overflow-hidden flex flex-col">
          <header class="flex items-center justify-between px-4 py-3 border-b border-app/40">
            <div class="min-w-0">
              <h3 class="font-semibold truncate">Manage Communication Equipment — {{ selectedStation?.name || '' }}</h3>
              <p class="text-xs text-app/70">Add, edit, or remove circuit equipment for this station.</p>
            </div>
            <button class="icon-btn" title="Close" @click="closeModal">
              <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M6.4 4.99L5 6.4L10.6 12L5 17.6L6.4 19L12 13.4L17.6 19l1.4-1.4L13.4 12L19 6.4L17.6 4.99L12 10.6z" /></svg>
            </button>
          </header>
          <div class="p-3 flex-1 overflow-y-auto">
            <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-left border-b border-app/40">
                      <th class="py-2.5 px-3">Category</th>
                      <th class="py-2.5 px-3">Equipment Name</th>
                      <th class="py-2.5 px-3">Make / Model</th>
                      <th class="py-2.5 px-3">Address</th>
                      <th class="py-2.5 px-3">Location</th>
                      <th class="py-2.5 px-3">Quantity</th>
                      <th class="py-2.5 px-3 w-16 text-center">Remove</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="tempEquipments.length === 0">
                      <td colspan="7" class="px-3 py-6 text-app/60 text-center">No equipment yet — add a row below.</td>
                    </tr>
                    <tr v-for="(r, i) in tempEquipments" :key="r.id || i" class="border-t border-app/30">
                      <td class="py-2 px-3 align-top"><input v-model="r.category" class="field h-9" placeholder="e.g., Telecom" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.name" class="field h-9" placeholder="e.g., Modem" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.make_modal" class="field h-9" placeholder="e.g., Cisco / 887VA" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.address" class="field h-9" placeholder="e.g., 16.12.13.39" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.location_in_station" class="field h-9" placeholder="e.g., OFC HUT" /></td>
                      <td class="py-2 px-3 align-top"><input v-model.number="r.quantity" type="number" class="field h-9 w-20" /></td>
                      <td class="py-2 px-3 align-top text-center">
                        <button
                          class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app ring-1 ring-app/60 hover:bg-black/10 transition"
                          title="Remove row" @click="removeEquipmentRow(i)">
                          <span class="sr-only">Remove row</span>
                          <svg viewBox="0 0 24 24" class="w-6 h-6" aria-hidden="true">
                            <path fill="currentColor"
                              d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm3.11 13.11l-1 1L12 13l-2.11 3.11l-1-1L11 12L8.89 9.89l1-1L12 11l2.11-2.11l1 1L13 12z" />
                          </svg>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-[1fr_auto_1fr] items-center">
              <div></div>
              <div class="justify-self-center">
                <button class="btn" @click="addEquipmentRow">+ Add Row</button>
              </div>
              <div class="justify-self-end flex items-center gap-2">
                <button class="btn btn-primary" @click="saveEquipments">Save Changes</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</template>





<script setup>
import { ref, onMounted, computed } from 'vue'
import { useInfrastructureStore } from '@/stores/infrastructure.js'
import { Trash2 } from 'lucide-vue-next'

const infrastructureStore = useInfrastructureStore()
const rows = computed(() => infrastructureStore.supervisors)
const depotOptions = computed(() => infrastructureStore.depots.map(d => ({ label: d.name, value: d.id })));

// --- Sorting State ---
const sortKey = ref('name');
const sortDir = ref('asc');

const sortedRows = computed(() => {
  const data = [...rows.value];
  data.sort((a, b) => {
    let valA = a[sortKey.value];
    let valB = b[sortKey.value];
    const modifier = sortDir.value === 'asc' ? 1 : -1;
    
    if (sortKey.value === 'depot_name') {
        valA = a.depot_name || '';
        valB = b.depot_name || '';
    }

    if (valA < valB) return -1 * modifier;
    if (valA > valB) return 1 * modifier;
    return 0;
  });
  return data;
});

function toggleSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
  } else {
    sortKey.value = key;
    sortDir.value = 'asc';
  }
}

// --- State for file upload ---
const selectedFile = ref(null)
const fileInput = ref(null)

// --- State for Modals ---
const isEditModalOpen = ref(false)
const currentSupervisor = ref(null)
const isDeleteModalOpen = ref(false)
const supervisorToDelete = ref(null)


onMounted(() => {
  infrastructureStore.fetchSupervisors()
  if (infrastructureStore.depots.length === 0) infrastructureStore.fetchDepots()
})

function handleFileSelect(event) {
  const target = event.target;
  if (target.files && target.files[0]) {
    selectedFile.value = target.files[0];
  }
}

function triggerFileInput() {
  fileInput.value?.click();
}

async function handleFileUpload() {
  if (!selectedFile.value) {
    alert('Please select a file to upload.');
    return;
  }
  await infrastructureStore.uploadSupervisorsFile(selectedFile.value);
  selectedFile.value = null;
  if(fileInput.value) fileInput.value.value = '';
}

// --- Modal and Form Functions ---
function openEditModal(supervisor) {
  currentSupervisor.value = { ...supervisor };
  isEditModalOpen.value = true;
}

function openAddModal() {
  currentSupervisor.value = {
    name: '',
    designation: '',
    depot: null,
    mobile: '',
    email: ''
  };
  isEditModalOpen.value = true;
}


async function saveSupervisorChanges() {
  if (!currentSupervisor.value) return;

  if (currentSupervisor.value.id) {
    await infrastructureStore.updateSupervisor(currentSupervisor.value.id, currentSupervisor.value);
  } else {
    await infrastructureStore.addSupervisor(currentSupervisor.value);
  }

  isEditModalOpen.value = false;
  currentSupervisor.value = null;
}

function openDeleteModal(supervisor) {
  supervisorToDelete.value = supervisor;
  isDeleteModalOpen.value = true;
}

async function confirmDelete() {
  if (!supervisorToDelete.value) return;
  await infrastructureStore.removeSupervisor(supervisorToDelete.value.id);
  isDeleteModalOpen.value = false;
  supervisorToDelete.value = null;
}
</script>

<template>
  <div class="space-y-4">
    <p class="text-app/80 text-sm">Add/update depot supervisors by uploading an Excel file or manage them individually below.</p>
    <!-- Bottom action bar -->
    <div class="mt-3 grid grid-cols-[1fr_auto_1fr] items-center">
      <div class="justify-self-start flex items-center gap-2">
        <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
        <button class="btn" @click="triggerFileInput">Choose Supervisor File</button>
        <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
        <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="infrastructureStore.loading.supervisors">
          {{ infrastructureStore.loading.supervisors ? 'Uploading...' : 'Upload' }}
        </button>
      </div>
      <div class="justify-self-end"><button class="btn" @click="openAddModal">+ Add Row</button></div>
    </div>

    <!-- Table -->
    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                 <colgroup>
                    <col class="w-[20%]">
                    <col class="w-[20%]">
                    <col class="w-[20%]">
                    <col class="w-[15%]">
                    <col class="w-[15%]">
                    <col class="w-[10%]">
                </colgroup>
                <thead>
                    <tr class="text-left border-b border-app/40">
                        <th @click="toggleSort('name')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-left">Supervisor <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th @click="toggleSort('designation')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-center">Designation <span v-if="sortKey === 'designation'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th @click="toggleSort('depot_name')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-center">Depot <span v-if="sortKey === 'depot_name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th @click="toggleSort('mobile')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-center">Mobile <span v-if="sortKey === 'mobile'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th @click="toggleSort('email')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-center">Email <span v-if="sortKey === 'email'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th class="py-2.5 px-3 w-40 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-if="infrastructureStore.loading.supervisors && sortedRows.length === 0">
                        <td colspan="6" class="py-6 px-3 text-center text-muted">Loading supervisors...</td>
                    </tr>
                    <tr v-else-if="infrastructureStore.error">
                        <td colspan="6" class="py-6 px-3 text-center text-red-500">{{ infrastructureStore.error }}</td>
                    </tr>
                    <tr v-for="r in sortedRows" :key="r.id">
                        <td class="py-2 px-3 align-middle text-left">{{ r.name }}</td>
                        <td class="py-2 px-3 align-middle text-center">{{ r.designation }}</td>
                        <td class="py-2 px-3 align-middle text-center">{{ r.depot_name || 'N/A' }}</td>
                        <td class="py-2 px-3 align-middle text-center">{{ r.mobile || 'N/A' }}</td>
                        <td class="py-2 px-3 align-middle text-center">{{ r.email || 'N/A' }}</td>
                        <td class="py-2 px-3 align-middle text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button @click="openEditModal(r)" class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" title="Edit Supervisor">
                                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                    </svg>
                                </button>
                                <button @click="openDeleteModal(r)" class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition" title="Remove Supervisor">
                                    <Trash2 class="w-6 h-6" />
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>


    <!-- Add/Edit Supervisor Modal -->
    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">{{ currentSupervisor.id ? 'Edit' : 'Add' }} Supervisor</h3>
        <div v-if="currentSupervisor" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Name</label>
            <input v-model="currentSupervisor.name" class="field" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Designation</label>
            <input v-model="currentSupervisor.designation" class="field" />
          </div>
           <div>
            <label class="block text-sm font-medium mb-1">Depot</label>
            <select v-model="currentSupervisor.depot" class="field">
              <option :value="null">-- No Depot --</option>
              <option v-for="depot in depotOptions" :key="depot.value" :value="depot.value">
                {{ depot.label }}
              </option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Mobile</label>
            <input v-model="currentSupervisor.mobile" class="field" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Email</label>
            <input v-model="currentSupervisor.email" type="email" class="field" />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveSupervisorChanges" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the supervisor "{{ supervisorToDelete?.name }}"? This action cannot be undone.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;">Delete</button>
        </div>
      </div>
    </div>

  </div>
</template>



<script setup>
import { onMounted, computed } from 'vue';
import { useTelegramStore } from '@/stores/telegram.js';

const tg = useTelegramStore();

const settings = computed(() => tg.settings);
const groupList = computed(() => tg.groups);

onMounted(() => {
  tg.fetchTelegramSettings();
  tg.fetchTelegramGroups();
});

function onSaveToken() {
  tg.saveTelegramSettings();
}

function onSaveGroup(group) {
  tg.updateTelegramGroup(group);
}

function onTest(group) {
  tg.sendTestMessage(group);
}
</script>

<template>
  <div class="space-y-6">
    <p class="text-app/80 text-sm">
      Configure the Telegram Bot and the three groups used for system alerts, file uploads, and scheduled reports.
    </p>

    <div class="card p-4 space-y-3">
        <h3 class="font-semibold text-app">Telegram Bot Configuration</h3>
        <div>
          <label class="block text-sm font-medium mb-1">Bot Token (HTTP API Key)</label>
          <input
            class="field"
            v-model="settings.bot_token"
            placeholder="Paste your bot token here, e.g., 8404126856:AAEXUY..."
          />
          <p class="text-xs opacity-70 mt-1">Get this from the BotFather on Telegram.</p>
        </div>
         <div class="flex gap-3 pt-2">
          <button class="btn btn-primary" @click="onSaveToken" :disabled="tg.loading">
            {{ tg.loading ? 'Saving...' : 'Save Token' }}
          </button>
        </div>
    </div>

    <div v-if="tg.loading && groupList.length === 0" class="text-center py-10 text-muted">
      Loading Telegram settings...
    </div>
    <div v-else-if="tg.error && groupList.length === 0" class="text-center py-10 text-red-500">
      {{ tg.error }}
    </div>
    <div v-else class="space-y-4">
      <div v-for="g in groupList" :key="g.key" class="card p-4 space-y-3">
        <h3 class="font-semibold text-app">{{ g.name }}</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Chat ID</label>
            <input
              class="field"
              v-model="g.chat_id"
              :placeholder="{
                reports: '-4923590033',
                alerts: '-4905455511',
                files: '-4812151797'
              }[g.key] || 'e.g., -1001234567890'"
            />
            <p class="text-xs opacity-70 mt-1">The unique identifier for the {{ g.name }}.</p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Link / Note (optional)</label>
            <input
              class="field"
              v-model="g.link"
              placeholder="e.g., Invitation link"
            />
          </div>
        </div>

        <div class="flex gap-3 pt-2">
          <button class="btn btn-primary" @click="onSaveGroup(g)" :disabled="tg.loading">
            {{ tg.loading ? 'Saving...' : 'Save Group' }}
          </button>
          <button class="btn" @click="onTest(g)" :disabled="tg.loading || !g.chat_id">Test Message</button>
        </div>
      </div>
    </div>
  </div>
</template>


<script setup>
import { onMounted, computed, ref, reactive } from 'vue';
import { useUserStore } from '@/stores/users';
import { useUIStore } from '@/stores/ui';
import { Trash2 } from 'lucide-vue-next';

// Initialize stores
const userStore = useUserStore();
const uiStore = useUIStore();

const users = computed(() => userStore.users);

// State for Add User modal
const isAddModalOpen = ref(false);
const initialNewUserState = {
  username: '', email: '', first_name: '', last_name: '', role: 'viewer', password: '',
};
const newUser = reactive({ ...initialNewUserState });

// State for Edit User modal
const isEditModalOpen = ref(false);
const currentUserToEdit = ref(null);

// State for Delete User modal
const isDeleteModalOpen = ref(false);
const userToDelete = ref(null);

const roleOptions = ['viewer', 'operator', 'supervisor', 'admin'];

onMounted(() => {
  userStore.fetchUsers();
});

// --- Add User Functions ---
function openAddModal() {
  Object.assign(newUser, initialNewUserState);
  isAddModalOpen.value = true;
}

async function saveNewUser() {
  if (!newUser.username || !newUser.password) {
    uiStore.pushToast({ type: 'error', title: 'Missing Fields', message: 'User ID (PF Number) and Password are required.' });
    return;
  }
  await userStore.addUser(newUser);
  if (!userStore.error) {
    isAddModalOpen.value = false;
  }
}

// --- Edit User Functions ---
function openEditModal(user) {
  currentUserToEdit.value = reactive({ ...user, password: '' });
  isEditModalOpen.value = true;
}

async function saveUserChanges() {
  if (!currentUserToEdit.value) return;
  await userStore.updateUser(currentUserToEdit.value.id, currentUserToEdit.value);
  if (!userStore.error) {
    isEditModalOpen.value = false;
    currentUserToEdit.value = null;
  }
}

// --- Delete User Functions ---
function openDeleteModal(user) {
  userToDelete.value = user;
  isDeleteModalOpen.value = true;
}

async function confirmDelete() {
  if (!userToDelete.value) return;
  await userStore.deleteUser(userToDelete.value.id);
  if (!userStore.error) {
    isDeleteModalOpen.value = false;
    userToDelete.value = null;
  }
}

// --- UI Helpers ---
function getRoleClass(role) {
  switch (role) {
    case 'admin': return 'bg-red-100 text-red-800 border-red-200';
    case 'supervisor': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
    case 'operator': return 'bg-blue-100 text-blue-800 border-blue-200';
    case 'viewer': default: return 'bg-gray-100 text-gray-800 border-gray-200';
  }
}

function getStatusClass(isActive) {
  return isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
}
</script>

<template>
  <div class="space-y-4">
    <div class="flex justify-between items-center">
      <p class="text-app/80 text-sm">Create users, assign roles, and manage permissions for the RFMS application.</p>
      <button class="btn btn-primary" @click="openAddModal">+ Add User</button>
    </div>

    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b border-app/40">
              <th class="py-2.5 px-3 whitespace-nowrap">DB ID</th>
              <th class="py-2.5 px-3 whitespace-nowrap">User ID (PF Number)</th>
              <th class="py-2.5 px-3 whitespace-nowrap">Full Name</th>
              <th class="py-2.5 px-3 whitespace-nowrap">Email</th>
              <th class="py-2.5 px-3 whitespace-nowrap text-center">Role</th>
              <th class="py-2.5 px-3 whitespace-nowrap text-center">Status</th>
              <th class="py-2.5 px-3 w-40 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="userStore.loading && users.length === 0">
              <td colspan="7" class="py-6 px-3 text-center text-muted">Loading users...</td>
            </tr>
            <tr v-else-if="userStore.error && users.length === 0">
              <td colspan="7" class="py-6 px-3 text-center text-red-500">{{ userStore.error }}</td>
            </tr>
            <tr v-else-if="users.length === 0">
              <td colspan="7" class="py-6 px-3 text-center text-app/60">No users found. Click "Add User" to begin.</td>
            </tr>
            <tr v-for="user in users" :key="user.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-middle">{{ user.id }}</td>
              <td class="py-2 px-3 align-middle">{{ user.username }}</td>
              <td class="py-2 px-3 align-middle">{{ user.first_name }} {{ user.last_name }}</td>
              <td class="py-2 px-3 align-middle">{{ user.email }}</td>
              <td class="py-2 px-3 align-middle text-center">
                <span class="badge capitalize" :class="getRoleClass(user.role)">{{ user.role }}</span>
              </td>
              <td class="py-2 px-3 align-middle text-center">
                 <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" :class="getStatusClass(user.is_active)">
                  {{ user.is_active ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td class="py-2 px-3 align-middle text-center">
                <div class="flex items-center justify-center gap-2">
                  <button @click="openEditModal(user)" class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" title="Edit User">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                  </button>
                  <button @click="openDeleteModal(user)" class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition" title="Remove User">
                    <Trash2 class="w-6 h-6" />
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div v-if="isAddModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">Add New User</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium mb-1">User ID (PF Number)</label><input v-model="newUser.username" class="field" placeholder="e.g., 12345678" /></div>
          <div><label class="block text-sm font-medium mb-1">Email</label><input v-model="newUser.email" type="email" class="field" placeholder="e.g., j.doe@example.com" /></div>
          <div><label class="block text-sm font-medium mb-1">First Name</label><input v-model="newUser.first_name" class="field" placeholder="e.g., John" /></div>
          <div><label class="block text-sm font-medium mb-1">Last Name</label><input v-model="newUser.last_name" class="field" placeholder="e.g., Doe" /></div>
          <div>
            <label class="block text-sm font-medium mb-1">Role</label>
            <select v-model="newUser.role" class="field capitalize">
              <option v-for="role in roleOptions" :key="role" :value="role">{{ role }}</option>
            </select>
          </div>
          <div><label class="block text-sm font-medium mb-1">Password</label><input v-model="newUser.password" type="password" class="field" placeholder="Enter a temporary password" /></div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isAddModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveNewUser" class="btn btn-primary" :disabled="userStore.loading">{{ userStore.loading ? 'Saving...' : 'Save User' }}</button>
        </div>
      </div>
    </div>

    <div v-if="isEditModalOpen && currentUserToEdit" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">Edit User: {{ currentUserToEdit.username }}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium mb-1">User ID (PF Number)</label><input v-model="currentUserToEdit.username" class="field" /></div>
          <div><label class="block text-sm font-medium mb-1">Email</label><input v-model="currentUserToEdit.email" type="email" class="field" /></div>
          <div><label class="block text-sm font-medium mb-1">First Name</label><input v-model="currentUserToEdit.first_name" class="field" /></div>
          <div><label class="block text-sm font-medium mb-1">Last Name</label><input v-model="currentUserToEdit.last_name" class="field" /></div>
          <div>
            <label class="block text-sm font-medium mb-1">Role</label>
            <select v-model="currentUserToEdit.role" class="field capitalize">
              <option v-for="role in roleOptions" :key="role" :value="role">{{ role }}</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Status</label>
            <label class="flex items-center gap-2">
              <input type="checkbox" v-model="currentUserToEdit.is_active" class="h-4 w-4 rounded" />
              <span>Active</span>
            </label>
          </div>
          <div class="md:col-span-2"><label class="block text-sm font-medium mb-1">New Password</label><input v-model="currentUserToEdit.password" type="password" class="field" placeholder="Leave blank to keep unchanged" /></div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveUserChanges" class="btn btn-primary" :disabled="userStore.loading">{{ userStore.loading ? 'Saving...' : 'Save Changes' }}</button>
        </div>
      </div>
    </div>
      
    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the user "<strong>{{ userToDelete?.username }}</strong>"? This action cannot be undone.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;" :disabled="userStore.loading">
            {{ userStore.loading ? 'Deleting...' : 'Delete' }}
          </button>
        </div>
      </div>
    </div>

  </div>
</template>

import { defineStore } from 'pinia'

export const useAppStore = defineStore('app', {
  state: () => ({
    appName: 'Railway Failure System',
  }),
  actions: {
    setAppName(name) { this.appName = name }
  }
})


import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useAttachmentStore = defineStore('attachments', {
  state: () => ({
    attachments: [],
    loading: false,
    error: null,
  }),
  actions: {
    async fetchAttachments(failureId) {
      if (!failureId) {
        this.attachments = [];
        return;
      }
      this.loading = true;
      this.error = null;
      try {
        const response = await http.get(`/failures/attachments/?failure=${failureId}`);
        this.attachments = response.data.results || response.data;
      } catch (err) {
        this.error = 'Failed to fetch attachments.';
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async uploadAttachment(failureId, file, description) {
  const uiStore = useUIStore();
  const formData = new FormData();
  formData.append('failure', failureId);
  formData.append('file', file);
  formData.append('description', description);

  this.loading = true;
  try {
    const response = await http.post('/failures/attachments/', formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
    });
    uiStore.pushToast({ type: 'success', title: 'Success', message: 'File uploaded.' });
    await this.fetchAttachments(failureId);
    return response.data;
  } catch (err) {
    uiStore.pushToast({ type: 'error', title: 'Upload Failed', message: 'Could not upload file.' });
    console.error(err);
    return null;
  } finally {
    this.loading = false;
  }
},

    async deleteAttachment(attachmentId, failureId) {
      const uiStore = useUIStore();
      this.loading = true;
      try {
        await http.delete(`/failures/attachments/${attachmentId}/`);
        uiStore.pushToast({ type: 'success', title: 'Deleted', message: 'Attachment removed.' });
        await this.fetchAttachments(failureId); // Refresh the list
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove attachment.' });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
  },
});

import { defineStore } from 'pinia'

export const useAuthStore = defineStore('auth', {
  state: () => ({
    user: null,   // { username }
    token: null,  // placeholder until backend
  }),
  actions: {
    initFromStorage() {
      const token = localStorage.getItem('auth_token')
      const userRaw = localStorage.getItem('auth_user')
      if (token) this.token = token
      if (userRaw) this.user = JSON.parse(userRaw)
    },
    async login({ username, password }) {
      if (!username || !password) throw new Error('Missing credentials')
      // Mock success; later replace with real API call
      this.user = { username }
      this.token = 'dev-token'
      localStorage.setItem('auth_token', this.token)
      localStorage.setItem('auth_user', JSON.stringify(this.user))
    },
    logout() {
      this.user = null
      this.token = null
      localStorage.removeItem('auth_token')
      localStorage.removeItem('auth_user')
    }
  }
})


import { defineStore } from 'pinia';

export const useCircuitsStore = defineStore('circuits', {
  state: () => ({
    circuits: [{ id: 1, circuit_id: 'CKT-MAIN-01', name: 'Main Line Feeder', severity: 'Critical' }],
    loading: false,
  }),
  actions: {
    async fetchCircuits() { this.loading = false; },
  },
});

import { defineStore } from 'pinia'
import { ref } from 'vue'
import { http } from '@/lib/http'
import { useUIStore } from './ui'

export const useCoreSettingsStore = defineStore('coreSettings', () => {
  const failureIdSettings = ref({
    prefix: 'RF',
    padding: 4,
    reset_cycle: 'yearly',
  })
  const loading = ref(false)

  async function fetchFailureIdSettings() {
    loading.value = true
    const uiStore = useUIStore()
    try {
      // The backend list view for the singleton returns the object directly.
      const response = await http.get('/failure-config/failure-id-settings/')
      // The response for a list is often nested, but our custom view returns the object directly.
      // However, a standard ViewSet list view would return { results: [...] }
      // So we handle both cases.
      if (response.data && response.data.results) {
         // This handles the case where the default list view is used.
         // Since we expect only one, we take the first.
        if (response.data.results.length > 0) {
            failureIdSettings.value = response.data.results[0];
        }
      } else {
        // This handles our custom list view that returns a single object.
        failureIdSettings.value = response.data
      }
    } catch (err) {
      console.error('Failed to fetch Failure ID settings:', err)
      uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not load Failure ID settings.' })
    } finally {
      loading.value = false
    }
  }

  async function saveFailureIdSettings(payload) {
    loading.value = true
    const uiStore = useUIStore()
    try {
      // The singleton is always at pk=1, so we update it there.
      const response = await http.patch('/failure-config/failure-id-settings/1/', payload)
      failureIdSettings.value = response.data
      uiStore.pushToast({ type: 'success', title: 'Success', message: 'Failure ID settings saved.' })
    } catch (err) {
      console.error('Failed to save Failure ID settings:', err)
      uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not save Failure ID settings.' })
    } finally {
      loading.value = false
    }
  }

  return {
    failureIdSettings,
    loading,
    fetchFailureIdSettings,
    saveFailureIdSettings,
  }
})

import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useDashboardStore = defineStore('dashboard', {
  state: () => ({
    data: null,
    loading: false,
    error: null,
  }),
  actions: {
    async fetchDashboardData(filters = {}) {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        // Convert filter object to query parameters
        const params = new URLSearchParams();
        if (filters.range) params.append('range', filters.range);
        if (filters.sections && filters.sections.length) {
            filters.sections.forEach(id => params.append('sections[]', id));
        }
        // Add other filters like status if needed in the future

        const response = await http.get('/dashboard/data/', { params });
        this.data = response.data;
      } catch (err) {
        this.error = 'Failed to fetch dashboard data.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
  },
});

// Path: frontend/src/stores/depots.js
import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useDepotsStore = defineStore('depots', {
  state: () => ({
    depots: [],
    loading: false,
    error: null,
  }),
  actions: {
    async fetchDepots() {
      this.loading = true;
      this.error = null;
      try {
        const response = await http.get('/depots/'); // CORRECTED PATH
        this.depots = response.data.results || response.data;
      } catch (err) {
        this.error = 'Failed to fetch depots.';
        useUIStore().pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
    async addDepot(payload) {
      this.loading = true;
      const uiStore = useUIStore();
      try {
        await http.post('/depots/', payload); // CORRECTED PATH
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Depot added.' });
        await this.fetchDepots();
      } catch (err) {
        this.error = 'Failed to add depot.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
      } finally {
        this.loading = false;
      }
    },
    async updateDepot(id, payload) {
      this.loading = true;
      const uiStore = useUIStore();
      try {
        const updateData = {
          name: payload.name,
          code: payload.code,
          location: payload.location,
        };
        await http.patch(`/depots/${id}/`, updateData);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Depot updated.' });
        await this.fetchDepots();
      } catch (err) {
        this.error = 'Failed to update depot.'; // Keep a generic error state

        // --- IMPROVED ERROR HANDLING ---
        let errorDetail = 'An unknown error occurred.';
        if (err.response && err.response.data) {
            // DRF validation errors are often objects where keys are field names
            if (typeof err.response.data === 'object') {
                errorDetail = Object.entries(err.response.data)
                    .map(([field, messages]) => `${field}: ${Array.isArray(messages) ? messages.join(', ') : messages}`)
                    .join('; ');
            } else {
                // Fallback for non-field errors or simple strings
                errorDetail = String(err.response.data.detail || err.response.data);
            }
        } else if (err.message) {
            errorDetail = err.message;
        }
        
        // Log the detailed error to the console
        console.error("Update Depot Error:", err.response?.data || err);

        // Show the detailed error in the toast
        uiStore.pushToast({ type: 'error', title: 'Update Failed', message: errorDetail });

      } finally {
        this.loading = false;
      }
    },
    async removeDepot(id) {
      this.loading = true;
      const uiStore = useUIStore();
      try {
        await http.delete(`/depots/${id}/`); // CORRECTED PATH
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Depot removed.' });
        await this.fetchDepots();
      } catch (err) {
        this.error = 'Failed to remove depot.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
      } finally {
        this.loading = false;
      }
    },
    async uploadDepotsFile(file) {
      this.loading = true;
      const uiStore = useUIStore();
      const formData = new FormData();
      formData.append('file', file);
      try {
        const response = await http.post('/depots/import_from_excel/', formData, { // CORRECTED PATH
          headers: { 'Content-Type': 'multipart/form-data' },
        });
        uiStore.pushToast({ type: 'success', title: 'Import Complete', message: response.data.message });
        await this.fetchDepots();
      } catch (err) {
        const message = err.response?.data?.error || 'File upload failed.';
        uiStore.pushToast({ type: 'error', title: 'Import Failed', message });
      } finally {
        this.loading = false;
      }
    },
    async downloadDepotsExcel() {
        this.loading = true;
        const uiStore = useUIStore();
        try {
            // --- FIX: CORRECTED URL PATH ---
            // Ensure it calls /depots/export_to_excel/ (relative to the base /api/v1/)
            const response = await http.get('/depots/export_to_excel/', {
                responseType: 'blob', // Keep this for file handling
            });

            // ... (rest of the download logic remains the same) ...
            const url = window.URL.createObjectURL(new Blob([response.data]));
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'depot_equipment_export.xlsx');
            document.body.appendChild(link);
            link.click();
            link.remove();
            window.URL.revokeObjectURL(url);
            uiStore.pushToast({ type: 'success', title: 'Success', message: 'Depot data export started.' });
        } catch (err) {
            uiStore.pushToast({ type: 'error', title: 'Error', message: 'Failed to download depot data.' });
            console.error("Download Error:", err); // Log the error for debugging
        } finally {
            this.loading = false;
        }
    },
    async addEquipment(payload) {
      const uiStore = useUIStore();
      try {
        await http.post('/equipments/', payload); // CORRECTED PATH
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Equipment added.' });
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not add equipment.' });
      }
    },
    async updateEquipment(id, payload) {
      const uiStore = useUIStore();
      try {
        await http.patch(`/equipments/${id}/`, payload); // CORRECTED PATH
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Equipment updated.' });
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not update equipment.' });
      }
    },
    async removeEquipment(id) {
      const uiStore = useUIStore();
      try {
        await http.delete(`/equipments/${id}/`); // CORRECTED PATH
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Equipment removed.' });
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove equipment.' });
      }
    },
  },
});

import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useEmailStore = defineStore('email', {
  state: () => ({
    settings: {
      host: '',
      port: 587,
      encryption: 'STARTTLS',
      username: '',
      password: '',
      from_name: 'RFMS Notifications',
      from_address: 'no-reply@rfms.local',
      recipients: {
        to: [],
        cc: [],
        bcc: [],
      },
    },
    loading: false,
    error: null,
  }),
  actions: {
    async fetchSettings() {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        const response = await http.get('/notifications/settings/email/');
        const recipients = response.data.recipients || {};
        // Ensure recipients object and its arrays exist
        this.settings = {
          ...response.data,
          recipients: {
            to: recipients.to || [],
            cc: recipients.cc || [],
            bcc: recipients.bcc || [],
          }
        };
      } catch (err) {
        this.error = 'Failed to fetch email settings.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
    async saveSettings() {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        // Create a payload to send, omitting the password if it's blank
        const payload = { ...this.settings };
        if (payload.password === '') {
          delete payload.password;
        }
        
        const response = await http.put('/notifications/settings/email/', payload);
        const recipients = response.data.recipients || {};
        this.settings = {
          ...response.data,
          recipients: {
            to: recipients.to || [],
            cc: recipients.cc || [],
            bcc: recipients.bcc || [],
          }
        };
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Email settings saved.' });
      } catch (err) {
        this.error = 'Failed to save email settings.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
    async sendTestEmail(toEmail) {
      if (!toEmail) {
        useUIStore().pushToast({ type: 'error', title: 'Input Required', message: 'Please enter a recipient for the test email.' });
        return;
      }
      this.loading = true;
      const uiStore = useUIStore();
      try {
        const response = await http.post('/email/settings/test/', { to_email: toEmail });
        uiStore.pushToast({ type: 'success', title: 'Success', message: response.data.message });
      } catch (err) {
        const message = err.response?.data?.error || 'An unknown error occurred.';
        uiStore.pushToast({ type: 'error', title: 'Test Failed', message: message, duration: 8000 });
        console.error(err);
      } finally {
        this.loading = false;
      }
    }
  },
});



import { defineStore } from 'pinia';
import { useUIStore } from './ui';

export const useFailureStore = defineStore('failure', {
  state: () => ({
    failures: [
        { id: 1, fail_id: 'DUMMY-001', circuit: { name: 'CKT-01' }, station: { name: 'STN-A' }, section: { name: 'SEC-A' }, current_status: 'Active', severity: 'Critical', reported_at: new Date().toISOString() },
        { id: 2, fail_id: 'DUMMY-002', circuit: { name: 'CKT-02' }, station: { name: 'STN-B' }, section: { name: 'SEC-B' }, current_status: 'Resolved', severity: 'Minor', reported_at: new Date().toISOString(), resolved_at: new Date().toISOString() },
    ],
    currentFailure: null,
    loading: false,
    error: null,
    archivedFailures: [],
  }),
  actions: {
    async fetchFailures() { this.loading = false; },
    async fetchFailure(id) { this.currentFailure = this.failures.find(f => f.id === id); },
    async addFailure(payload) { console.log('Mock add failure:', payload); useUIStore().pushToast({type: 'success', message: 'Mock failure added.'}); },
    async updateFailure(id, payload) { console.log('Mock update failure:', id, payload); useUIStore().pushToast({type: 'success', message: 'Mock failure updated.'}); },
    // Keep other function names but with no API calls
  },
});

import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useLogbookStore = defineStore('logbook', {
  state: () => ({
    failures: [],
    count: 0,
    num_pages: 1,
    loading: false,
    error: null,
  }),
  actions: {
    async fetchLogbookData(params = {}) {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        const response = await http.get('/logbook/data/', { params });
        this.failures = response.data.results;
        this.count = response.data.count;
        this.num_pages = response.data.num_pages;
      } catch (err) {
        this.error = 'Failed to fetch logbook data.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
  },
});

import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useRecentFailuresStore = defineStore('recentFailures', {
  state: () => ({
    items: [],
    loading: false,
    error: null,
  }),
  actions: {
    async fetchRecentFailures() {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        const response = await http.get('/recent-failures/');
        this.items = response.data.results || response.data;
      } catch (err) {
        this.error = 'Failed to fetch recent failures.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
  },
});

    import { defineStore } from 'pinia';
    import { http } from '@/lib/http';
    import { useUIStore } from './ui';

    export const useReportsStore = defineStore('reports', {
      state: () => ({
        schedules: [],
        loading: false,
        error: null,
      }),
      actions: {
        async fetchSchedules() {
          this.loading = true;
          this.error = null;
          try {
            const response = await http.get('/reports/schedules/');
            this.schedules = response.data.results || response.data;
          } catch (err) {
            this.error = 'Failed to fetch report schedules.';
            console.error(err);
          } finally {
            this.loading = false;
          }
        },
        async addSchedule(payload) {
          const uiStore = useUIStore();
          try {
            await http.post('/reports/schedules/', payload);
            uiStore.pushToast({ type: 'success', title: 'Success', message: 'Report schedule added.' });
            await this.fetchSchedules();
          } catch (err) {
            console.error('Failed to add schedule:', err);
            uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not add report schedule.' });
          }
        },
        async updateSchedule(scheduleId, payload) {
          const uiStore = useUIStore();
          // The backend now expects 'telegram_group_keys'
          const apiPayload = { ...payload };
          delete apiPayload.id; // Don't send the ID in the body of a PATCH request

          try {
            await http.patch(`/reports/schedules/${scheduleId}/`, apiPayload);
            uiStore.pushToast({ type: 'success', title: 'Saved', message: 'Report schedule updated.' });
            await this.fetchSchedules(); // Refresh list to get latest state
          } catch (err) {
            console.error('Failed to update schedule:', err);
            uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not update schedule.' });
          }
        },
        async removeSchedule(scheduleId) {
          const uiStore = useUIStore();
          try {
            await http.delete(`/reports/schedules/${scheduleId}/`);
            uiStore.pushToast({ type: 'success', title: 'Deleted', message: 'Report schedule removed.' });
            await this.fetchSchedules();
          } catch (err) {
            console.error('Failed to remove schedule:', err);
            uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove schedule.' });
          }
        },
        async uploadTemplate(scheduleId, file) {
          const uiStore = useUIStore();
          const formData = new FormData();
          formData.append('template', file);
          this.loading = true;
          try {
            await http.post(`/reports/schedules/${scheduleId}/upload_template/`, formData, {
              headers: { 'Content-Type': 'multipart/form-data' },
            });
            uiStore.pushToast({ type: 'success', title: 'Success', message: 'Template uploaded.' });
            await this.fetchSchedules();
          } catch (err) {
            console.error('Failed to upload template:', err);
            uiStore.pushToast({ type: 'error', title: 'Upload Failed', message: 'Could not upload template.' });
          } finally {
            this.loading = false;
          }
        },
      },
    });
    


// Path: frontend/src/stores/sections.js
import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useSectionsStore = defineStore('sections', {
  state: () => ({
    sections: [],
    sectionSubsections: [], // Store fetched subsections for the modal
    loading: false,
    error: null,
  }),
  actions: {
    // --- Section Actions ---
    async fetchSections() {
      this.loading = true; this.error = null;
      try {
        const response = await http.get('/sections/'); // Uses the sections router base path
        this.sections = response.data.results || response.data;
      } catch (err) {
        this.error = 'Failed to fetch sections.';
        useUIStore().pushToast({ type: 'error', title: 'Error', message: this.error });
      } finally { this.loading = false; }
    },
    async addSection(payload) {
      this.loading = true; const uiStore = useUIStore();
      try {
        await http.post('/sections/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Section added.' });
        await this.fetchSections();
      } catch (err) {
        this.error = 'Failed to add section.';
        const errorDetail = err.response?.data ? JSON.stringify(err.response.data) : this.error;
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorDetail });
      } finally { this.loading = false; }
    },
    async updateSection(id, payload) {
      this.loading = true; const uiStore = useUIStore();
      try {
        await http.patch(`/sections/${id}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Section updated.' });
        await this.fetchSections();
      } catch (err) {
        this.error = 'Failed to update section.';
        const errorDetail = err.response?.data ? JSON.stringify(err.response.data) : this.error;
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorDetail });
      } finally { this.loading = false; }
    },
    async removeSection(id) {
      this.loading = true; const uiStore = useUIStore();
      try {
        await http.delete(`/sections/${id}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Section removed.' });
        await this.fetchSections();
      } catch (err) {
        this.error = 'Failed to remove section.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
      } finally { this.loading = false; }
    },
    async uploadSectionsFile(file) {
      this.loading = true; const uiStore = useUIStore();
      const formData = new FormData();
      formData.append('file', file);
      try {
        const response = await http.post('/sections/import_master_file/', formData, { // Use correct action path
          headers: { 'Content-Type': 'multipart/form-data' },
        });
        uiStore.pushToast({ type: 'success', title: 'Import Complete', message: response.data.message });
        await this.fetchSections(); // Refresh after import
      } catch (err) {
        const message = err.response?.data?.error || err.response?.data?.message || 'File upload failed.';
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Import Failed', message });
      } finally { this.loading = false; }
    },

    // --- SubSection Actions ---
    async fetchSubsectionsForSection(sectionId) {
        this.loading = true; this.error = null;
        try {
            // Use the dedicated subsections endpoint with filtering
            const response = await http.get(`/subsections/?section=${sectionId}`);
            this.sectionSubsections = response.data.results || response.data;
        } catch (err) {
            this.error = 'Failed to fetch sub-sections.';
            useUIStore().pushToast({ type: 'error', title: 'Error', message: this.error });
            this.sectionSubsections = []; // Clear on error
        } finally { this.loading = false; }
    },
    async addSubSection(payload) {
      const uiStore = useUIStore();
      try {
        const response = await http.post('/subsections/', payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Sub-section added.' });
        return response.data; // Return the created object with its ID
      } catch (err) {
        const errorDetail = err.response?.data ? JSON.stringify(err.response.data) : 'Could not add sub-section.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorDetail });
        return null;
      }
    },
    async updateSubSection(id, payload) {
      const uiStore = useUIStore();
      try {
        await http.patch(`/subsections/${id}/`, payload);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Sub-section updated.' });
      } catch (err) {
        const errorDetail = err.response?.data ? JSON.stringify(err.response.data) : 'Could not update sub-section.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorDetail });
      }
    },
    async removeSubSection(id) {
      const uiStore = useUIStore();
      try {
        await http.delete(`/subsections/${id}/`);
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Sub-section removed.' });
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove sub-section.' });
      }
    },

    // --- Asset Actions ---
    async addAsset(payload) {
      const uiStore = useUIStore();
      try {
        await http.post('/assets/', payload);
        // Avoid toast spam in bulk operations
        // uiStore.pushToast({ type: 'success', title: 'Success', message: 'Asset added.' });
      } catch (err) {
        const errorDetail = err.response?.data ? JSON.stringify(err.response.data) : 'Could not add asset.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorDetail });
      }
    },
    async updateAsset(id, payload) {
      const uiStore = useUIStore();
      try {
        await http.patch(`/assets/${id}/`, payload);
        // uiStore.pushToast({ type: 'success', title: 'Success', message: 'Asset updated.' });
      } catch (err) {
        const errorDetail = err.response?.data ? JSON.stringify(err.response.data) : 'Could not update asset.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorDetail });
      }
    },
    async removeAsset(id) {
      const uiStore = useUIStore();
      try {
        await http.delete(`/assets/${id}/`);
        // uiStore.pushToast({ type: 'success', title: 'Success', message: 'Asset removed.' });
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not remove asset.' });
      }
    },
  },
});

import { defineStore } from 'pinia';

export const useStationsStore = defineStore('stations', {
  state: () => ({
    stations: [{ id: 1, name: 'Central Station', code: 'CTR', depot: 1, depot_name: 'Main Depot', equipment_count: 5 }],
    loading: false,
  }),
  actions: {
    async fetchStations() { this.loading = false; },
  },
});

import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useSupervisorMovementsStore = defineStore('supervisorMovements', {
  state: () => ({
    // This will now store the list of supervisors with their nested movement data
    dailyMovements: [],
    loading: false,
    error: null,
  }),
  actions: {
    /**
     * Fetches all supervisors and their movements for a specific date.
     * @param {string} date - The date in 'YYYY-MM-DD' format.
     */
    async fetchMovementsByDate(date) {
      if (!date) return;
      this.loading = true;
      this.error = null;
      try {
        const response = await http.get(`/operations/by-date/?date=${date}`);
        this.dailyMovements = response.data;
      } catch (err) {
        this.error = 'Failed to fetch movements for the selected date.';
        this.dailyMovements = [];
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    /**
     * Creates or updates a movement record.
     * @param {object} payload - The full movement object.
     */
    async saveMovement(payload) {
      const uiStore = useUIStore();
      this.loading = true;
      this.error = null;
      try {
        if (payload.id) {
          // If it has an ID, it's an update (PATCH)
          await http.patch(`/operations/movements/${payload.id}/`, payload);
          uiStore.pushToast({ type: 'success', title: 'Success', message: 'Movement updated.' });
        } else {
          // Otherwise, it's a new record (POST)
          await http.post('/operations/movements/', payload);
          uiStore.pushToast({ type: 'success', title: 'Success', message: 'Movement saved.' });
        }
        // Refresh the data for the current date to show the change
        await this.fetchMovementsByDate(payload.date);
      } catch (err) {
        this.error = 'Failed to save movement.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
     /**
     * Deletes a movement record.
     * @param {number} movementId - The ID of the movement record to delete.
     * @param {string} date - The date for which to refresh data after deletion.
     */
    async deleteMovement(movementId, date) {
        if (!movementId) return;
        const uiStore = useUIStore();
        this.loading = true;
        this.error = null;
        try {
            await http.delete(`/operations/movements/${movementId}/`);
            uiStore.pushToast({ type: 'success', title: 'Success', message: 'Movement entry deleted.' });
            await this.fetchMovementsByDate(date);
        } catch (err) {
            this.error = 'Failed to delete movement.';
            uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
            console.error(err);
        } finally {
            this.loading = false;
        }
    },

    async sendMovementReport(date) {
      const uiStore = useUIStore();
      this.loading = true;
      this.error = null;
      try {
        await http.post('/operations/send-report/', { date });
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Report sent successfully.' });
      } catch (err) {
        const message = err.response?.data?.error || 'Failed to send report.';
        this.error = message;
        uiStore.pushToast({ type: 'error', title: 'Error', message });
        console.error(err);
      } finally {
        this.loading = false;
      }
    }
  },
});

import { defineStore } from 'pinia';

export const useSupervisorsStore = defineStore('supervisors', {
  state: () => ({
    supervisors: [{ id: 1, name: 'John Doe', designation: 'Sr. Supervisor', depot: 1, depot_name: 'Main Depot' }],
    loading: false,
  }),
  actions: {
    async fetchSupervisors() { this.loading = false; },
  },
});

import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useTelegramStore = defineStore('telegram', {
  state: () => ({
    settings: {
      bot_token: '',
    },
    groups: [],
    loading: false,
    error: null,
  }),

  getters: {
    // A getter to easily access the list of groups
    list: (state) => state.groups,
  },

  actions: {
    async fetchTelegramSettings() {
      this.loading = true;
      try {
        const response = await http.get('/notifications/settings/telegram/');
        // ADD THIS CHECK to ensure we don't overwrite with a null/undefined value
        if (response.data && typeof response.data === 'object') {
          this.settings = response.data;
        } else {
          console.warn('Received invalid data for Telegram settings, preserving initial state.');
        }
      } catch (err) {
        console.error('Failed to fetch Telegram settings', err);
        useUIStore().pushToast({ type: 'error', title: 'Error', message: 'Could not load Telegram settings.' });
      } finally {
        this.loading = false;
      }
    },

    // ... (rest of the actions remain unchanged)
    async saveTelegramSettings() {
      this.loading = true;
      const uiStore = useUIStore();
      try {
        const response = await http.patch('/notifications/settings/telegram/1/', this.settings);
        this.settings = response.data;
        uiStore.pushToast({ type: 'success', title: 'Success', message: 'Bot Token saved.' });
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not save Bot Token.' });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async fetchTelegramGroups() {
      this.loading = true;
      try {
        const response = await http.get('/telegram/telegram-groups/');
        this.groups = response.data.results || response.data;
      } catch (err) {
        console.error('Failed to fetch Telegram groups', err);
        useUIStore().pushToast({ type: 'error', title: 'Error', message: 'Could not load Telegram groups.' });
      } finally {
        this.loading = false;
      }
    },

    async updateTelegramGroup(group) {
      this.loading = true;
      const uiStore = useUIStore();
      try {
        await http.patch(`/notifications/telegram-groups/${group.id}/`, group);
        uiStore.pushToast({ type: 'success', title: 'Success', message: `Group "${group.name}" updated.` });
        await this.fetchTelegramGroups();
      } catch (err) {
        uiStore.pushToast({ type: 'error', title: 'Error', message: 'Could not update group.' });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },

    async sendTestMessage(group) {
      this.loading = true;
      const uiStore = useUIStore();
      try {
        const response = await http.post('/telegram/groups/test/', { group_id: group.id });
        uiStore.pushToast({ type: 'success', title: 'Success', message: response.data.message });
      } catch (err) {
        const message = err.response?.data?.error || 'Failed to send test message.';
        uiStore.pushToast({ type: 'error', title: 'Test Failed', message });
        console.error(err);
      } finally {
        this.loading = false;
      }
    },
  },
});

import { defineStore } from 'pinia'
import { ref, computed } from 'vue'

export const useUIStore = defineStore('ui', () => {
  // No theme switching — single unified palette

  // --- SIDEBAR ---
  const SIDEBAR_MIN = 56
  const SIDEBAR_COLLAPSED = 64
  const SIDEBAR_MAX = 360
  const SNAP_THRESHOLD = 80 // px

  const sidebarWidth = ref(Number(localStorage.getItem('sidebarWidth') || 256))
  if (isNaN(sidebarWidth.value)) sidebarWidth.value = 256
  const sidebarCollapsed = ref(localStorage.getItem('sidebarCollapsed') === 'true')

  const computedSidebarWidth = computed(() => (sidebarCollapsed.value ? SIDEBAR_COLLAPSED : sidebarWidth.value))
  function setSidebarWidth(px) {
    const n = Math.round(Number(px))
    if (Number.isFinite(n)) {
      const clamped = Math.max(SIDEBAR_MIN, Math.min(SIDEBAR_MAX, n))
      sidebarWidth.value = clamped
      localStorage.setItem('sidebarWidth', String(clamped))
    }
  }
  function setSidebarCollapsed(v) {
    sidebarCollapsed.value = !!v
    localStorage.setItem('sidebarCollapsed', String(sidebarCollapsed.value))
  }
  function toggleSidebarCollapsed() { setSidebarCollapsed(!sidebarCollapsed.value) }
  function snapSidebar(currentPx) {
    const w = Number(currentPx ?? sidebarWidth.value)
    if (w <= SNAP_THRESHOLD) {
      setSidebarCollapsed(true)
      setSidebarWidth(SIDEBAR_COLLAPSED)
    } else {
      setSidebarCollapsed(false)
    }
  }

  // --- TOASTS (unchanged API) ---
  const toasts = ref([])
  let idSeq = 1
  /**
   * Push a toast notification to the queue.
   * @param {{ type?: string, title?: string, message?: string }} [opts]
   * @returns {void}
   */
  function pushToast({ type = 'info', title = '', message = '' } = {}) {
    const id = idSeq++
    toasts.value.push({ id, type, title, message })
    setTimeout(() => removeToast(id), 4000)
  }
  /**
   * Remove a toast by its id.
   * @param {number} id
   * @returns {void}
   */
  function removeToast(id) {
    toasts.value = toasts.value.filter(t => t.id !== id)
  }
  function clearToasts() {
    toasts.value = []
  }

  return {
    // sidebar
    sidebarWidth, sidebarCollapsed, computedSidebarWidth,
    setSidebarWidth, setSidebarCollapsed, toggleSidebarCollapsed, snapSidebar,
    // toasts
    toasts, pushToast, removeToast, clearToasts,
    // constants (optional export for tests)
    SIDEBAR_MIN, SIDEBAR_COLLAPSED, SIDEBAR_MAX, SNAP_THRESHOLD,
  }
})


import { defineStore } from 'pinia';
import { http } from '@/lib/http';
import { useUIStore } from './ui';

export const useUserStore = defineStore('users', {
  state: () => ({
    users: [],
    loading: false,
    error: null,
  }),
  actions: {
    /**
     * Fetches the list of all users from the backend API.
     */
    async fetchUsers() {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        const response = await http.get('/users/');
        this.users = response.data.results || response.data;
      } catch (err) {
        this.error = 'Failed to fetch users.';
        uiStore.pushToast({ type: 'error', title: 'Error', message: this.error });
        console.error('Error fetching users:', err);
      } finally {
        this.loading = false;
      }
    },

    /**
     * Adds a new user via the backend API.
     * @param {object} userData - The new user's data.
     */
    async addUser(userData) {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.post('/users/', userData);
        uiStore.pushToast({
          type: 'success',
          title: 'User Added',
          message: `User "${userData.username}" has been created.`,
        });
        await this.fetchUsers(); // Refresh the user list
      } catch (err) {
        this.error = 'Failed to add user.';
        const errorMessage = err.response?.data ? JSON.stringify(err.response.data) : this.error;
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorMessage });
        console.error('Error adding user:', err);
      } finally {
        this.loading = false;
      }
    },

    /**
     * Updates an existing user via the backend API.
     * @param {number} userId - The ID of the user to update.
     * @param {object} userData - The updated user data.
     */
    async updateUser(userId, userData) {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        // Remove password from payload if it's empty
        const payload = { ...userData };
        if (!payload.password) {
          delete payload.password;
        }
          
        await http.patch(`/users/${userId}/`, payload);
        uiStore.pushToast({
          type: 'success',
          title: 'User Updated',
          message: `User "${userData.username}" has been updated.`,
        });
        await this.fetchUsers(); // Refresh the user list
      } catch (err) {
        this.error = 'Failed to update user.';
        const errorMessage = err.response?.data ? JSON.stringify(err.response.data) : this.error;
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorMessage });
        console.error('Error updating user:', err);
      } finally {
        this.loading = false;
      }
    },

    /**
     * Deletes a user via the backend API.
     * @param {number} userId - The ID of the user to delete.
     */
    async deleteUser(userId) {
      this.loading = true;
      this.error = null;
      const uiStore = useUIStore();
      try {
        await http.delete(`/users/${userId}/`);
        uiStore.pushToast({
          type: 'success',
          title: 'User Deleted',
          message: `User with ID #${userId} has been deleted.`,
        });
        await this.fetchUsers(); // Refresh the user list
      } catch (err) {
        this.error = 'Failed to delete user.';
        const errorMessage = err.response?.data ? JSON.stringify(err.response.data) : this.error;
        uiStore.pushToast({ type: 'error', title: 'Error', message: errorMessage });
        console.error('Error deleting user:', err);
      } finally {
        this.loading = false;
      }
    },
  },
});

/* Trim default Vite styles to avoid conflicting with Tailwind + token-based theming. */
/* palettes */
@import "@/styles/palettes.css";
/* status palette */
@import "@/styles/status-palette.css";
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;
  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

body { margin: 0; }

/* Base button reset; color comes from utility classes (.btn, etc.) */
button {
  font-family: inherit;
  cursor: pointer;
}

/* .card styles live in Tailwind layer; do not override here */


/* Unified global palette and shadows (grayscale scheme) */
:root {
  /* Base Palette */
  --seasalt: #f8f9fa;
  --antiflash-white: #e9ecef;
  --platinum: #dee2e6;
  --french-gray: #ced4da;
  --french-gray-2: #adb5bd;
  --slate-gray: #6c757d;
  --outer-space: #495057;
  --onyx: #343a40;
  --eerie-black: #212529;

  /* Nearby Shades */
  --seasalt-lighter: #ffffff;
  --antiflash-white-lighter: #f2f4f6;
  --platinum-lighter: #e7ebed;
  --french-gray-lighter: #d7dde3;
  --french-gray-2-lighter: #b6bec6;
  --slate-gray-lighter: #858e96;
  --outer-space-lighter: #626b73;
  --onyx-lighter: #4d5359;
  --eerie-black-lighter: #3a3e42;
  --off-white: #f5f5f5;
  --body-text: #2c3135;

  /* Component Assignments */
  --bg-main: var(--antiflash-white);
  --navbar-bg: var(--outer-space); /* keep for compatibility but unified with sidebar */
  --sidebar-bg: var(--outer-space);
  --sidebar-fg: var(--seasalt);
  --sidebar-fg-muted: var(--french-gray-2);
  --button-primary: var(--slate-gray);
  --button-hover: var(--slate-gray-lighter);
  --card-bg: var(--seasalt);
  --input-bg: var(--off-white);
  --error: var(--slate-gray);

  /* Status Colors (hex-mapped) */
  --status-green: #BBD9AD; /* Resolved */
  --status-yellow: #F2D194; /* In Progress */
  --status-amber: #D98236; /* On Hold */
  --status-red: #F2A0A0; /* Active */
  --on-status-green: #1F2937; /* gray-800 for readability */
  --on-status-yellow: #1F2937;
  --on-status-amber: #FFFFFF;
  --on-status-red: #1F2937;

  /* Shadow Variables */
  --shadow-resting: 0 2px 4px rgba(0, 0, 0, 0.1);
  --shadow-hover: 0 4px 8px rgba(0, 0, 0, 0.15);
  --shadow-card: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-card-hover: 0 6px 12px rgba(0, 0, 0, 0.15);
}


:root {
  /* status solids */
  --s-resolved:   #8FE0AD;
  --s-active:     #FC9796;
  --s-inprogress: #EEEE96;
  --s-onhold:     #FFC08C;
  --s-all:        #237FB7;

  /* readable text colors over those backgrounds */
  --s-on-dark:    #ffffff;
  --s-on-light:   #0b1b1f;

  /* Weak/tint variants for subtle row/card backgrounds */
  --s-active-weak:     color-mix(in oklab, var(--s-active) 18%, transparent);
  --s-inprogress-weak: color-mix(in oklab, var(--s-inprogress) 18%, transparent);
  --s-resolved-weak:   color-mix(in oklab, var(--s-resolved) 18%, transparent);
  --s-onhold-weak:     color-mix(in oklab, var(--s-onhold) 18%, transparent);
}


<template>
  <div class="p-6 space-y-6">
    <div class="flex items-baseline justify-between">
      <div>
        <h2 class="text-2xl font-semibold">Analytics Board</h2>
        <!-- helper text removed per request -->
      </div>

      <div class="flex items-center gap-2 text-sm">
        <label class="flex items-center gap-2 text-app">
          <input type="checkbox" v-model="liveToday" class="h-4 w-4 rounded border-app" />
          Live: Today’s Failures
        </label>
        <label class="flex items-center gap-2 text-app">
          <input type="checkbox" v-model="liveRecent" class="h-4 w-4 rounded border-app" />
          Live: Recent Failures
        </label>
      </div>
    </div>

    <!-- Global filters: ranges + statuses -->
    <DashboardFilterBar v-model="filters" />

    <!-- Board grid -->
    <section class="grid gap-4 sm:grid-cols-2 xl:grid-cols-3">
      <div
        v-for="(p, idx) in panels"
        :key="p.id"
        class="rounded-2xl border-app bg-card text-app overflow-hidden shadow-card"
        :class="fullscreen === p.id ? 'fixed inset-6 z-50' : 'relative'"
        draggable="true"
        @dragstart="onDragStart(idx)"
        @dragover.prevent
        @drop="onDrop(idx)"
      >
        <!-- Header -->
        <div class="px-4 pt-3 pb-2 flex items-center gap-2 border-b border-app">
          <h3 class="font-semibold text-app flex-1 truncate">{{ p.title }}</h3>

          <!-- chart type -->
          <select v-model="state[p.id].type" class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm">
            <option value="bar">Bar</option>
            <option value="line">Line</option>
            <option value="table">Table</option>
            <option value="pie">Pie</option>
            <option value="doughnut">Doughnut</option>
          </select>

          <!-- Fullscreen / close fullscreen -->
          <button class="p-1.5 rounded hover:bg-card" title="Toggle fullscreen" @click="toggleFullscreen(p.id)">
            <svg v-if="fullscreen !== p.id" class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M4 10V4h6v2H6v4H4Zm10-4V4h6v6h-2V6h-4ZM6 14H4v6h6v-2H6v-4Zm14 0h-2v4h-4v2h6v-6Z"/></svg>
            <svg v-else class="w-4 h-4" viewBox="0 0 24 24"><path fill="currentColor" d="M14 10V6h4V4h-6v6h2ZM6 10V6h4V4H4v6h2Zm8 8v-4h2v6h-6v-2h4ZM6 14H4v6h6v-2H6v-4Z"/></svg>
          </button>

          <!-- Remove button hidden as per request -->
        </div>

        <!-- Toolbar (per-card filters): show only in fullscreen -->
        <div v-if="fullscreen === p.id" class="px-4 pt-2 pb-3 flex flex-wrap items-center gap-2">
          <!-- Time range pills -->
          <button
            v-for="r in ranges"
            :key="r.key"
            class="px-3 py-1.5 text-sm rounded-lg border"
            :class="state[p.id].range === r.key ? 'selected-primary' : 'bg-card text-app border-app hover-primary'"
            @click="setRange(p.id, r.key)"
          >
            {{ r.label }}
          </button>

          <!-- Custom dates -->
          <div v-if="state[p.id].range === 'custom'" class="ml-auto flex items-center gap-2">
            <input type="date" v-model="state[p.id].from" class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm" />
            <span class="text-muted text-sm">to</span>
            <input type="date" v-model="state[p.id].to" class="rounded-lg border-app bg-card text-app px-2 py-1 text-sm" />
            <button class="px-3 py-1.5 text-sm rounded-lg border-app bg-card hover:bg-card" @click="applyCustom(p.id)">Apply</button>
          </div>
          <div v-else class="ml-auto"></div>

          <!-- Status chips (NEW) -->
          <div class="w-full mt-2 flex flex-wrap items-center gap-2">
            <span class="text-xs text-muted mr-1">Status:</span>

            <button
              v-for="s in statuses"
              :key="s"
              class="px-2.5 py-1 text-xs rounded-full border"
              :class="(state[p.id].statuses || []).includes(s) ? 'selected-primary' : 'bg-card text-app border-app hover-primary'"
              @click="togglePanelStatus(p.id, s)"
            >
              {{ s }}
            </button>

            <button
              class="ml-auto px-2.5 py-1 text-xs rounded-full border-app bg-card hover-primary"
              title="Select all statuses"
              @click="clearPanelStatuses(p.id)"
            >
              All
            </button>

            <!-- Severity filter (only for Failure card) -->
            <div v-if="p.kind==='failureSeverity'" class="ml-2 inline-flex items-center gap-2">
              <label class="text-xs text-muted">Severity</label>
              <select v-model="state[p.id].severity" class="rounded border-app bg-card text-app px-2 py-1 text-xs">
                <option value="all">All</option>
                <option value="minor">Minor</option>
                <option value="major">Major</option>
                <option value="critical">Critical</option>
              </select>
            </div>
          </div>
        </div>

        
        <!-- Body (resizable) -->
        <div class="px-4 pb-4">
          <div class="relative rounded-xl border-app bg-card text-app overflow-auto" style="min-height: 240px; resize: both;">
            <PanelBody
              :key="'panel-' + p.id"
              :panel="p"
              :state="state[p.id]"
              :data="panelData(p)"
              :chart-options="chartOptions"
            />
          </div>
        </div>
      </div>
    </section>

    <!-- Restore button when all removed -->
    <div v-if="panels.length === 0" class="text-center text-sm text-muted">
      All panels removed. <button class="underline" @click="restoreDefault">Restore defaults</button>
    </div>
  </div>
</template>

<script setup>
import { ref, reactive, watch, onMounted, onBeforeUnmount, computed } from 'vue'
import { useUIStore } from '@/stores/ui'
const ui = useUIStore()
import PanelBody from '@/components/PanelBody.vue'
import DashboardFilterBar from '@/components/DashboardFilterBar.vue'
import { useFailureStore } from '@/stores/failures'

const failureStore = useFailureStore()

onMounted(() => {
  failureStore.fetchFailures(); // Initial data load
});

const statuses = ['Active', 'In Progress', 'Resolved', 'On Hold'];

/* ------------------- sample data generator ------------------- */


/* ------------------- board + per-panel state ------------------- */
const panels = ref([
  { id: 'today',       title: "Failure",                    kind: 'count' },
  { id: 'failureSeverity', title: 'Failure',                 kind: 'failureSeverity' },
  { id: 'avgtime',     title: 'Avg. Resolution Time',      kind: 'avgTime' },
  { id: 'bysection',   title: 'Failures by Section',       kind: 'bySection' },
  { id: 'bycircuit',   title: 'Failures by Circuit',       kind: 'byCircuit' },
  { id: 'statusdist',  title: 'Status Distribution',       kind: 'statusDistribution' },
  { id: 'bysuper',     title: 'Failure Count by Supervisor', kind: 'bySupervisor' },
])

const defaultState = () => ({
  type: 'bar',
  range: 'today',
  from: '',
  to: '',
  statuses: [...statuses], // select all by default
  severity: 'all',
})

function togglePanelStatus(id, s) {
  const arr = state[id].statuses || []
  const set = new Set(arr)
  set.has(s) ? set.delete(s) : set.add(s)
  state[id].statuses = Array.from(set)
}
function clearPanelStatuses(id) {
  state[id].statuses = [...statuses] // back to “All”
}


const state = reactive(Object.fromEntries(panels.value.map(p => [p.id, defaultState()])))
state.bysection.range = 'month'
state.bycircuit.range = 'month'
state.statusdist.range = 'month'
state.avgtime.range = 'month'

const liveToday = ref(true)
const liveRecent = ref(true)

// Global Analytics filters (UI only for now)
const filters = ref({ range: 'today', status: ['Active','In Progress','Resolved','On Hold'] })

// ---- persistence (localStorage) ----
const STORAGE_KEY = 'analyticsBoard.v1'

function serializeState() {
  const out = {}
  for (const id of Object.keys(state)) out[id] = { ...state[id] }
  return out
}

function saveBoard() {
  try {
    const payload = {
      panels: panels.value.map(p => ({ id: p.id, title: p.title, kind: p.kind })),
      state: serializeState(),
      liveToday: !!liveToday.value,
      liveRecent: !!liveRecent.value,
    }
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload))
  } catch (e) {
    console.warn('saveBoard failed', e)
  }
}

function loadBoard() {
  let saved = null
  try { saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || 'null') } catch (_) {}
  if (!saved || typeof saved !== 'object') return

  if (Array.isArray(saved.panels) && saved.panels.length) {
    panels.value = saved.panels
      .filter(p => p && p.id && p.kind && p.title)
      // Remove deprecated KPI panels per spec
      .filter(p => !['week','pending','recent'].includes(p.id))
      // Rename today's panel to "Failure"
      .map(p => p.id === 'today' ? { ...p, title: 'Failure' } : p)
    // Ensure new Failure-by-Severity card exists
    if (!panels.value.some(p => p.id === 'failureSeverity')) {
      panels.value.splice(1, 0, { id: 'failureSeverity', title: 'Failure', kind: 'failureSeverity' })
    }
  }

  const rebuilt = {}
  for (const p of panels.value) {
    rebuilt[p.id] = { ...defaultState(), ...(saved.state?.[p.id] || {}) }
  }
  Object.keys(state).forEach(k => delete state[k])
  Object.assign(state, rebuilt)

  if (typeof saved.liveToday === 'boolean')  liveToday.value  = saved.liveToday
  if (typeof saved.liveRecent === 'boolean') liveRecent.value = saved.liveRecent
}

// Load any saved layout/settings (now safe)
loadBoard()

// Save whenever layout or settings change
watch(panels, saveBoard, { deep: true })
watch(state,  saveBoard, { deep: true })
watch([liveToday, liveRecent], saveBoard)


/* ------------------- time ranges ------------------- */
const ranges = [
  { key: 'today',  label: 'Today' },
  { key: 'week',   label: 'This Week' },
  { key: 'month',  label: 'This Month' },
  { key: 'year',   label: 'This Year' },
  { key: 'custom', label: 'Custom' },
]
function startOfDay(ts){ const d=new Date(ts); d.setHours(0,0,0,0); return d.getTime() }
function startOfWeek(ts){ const d=new Date(ts); const day=(d.getDay()+6)%7; d.setDate(d.getDate()-day); d.setHours(0,0,0,0); return d.getTime() }
function startOfMonth(ts){ const d=new Date(ts); d.setDate(1); d.setHours(0,0,0,0); return d.getTime() }
function startOfYear(ts){ const d=new Date(ts); d.setMonth(0,1); d.setHours(0,0,0,0); return d.getTime() }
function bounds(rangeKey, from='', to=''){
  const now = Date.now()
  if(rangeKey==='today') return { start: startOfDay(now), end: now }
  if(rangeKey==='week')  return { start: startOfWeek(now), end: now }
  if(rangeKey==='month') return { start: startOfMonth(now), end: now }
  if(rangeKey==='year')  return { start: startOfYear(now), end: now }
  const s = from ? new Date(from).getTime() : startOfDay(now)
  const e = to ? (new Date(to).getTime() + 86399999) : now
  return { start: s, end: e }
}
function setRange(id, key){ state[id].range = key }
function applyCustom(_id){ /* state already holds from/to */ }

/* ------------------- data shaping helpers ------------------- */
const nf = new Intl.NumberFormat('en-IN')
function filterRange(rows, b){ return rows.filter(r => r.reported_at >= b.start && r.reported_at <= b.end) }
function countBy(rows, key){ 
  const m=new Map();
  rows.forEach(r=>{
    let val = r;
    // Handle nested properties like 'section.name'
    if (key.includes('.')) {
      const parts = key.split('.');
      for (const part of parts) {
        val = val ? val[part] : undefined;
      }
    } else {
      val = r[key];
    }
    if (val !== undefined) {
      m.set(val, (m.get(val)||0)+1);
    }
  });
  return m
 }
function toChart(m){ const labels=[...m.keys()]; const data=labels.map(l=>m.get(l)); return {labels, data} }
function avgResolutionMs(rows){
  const done = rows.filter(r => r.current_status==='Resolved' && r.resolved_at && r.reported_at)
  if(!done.length) return 0
  return Math.round(done.reduce((s,r)=>s+(r.resolved_at - r.reported_at),0) / done.length)
}
function fmtDuration(ms){
  if(!ms) return '—'
  const m = Math.round(ms/60000)
  const h = Math.floor(m/60)
  const mm = m%60
  return h? `${h}h ${mm}m` : `${mm}m`
}

/* ------------------- per-panel data ------------------- */
function panelData(p){
  const st = state[p.id]
  const { start, end } = bounds(st.range, st.from, st.to)
  const baseRows = filterRange(failureStore.failures, { start, end })
  const selected = (st.statuses && st.statuses.length) ? new Set(st.statuses) : new Set(statuses)
  const rows = baseRows.filter(r => selected.has(r.current_status))


  switch(p.kind){
    case 'failureSeverity': {
      // provide raw records for the card to aggregate by severity
      return { records: rows }
    }
    case 'count': {
      const byDay = new Map()
      rows.forEach(r=>{
        const d = new Date(r.reported_at); d.setHours(0,0,0,0)
        const k = d.toISOString().slice(0,10)
        byDay.set(k, (byDay.get(k)||0)+1)
      })
      const labels = [...byDay.keys()].sort()
      const data = labels.map(k=>byDay.get(k))
      return { labels, datasets: [{ label: 'Failure Count', data }] }
    }
    case 'pending': {
      const pending = rows.filter(r => r.current_status==='Active' || r.current_status==='In Progress' || r.current_status==='On Hold')
      const m = countBy(pending, 'current_status')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Pending', data }] }
    }
    case 'avgTime': {
      const val = avgResolutionMs(rows)
      return { labels: ['Avg'], datasets: [{ label: fmtDuration(val), data: [Math.round(val/60000)] }], pretty: fmtDuration(val) }
    }
    case 'bySection': {
      const m = countBy(rows, 'section.name')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Failures', data }] }
    }
    case 'byCircuit': {
      const m = countBy(rows, 'circuit')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Failures', data }] }
    }
    case 'statusDistribution': {
      const m = countBy(rows, 'current_status')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Status', data }] }
    }
    case 'bySupervisor': {
      const m = countBy(rows, 'supervisor')
      const {labels, data} = toChart(m)
      return { labels, datasets: [{ label: 'Failures', data }] }
    }
    case 'recent': {
      const recent = [...rows].sort((a,b)=>b.reported_at - a.reported_at).slice(0, 10)
      return { recent }
    }
    default:
      return { labels: [], datasets: [{ label: 'N/A', data: [] }] }
  }
}

/* ------------------- chart options ------------------- */
const chartOptions = {
  responsive: true,
  maintainAspectRatio: false,
  resizeDelay: 150,
  plugins: {
    legend: { position: 'bottom' },
    tooltip: {
      callbacks: {
        title(ctx){ return ctx?.[0]?.label ?? '' },
        label(ctx){ const v = ctx.parsed?.y ?? ctx.parsed ?? 0; return `${ctx.dataset?.label ?? 'Value'}: ${nf.format(v)}` },
      }
    }
  },
  scales: { y: { beginAtZero: true, ticks: { callback: v => nf.format(v) } } }
}

/* ------------------- drag & drop reorder ------------------- */
let dragFrom = -1
function onDragStart(i){ dragFrom = i }
function onDrop(i){
  if(dragFrom < 0 || dragFrom === i) return
  const arr = panels.value
  const [moved] = arr.splice(dragFrom, 1)
  arr.splice(i, 0, moved)
  dragFrom = -1
}

/* ------------------- fullscreen toggle ------------------- */
const fullscreen = ref(null)
function toggleFullscreen(id){ fullscreen.value = (fullscreen.value === id ? null : id) }
function removePanel(id){
  const i = panels.value.findIndex(p=>p.id===id)
  if(i>=0) panels.value.splice(i,1)
}
function restoreDefault(){
  panels.value = [
    { id: 'today',       title: "Failure",                    kind: 'count' },
    { id: 'failureSeverity', title: 'Failure',                 kind: 'failureSeverity' },
    { id: 'avgtime',     title: 'Avg. Resolution Time',      kind: 'avgTime' },
    { id: 'bysection',   title: 'Failures by Section',       kind: 'bySection' },
    { id: 'bycircuit',   title: 'Failures by Circuit',       kind: 'byCircuit' },
    { id: 'statusdist',  title: 'Status Distribution',       kind: 'statusDistribution' },
    { id: 'bysuper',     title: 'Failure Count by Supervisor', kind: 'bySupervisor' },
  ]
    // reset state for the new set
  const rebuilt = {}
  for (const p of panels.value) rebuilt[p.id] = defaultState()
  Object.keys(state).forEach(k => delete state[k])
  Object.assign(state, rebuilt)
  // clear saved board
  localStorage.removeItem(STORAGE_KEY)
}


</script>

<style scoped>
[draggable="true"] { cursor: move; }
</style>

<script setup>
import { ref, computed, watch, onMounted, onBeforeUnmount } from 'vue';
import { useRouter } from 'vue-router';
import { useDashboardStore } from '@/stores/dashboard';
import { useFailureStore } from '@/stores/failures';
import { useRecentFailuresStore } from '@/stores/recentFailures';
import { useSectionsStore } from '@/stores/sections';
import { useDebounce } from '@/composables/useDebounce';

// Restore missing component imports
import SplitPane from '@/components/SplitPane.vue';
import KpiCard from '@/components/KpiCard.vue';
import BarChart from '@/components/BarChart.vue';
import LineChart from '@/components/LineChart.vue';
import DashboardFilterBar from '@/components/DashboardFilterBar.vue';
import RecentFailures from '@/components/RecentFailures.vue';
import SectionPicker from '@/components/SectionPicker.vue';
import FailureDetailsDrawer from '@/components/FailureDetailsDrawer.vue';
import NotificationModal from '@/components/NotificationModal.vue';
import { borderColor } from '@/lib/statusColors';
import { withAlpha } from '@/lib/theme';

// --- Store and Router setup ---
const dashboardStore = useDashboardStore();
const failureStore = useFailureStore();
const recentFailuresStore = useRecentFailuresStore();
const sectionsStore = useSectionsStore();
const router = useRouter();

// --- Restore Missing UI Controls & State ---
const topNMode = ref(true);
const topN = ref(10);
const autoRefresh = ref(false);
const intervalMs = ref(30000);
const chartsSplit = ref(60);
const cumulativeMode = ref(true);
const lastUpdated = ref(Date.now());
let refreshTimer = null;
const drawerOpen = ref(false);
const activeItem = ref(null);
const filters = ref({
  range: '30d',
  status: ['Active', 'In Progress', 'Resolved', 'On Hold'],
  sections: [],
});
const split = ref(Number(localStorage.getItem('dashSplit') || 66));
const isNotifyModalOpen = ref(false);
const failureToNotify = ref(null);

// --- Restore Missing Helper Functions ---
const nf = new Intl.NumberFormat('en-IN');
const formatInt = n => (typeof n === 'number' ? nf.format(n) : n);
function timeAgo(ts) {
  const ms = new Date(ts).getTime();
  if (isNaN(ms)) return '—';
  const diff = Date.now() - ms;
  const m = Math.floor(diff / 60000);
  if (m < 1) return 'just now';
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60);
  if (h < 24) return `${h}h ago`;
  const d = Math.floor(h / 24);
  return `${d}d ago`;
}
// --- End of restored code ---

const fetchData = useDebounce(() => {
    // We need to map section names to IDs for the API
    const sectionNameToIdMap = new Map(sectionsStore.sections.map(s => [s.name, s.id]));
    const sectionIds = filters.value.sections.map(name => sectionNameToIdMap.get(name)).filter(id => id);

    dashboardStore.fetchDashboardData({ ...filters.value, sections: sectionIds });
    recentFailuresStore.fetchRecentFailures();
    lastUpdated.value = Date.now();
}, 300);

onMounted(() => {
  sectionsStore.fetchSections().then(() => {
    fetchData(); // Initial data load after sections are available
  });
  // No need to fetch all failures here anymore, recentFailuresStore handles its own
});

onBeforeUnmount(() => stopTimer());

watch(filters, fetchData, { deep: true });

const isLoading = computed(() => dashboardStore.loading || recentFailuresStore.loading);

// --- Restore missing computed properties ---
const allSectionsMaster = computed(() =>
  (sectionsStore.sections || []).map(s => s.name).sort()
);

const kpis = computed(() => {
  const data = dashboardStore.data?.kpis;
  return [
    { label: 'Active Failures', value: formatInt(data?.active_failures), sublabel: 'in range' },
    { label: 'Resolved', value: formatInt(data?.resolved_in_range), sublabel: 'in range' },
    { label: 'Avg Resolution Time', value: data?.avg_resolution_time || '—', sublabel: 'for range' },
    { label: 'Critical Alerts', value: formatInt(data?.critical_alerts), sublabel: 'filtered' },
  ];
});

const hasBarData = computed(() => {
  const ds = statusBySection.value?.datasets || [];
  return ds.some(d => Array.isArray(d.data) && d.data.some(v => Number(v) > 0));
});

const hasLineData = computed(() => {
  const ds = resolvedOverTime.value?.datasets || [];
  return ds.some(d => Array.isArray(d.data) && d.data.some(v => Number(v) > 0));
});

const rangeLabel = computed(() =>
  filters.value.range === 'today' ? 'today' :
  filters.value.range === '7d' ? 'last 7 days' : 'last 30 days'
);

const statusBySection = computed(() => {
  const chartData = dashboardStore.data?.charts?.status_by_section || [];
  const topData = topNMode.value ? chartData.slice(0, topN.value) : chartData;
  const labels = topData.map(item => item.section__name);
  return {
    labels,
    datasets: [
      { label: 'Active', data: topData.map(item => item.active), borderRadius: 6 },
      { label: 'Resolved', data: topData.map(item => item.resolved), borderRadius: 6 },
    ],
  };
});

const resolvedOverTime = computed(() => {
  const chartData = dashboardStore.data?.charts?.resolved_over_time || [];
  const labels = chartData.map(item => new Date(item.date).toLocaleDateString([], { month: 'short', day: '2-digit' }));
  const data = chartData.map(item => item.count);

  const series = cumulativeMode.value
    ? data.map((sum => value => sum += value)(0))
    : data;

  const primary = borderColor('Resolved');
  return {
    labels,
    datasets: [{
      label: cumulativeMode.value ? 'Resolved (cumulative)' : 'Resolved (per interval)',
      data: series,
      tension: 0.3,
      fill: true,
      borderColor: primary,
      backgroundColor: withAlpha(primary, 0.2),
    }],
  };
});

const recent = computed(() => recentFailuresStore.items);

// --- Other methods that can remain ---
function openDetails(item) { activeItem.value = item; drawerOpen.value = true; }
function handleEdit(id) { router.push(`/failures/edit/${id}`); }
function openNotifyModal(row) { failureToNotify.value = row; isNotifyModalOpen.value = true; }
function stopTimer() { if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; } }
function startTimer() {
    stopTimer();
    if (autoRefresh.value) {
        refreshTimer = setInterval(fetchData, Number(intervalMs.value) || 30000);
    }
}
watch([autoRefresh, intervalMs], startTimer);
watch(split, v => localStorage.setItem('dashSplit', String(v)));
</script>

<template>
  <div class="space-y-6">
    <div class="mt-3 mb-3 flex flex-wrap items-center justify-between gap-3">
      <div class="flex flex-wrap items-center gap-2">
          <DashboardFilterBar v-model="filters" :show-statuses="false" />
          <SectionPicker v-model="filters.sections" :sections="allSectionsMaster" :max-inline="1" placeholder="Search sections…" />
      </div>
      <div class="flex flex-wrap items-center gap-2 shrink-0">
        <select v-model="intervalMs" class="h-10 rounded-lg border-app bg-card text-app px-2 text-sm" title="Auto-refresh interval">
          <option :value="10000">10s</option>
          <option :value="30000">30s</option>
          <option :value="60000">1m</option>
          <option :value="300000">5m</option>
        </select>
        <label class="h-10 inline-flex items-center gap-2 text-sm text-app px-2">
          <input type="checkbox" v-model="autoRefresh" class="h-4 w-4 rounded border-app align-middle" />
          <span class="align-middle">Auto-refresh</span>
        </label>
        <button @click="refresh" :disabled="isLoading" class="h-10 inline-flex items-center gap-2 rounded-lg border-app bg-card text-app px-3 text-sm shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition disabled:opacity-60 disabled:cursor-not-allowed" title="Refresh now">
          <svg viewBox="0 0 24 24" class="w-4 h-4 shrink-0 align-middle"><path fill="currentColor" d="M12 6V3l-4 4l4 4V8c2.76 0 5 2.24 5 5a5 5 0 0 1-8.66 3.54a1 1 0 1 0-1.41 1.41A7 7 0 0 0 19 13c0-3.87-3.13-7-7-7Z"/></svg>
          <span class="leading-none">Refresh</span>
        </button>
        <button @click="resetFilters" :disabled="isLoading" class="h-10 inline-flex items-center gap-2 rounded-lg border-app bg-card text-app px-3 text-sm shadow-card hover:shadow-popover hover:bg-[var(--seasalt-lighter)] transition disabled:opacity-60 disabled:cursor-not-allowed" title="Reset Filters">
          <svg viewBox="0 0 24 24" class="w-4 h-4 shrink-0 align-middle"><path fill="currentColor" d="M12 5a7 7 0 1 1-6.71 9H3a1 1 0 0 1 0-2h4v4a1 1 0 1 1-2 0v-1.52A9 9 0 1 0 12 3a1 1 0 1 1 0 2Z"/></svg>
          <span class="leading-none">Reset</span>
        </button>
      </div>
    </div>
      
    <DashboardFilterBar v-model="filters" :show-ranges="false" />

    <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
        <KpiCard v-for="(kpi, index) in kpis" :key="index" :label="kpi.label" :value="kpi.value" :sublabel="kpi.sublabel" />
    </div>
 
    <SplitPane v-model="split">
      <template #left>
        <SplitPane v-model="chartsSplit" :min-left="35" :max-left="80" class="widget-eq">
          <template #left>
            <div class="rounded-2xl border-app bg-card text-app p-4 relative overflow-hidden shadow-card mr-2 widget-eq-body">
              <div class="mb-2 text-sm font-semibold text-app flex items-center justify-between">
                <span>Status by Section</span>
                <div class="flex items-center gap-2 text-xs font-normal">
                  <label class="inline-flex items-center gap-1">
                    <input type="checkbox" v-model="topNMode" class="h-3.5 w-3.5 rounded border-app" />
                    Top-N
                  </label>
                  <select v-model="topN" :disabled="!topNMode" class="rounded border-app bg-card text-app px-1.5 py-1 disabled:opacity-50" title="How many sections to show">
                    <option :value="5">5</option><option :value="10">10</option><option :value="15">15</option><option :value="20">20</option>
                  </select>
                </div>
              </div>
              <div v-if="!hasBarData && !isLoading" class="h-64 md:h-80 flex items-center justify-center text-sm text-muted">No data for current filters</div>
              <div v-else class="relative h-[300px]"><div class="absolute inset-0"><BarChart :data="statusBySection" /></div></div>
              <div class="mt-2 text-xs text-muted">Last updated: {{ timeAgo(lastUpdated) }}</div>
              <div v-if="isLoading" class="absolute inset-0 bg-card/70 flex items-center justify-center rounded-2xl">
                <svg class="animate-spin h-6 w-6 text-app" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z"/></svg>
              </div>
            </div>
          </template>
          <template #right>
            <div class="rounded-2xl border-app bg-card text-app p-4 relative overflow-hidden shadow-card ml-2 widget-eq-body">
              <div class="mb-2 text-sm font-semibold text-app flex items-center justify-between">
                <span>Resolved over Time ({{ rangeLabel }})</span>
                <label class="inline-flex items-center gap-1 text-xs font-normal">
                  <input type="checkbox" v-model="cumulativeMode" class="h-3.5 w-3.5 rounded border-app" />
                  Cumulative
                </label>
              </div>
              <div v-if="!hasLineData && !isLoading" class="h-64 md:h-80 flex items-center justify-center text-sm text-muted">No data for current filters</div>
              <div v-else class="relative h-[320px]"><div class="absolute inset-0"><LineChart :data="resolvedOverTime" /></div></div>
              <div v-if="isLoading" class="absolute inset-0 bg-card/70 flex items-center justify-center rounded-2xl">
                <svg class="animate-spin h-6 w-6 text-app" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z"/></svg>
              </div>
            </div>
          </template>
        </SplitPane>
      </template>
      <template #right>
        <div class="rounded-2xl border-app bg-card text-app overflow-hidden shadow-card widget-eq">
          <div class="px-4 py-3 border-b border-app text-sm font-semibold">Recent Failures</div>
          <div class="p-2">
            <RecentFailures 
                :items="recent" 
                :show-toolbar="false" 
                :show-bottom-actions="false" 
                :show-row-actions="true" 
                :loading="isLoading" 
                :show-header="false" 
                storage-key="rf-dashboard" 
                @view="openDetails" 
                @edit="handleEdit" 
                @notify="openNotifyModal" />
            <FailureDetailsDrawer v-model="drawerOpen" :item="activeItem" />
            <NotificationModal v-model="isNotifyModalOpen" :failure="failureToNotify" />
          </div>
        </div>
      </template>
    </SplitPane>
  </div>
</template>

<script setup>
import { ref, reactive, onMounted, computed, watch, nextTick } from 'vue';
import { useRoute, useRouter } from 'vue-router';
import { useFailureStore } from '@/stores/failures';
import { useSectionsStore } from '@/stores/sections';
import { useUIStore } from '@/stores/ui';
import FailureForm from '@/components/FailureForm.vue';
import Spinner from '@/components/ui/Spinner.vue';

// Helper to format dates for the datetime-local input
function toLocalISOString(date) {
  if (!date) return '';
  const d = new Date(date);
  if (isNaN(d.getTime())) return '';
  const offset = d.getTimezoneOffset();
  const localDate = new Date(d.getTime() - (offset * 60 * 1000));
  return localDate.toISOString().slice(0, 16);
}

const route = useRoute();
const router = useRouter();
const failureStore = useFailureStore();
const sectionsStore = useSectionsStore();
const ui = useUIStore();

const failureId = route.params.id;
const isLoading = ref(true);
const form = reactive({ userTags: [] });
const errors = reactive({});

const options = computed(() => ({
  depots: infrastructureStore.depots.map(d => ({ label: d.code || d.name, value: d.id })),
  circuits: infrastructureStore.circuits,
  stations: infrastructureStore.stations,
  sections: infrastructureStore.sections,
  subSections: infrastructureStore.subSections,
  supervisors: infrastructureStore.supervisors.map(s => ({ label: s.name, value: s.id })),
  statuses: [ { label: 'Active', value: 'Active' }, { label: 'In Progress', value: 'In Progress' }, { label: 'Resolved', value: 'Resolved' }, { label: 'On Hold', value: 'On Hold' }, { label: 'Information', value: 'Information' }],
}));

onMounted(async () => {
  try {
    await Promise.all([
      infrastructureStore.fetchDepots(),
      infrastructureStore.fetchCircuits(),
      infrastructureStore.fetchStations(),
      infrastructureStore.fetchSections(),
      infrastructureStore.fetchSubSections(),
      infrastructureStore.fetchSupervisors(),
    ]);

    await failureStore.fetchFailure(failureId);
    const failureData = failureStore.currentFailure;
    
    if (failureData) {
      Object.assign(form, {
        ...failureData,
        depot: failureData.station?.depot || failureData.section?.depot || null,
        circuit: failureData.circuit?.id || null,
        station: failureData.station?.id || null,
        section: failureData.section?.id || null,
        sub_section: failureData.sub_section?.id || null,
        assigned_to: failureData.assigned_to?.id || null,
        reported_at: toLocalISOString(failureData.reported_at),
        resolved_at: toLocalISOString(failureData.resolved_at),
        userTags: [],
      });
      // Use nextTick to ensure dependent dropdowns populate correctly
      await nextTick();
    }
  } catch (error) {
    console.error("Failed to load data for editing:", error);
    ui.pushToast({ type: 'error', title: 'Load Failed', message: 'Could not load failure data for editing.' });
  } finally {
    isLoading.value = false;
  }
});

// Watchers for auto-populating date and duration
watch(() => form.current_status, (status) => {
  if (status === 'Resolved' && !form.resolved_at) {
    form.resolved_at = toLocalISOString(new Date());
  }
});

watch(() => [form.reported_at, form.resolved_at], ([reported, resolved]) => {
  if (reported && resolved) {
    const ms = new Date(resolved) - new Date(reported);
    form.duration_minutes = isNaN(ms) || ms < 0 ? '' : Math.round(ms / 60000);
  } else {
    form.duration_minutes = '';
  }
});

function validate() {
  errors.circuit = form.circuit ? '' : 'Required';
  return !errors.circuit;
}

async function submit() {
  if (!validate()) {
    ui.pushToast({ type: 'error', title: 'Missing fields', message: 'Circuit is required.' });
    return;
  }
  
  const payload = { ...form };
  delete payload.userTags;
  payload.resolved_at = payload.resolved_at || null;

  const savedFailure = await failureStore.updateFailure(failureId, payload);
  if (savedFailure) {
    ui.pushToast({ type: 'success', title: 'Success', message: 'Logbook entry updated.' });
    if (savedFailure.current_status !== 'Draft' && savedFailure.current_status !== 'Information') {
      await failureStore.sendFailureNotification(savedFailure.id, ['alert']);
      ui.pushToast({ type: 'info', title: 'Notification', message: 'Update notification sent.' });
    }
    // Go to Logbook to see the change, not the new entry page
    router.push('/logbook');
  }
}

function cancel() {
    router.push('/logbook');
}
</script>

<template>
  <div class="space-y-4 max-w-4xl mx-auto">
    <div class="text-center">
      <h2 class="text-2xl font-semibold leading-tight">
        Edit Failure Log #{{ failureStore.currentFailure?.fail_id || failureId }}
      </h2>
    </div>
    <div class="card min-h-[400px]">
      <div v-if="isLoading" class="flex items-center justify-center p-10">
        <Spinner :size="40" />
      </div>
      <div v-else-if="!failureStore.currentFailure" class="text-center p-10 text-muted">
        Could not load failure record.
      </div>
      <div v-else>
        <FailureForm v-model="form" :options="options" :errors="errors" :is-edit-mode="true" />
        <div class="sm:col-span-2 flex items-center justify-end gap-3 pt-4 mt-4 border-t border-app">
            <button type="button" class="btn btn-outline" @click="cancel">Cancel</button>
            <button type="button" class="btn btn-primary" @click="submit">Save Changes & Notify</button>
        </div>
      </div>
    </div>
  </div>
</template>


<script setup>
import { reactive, ref, computed, watch, onMounted, nextTick } from 'vue'
import { useRouter } from 'vue-router'
import { useUIStore } from '@/stores/ui'
import { useSectionsStore } from '@/stores/sections';
import { useFailureStore } from '@/stores/failures'
import { useRecentFailuresStore } from '@/stores/recentFailures';
import { useTelegramStore } from '@/stores/telegram'
import { useAttachmentStore } from '@/stores/attachments'
import FailureForm from '@/components/FailureForm.vue'
import RecentFailures from '@/components/RecentFailures.vue'
import NotificationModal from '@/components/NotificationModal.vue'

// Helper to format dates
function toLocalISOString(date) {
  if (!date) return '';
  const d = new Date(date);
  if (isNaN(d.getTime())) return '';
  const offset = d.getTimezoneOffset();
  const localDate = new Date(d.getTime() - (offset * 60 * 1000));
  return localDate.toISOString().slice(0, 16);
}

// Initialize Stores
const ui = useUIStore();
const sectionsStore = useSectionsStore();
const failureStore = useFailureStore();
const recentFailuresStore = useRecentFailuresStore();
const telegramStore = useTelegramStore();
const attachmentStore = useAttachmentStore();
const router = useRouter();

// Component State
const editingFailureId = ref(null);
const isEditMode = computed(() => !!editingFailureId.value);
const isArchiveModalOpen = ref(false);
const failureToArchive = ref(null);
const archiveReason = ref('');
const isNotifyModalOpen = ref(false);
const failureToNotify = ref(null);

// Form State
const initialFormState = { id: null, fail_id: '', depot: null, circuit: null, entry_type: 'item', station: null, section: null, sub_section: null, reported_at: toLocalISOString(new Date()), assigned_to: null, current_status: 'Active', remark_fail: '', resolved_at: '', duration_minutes: '', remark_right: '', userTags: [] };
const form = reactive({ ...initialFormState });
const errors = reactive({});

// Data Loading
let initialDataLoadPromise = null;
onMounted(() => {
  initialDataLoadPromise = Promise.all([
    infrastructureStore.fetchDepots(),
    infrastructureStore.fetchCircuits(),
    infrastructureStore.fetchStations(),
    infrastructureStore.fetchSections(),
    infrastructureStore.fetchSubSections(),
    infrastructureStore.fetchSupervisors(),
    recentFailuresStore.fetchRecentFailures(),
    telegramStore.fetchTelegramGroups(),
  ]).catch(error => {
    console.error("Failed to load initial form data:", error);
    ui.pushToast({ type: 'error', title: 'Load Failed', message: 'Could not load necessary form data.' });
  });
});

// Computed properties for dropdowns
const options = computed(() => ({
  depots: infrastructureStore.depots.map(d => ({ label: d.code || d.name, value: d.id })),
  circuits: infrastructureStore.circuits,
  stations: infrastructureStore.stations,
  sections: infrastructureStore.sections,
  subSections: infrastructureStore.subSections,
  supervisors: infrastructureStore.supervisors.map(s => ({ label: s.name, value: s.id })),
  statuses: [ { label: 'Active', value: 'Active' }, { label: 'In Progress', value: 'In Progress' }, { label: 'Resolved', value: 'Resolved' }, { label: 'On Hold', value: 'On Hold' }, { label: 'Information', value: 'Information' }],
}));

const recentFailures = computed(() => recentFailuresStore.items)

async function handleEditRequest(id) {
  await initialDataLoadPromise;
  await failureStore.fetchFailure(id); // 1. Call the action to update the store
  const failureData = failureStore.currentFailure; // 2. Get the data from the store's state

  if (failureData) {
    resetForm();
    editingFailureId.value = id;
    Object.assign(form, {
      ...failureData,
      circuit: failureData.circuit?.id || null,
      assigned_to: failureData.assigned_to?.id || null,
      reported_at: toLocalISOString(failureData.reported_at),
      resolved_at: toLocalISOString(failureData.resolved_at),
      userTags: [],
    });
    form.depot = failureData.station?.depot || failureData.section?.depot || null;
    await nextTick();
    form.station = failureData.station?.id || null;
    form.section = failureData.section?.id || null;
    await nextTick();
    form.sub_section = failureData.sub_section?.id || null;
  }
}

// Other form logic
watch(() => form.entry_type, (newType, oldType) => {
  if (newType === 'message') {
    const infoCircuit = infrastructureStore.circuits.find(c => c.name === 'Info');
    const allDepot = infrastructureStore.depots.find(d => d.name === 'ALL');
    const allSupervisor = infrastructureStore.supervisors.find(s => s.name === 'ALL');
    form.circuit = infoCircuit?.id || null;
    form.current_status = 'Information';
    form.depot = allDepot?.id || null;
    form.assigned_to = allSupervisor?.id || null;
  } else if (oldType === 'message') {
    resetForm();
  }
});
watch(() => form.current_status, v => { if (v === 'Resolved' && !form.resolved_at) form.resolved_at = toLocalISOString(new Date()) });
watch(() => [form.reported_at, form.resolved_at], ([rep, res]) => { if (!rep || !res) { form.duration_minutes = '' } else { const ms = new Date(res) - new Date(rep); form.duration_minutes = isNaN(ms) || ms < 0 ? '' : Math.round(ms / 60000) } });
function validate() { errors.circuit = form.circuit ? '' : 'Required'; return !errors.circuit; }

function resetForm() {
  Object.assign(form, initialFormState);
  form.reported_at = toLocalISOString(new Date());
  editingFailureId.value = null;
  attachmentStore.attachments = [];
}

async function submit() {
  if (!validate()) {
    ui.pushToast({ type: 'error', title: 'Missing fields', message: 'Circuit is required.' });
    return;
  }
  const payload = { ...form };
  delete payload.userTags;
  payload.resolved_at = payload.resolved_at || null;

  let savedFailure;
  if (isEditMode.value) {
    savedFailure = await failureStore.updateFailure(editingFailureId.value, payload);
    if (savedFailure) {
        ui.pushToast({ type: 'success', title: 'Success', message: 'Logbook entry updated.' });
        // After updating, you might want to stay on the page or redirect
        // For now, we stay.
    }
  } else {
    // This is a new entry
    savedFailure = await failureStore.addFailure(payload);
     if (savedFailure) {
        ui.pushToast({ type: 'success', title: 'Success', message: 'Entry saved. You can now add attachments.' });
        // Reset the form for the next entry
        resetForm();

        if (savedFailure.current_status !== 'Information') {
             await failureStore.sendFailureNotification(savedFailure.id, ['alert']);
             ui.pushToast({ type: 'info', title: 'Notified', message: 'Alert notification sent.' });
        }
    }
  }
}

function openNotifyModal(row) { failureToNotify.value = row; isNotifyModalOpen.value = true; }
function handleArchiveRequest(failure) { failureToArchive.value = failure; isArchiveModalOpen.value = true; archiveReason.value = ''; }
async function confirmArchive() { if (failureToArchive.value) { await failureStore.archiveFailure(failureToArchive.value.id, archiveReason.value); failureToArchive.value = null; isArchiveModalOpen.value = false; } }
const split = ref(50);
const dragging = ref(false);
const splitWrap = ref(null);
function onDragStart(e) { dragging.value = true; window.addEventListener('mousemove', onDrag); window.addEventListener('mouseup', onDragEnd); }
function onDrag(e) { if (!splitWrap.value) return; const rect = splitWrap.value.getBoundingClientRect(); let pct = ((e.clientX - rect.left) / rect.width) * 100; pct = Math.max(25, Math.min(75, pct)); split.value = Math.round(pct); }
function onDragEnd() { dragging.value = false; window.removeEventListener('mousemove', onDrag); window.removeEventListener('mouseup', onDragEnd); }
</script>

<template>
  <div class="flex-1 flex flex-col gap-4 p-4 overflow-y-auto">
    <div ref="splitWrap" class="flex-1 flex items-start gap-4" :class="dragging ? 'cursor-col-resize select-none' : ''">
      <div class="flex flex-col" :style="{ width: split + '%' }">
        <h2 class="text-xl font-semibold leading-tight mb-4">{{ isEditMode ? `Editing Entry #${form.fail_id}` : 'New Logbook Entry' }}</h2>
        <div class="card">
          <FailureForm v-model="form" :options="options" :errors="errors" :is-edit-mode="isEditMode" />
          <div class="sm:col-span-2 flex items-center justify-between pt-4 mt-4 border-t border-app">
            <div :class="{'invisible': isEditMode}">
                </div>
            <div class="flex gap-3">
              <button type="button" class="btn btn-outline" @click="resetForm">{{ isEditMode ? 'Cancel Edit' : 'Reset' }}</button>
              <button type="button" class="btn btn-primary" @click="submit">{{ isEditMode ? 'Save Changes' : 'Submit & Notify' }}</button>
            </div>
          </div>
        </div>
      </div>

      <div class="w-1 self-stretch bg-[var(--border)] hover:bg-[var(--text)]/30 cursor-col-resize rounded" @mousedown="onDragStart" />

      <div class="flex flex-col" :style="{ width: 100 - split + '%' }">
        <h2 class="text-xl font-semibold leading-tight mb-4">Recent Failure Logs</h2>
        <RecentFailures
          :items="recentFailures"
          storage-key="rf-newfailure"
          :editing-id="editingFailureId"
          :show-header="false"
          @notify="openNotifyModal"
          @edit="handleEditRequest"
          @delete="handleArchiveRequest"
        />
      </div>
    </div>

    <NotificationModal v-model="isNotifyModalOpen" :failure="failureToNotify" />
    <div v-if="isArchiveModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div class="bg-card rounded-lg p-6 shadow-xl w-full max-w-md">
        <h3 class="text-lg font-bold">Confirm Archival</h3>
        <p class="mt-2">
          Are you sure you want to archive failure log
          <span class="font-semibold">{{ failureToArchive?.fail_id }}</span>?
        </p>
        <div class="mt-4">
          <label for="archiveReason" class="block text-sm font-medium text-app">Reason for archiving</label>
          <textarea v-model="archiveReason" id="archiveReason" rows="3" class="field-textarea mt-1"></textarea>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button @click="isArchiveModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmArchive" class="btn btn-danger">Archive</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch, onMounted } from 'vue';
import { useRouter } from 'vue-router';
import { useDebounce } from '@/composables/useDebounce';
import { useLogbookStore } from '@/stores/logbook';
import { useSectionsStore } from '@/stores/sections';
import { useFailureStore } from '@/stores/failures';
import DataTable from '@/components/DataTable.vue';
import FailureDetailsDrawer from '@/components/FailureDetailsDrawer.vue';
import Spinner from '@/components/ui/Spinner.vue';
import SearchSelect from '@/components/form/SearchSelect.vue';
import { Bell, Pencil, Trash2, FileDown, FileText, ChevronLeft, ChevronRight, ChevronsLeft, ChevronsRight } from 'lucide-vue-next';

// --- Store setup ---
const logbookStore = useLogbookStore();
const sectionsStore = useSectionsStore();
const failureStore = useFailureStore(); // Keep for archive action
const router = useRouter();

// --- UI State ---
const drawerOpen = ref(false);
const activeItem = ref(null);
const isArchiveModalOpen = ref(false);
const failureToArchive = ref(null);
const archiveReason = ref('');

// --- Filtering, Sorting, and Pagination State ---
// This is the main state object that drives the API calls
const filters = ref({
  query: '',
  circuits: [],
  sections: [],
  stations: [],
  supervisors: [],
  statuses: [],
  sortKey: 'reported_at',
  sortDir: 'desc',
  page: 1,
  rowsPerPage: 20,
});

// --- Data Fetching ---
onMounted(() => {
  fetchData(); // Initial data load
  // Fetch data for filter dropdowns
  infrastructureStore.fetchCircuits();
  infrastructureStore.fetchSections();
  infrastructureStore.fetchStations();
  infrastructureStore.fetchSupervisors();
});

const fetchData = useDebounce(() => {
    // Construct params object for the API call
    const params = {
        query: filters.value.query,
        'circuits[]': filters.value.circuits,
        'sections[]': filters.value.sections,
        'stations[]': filters.value.stations,
        'supervisors[]': filters.value.supervisors,
        'statuses[]': filters.value.statuses,
        sortKey: filters.value.sortKey,
        sortDir: filters.value.sortDir,
        page: filters.value.page,
        rowsPerPage: filters.value.rowsPerPage,
    };
    logbookStore.fetchLogbookData(params);
}, 300); // Debounce API calls to prevent spamming

// Watch for any changes in filters and re-fetch data
watch(filters, fetchData, { deep: true });

// --- Computed Data for UI ---
const loading = computed(() => logbookStore.loading);
const error = computed(() => logbookStore.error);
const paginatedRows = computed(() => logbookStore.failures);
const totalPages = computed(() => logbookStore.num_pages);
const currentPage = computed({
    get: () => filters.value.page,
    set: (val) => { filters.value.page = val; }
});

// --- RESTORED: Options for Filter Dropdowns ---
const circuitOptions = computed(() => infrastructureStore.circuits.map(c => ({ label: `${c.circuit_id} (${c.name})`, value: c.id })));
const sectionOptions = computed(() => infrastructureStore.sections.map(s => ({ label: s.name, value: s.id })));
const stationOptions = computed(() => infrastructureStore.stations.map(s => ({ label: s.name, value: s.id })));
const supervisorOptions = computed(() => infrastructureStore.supervisors.map(s => ({ label: s.name, value: s.id })));
const statusOptions = computed(() => ([
    { label: 'Active', value: 'Active' }, { label: 'In Progress', value: 'In Progress' },
    { label: 'Resolved', value: 'Resolved' }, { label: 'On Hold', value: 'On Hold' },
]));

// --- RESTORED: Columns definition for DataTable ---
const columns = [
  { key: 'reported_at', label: 'Reported', sortable: true },
  { key: 'resolved_at', label: 'Resolved', sortable: true },
  { key: 'duration',    label: 'Duration', sortable: false, align: 'text-center' },
  { key: 'fail_id',     label: 'Event ID', sortable: true },
  { key: 'circuit',     label: 'Circuit', sortable: true },
  { key: 'station',     label: 'Station', sortable: true },
  { key: 'section',     label: 'Section', sortable: true },
  { key: 'assigned_to', label: 'Assigned', sortable: true },
  { key: 'current_status', label: 'Status', sortable: true },
  { key: 'actions',     label: 'Actions', sortable: false, align: 'text-center', width: '120px' },
];

// --- Methods ---
function toggleSort(key) {
  if (filters.value.sortKey === key) {
    filters.value.sortDir = filters.value.sortDir === 'asc' ? 'desc' : 'asc';
  } else {
    filters.value.sortKey = key;
    filters.value.sortDir = 'desc';
  }
}

// Pagination methods
function goToFirstPage() { filters.value.page = 1; }
function goToLastPage() { filters.value.page = totalPages.value; }
function goToNextPage() { if (filters.value.page < totalPages.value) filters.value.page++; }
function goToPreviousPage() { if (filters.value.page > 1) filters.value.page--; }

// --- RESTORED: All other helper methods ---
function openDetails(row) { activeItem.value = row; drawerOpen.value = true; }
function editFailure(row) { router.push(`/failures/edit/${row.id}`); }
function openArchiveModal(row) { failureToArchive.value = row; isArchiveModalOpen.value = true; archiveReason.value = ''; }
async function confirmArchive() {
  if (failureToArchive.value) {
    await failureStore.archiveFailure(failureToArchive.value.id, archiveReason.value);
    failureToArchive.value = null;
    isArchiveModalOpen.value = false;
    fetchData(); // Re-fetch data after archiving
  }
}
function formatDuration(start, end) {
  if (!start || !end) return '—';
  const diff = new Date(end) - new Date(start);
  if (diff < 0) return '—';
  const minutes = Math.floor(diff / 60000);
  if (minutes < 60) return `${minutes}m`;
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${hours}h ${mins}m`;
}
function badgeClasses(status) {
    if (status === 'Resolved') return 'badge-success';
    if (status === 'Active') return 'badge-danger';
    if (status === 'In Progress') return 'badge-warning';
    if (status === 'On Hold') return 'badge-hold';
    if (status === 'Information') return 'badge-neutral';
    return 'badge-neutral';
}
</script>

<template>
  <div class="space-y-4">
    <div class="text-center">
      <h2 class="text-2xl font-semibold">Logbook</h2>
    </div>

    <!-- Filter Bar -->
    <div class="sticky top-0 z-10 bg-app py-4 card">
       <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4">
        <input v-model="filters.query" type="search" placeholder="Search anything..." class="h-11 w-full rounded-lg border-app bg-card text-app px-3 text-sm" />
        <SearchSelect v-model="filters.circuits" :options="circuitOptions" placeholder="Filter by Circuit" multiple />
        <SearchSelect v-model="filters.sections" :options="sectionOptions" placeholder="Filter by Section" multiple />
        <SearchSelect v-model="filters.stations" :options="stationOptions" placeholder="Filter by Station" multiple />
        <SearchSelect v-model="filters.supervisors" :options="supervisorOptions" placeholder="Filter by Supervisor" multiple />
        <SearchSelect v-model="filters.statuses" :options="statusOptions" placeholder="Filter by Status" multiple />
      </div>
    </div>

    <div v-if="loading" class="text-center p-6"><Spinner /></div>
    <div v-else-if="error" class="card p-6 text-center text-red-500">{{ error }}</div>

    <div v-else>
      <div class="card p-4">
        <DataTable
          :columns="columns"
          :rows="paginatedRows"
          :sort-key="filters.sortKey"
          :sort-dir="filters.sortDir"
          @sort="toggleSort"
          @rowclick="openDetails"
        >
          <template #body-cell-comp="{ row, column }">
            <tr :class="{ 'opacity-60': row.is_archived }">
              <component :is="column.cell" :row="row" />
            </tr>
          </template>
          <template #reported_at="{ row }">{{ new Date(row.reported_at).toLocaleString() }}</template>
          <template #resolved_at="{ row }">{{ row.resolved_at ? new Date(row.resolved_at).toLocaleString() : '–' }}</template>
          <template #duration="{ row }">{{ formatDuration(row.reported_at, row.resolved_at) }}</template>
          <template #circuit="{ row }">{{ row.circuit?.name || '–' }}</template>
          <template #station="{ row }">{{ row.station?.name || '–' }}</template>
          <template #section="{ row }">{{ row.section?.name || '–' }}</template>
          <template #assigned_to="{ row }">{{ row.assigned_to?.name || '–' }}</template>
          <template #current_status="{ row }"><span class="badge" :class="badgeClasses(row.current_status)">{{ row.current_status }}</span></template>
          <template #actions="{ row }">
            <div class="flex items-center justify-center gap-1.5">
              <button class="btn-ghost border-app rounded-md hover-primary p-2" title="Notify" @click.stop disabled><Bell class="w-4 h-4" /></button>
              <button class="btn-ghost border-app rounded-md hover-primary p-2" title="Edit" @click.stop="editFailure(row)"><Pencil class="w-4 h-4" /></button>
              <button class="btn-ghost border-app rounded-md hover-primary p-2" title="Archive" @click.stop="openArchiveModal(row)"><Trash2 class="w-4 h-4" /></button>
            </div>
          </template>
        </DataTable>
      </div>
        
      <!-- Pagination Controls -->
      <div class="mt-4 flex items-center justify-between">
        <div class="flex items-center justify-center gap-2 p-2 rounded-lg">
          <button class="btn btn-outline btn-sm gap-2"><FileDown class="w-4 h-4" /><span>Export CSV</span></button>
          <button class="btn btn-outline btn-sm gap-2"><FileText class="w-4 h-4" /><span>Export PDF</span></button>
        </div>
        <div class="flex items-center justify-end gap-2 p-2 rounded-lg">
          <button @click="goToFirstPage" :disabled="filters.page === 1" class="btn-ghost p-2" title="First"><ChevronsLeft class="w-4 h-4" /></button>
          <button @click="goToPreviousPage" :disabled="filters.page === 1" class="btn-ghost p-2" title="Previous"><ChevronLeft class="w-4 h-4" /></button>
          <span class="text-sm text-muted">Page {{ filters.page }} of {{ totalPages }}</span>
          <button @click="goToNextPage" :disabled="filters.page >= totalPages" class="btn-ghost p-2" title="Next"><ChevronRight class="w-4 h-4" /></button>
          <button @click="goToLastPage" :disabled="filters.page >= totalPages" class="btn-ghost p-2" title="Last"><ChevronsRight class="w-4 h-4" /></button>
        </div>
      </div>
    </div>

    <FailureDetailsDrawer v-model="drawerOpen" :item="activeItem" />

    <!-- Archive Confirmation Modal -->
    <div v-if="isArchiveModalOpen" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div class="bg-card rounded-lg p-6 shadow-xl w-full max-w-md">
        <h3 class="text-lg font-bold">Confirm Archival</h3>
        <p class="mt-2">
          Are you sure you want to archive failure log
          <span class="font-semibold">{{ failureToArchive?.fail_id }}</span>?
        </p>
        <div class="mt-4">
          <label for="archiveReason" class="block text-sm font-medium text-app">Reason for archiving</label>
          <textarea v-model="archiveReason" id="archiveReason" rows="3" class="field-textarea mt-1"></textarea>
        </div>
        <div class="mt-6 flex justify-end gap-3">
          <button @click="isArchiveModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmArchive" class="btn btn-danger">Archive</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { reactive } from 'vue'
import InputText from '@/components/form/InputText.vue'
import { useRouter, useRoute } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { useUIStore } from '@/stores/ui'

const router = useRouter()
const route = useRoute()
const auth = useAuthStore()
const ui = useUIStore()

const form = reactive({ username: '', password: '' })
const errors = reactive({ username: '', password: '' })

function validate() {
  errors.username = form.username ? '' : 'Required'
  errors.password = form.password ? '' : 'Required'
  return !errors.username && !errors.password
}

async function submit() {
  if (!validate()) return ui.pushToast({ type: 'error', title: 'Missing fields', message: 'Enter username & password.' })
  try {
    await auth.login(form) // mock for now
    ui.pushToast({ type: 'success', title: 'Welcome', message: `Logged in as ${auth.user.username}` })
    const next = (route.query.next && String(route.query.next)) || '/dashboard'
    router.push(next)
  } catch (e) {
    ui.pushToast({ type: 'error', title: 'Login failed', message: e?.message || 'Try again.' })
  }
}
</script>

<template>
  <div class="min-h-[60vh] flex items-center justify-center p-6">
    <div class="w-full max-w-sm rounded-2xl border bg-white p-6">
      <div>
        <h2 class="text-xl font-semibold">Sign in</h2>
        <p class="text-sm text-gray-500">Demo auth — will connect to Django later.</p>
      </div>
      <form class="space-y-4 mt-4" @submit.prevent="submit">
        <div class="space-y-3">
          <InputText label="Username" v-model="form.username" :error="errors.username" placeholder="e.g. admin" />
          <InputText label="Password" v-model="form.password" :error="errors.password" type="password" placeholder="••••••••" autocomplete="current-password" />
        </div>
        <button type="submit" class="btn w-full">Sign in</button>
      </form>
    </div>
  </div>
</template>


<script setup>
import WidgetShell from '@/components/WidgetShell.vue'
import { computed, ref } from 'vue'
import { useReportsStore } from '@/stores/reports.js'
import { useTelegramStore } from '@/stores/telegram.js'

const reports = useReportsStore()
const tg = useTelegramStore()
const rows = computed(() => reports.items)
const tgOptions = computed(() => tg.list)

const sendingIds = ref(new Set())

function sendNow(row) {
  const payload = {
    id: row.id,
    name: row.name,
    templateName: row.templateName,
    sendEmail: row.sendEmail ?? false,
    sendTelegram: row.sendTelegram ?? false,
    telegramGroupKey: row.telegramGroupKey ?? 'reports',
  }
  sendingIds.value.add(row.id)
  setTimeout(() => {
    console.log('[ReportsNow] SEND NOW payload:', payload)
    alert(`Queued send for “${row.name}”\nEmail: ${payload.sendEmail}\nTelegram: ${payload.sendTelegram} (${payload.telegramGroupKey})`)
    sendingIds.value.delete(row.id)
  }, 400)
}
</script>

<template>
  <div class="p-4 md:p-6 space-y-4">
    <h1 class="text-xl md:text-2xl font-semibold">Reports Now</h1>

    <WidgetShell :hideHeader="true">
      <div class="space-y-3">
        <p class="text-sm opacity-80">Trigger any defined report immediately. (Frontend-only mock)</p>

        <div class="overflow-x-auto">
          <table class="min-w-[960px] w-full text-sm">
            <thead>
              <tr class="text-left border-b border-[var(--surface-3)]">
                <th class="py-2 pr-3 w-[280px]">Report</th>
                <th class="py-2 pr-3 w-[220px]">Template</th>
                <th class="py-2 pr-3 w-[140px]">Email</th>
                <th class="py-2 pr-3 w-[240px]">Telegram</th>
                <th class="py-2 pr-0  w-[120px]">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="r in rows" :key="r.id" class="border-b border-[var(--surface-2)]">
                <td class="py-2 pr-3">
                  <div class="font-medium">{{ r.name || '—' }}</div>
                  <div class="text-xs opacity-70">ID: {{ r.id.slice(0,8) }}</div>
                </td>
                <td class="py-2 pr-3">
                  <span class="opacity-80">{{ r.templateName || 'No file chosen' }}</span>
                </td>
                <td class="py-2 pr-3">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" v-model="r.sendEmail" />
                    <span>Send Email</span>
                  </label>
                </td>
                <td class="py-2 pr-3">
                  <div class="flex flex-wrap items-center gap-2">
                    <label class="inline-flex items-center gap-2">
                      <input type="checkbox" v-model="r.sendTelegram" />
                      <span>Telegram</span>
                    </label>
                    <select
                      class="chip"
                      :disabled="!r.sendTelegram"
                      :value="r.telegramGroupKey ?? 'reports'"
                      @change="reports.update(r.id, { telegramGroupKey: $event.target.value })"
                    >
                      <option v-for="g in tgOptions" :key="g.key" :value="g.key">{{ g.name }}</option>
                    </select>
                  </div>
                </td>
                <td class="py-2 pr-0">
                  <button
                    class="chip selected-primary"
                    :disabled="sendingIds.has(r.id) || (!r.sendEmail && !r.sendTelegram)"
                    @click="sendNow(r)"
                  >
                    {{ sendingIds.has(r.id) ? 'Sending…' : 'Send Now' }}
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <p class="text-xs opacity-70">
          Note: backend/bot wiring comes later; this page logs a mock payload.
        </p>
      </div>
    </WidgetShell>
  </div>
</template>

<style scoped></style>



<script setup>
import InputText from '@/components/form/InputText.vue'
import SelectBox from '@/components/form/SelectBox.vue'
import { reactive } from 'vue'
import { useAppStore } from '@/stores/app'
import { useUIStore } from '@/stores/ui'

const app = useAppStore()
const ui = useUIStore()

// demo form state (later we’ll load/save via API)
const form = reactive({
  appName: app.appName,

  realtimeIntervalSec: '30',
  failIdSeparator: '-',
})

const intervalOptions = [
  { label: '10 sec', value: '10' },
  { label: '20 sec', value: '20' },
  { label: '30 sec', value: '30' },
  { label: '60 sec', value: '60' },
]

function save() {
  // for now, just update the store for app name and toast
  app.setAppName(form.appName || 'Railway Failure System')
  ui.pushToast({ type: 'success', title: 'Saved', message: 'Settings updated (local only).' })
}
</script>

<template>
  <div class="space-y-6 max-w-3xl">
    <div>
      <h2 class="text-2xl font-semibold">Settings</h2>
      <p class="text-sm text-gray-500">UI-only for now. We’ll wire to Django later.</p>
    </div>
    <div class="rounded-2xl border bg-white p-4 space-y-6">
      <section class="space-y-3">
        <h3 class="text-sm font-semibold text-gray-700">General</h3>
        <InputText label="Application Name" v-model="form.appName" placeholder="Railway Failure System" />
        <SelectBox label="Realtime Update Interval" v-model="form.realtimeIntervalSec" :options="intervalOptions" />
      </section>

      <section class="space-y-3">
        <h3 class="text-sm font-semibold text-gray-700">Event ID</h3>
        <InputText label="Separator" v-model="form.failIdSeparator" placeholder="-" />
      </section>

      <div class="flex gap-2">
        <button @click="save" class="btn">Save</button>
        <button
          @click="Object.assign(form,{ appName:'Railway Failure System', realtimeIntervalSec:'30', failIdSeparator:'-' })"
          class="btn btn-outline"
        >
          Reset
        </button>
      </div>
    </div>
    <div class="rounded-2xl border bg-white p-4 mt-6">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Buttons Preview</h3>
        <div class="flex flex-wrap gap-3">
          <button class="btn">Primary</button>
          <button class="btn btn-secondary">Secondary</button>
          <button class="btn btn-outline">Outline</button>
          <button class="btn btn-ghost">Ghost</button>
        </div>
    </div>
  </div>
</template>


<script setup>
import { ref, computed, onMounted, watch } from 'vue';
import { useSupervisorMovementsStore } from '@/stores/supervisorMovements';
import { useSectionsStore } from '@/stores/sections';
import { Save, Send } from 'lucide-vue-next';

// --- Store Setup ---
const movementsStore = useSupervisorMovementsStore();
const sectionsStore = useSectionsStore();

// --- State ---
const today = new Date().toISOString().slice(0, 10);
const selectedDate = ref(today);
const supervisorData = computed(() => movementsStore.dailyMovements);
const supervisorOptions = computed(() => infrastructureStore.supervisors.map(s => ({ value: s.id, label: s.name })));

const editableData = ref([]);
const dirtyRows = ref(new Set());
const sortKey = ref('name');
const sortDir = ref('asc');

// --- Data Fetching ---
onMounted(() => {
  movementsStore.fetchMovementsByDate(selectedDate.value);
  infrastructureStore.fetchSupervisors();
});

// --- Sorting Logic ---
const sortedData = computed(() => {
    const data = [...editableData.value];
    if (!sortKey.value) return data;
    return data.sort((a, b) => {
        let valA, valB;
        if (['location', 'purpose'].includes(sortKey.value)) {
            valA = a.movement?.[sortKey.value] || '';
            valB = b.movement?.[sortKey.value] || '';
        } else {
            valA = a[sortKey.value] || '';
            valB = b[sortKey.value] || '';
        }
        
        const modifier = sortDir.value === 'asc' ? 1 : -1;
        if (valA < valB) return -1 * modifier;
        if (valA > valB) return 1 * modifier;
        return 0;
    });
});

function toggleSort(key) {
    if (sortKey.value === key) {
        sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
    } else {
        sortKey.value = key;
        sortDir.value = 'asc';
    }
}


// --- Main Logic ---
watch(selectedDate, (newDate) => {
  if (newDate) {
    movementsStore.fetchMovementsByDate(newDate);
    dirtyRows.value.clear();
  }
});

watch(supervisorData, (newData) => {
  editableData.value = JSON.parse(JSON.stringify(newData || [])).map(supervisor => {
    if (!supervisor.movement) {
      supervisor.movement = {
        location: '', on_leave: false, leave_from: null,
        leave_to: null, look_after: null, purpose: '',
      };
    }
    return supervisor;
  });
}, { deep: true, immediate: true });


function markAsDirty(supervisorId) {
  dirtyRows.value.add(supervisorId);
}

async function handleSaveAll() {
  const promises = [];
  for (const supervisorId of dirtyRows.value) {
    const supervisorRow = editableData.value.find(s => s.id === supervisorId);
    if (supervisorRow && supervisorRow.movement) {
      const payload = {
        id: supervisorRow.movement.id,
        date: selectedDate.value,
        supervisor: supervisorRow.id,
        location: supervisorRow.movement.location || '',
        on_leave: supervisorRow.movement.on_leave || false,
        leave_from: supervisorRow.movement.leave_from || null,
        leave_to: supervisorRow.movement.leave_to || null,
        look_after: supervisorRow.movement.look_after || null,
        purpose: supervisorRow.movement.purpose || '',
      };
      if (!payload.on_leave) {
        payload.leave_from = null;
        payload.leave_to = null;
        payload.look_after = null;
      }
      promises.push(movementsStore.saveMovement(payload));
    }
  }
  await Promise.all(promises);
  dirtyRows.value.clear();
}

async function handleSendReport() {
    movementsStore.sendMovementReport(selectedDate.value);
}
</script>

<template>
  <div class="space-y-4">
    <div class="flex flex-wrap items-center justify-between gap-4">
        <h1 class="text-2xl font-bold">Supervisor Movements</h1>
        <div class="flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <label for="movement-date" class="text-sm font-medium">Date:</label>
                <input type="date" id="movement-date" v-model="selectedDate" class="field h-10 w-48" />
            </div>
            <div class="flex items-center gap-2">
                 <button 
                    @click="handleSaveAll" 
                    class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" 
                    :disabled="dirtyRows.size === 0 || movementsStore.loading" 
                    title="Save All Changes">
                    <Save class="w-5 h-5" />
                </button>
                <button 
                    @click="handleSendReport" 
                    class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--french-gray)] text-[var(--eerie-black)] hover:bg-[var(--french-gray-lighter)] transition"
                    :disabled="movementsStore.loading"
                    title="Send Report">
                    <Send class="w-5 h-5" />
                </button>
            </div>
        </div>
    </div>

    <div v-if="movementsStore.loading" class="text-center py-10 text-muted">Loading...</div>
    <div v-else-if="movementsStore.error" class="text-center py-10 text-red-500">{{ movementsStore.error }}</div>

    <div v-else class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <colgroup>
            <col class="w-[15%]" />
            <col class="w-[15%]" />
            <col class="w-[15%]" />
            <col class="w-[10%]" />
            <col class="w-[10%]" />
            <col class="w-[20%]" />
            <col class="w-[15%]" />
          </colgroup>
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('depot_display')" class="py-2.5 px-3 cursor-pointer select-none">Depot <span v-if="sortKey === 'depot_display'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('name')" class="py-2.5 px-3 cursor-pointer select-none">Name <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('designation')" class="py-2.5 px-3 cursor-pointer select-none">Designation <span v-if="sortKey === 'designation'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('location')" class="py-2.5 px-3 cursor-pointer select-none">Location <span v-if="sortKey === 'location'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3">On Leave</th>
              <th class="py-2.5 px-3">Leave Details</th>
              <th class="py-2.5 px-3">Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="row in sortedData" :key="row.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-top font-semibold">{{ row.depot_display || 'N/A' }}</td>
              <td class="py-2 px-3 align-top">{{ row.name }}</td>
              <td class="py-2 px-3 align-top text-muted">{{ row.designation }}</td>
              <td class="py-2 px-3 align-top">
                <input v-model="row.movement.location" class="field h-9" placeholder="Location" @change="markAsDirty(row.id)" />
              </td>
              <td class="py-2 px-3 align-top">
                <label class="inline-flex items-center gap-2 mt-2">
                  <input type="checkbox" v-model="row.movement.on_leave" class="h-4 w-4" @change="markAsDirty(row.id)" />
                </label>
              </td>
              <td class="py-2 px-3 align-top">
                <div v-if="row.movement.on_leave" class="space-y-2">
                  <div class="grid grid-cols-2 gap-2">
                    <input type="date" v-model="row.movement.leave_from" class="field h-9" title="Leave From" @change="markAsDirty(row.id)" />
                    <input type="date" v-model="row.movement.leave_to" class="field h-9" title="Leave To" @change="markAsDirty(row.id)" />
                  </div>
                  <select v-model="row.movement.look_after" class="field h-9" title="Looked After By" @change="markAsDirty(row.id)">
                    <option :value="null">-- Looked After By --</option>
                    <option v-for="opt in supervisorOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                  </select>
                </div>
              </td>
              <td class="py-2 px-3 align-top">
                 <input type="text" v-model="row.movement.purpose" class="field h-9" placeholder="Purpose / Remarks..." @change="markAsDirty(row.id)" maxlength="100" />
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</template>


<!--
This file is a new Vue component for managing archived failures.
1. It uses the `useFailureStore` to fetch and display `archivedFailures` in a table.
2. The table shows 'Fail ID', 'Archived At', 'Archived Reason', 'Circuit', and 'Station'.
3. It includes a "Permanent Delete" button for each row that opens a confirmation modal.
4. On confirmation, it calls the `permanentlyDeleteFailure` action from the store.
-->
<script setup>
import { onMounted, computed, ref } from 'vue';
import { useFailureStore } from '@/stores/failures';
import { Trash2 } from 'lucide-vue-next';
import Spinner from '@/components/ui/Spinner.vue';

const failureStore = useFailureStore();
const archivedFailures = computed(() => failureStore.archivedFailures);

const isDeleteModalOpen = ref(false);
const failureToDelete = ref(null);

onMounted(() => {
  failureStore.fetchArchivedFailures();
});

function openDeleteModal(failure) {
  failureToDelete.value = failure;
  isDeleteModalOpen.value = true;
}

async function confirmDelete() {
  if (!failureToDelete.value) return;
  await failureStore.permanentlyDeleteFailure(failureToDelete.value.id);
  isDeleteModalOpen.value = false;
  failureToDelete.value = null;
}

const formatDate = (dateString) => {
  if (!dateString) return 'N/A';
  return new Date(dateString).toLocaleString();
};
</script>

<template>
  <div class="space-y-4">
    <p class="text-app/80 text-sm">
      Review and permanently delete archived failure logs. This action cannot be undone.
    </p>

    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b border-app/40">
              <th class="py-2.5 px-3">Event ID</th>
              <th class="py-2.5 px-3">Circuit</th>
              <th class="py-2.5 px-3">Station</th>
              <th class="py-2.5 px-3">Archived At</th>
              <th class="py-2.5 px-3">Reason</th>
              <th class="py-2.5 px-3 w-40 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="failureStore.loading && archivedFailures.length === 0">
              <td colspan="6" class="py-6 px-3 text-center text-muted"><Spinner /></td>
            </tr>
            <tr v-else-if="failureStore.error && archivedFailures.length === 0">
              <td colspan="6" class="py-6 px-3 text-center text-red-500">{{ failureStore.error }}</td>
            </tr>
            <tr v-else-if="archivedFailures.length === 0">
              <td colspan="6" class="py-6 px-3 text-center text-app/60">No archived failures found.</td>
            </tr>
            <tr v-for="failure in archivedFailures" :key="failure.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-middle">{{ failure.fail_id }}</td>
              <td class="py-2 px-3 align-middle">{{ failure.circuit?.name || 'N/A' }}</td>
              <td class="py-2 px-3 align-middle">{{ failure.station?.name || 'N/A' }}</td>
              <td class="py-2 px-3 align-middle">{{ formatDate(failure.archived_at) }}</td>
              <td class="py-2 px-3 align-middle">{{ failure.archived_reason || 'No reason provided' }}</td>
              <td class="py-2 px-3 align-middle text-center">
                <button @click="openDeleteModal(failure)" class="btn btn-sm btn-danger inline-flex items-center justify-center h-9 w-9 rounded-md" title="Permanently Delete">
                  <Trash2 class="w-4 h-4" />
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Permanent Deletion</h3>
        <p>Are you sure you want to permanently delete event "<strong>{{ failureToDelete?.fail_id }}</strong>"? This action cannot be undone.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn btn-danger" :disabled="failureStore.loading">
            {{ failureStore.loading ? 'Deleting...' : 'Delete Permanently' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { onMounted, computed, ref } from 'vue';
import { useCircuitsStore } from '@/stores/circuits';
import { Trash2 } from 'lucide-vue-next';

const circuitsStore = useCircuitsStore();
const rows = computed(() => circuitsStore.circuits);

onMounted(() => {
  circuitsStore.fetchCircuits();
});

// ... (ensure all other functions now call `circuitsStore`) ...
</script>

<template>
  <div class="space-y-4">
    <div class="flex justify-between items-center">
        <p class="text-app/80 text-sm">Manage circuits with severity and equipment mapping.</p>
        <button class="btn btn-primary" @click="openAddModal">+ Add Circuit</button>
    </div>

    <!-- Table -->
    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('circuit_id')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none">Circuit ID <span v-if="sortKey === 'circuit_id'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('name')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none">Circuit Name <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('related_equipment')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none">Related Equipment <span v-if="sortKey === 'related_equipment'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('severity')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none">Severity <span v-if="sortKey === 'severity'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3 whitespace-nowrap">Details</th>
              <th class="py-2.5 px-3 w-40 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="circuitsStore.loading.circuits && sortedRows.length === 0">
              <td colspan="6" class="py-6 px-3 text-center text-muted">Loading circuits...</td>
            </tr>
            <tr v-else-if="circuitsStore.error">
              <td colspan="6" class="py-6 px-3 text-center text-red-500">{{ circuitsStore.error }}</td>
            </tr>
             <tr v-else-if="sortedRows.length === 0">
              <td colspan="6" class="py-6 px-3 text-center text-app/60">No circuits defined. Add one above.</td>
            </tr>
            <tr v-for="r in sortedRows" :key="r.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-top">{{ r.circuit_id }}</td>
              <td class="py-2 px-3 align-top">{{ r.name }}</td>
              <td class="py-2 px-3 align-top">{{ r.related_equipment }}</td>
              <td class="py-2 px-3 align-top">{{ r.severity }}</td>
              <td class="py-2 px-3 align-top">{{ r.details }}</td>
              <td class="py-2 px-3 align-top text-center">
                 <div class="flex items-center justify-center gap-2">
                    <button @click="openEditModal(r)" class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" title="Edit Circuit">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                          <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                        </svg>
                    </button>
                    <button class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition" title="Remove row" @click="openDeleteModal(r)">
                      <Trash2 class="w-6 h-6" />
                    </button>
                 </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Bottom action bar -->
    <div class="mt-3 flex justify-end">
        <div class="flex items-center gap-2">
            <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
            <button class="btn" @click="triggerFileInput">Choose File</button>
            <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
            <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="circuitsStore.loading.circuits">
                {{ circuitsStore.loading.circuits ? 'Uploading...' : 'Upload' }}
            </button>
        </div>
    </div>

     <!-- Add/Edit Modal -->
    <div v-if="isModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-3xl space-y-4">
        <h3 class="text-lg font-semibold">{{ currentCircuit.id ? 'Edit' : 'Add' }} Circuit</h3>
        <div v-if="currentCircuit" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Circuit ID</label>
            <input v-model="currentCircuit.circuit_id" class="field h-9" placeholder="e.g., CKT-001" />
          </div>
           <div>
            <label class="block text-sm font-medium mb-1">Circuit Name</label>
            <input v-model="currentCircuit.name" class="field h-9" placeholder="e.g., Feeder Line A" />
          </div>
           <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Related Equipment</label>
            <input v-model="currentCircuit.related_equipment" class="field h-9" placeholder="e.g., Breaker-12, XFMR-3" />
          </div>
           <div>
            <label class="block text-sm font-medium mb-1">Severity</label>
            <select v-model="currentCircuit.severity" class="field h-9">
              <option v-for="s in severityOptions" :key="s" :value="s">{{ s }}</option>
            </select>
          </div>
           <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Details</label>
            <textarea v-model="currentCircuit.details" class="field-textarea min-h-[80px]" placeholder="Notes / details..."></textarea>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveChanges" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the circuit "{{ circuitToDelete?.name }}"? This action cannot be undone.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;">Delete</button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { reactive, ref, onMounted, computed } from 'vue'
import { useDepotsStore } from '@/stores/depots.js'
import { useUIStore } from '@/stores/ui.js'
import { Trash2 } from 'lucide-vue-next'

const clone = (o) => JSON.parse(JSON.stringify(o))

// Store state
const depotStore = useDepotsStore()
const uiStore = useUIStore()

// --- Sorting State ---
const sortKey = ref('name');
const sortDir = ref('asc');

const sortedDepots = computed(() => {
  const data = Array.isArray(depotStore.depots) ? [...depotStore.depots] : [];
  data.sort((a, b) => {
    let valA = a[sortKey.value] || '';
    let valB = b[sortKey.value] || '';
    const modifier = sortDir.value === 'asc' ? 1 : -1;
    if (valA < valB) return -1 * modifier;
    if (valA > valB) return 1 * modifier;
    return 0;
  });
  return data;
});

function toggleSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
  } else {
    sortKey.value = key;
    sortDir.value = 'asc';
  }
}

// --- State for file upload ---
const selectedFile = ref(null)
const fileInput = ref(null)

// Fetch data when the component is first mounted
onMounted(() => {
  depotStore.fetchDepots()
})

// New depot inline form
const newDepot = reactive({ name: '', code: '', location: '' })

// --- State for Modals ---
const isDeleteModalOpen = ref(false)
const depotToDelete = ref(null)
const isEquipmentModalOpen = ref(false)
const selectedDepot = ref(null)
const tempEquipments = ref([])
const originalEquipments = ref([])

// --- Edit Modal State ---
const isEditModalOpen = ref(false);
const depotToEdit = ref(null);

function openEditModal(depot) {
  depotToEdit.value = { ...depot };
  isEditModalOpen.value = true;
}

async function saveDepotChanges() {
  if (!depotToEdit.value) return;
  await depotStore.updateDepot(depotToEdit.value.id, depotToEdit.value);
  isEditModalOpen.value = false;
  depotToEdit.value = null;
}


function addDepot() {
  if (!newDepot.name.trim()) {
    uiStore.pushToast({type: 'error', title: 'Missing Field', message: 'Depot Name is required.'});
    return;
  }
  depotStore.addDepot({
    name: newDepot.name.trim(),
    code: newDepot.code.trim(),
    location: newDepot.location.trim(),
  })
  newDepot.name = ''; newDepot.code = ''; newDepot.location = ''
}

function openDeleteModal(depot) {
  depotToDelete.value = depot;
  isDeleteModalOpen.value = true;
}

async function confirmDelete() {
  if (!depotToDelete.value) return;
  await depotStore.removeDepot(depotToDelete.value.id);
  isDeleteModalOpen.value = false;
  depotToDelete.value = null;
}

function handleFileSelect(event) {
  const target = event.target;
  if (target.files && target.files[0]) {
    selectedFile.value = target.files[0];
  }
}

function triggerFileInput() {
  fileInput.value?.click();
}

async function handleFileUpload() {
  if (!selectedFile.value) {
    uiStore.pushToast({type: 'error', title: 'No file', message: 'Please select a file to upload.'});
    return;
  }
  await depotStore.uploadDepotsFile(selectedFile.value);
  selectedFile.value = null;
  if(fileInput.value) fileInput.value.value = '';
}

// --- Equipment Modal Functions ---
function openManageModal(depot) {
  selectedDepot.value = depot
  const equipments = depot.equipments || []
  originalEquipments.value = clone(equipments)
  tempEquipments.value = clone(equipments)
  isEquipmentModalOpen.value = true
}

function closeManageModal() {
  isEquipmentModalOpen.value = false
  selectedDepot.value = null
  tempEquipments.value = []
  originalEquipments.value = []
}

async function saveEquipmentChanges() {
    if (!selectedDepot.value) return;

    const originalIds = new Set(originalEquipments.value.map(e => e.id));
    const currentIds = new Set(tempEquipments.value.filter(e => e.id).map(e => e.id));
    const promises = [];

    // Check for deletions
    for (const original of originalEquipments.value) {
        if (!currentIds.has(original.id)) {
            promises.push(depotStore.removeEquipment(original.id));
        }
    }

    // Check for additions and updates
    for (const current of tempEquipments.value) {
        if (current.id) { // This is an existing item, check for update
            const original = originalEquipments.value.find(o => o.id === current.id);
            if (JSON.stringify(original) !== JSON.stringify(current)) {
                promises.push(depotStore.updateEquipment(current.id, current));
            }
        } else { // This is a new item, create it
            const payload = { ...current, depot: selectedDepot.value.id };
            promises.push(depotStore.addEquipment(payload));
        }
    }

    await Promise.all(promises);
    await depotStore.fetchDepots();
    closeManageModal();
}

function addEquipmentRow() {
  tempEquipments.value.push({
    name: '', model_type: '', asset_id: '', location_in_depot: '', notes: ''
  })
}

function removeEquipmentRow(index) {
  tempEquipments.value.splice(index, 1)
}
</script>

<template>
  <div class="space-y-5">
    <p class="text-app/80 text-sm">Add depots, upload depot/equipment lists from Excel, or manage equipment for each depot.</p>

    <div class="card">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Depot Name</label>
          <input v-model="newDepot.name" class="field" placeholder="e.g., West Yard" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Depot Code</label>
          <input v-model="newDepot.code" class="field" placeholder="e.g., WY-01" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Location</label>
          <input v-model="newDepot.location" class="field" placeholder="e.g., Sector 12" />
        </div>
      </div>
      <div class="mt-3 flex justify-end">
        <button class="btn btn-primary" @click="addDepot">Add Depot</button>
      </div>
    </div>

     <div class="mt-3 flex items-center justify-between">
    <div class="flex items-center gap-2">
        <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
        <button class="btn" @click="triggerFileInput">Choose Depot File</button>
        <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
        <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="depotStore.loading">
          {{ depotStore.loading ? 'Uploading...' : 'Upload' }}
        </button>
        <button class="btn btn-outline" @click="depotStore.downloadDepotsExcel()" :disabled="depotStore.loading">Download Excel</button>
    </div>
</div>

    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
           <colgroup>
            <col class="w-[25%]">
            <col class="w-[20%]">
            <col class="w-[25%]">
            <col class="w-[15%]">
            <col class="w-[15%]">
          </colgroup>
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('name')" class="py-2.5 px-3 cursor-pointer select-none text-center">Depot Name <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('code')" class="py-2.5 px-3 cursor-pointer select-none text-center">Code <span v-if="sortKey === 'code'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('location')" class="py-2.5 px-3 cursor-pointer select-none text-center">Location <span v-if="sortKey === 'location'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3 text-center">Equipment Count</th>
              <th class="py-2.5 px-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="depotStore.loading && sortedDepots.length === 0">
                <td colspan="5" class="px-3 py-6 text-center text-muted">Loading...</td>
            </tr>
            <tr v-else-if="depotStore.error">
                <td colspan="5" class="px-3 py-6 text-center text-red-500">{{ depotStore.error }}</td>
            </tr>
            <tr v-else-if="sortedDepots.length === 0">
                <td colspan="5" class="px-3 py-6 text-app/60 text-center">No depots yet — add one above.</td>
            </tr>
            <tr v-for="d in sortedDepots" :key="d.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-middle text-center">{{ d.name }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ d.code || '—' }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ d.location || '—' }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ d.equipment_count }}</td>
              <td class="py-2 px-3 align-middle">
                <div class="flex flex-wrap items-center justify-center gap-2">
                  <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openEditModal(d)" title="Edit Depot">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                  </button>
                  <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openManageModal(d)" title="Manage Equipment">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z" /></svg>
                  </button>
                  <button class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app ring-1 ring-app/60 hover:bg-black/10 transition" title="Remove depot" @click="openDeleteModal(d)">
                    <Trash2 class="w-6 h-6" />
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">Edit Depot</h3>
        <div v-if="depotToEdit" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Depot Name</label>
            <input v-model="depotToEdit.name" class="field" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Depot Code</label>
            <input v-model="depotToEdit.code" class="field" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Location</label>
            <input v-model="depotToEdit.location" class="field" />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveDepotChanges" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>

     <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the depot "<strong>{{ depotToDelete?.name }}</strong>"? This will also delete all associated equipment.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;">Delete</button>
        </div>
      </div>
    </div>

    <div v-if="isEquipmentModalOpen" class="fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40" @click="closeManageModal" />
      <div class="absolute inset-0 grid place-items-center p-4">
        <section class="w-full max-w-6xl rounded-2xl border-app bg-card text-app shadow-2xl overflow-hidden flex flex-col" style="max-height: 90vh;">
          <header class="flex items-center justify-between px-4 py-3 border-b border-app/40">
            <div class="min-w-0">
              <h3 class="font-semibold truncate">Manage Measuring Equipment — {{ selectedDepot?.name }}</h3>
              <p class="text-xs text-app/70">Add, edit, or remove measuring equipment for this depot.</p>
            </div>
            <button class="icon-btn" title="Close" @click="closeManageModal">
              <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M6.4 4.99L5 6.4L10.6 12L5 17.6L6.4 19L12 13.4L17.6 19l1.4-1.4L13.4 12L19 6.4L17.6 4.99L12 10.6z"/></svg>
            </button>
          </header>
          <div class="p-3 flex-1 overflow-y-auto">
            <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-left border-b border-app/40">
                      <th class="py-2.5 px-3 whitespace-nowrap">Measuring Equipment</th>
                      <th class="py-2.5 px-3 whitespace-nowrap">Model / Type</th>
                      <th class="py-2.5 px-3 whitespace-nowrap">Asset / Serial ID</th>
                      <th class="py-2.5 px-3 whitespace-nowrap">Location in Depot</th>
                      <th class="py-2.5 px-3 whitespace-nowrap">Notes</th>
                      <th class="py-2.5 px-3 w-16 text-center">Remove</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="tempEquipments.length===0">
                      <td colspan="6" class="px-3 py-6 text-app/60 text-center">No equipment yet — add a row below.</td>
                    </tr>
                    <tr v-for="(r, i) in tempEquipments" :key="r.id || i" class="border-t border-app/30">
                      <td class="py-2 px-3 align-top"><input v-model="r.name" class="field h-9" placeholder="e.g., Multimeter" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.model_type" class="field h-9" placeholder="e.g., Fluke 117" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.asset_id" class="field h-9" placeholder="e.g., SN-123456" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.location_in_depot" class="field h-9" placeholder="e.g., Bay 3, Shelf A" /></td>
                      <td class="py-2 px-3 align-top"><textarea v-model="r.notes" class="field-textarea min-h-[44px]" placeholder="Calibration due..."></textarea></td>
                      <td class="py-2 px-3 align-top text-center">
                        <button class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app ring-1 ring-app/60 hover:bg-black/10 transition" title="Remove row" @click="removeEquipmentRow(i)">
                          <span class="sr-only">Remove row</span>
                          <svg viewBox="0 0 24 24" class="w-6 h-6" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm3.11 13.11l-1 1L12 13l-2.11 3.11l-1-1L11 12L8.89 9.89l1-1L12 11l2.11-2.11l1 1L13 12z"/></svg>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-[1fr_auto_1fr] items-center">
              <div></div>
              <div class="justify-self-center"><button class="btn" @click="addEquipmentRow">+ Add Row</button></div>
              <div class="justify-self-end flex items-center gap-2"><button class="btn btn-primary" @click="saveEquipmentChanges">Save Changes</button></div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</template>

<script setup>
import { onMounted, reactive, computed, ref } from 'vue';
import { useEmailStore } from '@/stores/email';

const emailStore = useEmailStore();

const settings = computed(() => emailStore.settings);
const loading = computed(() => emailStore.loading);
const testEmail = ref('');

// Local state for the "add recipient" input fields
const add = reactive({ to: '', cc: '', bcc: '' });

// Fetch settings when the component is mounted
onMounted(() => {
  emailStore.fetchSettings().then(() => {
    // Pre-fill test email with first recipient if available
    if (settings.value.recipients?.to?.length > 0) {
      testEmail.value = settings.value.recipients.to[0];
    }
  });
});

function addRecipient(kind) {
  const email = (add[kind] || '').trim();
  if (!email) return;

  // Ensure the array exists before pushing
  if (!settings.value.recipients[kind]) {
    settings.value.recipients[kind] = [];
  }
  
  if (!settings.value.recipients[kind].includes(email)) {
    settings.value.recipients[kind].push(email);
  }
  add[kind] = ''; // Clear the input field
}

function removeRecipient(kind, email) {
  if (settings.value.recipients[kind]) {
    settings.value.recipients[kind] = settings.value.recipients[kind].filter(e => e !== email);
  }
}

function onSave() {
  emailStore.saveSettings();
}

function onTest() {
  emailStore.sendTestEmail(testEmail.value);
}
</script>

<template>
  <div class="space-y-4">
    <p class="text-app/80 text-sm">
      Configure the SMTP server for sending automated emails and set default recipients.
    </p>

    <!-- SMTP Section -->
    <div class="card">
      <h2 class="text-lg font-semibold mb-3">SMTP Server</h2>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Host</label>
          <input class="field" v-model="settings.host" placeholder="smtp.example.com" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Port</label>
          <input type="number" class="field" v-model.number="settings.port" placeholder="587" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Encryption</label>
          <select class="field" v-model="settings.encryption">
            <option value="STARTTLS">STARTTLS</option>
            <option value="SSL/TLS">SSL/TLS</option>
            <option value="None">None</option>
          </select>
        </div>
        <div></div>
        <div>
          <label class="block text-sm font-medium mb-1">Username</label>
          <input class="field" v-model="settings.username" placeholder="user@example.com" autocomplete="username" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Password</label>
          <input type="password" class="field" v-model="settings.password" autocomplete="new-password" placeholder="Leave blank to keep unchanged" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">From Name</label>
          <input class="field" v-model="settings.from_name" placeholder="RFMS Notifications" />
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">From Address</label>
          <input class="field" v-model="settings.from_address" placeholder="no-reply@example.com" />
        </div>
      </div>
    </div>

    <!-- Recipients Section -->
    <div class="card">
       <h2 class="text-lg font-semibold mb-3">Default Recipients</h2>
       <div class="space-y-3">
          <!-- TO -->
          <div>
            <label class="block text-sm font-medium mb-1">To</label>
            <div class="flex gap-2 mb-2">
              <input class="field" v-model="add.to" @keydown.enter.prevent="addRecipient('to')" placeholder="Add recipient email and press Enter"/>
              <button class="btn btn-secondary" @click="addRecipient('to')">+</button>
            </div>
            <div class="flex flex-wrap gap-2" v-if="settings.recipients.to && settings.recipients.to.length">
              <span v-for="r in settings.recipients.to" :key="r" class="inline-flex items-center gap-2 px-2 py-1 rounded-lg border text-sm bg-gray-100">
                {{ r }}
                <button class="text-xs opacity-70 hover:opacity-100" @click="removeRecipient('to', r)">×</button>
              </span>
            </div>
          </div>
          <!-- CC -->
          <div>
            <label class="block text-sm font-medium mb-1">CC</label>
            <div class="flex gap-2 mb-2">
              <input class="field" v-model="add.cc" @keydown.enter.prevent="addRecipient('cc')" placeholder="Add CC email and press Enter" />
              <button class="btn btn-secondary" @click="addRecipient('cc')">+</button>
            </div>
             <div class="flex flex-wrap gap-2" v-if="settings.recipients.cc && settings.recipients.cc.length">
              <span v-for="r in settings.recipients.cc" :key="r" class="inline-flex items-center gap-2 px-2 py-1 rounded-lg border text-sm bg-gray-100">
                {{ r }}
                <button class="text-xs opacity-70 hover:opacity-100" @click="removeRecipient('cc', r)">×</button>
              </span>
            </div>
          </div>
          <!-- BCC -->
          <div>
            <label class="block text-sm font-medium mb-1">BCC</label>
            <div class="flex gap-2 mb-2">
              <input class="field" v-model="add.bcc" @keydown.enter.prevent="addRecipient('bcc')" placeholder="Add BCC email and press Enter"/>
              <button class="btn btn-secondary" @click="addRecipient('bcc')">+</button>
            </div>
            <div class="flex flex-wrap gap-2" v-if="settings.recipients.bcc && settings.recipients.bcc.length">
              <span v-for="r in settings.recipients.bcc" :key="r" class="inline-flex items-center gap-2 px-2 py-1 rounded-lg border text-sm bg-gray-100">
                {{ r }}
                <button class="text-xs opacity-70 hover:opacity-100" @click="removeRecipient('bcc', r)">×</button>
              </span>
            </div>
          </div>
       </div>
    </div>
    
    <!-- Actions -->
    <div class="flex items-center justify-end gap-3">
        <input v-model="testEmail" class="field w-64" placeholder="Enter test email address" />
        <button class="btn" @click="onTest" :disabled="loading || !testEmail">
          {{ loading ? 'Sending...' : 'Send Test Email' }}
        </button>
        <button class="btn btn-primary" @click="onSave" :disabled="loading">
          {{ loading ? 'Saving...' : 'Save Changes' }}
        </button>
    </div>
  </div>
</template>



<script setup>
import { onMounted, computed } from 'vue'
import { useCoreSettingsStore } from '@/stores/coreSettings'

const coreSettingsStore = useCoreSettingsStore()

// A computed property to easily access the settings object from the store
const settings = computed(() => coreSettingsStore.failureIdSettings)

// Fetch the settings from the backend when the component is first loaded
onMounted(() => {
  coreSettingsStore.fetchFailureIdSettings()
})

// Function to call the store action to save the current settings
function saveSettings() {
  // We pass the current state of the settings object to the action
  coreSettingsStore.saveFailureIdSettings(settings.value)
}

// A computed property to generate a live preview of the Failure ID format
const previewId = computed(() => {
  // Return a placeholder if settings haven't loaded yet
  if (!settings.value || !settings.value.prefix) {
    return '...';
  }
  
  const prefix = settings.value.prefix;
  const padding = settings.value.padding_digits || 4;
  const year = new Date().getFullYear();
  const month = String(new Date().getMonth() + 1).padStart(2, '0');
  const number = '1'.padStart(padding, '0');

  let datePart = '';
  if (settings.value.reset_cycle === 'yearly') {
    datePart = `-${year}`;
  } else if (settings.value.reset_cycle === 'monthly') {
    datePart = `-${year}${month}`;
  }

  return `${prefix}${datePart}-${number}`;
});
</script>

<template>
  <div class="space-y-4">
    <p class="text-app/80 text-sm">Configure Event ID/sequence rules, prefixes, padding, and resets.</p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">Prefix</label>
        <input class="field" v-model="settings.prefix" placeholder="e.g., RF" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Padding (digits)</label>
        <input class="field" type="number" min="1" max="10" v-model.number="settings.padding_digits" placeholder="4" />
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Reset Cycle</label>
        <select class="field" v-model="settings.reset_cycle">
          <option value="never">Never</option>
          <option value="yearly">Yearly</option>
          <option value="monthly">Monthly</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Preview</label>
        <input class="field" :value="previewId" readonly />
      </div>
    </div>

    <div class="flex gap-2">
      <button class="btn btn-primary" @click="saveSettings" :disabled="coreSettingsStore.loading">
        {{ coreSettingsStore.loading ? 'Saving...' : 'Save' }}
      </button>
    </div>
  </div>
</template>

    <script setup>
    import { computed, onMounted, onBeforeUnmount, ref } from 'vue';
    import { useReportsStore } from '@/stores/reports.js';
    import { useTelegramStore } from '@/stores/telegram.js';
    import { Save, Trash2 } from 'lucide-vue-next';

    const reportsStore = useReportsStore();
    const telegramStore = useTelegramStore();

    const schedules = computed(() => reportsStore.schedules);
    const tgOptions = computed(() => telegramStore.groups);
    const fileInputs = ref({});

    // For multi-select dropdown state
    const activeDropdownId = ref(null);

    onMounted(() => {
      reportsStore.fetchSchedules();
      if (telegramStore.groups.length === 0) {
        telegramStore.fetchTelegramGroups();
      }
      // Close dropdown if user clicks outside
      document.addEventListener('click', closeDropdowns);
    });

    onBeforeUnmount(() => {
        document.removeEventListener('click', closeDropdowns);
    });

    function closeDropdowns(event) {
        if (event.target.closest('[data-dropdown-host]')) return;
        activeDropdownId.value = null;
    }

    const freqOptions = [
      { label: 'Daily', value: 'daily' },
      { label: 'Weekly', value: 'weekly' },
      { label: 'Monthly', value: 'monthly' },
    ];
    const dowOptions = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
    const domOptions = Array.from({ length: 31 }, (_, i) => String(i + 1));

    function addReport() {
      const newReport = {
        name: 'New Report',
        frequency: 'daily',
        day_of_week: 'Mon',
        day_of_month: 1,
        time: '09:00',
        send_email: false,
        send_telegram: false,
        telegram_group_keys: [], // Use the correct key and initialize as an array
      };
      reportsStore.addSchedule(newReport);
    }

    function updateSchedule(schedule) {
      reportsStore.updateSchedule(schedule.id, schedule);
    }

    function removeSchedule(id) {
      if (confirm('Are you sure you want to delete this report schedule?')) {
        reportsStore.removeSchedule(id);
      }
    }

    function triggerFileInput(id) {
        fileInputs.value[id]?.click();
    }

    async function onTemplatePicked(id, event) {
      const file = event.target.files?.[0];
      if (file) {
        await reportsStore.uploadTemplate(id, file);
        if(event.target) event.target.value = '';
      }
    }

    function toggleTelegramGroup(schedule, groupKey) {
        const selectedKeys = new Set(schedule.telegram_group_keys || []);
        if (selectedKeys.has(groupKey)) {
            selectedKeys.delete(groupKey);
        } else {
            selectedKeys.add(groupKey);
        }
        schedule.telegram_group_keys = Array.from(selectedKeys);
    }

    function getSelectedGroupsText(keys) {
        if (!keys || keys.length === 0) return '-- Select --';
        if (keys.length === 1) {
            const group = tgOptions.value.find(g => g.key === keys[0]);
            return group ? group.name : keys[0];
        }
        return `${keys.length} groups selected`;
    }
    </script>

    <template>
      <div class="space-y-4">
        <div class="flex justify-between items-center">
            <p class="text-app/80 text-sm">
              Configure scheduled report emails and Telegram deliveries.
            </p>
            <button class="btn btn-primary" @click="addReport">+ Add Report</button>
        </div>
        
        <div v-if="reportsStore.loading && schedules.length === 0" class="text-center py-10 text-muted">
            Loading schedules...
        </div>
        <div v-else-if="reportsStore.error" class="text-center py-10 text-red-500">
            {{ reportsStore.error }}
        </div>
         <div v-else-if="schedules.length === 0" class="text-center py-10 text-muted">
            No report schedules found. Click "Add Report" to create one.
        </div>

        <div v-else class="overflow-x-auto">
          <table class="min-w-full w-full text-sm">
            <thead>
              <tr class="text-left border-b border-app/40">
                <th class="py-2.5 px-3 w-[220px]">Report Name</th>
                <th class="py-2.5 px-3 w-[260px]">Report Template (Excel)</th>
                <th class="py-2.5 px-3 w-[300px]">Schedule</th>
                <th class="py-2.5 px-3 w-[120px]">Emails</th>
                <th class="py-2.5 px-3 w-[220px]">Telegram Group</th>
                <th class="py-2.5 px-3 w-[140px] text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="r in schedules" :key="r.id" class="border-b border-app/30">
                <!-- Report Name -->
                <td class="py-2 px-3 align-top">
                  <input
                    class="field h-9"
                    v-model="r.name"
                    placeholder="e.g., Daily Failure Summary"
                  />
                </td>

                <!-- Template -->
                <td class="py-2 px-3 align-top">
                  <div class="flex items-center gap-2">
                    <input
                      type="file"
                      accept=".xlsx,.xls"
                      class="hidden"
                      :ref="el => fileInputs[r.id] = el"
                      @change="e => onTemplatePicked(r.id, e)"
                    />
                    <button class="btn btn-sm" @click="triggerFileInput(r.id)">Choose…</button>
                    <span class="opacity-80 truncate max-w-[180px]" :title="r.template_name || 'No file chosen'">
                      {{ r.template_name || 'No file chosen' }}
                    </span>
                  </div>
                </td>

                <!-- Schedule -->
                <td class="py-2 px-3 align-top">
                  <div class="flex flex-wrap items-center gap-2">
                    <select class="field h-9" v-model="r.frequency">
                      <option v-for="o in freqOptions" :key="o.value" :value="o.value">{{ o.label }}</option>
                    </select>

                    <select v-if="r.frequency === 'weekly'" class="field h-9" v-model="r.day_of_week">
                      <option v-for="d in dowOptions" :key="d" :value="d">{{ d }}</option>
                    </select>

                    <select v-if="r.frequency === 'monthly'" class="field h-9 w-20" v-model.number="r.day_of_month">
                      <option v-for="d in domOptions" :key="d" :value="d">{{ d }}</option>
                    </select>

                    <input type="time" class="field h-9" v-model="r.time" />
                  </div>
                </td>

                <!-- Emails -->
                <td class="py-2 px-3 align-top">
                  <label class="inline-flex items-center gap-2">
                    <input type="checkbox" v-model="r.send_email" class="h-4 w-4" />
                    <span>Enable</span>
                  </label>
                </td>

                <!-- Telegram Multi-Select -->
                <td class="py-2 px-3 align-top">
                    <div class="flex flex-wrap items-center gap-2">
                        <label class="inline-flex items-center gap-2">
                            <input type="checkbox" v-model="r.send_telegram" class="h-4 w-4" />
                            <span>Enable</span>
                        </label>
                        <div class="relative w-full" data-dropdown-host>
                            <button
                                class="field h-9 w-full text-left flex items-center justify-between pr-2"
                                :disabled="!r.send_telegram"
                                @click.stop="activeDropdownId = activeDropdownId === r.id ? null : r.id"
                            >
                                <span class="truncate">{{ getSelectedGroupsText(r.telegram_group_keys) }}</span>
                                <span class="text-muted">▾</span>
                            </button>
                            <div v-if="activeDropdownId === r.id" class="absolute z-10 mt-1 w-full rounded-lg border bg-card text-app border-app shadow-lg max-h-48 overflow-auto">
                                <label v-for="g in tgOptions" :key="g.key" class="flex items-center gap-2 px-3 py-2 text-sm cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" :checked="(r.telegram_group_keys || []).includes(g.key)" @change="toggleTelegramGroup(r, g.key)" class="h-4 w-4" />
                                    <span>{{ g.name }}</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </td>

                <!-- Actions -->
                <td class="py-2 px-3 align-top text-center">
                    <div class="flex items-center justify-center gap-2">
                        <button
                          class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition"
                          @click="updateSchedule(r)"
                          :disabled="reportsStore.loading"
                          title="Save Changes"
                        >
                            <Save class="w-5 h-5" />
                        </button>
                        <button
                          class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition"
                          @click="removeSchedule(r.id)"
                          title="Delete Schedule"
                        >
                            <Trash2 class="w-5 h-5" />
                        </button>
                    </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </template>
    


<script setup>
import { reactive, ref, computed, onMounted } from 'vue';
import { useSectionsStore } from '@/stores/sections';
import { useDepotsStore } from '@/stores/depots';
import { useUIStore } from '@/stores/ui';
import { Wrench, Trash2 } from 'lucide-vue-next';

// Initialize stores
const sectionsStore = useSectionsStore();
const depotsStore = useDepotsStore();
const uiStore = useUIStore();

// Data from stores
const sections = computed(() => sectionsStore.sections);
const depotOptions = computed(() =>
  (depotsStore.depots || []).map(d => ({ value: d.id, label: d.code || d.name }))
);

// --- Sorting ---
const sortKey = ref('name');
const sortDir = ref('asc');
const sortedSections = computed(() => {
  const data = [...sections.value];
  return data.sort((a, b) => {
    const modifier = sortDir.value === 'asc' ? 1 : -1;
    const valA = sortKey.value === 'depot_display' ? (a.depot_display || '') : (a[sortKey.value] || '');
    const valB = sortKey.value === 'depot_display' ? (b.depot_display || '') : (b[sortKey.value] || '');
    if (valA < valB) return -1 * modifier;
    if (valA > valB) return 1 * modifier;
    return 0;
  });
});
function toggleSort(key) {
  if (sortKey.value === key) {
    sortDir.value = sortDir.value === 'asc' ? 'desc' : 'asc';
  } else {
    sortKey.value = key;
    sortDir.value = 'asc';
  }
}

// --- Fetch initial data ---
onMounted(() => {
  sectionsStore.fetchSections();
  // Ensure depots are loaded for the dropdown
  if (depotsStore.depots.length === 0) {
    depotsStore.fetchDepots();
  }
});

// --- Add Form ---
const newSection = reactive({ name: '', depot: null });
async function addSection() {
  if (!newSection.name || !newSection.depot) {
    uiStore.pushToast({type: 'error', title: 'Missing Fields', message: 'Please provide a section name and select a depot.'});
    return;
  }
  await sectionsStore.addSection({ ...newSection });
  newSection.name = ''; // Clear name after adding
  // Keep depot selected
}

// --- Edit Modal ---
const isEditModalOpen = ref(false);
const sectionToEdit = ref(null);
function openEditModal(section) {
  // Ensure we set the depot ID correctly for the select dropdown
  sectionToEdit.value = { ...section, depot: section.depot };
  isEditModalOpen.value = true;
}
async function saveSectionChanges() {
  if (!sectionToEdit.value) return;
  await sectionsStore.updateSection(sectionToEdit.value.id, sectionToEdit.value);
  isEditModalOpen.value = false;
  sectionToEdit.value = null;
}

// --- Delete Modal ---
const isDeleteModalOpen = ref(false);
const sectionToDelete = ref(null);
function openDeleteModal(section) {
  sectionToDelete.value = section;
  isDeleteModalOpen.value = true;
}
async function confirmDelete() {
  if (!sectionToDelete.value) return;
  await sectionsStore.removeSection(sectionToDelete.value.id);
  isDeleteModalOpen.value = false;
  sectionToDelete.value = null;
}

// --- File Upload ---
const selectedFile = ref(null);
const fileInput = ref(null);
function handleFileSelect(event) {
    const target = event.target;
    if (target.files && target.files[0]) {
        selectedFile.value = target.files[0];
    }
}
function triggerFileInput() {
    fileInput.value?.click();
}
async function handleFileUpload() {
    if (!selectedFile.value) {
        uiStore.pushToast({ type: 'error', title: 'No File', message: 'Please select a file to upload.' });
        return;
    }
    await sectionsStore.uploadSectionsFile(selectedFile.value);
    selectedFile.value = null;
    if (fileInput.value) fileInput.value.value = '';
}

// --- Sub-sections & Assets Modal ---
const clone = (o) => JSON.parse(JSON.stringify(o));
const isSubSectionModalOpen = ref(false);
const selectedSection = ref(null);
const tempSubsections = ref([]); // Use ref for reactivity
const originalSubsections = ref([]);

async function openSubsectionsModal(section) {
  selectedSection.value = section;
  await sectionsStore.fetchSubsectionsForSection(section.id); // Fetch data first
  const subsections = sectionsStore.sectionSubsections; // Use the fetched data
  originalSubsections.value = clone(subsections);
  // Ensure assets array exists
  tempSubsections.value = clone(subsections.map(ss => ({ ...ss, assets: ss.assets || [] })));
  isSubSectionModalOpen.value = true;
}

function closeSubsectionsModal() {
    isSubSectionModalOpen.value = false;
    selectedSection.value = null;
    sectionsStore.sectionSubsections = []; // Clear store data on close
}

async function saveSubsectionsAndAssets() {
    if (!selectedSection.value) return;
    uiStore.pushToast({ type: 'info', title: 'Saving...', message: 'Processing sub-sections and assets.' });

    const originalSubMap = new Map(originalSubsections.value.map(s => [s.id, s]));
    const currentSubMap = new Map(tempSubsections.value.filter(s => s.id).map(s => [s.id, s]));
    const promises = [];

    // --- Process Deletions First ---
    for (const originalSub of originalSubsections.value) {
        if (!currentSubMap.has(originalSub.id)) {
            promises.push(sectionsStore.removeSubSection(originalSub.id));
        } else {
            // Check for asset deletions within existing subsections
            const currentSub = currentSubMap.get(originalSub.id);
            const originalAssetIds = new Set((originalSub.assets || []).map(a => a.id));
            const currentAssetIds = new Set((currentSub.assets || []).filter(a => a.id).map(a => a.id));
            for (const originalAssetId of originalAssetIds) {
                if (!currentAssetIds.has(originalAssetId)) {
                    promises.push(sectionsStore.removeAsset(originalAssetId));
                }
            }
        }
    }
    // Wait for deletions before proceeding
    await Promise.all(promises);
    promises.length = 0;

    // --- Process Updates and Creations ---
    for (const sub of tempSubsections.value) {
        if (sub.id) { // Existing sub-section
            const originalSub = originalSubMap.get(sub.id);
            if (originalSub && originalSub.name !== sub.name) {
                promises.push(sectionsStore.updateSubSection(sub.id, { name: sub.name }));
            }
            // Process assets for existing sub-section
            for (const asset of (sub.assets || [])) {
                if (asset.id) { // Existing asset
                    const originalAsset = originalSub?.assets?.find(a => a.id === asset.id);
                    if (originalAsset && JSON.stringify(originalAsset) !== JSON.stringify(asset)) {
                         promises.push(sectionsStore.updateAsset(asset.id, asset));
                    }
                } else { // New asset
                    promises.push(sectionsStore.addAsset({ ...asset, subsection: sub.id }));
                }
            }
        } else { // New sub-section
            // Use await here to get the new ID for subsequent asset creation
            const newSubSectionData = await sectionsStore.addSubSection({ name: sub.name, section: selectedSection.value.id });
            if (newSubSectionData && newSubSectionData.id) {
                for (const asset of (sub.assets || [])) {
                   promises.push(sectionsStore.addAsset({ ...asset, subsection: newSubSectionData.id }));
                }
            }
        }
    }

    await Promise.all(promises);

    uiStore.pushToast({ type: 'success', title: 'Save Complete', message: 'Infrastructure updated successfully.' });
    await sectionsStore.fetchSections(); // Refresh main list
    closeSubsectionsModal();
}


function addSubSectionRow() { tempSubsections.value.push({ name: '', assets: [] }); }
function removeSubSectionRow(index) { tempSubsections.value.splice(index, 1); }
function addAssetRow(subSection) { if (!subSection.assets) { subSection.assets = []; } subSection.assets.push({ name: '', quantity: null, unit: '' }); } // Default quantity null
function removeAssetRow(subSection, assetIndex) { subSection.assets.splice(assetIndex, 1); }
</script>

<template>
  <div class="space-y-5">
    <p class="text-app/80 text-sm">Define Sections per Depot, manage Sub-sections and their Assets, or upload a master file with the complete hierarchy.</p>

    <div class="card">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium mb-1">Depot</label>
          <select v-model="newSection.depot" class="field h-9">
            <option :value="null" disabled>Select Depot</option>
            <option v-for="opt in depotOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">New Section Name</label>
          <input v-model="newSection.name" class="field h-9" placeholder="e.g., Central Line" />
        </div>
        <div class="self-end">
          <button class="btn btn-primary w-full" @click="addSection" :disabled="sectionsStore.loading">
            {{ sectionsStore.loading ? 'Adding...' : 'Add Section' }}
          </button>
        </div>
      </div>
    </div>

    <div class="card">
       <div class="flex items-end gap-4">
          <div class="flex-grow">
            <label class="block text-sm font-medium mb-1">Upload Master Infrastructure File</label>
             <p class="text-xs text-app/60 mb-2">Excel/CSV: Depot, Section, Sub-section, Asset, Quantity, Unit. Depots must exist.</p>
             <div class="flex items-center gap-2">
                <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
                <button class="btn" @click="triggerFileInput">Choose File...</button>
                <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
             </div>
          </div>
          <div>
            <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="sectionsStore.loading">
              {{ sectionsStore.loading ? 'Uploading...' : 'Upload Master File' }}
            </button>
          </div>
       </div>
    </div>

    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('depot_display')" class="py-2.5 px-3 text-left cursor-pointer select-none">Depot <span v-if="sortKey === 'depot_display'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('name')" class="py-2.5 px-3 text-center cursor-pointer select-none">Section <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3 text-center">Sub-sections</th>
              <th class="py-2.5 px-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="sectionsStore.loading && sortedSections.length === 0">
              <td colspan="4" class="px-3 py-6 text-center text-muted">Loading sections...</td>
            </tr>
            <tr v-else-if="sectionsStore.error && sortedSections.length === 0"> <td colspan="4" class="px-3 py-6 text-center text-red-500">{{ sectionsStore.error }}</td>
            </tr>
            <tr v-else-if="sortedSections.length === 0">
              <td colspan="4" class="px-3 py-6 text-app/60 text-center">No sections yet — add one above.</td>
            </tr>
            <tr v-for="s in sortedSections" :key="s.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-middle text-left">{{ s.depot_display }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.name }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.subsection_count || 0 }}</td>
              <td class="py-2 px-3 align-middle">
                <div class="flex flex-wrap items-center justify-center gap-2">
                   <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openEditModal(s)" title="Edit Section">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                   </button>
                   <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openSubsectionsModal(s)" title="Manage Sub-sections & Assets">
                     <Wrench class="w-6 h-6" />
                   </button>
                  <button class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-black/10 transition" title="Remove Section" @click="openDeleteModal(s)">
                    <Trash2 class="w-6 h-6" />
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Edit Section</h3>
        <div v-if="sectionToEdit" class="space-y-4">
          <div>
            <label class="block text-sm font-medium mb-1">Section Name</label>
            <input v-model="sectionToEdit.name" class="field h-9" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Depot</label>
            <select v-model="sectionToEdit.depot" class="field h-9">
              <option :value="null" disabled>Select Depot</option>
              <option v-for="opt in depotOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
            </select>
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveSectionChanges" class="btn btn-primary" :disabled="sectionsStore.loading">{{ sectionsStore.loading ? 'Saving...' : 'Save Changes' }}</button>
        </div>
      </div>
    </div>

    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the section "<strong>{{ sectionToDelete?.name }}</strong>"? This will also delete its sub-sections and assets.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;" :disabled="sectionsStore.loading">{{ sectionsStore.loading ? 'Deleting...' : 'Delete' }}</button>
        </div>
      </div>
    </div>

    <div v-if="isSubSectionModalOpen" class="fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40" @click="closeSubsectionsModal"></div>
      <div class="absolute inset-0 grid place-items-center p-4">
        <section class="w-full max-w-4xl rounded-2xl border-app bg-card text-app shadow-2xl overflow-hidden flex flex-col" style="max-height: 90vh;">
          <header class="flex items-center justify-between px-4 py-3 border-b border-app/40">
            <div class="min-w-0">
              <h3 class="font-semibold truncate">Manage Sub-sections & Assets for "{{ selectedSection?.name }}"</h3>
            </div>
            <button class="icon-btn" title="Close" @click="closeSubsectionsModal">
              <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M6.4 4.99L5 6.4L10.6 12L5 17.6L6.4 19L12 13.4L17.6 19l1.4-1.4L13.4 12L19 6.4L17.6 4.99L12 10.6z"/></svg>
            </button>
          </header>
          <div class="p-3 flex-1 overflow-y-auto space-y-3">
            <div v-if="sectionsStore.loading" class="text-center py-10 text-muted">Loading sub-sections...</div>
            <div v-else-if="tempSubsections.length === 0" class="text-center py-10 text-muted">No sub-sections yet. Add one below.</div>
            <div v-for="(sub, subIndex) in tempSubsections" :key="sub.id || `new-${subIndex}`" class="card">
              <div class="flex items-center gap-2">
                <input v-model="sub.name" class="field h-9 flex-grow" placeholder="Enter sub-section name"/>
                <button class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition" title="Remove Sub-section" @click="removeSubSectionRow(subIndex)">
                   <Trash2 class="w-5 h-5" />
                </button>
              </div>
              <div class="mt-3 pl-4 border-l-2 border-app/40">
                <h4 class="text-xs font-semibold text-app/80 mb-2">Assets in this Sub-section</h4>
                <table class="w-full text-sm">
                  <tr v-for="(asset, assetIndex) in sub.assets" :key="asset.id || `new-asset-${assetIndex}`">
                    <td class="py-1 pr-2"><input v-model="asset.name" class="field h-8" placeholder="Asset Name"></td>
                    <td class="py-1 pr-2 w-28"><input v-model.number="asset.quantity" type="number" step="0.01" class="field h-8" placeholder="Qty"></td>
                    <td class="py-1 pr-2 w-28"><input v-model="asset.unit" class="field h-8" placeholder="Unit"></td>
                    <td class="py-1 w-10 text-center">
                      <button @click="removeAssetRow(sub, assetIndex)" class="text-app/50 hover:text-red-500 text-xl font-bold">&times;</button>
                    </td>
                  </tr>
                </table>
                <button @click="addAssetRow(sub)" class="text-xs btn btn-sm mt-2">+ Add Asset</button>
              </div>
            </div>
          </div>
          <footer class="p-3 border-t border-app/40 grid grid-cols-[1fr_auto_1fr] items-center">
            <div></div>
            <div class="justify-self-center"><button class="btn" @click="addSubSectionRow">+ Add Sub-section</button></div>
            <div class="justify-self-end"><button class="btn btn-primary" @click="saveSubsectionsAndAssets">Save All Changes</button></div>
          </footer>
        </section>
      </div>
    </div>
  </div>
</template>

<script setup>
import { computed } from 'vue'
import { useRoute } from 'vue-router'
const route = useRoute()
const links = [
  // 1) Reports Management
  { to: '/settings/reports',           label: 'Reports Management',             icon: 'reports' },
  // 2) Failure ID Configuration
  { to: '/settings/failure-id',        label: 'Failure ID Configuration',       icon: 'failure-id' },
  // 3) Telegram Integration Settings
  { to: '/settings/telegram',          label: 'Telegram Integration Settings',  icon: 'telegram' },
  { to: '/settings/email',             label: 'Email Settings',                 icon: 'email' },
  // 4) User and Role Management
  { to: '/settings/users-roles',       label: 'User and Role Management',       icon: 'users-roles' },
  { to: '/settings/archive', label: 'Archive Management', icon: 'archive' },
  // 5) Circuit Management
  { to: '/settings/circuits',          label: 'Circuit Management',             icon: 'circuits' },
  // 6) Depot Management
  { to: '/settings/depots',            label: 'Depot Management',               icon: 'depot' },
  // 7) Supervisor Management
  { to: '/settings/supervisors',       label: 'Supervisor Management',          icon: 'supervisors' },
  // 8) Station Management
  { to: '/settings/stations',          label: 'Station Management',             icon: 'stations' },
  // 9) Section Management
  { to: '/settings/sections',          label: 'Section Management',             icon: 'sections' },
]
const title = computed(() => route.meta?.title ?? 'Settings')
</script>

<template>
  <div class="grid grid-cols-1 lg:grid-cols-[260px_1fr] gap-4">
    <!-- In-page nav -->
    <aside class="rounded-2xl border-app bg-card text-app p-2 h-fit border">
      <nav class="flex flex-col gap-1">
        <RouterLink
          v-for="link in links" :key="link.to" :to="link.to"
          :class="[
            'flex items-center gap-3 rounded-lg px-3 py-2 transition',
            ($route.path === link.to)
              ? 'bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-primary)] hover:text-[var(--seasalt)]'
              : 'hover:bg-[var(--seasalt-lighter)] hover:shadow-popover'
          ]"
        >
          <span class="w-5 h-5 flex items-center justify-center" aria-hidden="true">
            <!-- Monochrome, inherits current color -->
            <svg v-if="link.icon==='failure-id'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M10 2a2 2 0 0 0-2 2v2H6a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-2V4a2 2 0 0 0-2-2zm0 4V4h4v2zM8 12h8v2H8zm0 4h5v2H8z"/></svg>
            <svg v-else-if="link.icon==='telegram'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M9.03 14.86 8.7 18.6a.75.75 0 0 0 1.18.68l2.11-1.52l3.94 2.88c.58.43 1.41.11 1.58-.6l3.2-13.22c.18-.75-.5-1.4-1.23-1.16L2.7 10.03c-.83.28-.8 1.46.04 1.7l5.1 1.44l9.24-6.2z"/></svg>
            <svg v-else-if="link.icon==='users-roles'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5a5 5 0 0 0 5 5m-7 8a7 7 0 0 1 14 0v1H5z"/></svg>
            <svg v-else-if="link.icon==='archive'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M3 3h18v4H3V3m4 6h10v2H7v-2m-4 6h18v4H3v-4Z"/></svg>
            <svg v-else-if="link.icon==='circuits'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M7 3h2v4h6V3h2v4h2a2 2 0 0 1 2 2v3h-2V9H5v9h12v-2h2v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2z"/></svg>
            <svg v-else-if="link.icon==='supervisors'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M12 12a4 4 0 1 0-4-4a4 4 0 0 0 4 4m6 8v-1a5 5 0 0 0-5-5H7a5 5 0 0 0-5 5v1z"/></svg>
            <svg v-else-if="link.icon==='stations'" viewBox="0 0 24 24" class="w-5 h-5">
              <path fill="currentColor" d="M12 2c3.9 0 7 3.1 7 7c0 5.3-7 13-7 13S5 14.3 5 9c0-3.9 3.1-7 7-7m0 9a2 2 0 1 0-2-2a2 2 0 0 0 2 2"/>
            </svg>
            <svg v-else-if="link.icon==='sections'" viewBox="0 0 24 24" class="w-5 h-5">
              <path fill="currentColor" d="M12 2l8 4l-8 4l-8-4zm0 6l8 4l-8 4l-8-4zm0 6l8 4l-8 4l-8-4z"/>
            </svg>
            <svg v-else-if="link.icon==='depot'" viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M3 10.5L12 6l9 4.5V20a1 1 0 0 1-1 1h-6v-6H10v6H4a1 1 0 0 1-1-1z"/></svg>
            <svg v-else-if="link.icon==='reports'" viewBox="0 0 24 24" class="w-5 h-5">
              <path fill="currentColor" d="M6 2a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h9l5-5V4a2 2 0 0 0-2-2H6zm9 18v-3a2 2 0 0 1 2-2h3l-5 5zM8 7h8v2H8V7zm0 4h8v2H8v-2zm0 4h5v2H8v-2z"/>
            </svg>
            <svg v-else viewBox="0 0 24 24" class="w-5 h-5"><circle cx="12" cy="12" r="5" fill="currentColor"/></svg>
          </span>
          <span class="truncate">{{ link.label }}</span>
        </RouterLink>
      </nav>
    </aside>

    <!-- Content -->
    <section class="space-y-3">
      <header class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">{{ title }}</h1>
      </header>
      <div class="card">
        <RouterView />
      </div>
    </section>
  </div>
  
</template>

<script setup>
import { reactive, ref, computed, onMounted } from 'vue';
import { useStationsStore } from '@/stores/stations';
import { useDepotsStore } from '@/stores/depots';
import { useUIStore } from '@/stores/ui';
import { Trash2 } from 'lucide-vue-next';

const stationsStore = useStationsStore();
const depotsStore = useDepotsStore();
const uiStore = useUIStore();

const depotOptions = computed(() => (depotsStore.depots || []).map(d => ({ value: d.id, label: d.code || d.name })));
const stations = computed(() => stationsStore.stations);

onMounted(() => {
  stationsStore.fetchStations();
  depotsStore.fetchDepots();
});

// ... (ensure all other functions in this component now call `stationsStore` or `depotsStore` instead of `stationsStore`) ...
</script>

<template>
  <div class="space-y-5">
    <p class="text-app/80 text-sm">Map stations to depots, manage communication equipment, or upload a complete list via Excel.</p>

    <!-- Form for creating a new station -->
    <div class="card">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Depot</label>
          <select v-model="newStation.depot" class="field h-9">
            <option :value="null" disabled>Select Depot</option>
            <option v-for="opt in depotOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
          </select>
        </div>
        <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Station Name</label>
          <input v-model="newStation.name" class="field h-9" placeholder="e.g., Dadar" />
        </div>
        <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Station Code</label>
          <input v-model="newStation.code" class="field h-9" placeholder="e.g., DDR" />
        </div>
         <div class="md:col-span-1">
          <label class="block text-sm font-medium mb-1">Station Category</label>
          <input v-model="newStation.category" class="field h-9" placeholder="e.g., NSG6" />
        </div>
      </div>
       <div class="mt-3 flex justify-end">
          <button class="btn btn-primary" @click="addStation">Add Station</button>
      </div>
    </div>
    
    <!-- File Upload Section -->
    <div class="card">
       <div class="flex items-end gap-4">
          <div class="flex-grow">
            <label class="block text-sm font-medium mb-1">Upload Stations & Equipment File</label>
             <p class="text-xs text-app/60 mb-2">Select an Excel file with Depot, Station Name, Code, Category, and Equipment details.</p>
             <div class="flex items-center gap-2">
                <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
                <button class="btn" @click="triggerFileInput">Choose File...</button>
                <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
             </div>
          </div>
          <div>
            <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="stationsStore.loading.stations">
              {{ stationsStore.loading.stations ? 'Uploading...' : 'Upload' }}
            </button>
          </div>
       </div>
    </div>

    <!-- Stations List Table -->
    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <colgroup>
            <col class="w-[20%]">
            <col class="w-[20%]">
            <col class="w-[15%]">
            <col class="w-[15%]">
            <col class="w-[15%]">
            <col class="w-[15%]">
          </colgroup>
          <thead>
            <tr class="text-left border-b border-app/40">
              <th @click="toggleSort('depot_display')" class="py-2.5 px-3 cursor-pointer select-none text-left">Depot <span v-if="sortKey === 'depot_display'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('name')" class="py-2.5 px-3 cursor-pointer select-none text-center">Station Name <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('code')" class="py-2.5 px-3 cursor-pointer select-none text-center">Station Code <span v-if="sortKey === 'code'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th @click="toggleSort('category')" class="py-2.5 px-3 cursor-pointer select-none text-center">Category <span v-if="sortKey === 'category'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
              <th class="py-2.5 px-3 text-center">Equipment Count</th>
              <th class="py-2.5 px-3 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="stationsStore.loading.stations && sortedStations.length === 0">
              <td colspan="6" class="px-3 py-6 text-center text-muted">Loading...</td>
            </tr>
            <tr v-else-if="stationsStore.error">
              <td colspan="6" class="px-3 py-6 text-center text-red-500">{{ stationsStore.error }}</td>
            </tr>
            <tr v-else-if="sortedStations.length === 0">
              <td colspan="6" class="px-3 py-6 text-app/60 text-center">No stations yet — add one above or upload a file.</td>
            </tr>
            <tr v-for="s in sortedStations" :key="s.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-middle text-left">{{ s.depot_display }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.name }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.code }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.category }}</td>
              <td class="py-2 px-3 align-middle text-center">{{ s.equipment_count }}</td>
              <td class="py-2 px-3 align-middle">
                <div class="flex flex-wrap items-center justify-center gap-2">
                  <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openEditModal(s)" title="Edit Station">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                  </button>
                  <button class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" @click="openManage(s)" title="Manage Equipment">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 1 1-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 0 0 4.486-6.336l-3.276 3.277a3.004 3.004 0 0 1-2.25-2.25l3.276-3.276a4.5 4.5 0 0 0-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437 1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008Z" />
                    </svg>
                  </button>
                  <button
                    class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app ring-1 ring-app/60 hover:bg-black/10 transition"
                    title="Remove station" @click="openDeleteModal(s)">
                    <Trash2 class="w-6 h-6" />
                  </button>
                </div>
              </td>

            </tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Edit Station Modal -->
    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">Edit Station</h3>
        <div v-if="stationToEdit" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Depot</label>
            <select v-model="stationToEdit.depot" class="field h-9">
              <option v-for="opt in depotOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Station Name</label>
            <input v-model="stationToEdit.name" class="field h-9" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Station Code</label>
            <input v-model="stationToEdit.code" class="field h-9" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Station Category</label>
            <input v-model="stationToEdit.category" class="field h-9" />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveStationChanges" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete station "{{ stationToDelete?.name }}"? This action cannot be undone.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;">Delete</button>
        </div>
      </div>
    </div>

    <!-- Manage Equipment Modal -->
    <div v-if="showModal" class="fixed inset-0 z-50">
      <div class="absolute inset-0 bg-black/40" @click="closeModal"></div>
      <div class="absolute inset-0 grid place-items-center p-4">
        <section class="w-full max-w-7xl rounded-2xl border-app bg-card text-app shadow-2xl overflow-hidden flex flex-col">
          <header class="flex items-center justify-between px-4 py-3 border-b border-app/40">
            <div class="min-w-0">
              <h3 class="font-semibold truncate">Manage Communication Equipment — {{ selectedStation?.name || '' }}</h3>
              <p class="text-xs text-app/70">Add, edit, or remove circuit equipment for this station.</p>
            </div>
            <button class="icon-btn" title="Close" @click="closeModal">
              <svg viewBox="0 0 24 24" class="w-5 h-5"><path fill="currentColor" d="M6.4 4.99L5 6.4L10.6 12L5 17.6L6.4 19L12 13.4L17.6 19l1.4-1.4L13.4 12L19 6.4L17.6 4.99L12 10.6z" /></svg>
            </button>
          </header>
          <div class="p-3 flex-1 overflow-y-auto">
            <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
              <div class="overflow-x-auto">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="text-left border-b border-app/40">
                      <th class="py-2.5 px-3">Category</th>
                      <th class="py-2.5 px-3">Equipment Name</th>
                      <th class="py-2.5 px-3">Make / Model</th>
                      <th class="py-2.5 px-3">Address</th>
                      <th class="py-2.5 px-3">Location</th>
                      <th class="py-2.5 px-3">Quantity</th>
                      <th class="py-2.5 px-3 w-16 text-center">Remove</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-if="tempEquipments.length === 0">
                      <td colspan="7" class="px-3 py-6 text-app/60 text-center">No equipment yet — add a row below.</td>
                    </tr>
                    <tr v-for="(r, i) in tempEquipments" :key="r.id || i" class="border-t border-app/30">
                      <td class="py-2 px-3 align-top"><input v-model="r.category" class="field h-9" placeholder="e.g., Telecom" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.name" class="field h-9" placeholder="e.g., Modem" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.make_modal" class="field h-9" placeholder="e.g., Cisco / 887VA" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.address" class="field h-9" placeholder="e.g., 16.12.13.39" /></td>
                      <td class="py-2 px-3 align-top"><input v-model="r.location_in_station" class="field h-9" placeholder="e.g., OFC HUT" /></td>
                      <td class="py-2 px-3 align-top"><input v-model.number="r.quantity" type="number" class="field h-9 w-20" /></td>
                      <td class="py-2 px-3 align-top text-center">
                        <button
                          class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app ring-1 ring-app/60 hover:bg-black/10 transition"
                          title="Remove row" @click="removeEquipmentRow(i)">
                          <span class="sr-only">Remove row</span>
                          <svg viewBox="0 0 24 24" class="w-6 h-6" aria-hidden="true">
                            <path fill="currentColor"
                              d="M12 2a10 10 0 1 0 0 20a10 10 0 0 0 0-20Zm3.11 13.11l-1 1L12 13l-2.11 3.11l-1-1L11 12L8.89 9.89l1-1L12 11l2.11-2.11l1 1L13 12z" />
                          </svg>
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-[1fr_auto_1fr] items-center">
              <div></div>
              <div class="justify-self-center">
                <button class="btn" @click="addEquipmentRow">+ Add Row</button>
              </div>
              <div class="justify-self-end flex items-center gap-2">
                <button class="btn btn-primary" @click="saveEquipments">Save Changes</button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useSupervisorsStore } from '@/stores/supervisors';
import { useDepotsStore } from '@/stores/depots';
import { Trash2 } from 'lucide-vue-next';

const supervisorsStore = useSupervisorsStore();
const depotsStore = useDepotsStore();

const rows = computed(() => supervisorsStore.supervisors);
const depotOptions = computed(() => depotsStore.depots.map(d => ({ label: d.code || d.name, value: d.id })));

onMounted(() => {
  supervisorsStore.fetchSupervisors();
  depotsStore.fetchDepots();
});

// ... (ensure all other functions now call `supervisorsStore` or `depotsStore`) ...
</script>

<template>
  <div class="space-y-4">
    <p class="text-app/80 text-sm">Add/update depot supervisors by uploading an Excel file or manage them individually below.</p>
    <!-- Bottom action bar -->
    <div class="mt-3 grid grid-cols-[1fr_auto_1fr] items-center">
      <div class="justify-self-start flex items-center gap-2">
        <input type="file" ref="fileInput" @change="handleFileSelect" class="hidden" accept=".xlsx, .xls, .csv" />
        <button class="btn" @click="triggerFileInput">Choose Supervisor File</button>
        <span v-if="selectedFile" class="text-sm text-muted truncate max-w-xs">{{ selectedFile.name }}</span>
        <button v-if="selectedFile" class="btn btn-primary" @click="handleFileUpload" :disabled="supervisorsStore.loading.supervisors">
          {{ supervisorsStore.loading.supervisors ? 'Uploading...' : 'Upload' }}
        </button>
      </div>
      <div class="justify-self-end"><button class="btn" @click="openAddModal">+ Add Row</button></div>
    </div>

    <!-- Table -->
    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                 <colgroup>
                    <col class="w-[20%]">
                    <col class="w-[20%]">
                    <col class="w-[20%]">
                    <col class="w-[15%]">
                    <col class="w-[15%]">
                    <col class="w-[10%]">
                </colgroup>
                <thead>
                    <tr class="text-left border-b border-app/40">
                        <th @click="toggleSort('name')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-left">Supervisor <span v-if="sortKey === 'name'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th @click="toggleSort('designation')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-center">Designation <span v-if="sortKey === 'designation'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th @click="toggleSort('depot_display')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-center">Depot <span v-if="sortKey === 'depot_display'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th @click="toggleSort('mobile')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-center">Mobile <span v-if="sortKey === 'mobile'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th @click="toggleSort('email')" class="py-2.5 px-3 whitespace-nowrap cursor-pointer select-none text-center">Email <span v-if="sortKey === 'email'">{{ sortDir === 'asc' ? '▲' : '▼' }}</span></th>
                        <th class="py-2.5 px-3 w-40 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-if="supervisorsStore.loading.supervisors && sortedRows.length === 0">
                        <td colspan="6" class="py-6 px-3 text-center text-muted">Loading supervisors...</td>
                    </tr>
                    <tr v-else-if="supervisorsStore.error">
                        <td colspan="6" class="py-6 px-3 text-center text-red-500">{{ supervisorsStore.error }}</td>
                    </tr>
                    <tr v-for="r in sortedRows" :key="r.id">
                        <td class="py-2 px-3 align-middle text-left">{{ r.name }}</td>
                        <td class="py-2 px-3 align-middle text-center">{{ r.designation }}</td>
                        <td class="py-2 px-3 align-middle text-center">{{ r.depot_display || 'N/A' }}</td>
                        <td class="py-2 px-3 align-middle text-center">{{ r.mobile || 'N/A' }}</td>
                        <td class="py-2 px-3 align-middle text-center">{{ r.email || 'N/A' }}</td>
                        <td class="py-2 px-3 align-middle text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button @click="openEditModal(r)" class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" title="Edit Supervisor">
                                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                    </svg>
                                </button>
                                <button @click="openDeleteModal(r)" class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition" title="Remove Supervisor">
                                    <Trash2 class="w-6 h-6" />
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>


    <!-- Add/Edit Supervisor Modal -->
    <div v-if="isEditModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">{{ currentSupervisor.id ? 'Edit' : 'Add' }} Supervisor</h3>
        <div v-if="currentSupervisor" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Name</label>
            <input v-model="currentSupervisor.name" class="field" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Designation</label>
            <input v-model="currentSupervisor.designation" class="field" />
          </div>
           <div>
            <label class="block text-sm font-medium mb-1">Depot</label>
            <select v-model="currentSupervisor.depot" class="field">
              <option :value="null">-- No Depot --</option>
              <option v-for="depot in depotOptions" :key="depot.value" :value="depot.value">
                {{ depot.label }}
              </option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Mobile</label>
            <input v-model="currentSupervisor.mobile" class="field" />
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium mb-1">Email</label>
            <input v-model="currentSupervisor.email" type="email" class="field" />
          </div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveSupervisorChanges" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the supervisor "{{ supervisorToDelete?.name }}"? This action cannot be undone.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;">Delete</button>
        </div>
      </div>
    </div>

  </div>
</template>

<script setup>
import { onMounted, computed } from 'vue';
import { useTelegramStore } from '@/stores/telegram.js';

const tg = useTelegramStore();

const settings = computed(() => tg.settings);
const groupList = computed(() => tg.groups);

onMounted(() => {
  tg.fetchTelegramSettings();
  tg.fetchTelegramGroups();
});

function onSaveToken() {
  tg.saveTelegramSettings();
}

function onSaveGroup(group) {
  tg.updateTelegramGroup(group);
}

function onTest(group) {
  tg.sendTestMessage(group);
}
</script>

<template>
  <div class="space-y-6">
    <p class="text-app/80 text-sm">
      Configure the Telegram Bot and the three groups used for system alerts, file uploads, and scheduled reports.
    </p>

    <div class="card p-4 space-y-3">
        <h3 class="font-semibold text-app">Telegram Bot Configuration</h3>
        <div>
          <label class="block text-sm font-medium mb-1">Bot Token (HTTP API Key)</label>
          <input
            class="field"
            v-model="settings.bot_token"
            placeholder="Paste your bot token here, e.g., 8404126856:AAEXUY..."
          />
          <p class="text-xs opacity-70 mt-1">Get this from the BotFather on Telegram.</p>
        </div>
         <div class="flex gap-3 pt-2">
          <button class="btn btn-primary" @click="onSaveToken" :disabled="tg.loading">
            {{ tg.loading ? 'Saving...' : 'Save Token' }}
          </button>
        </div>
    </div>

    <div v-if="tg.loading && groupList.length === 0" class="text-center py-10 text-muted">
      Loading Telegram settings...
    </div>
    <div v-else-if="tg.error && groupList.length === 0" class="text-center py-10 text-red-500">
      {{ tg.error }}
    </div>
    <div v-else class="space-y-4">
      <div v-for="g in groupList" :key="g.key" class="card p-4 space-y-3">
        <h3 class="font-semibold text-app">{{ g.name }}</h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Chat ID</label>
            <input
              class="field"
              v-model="g.chat_id"
              :placeholder="{
                reports: '-4923590033',
                alerts: '-4905455511',
                files: '-4812151797'
              }[g.key] || 'e.g., -1001234567890'"
            />
            <p class="text-xs opacity-70 mt-1">The unique identifier for the {{ g.name }}.</p>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Link / Note (optional)</label>
            <input
              class="field"
              v-model="g.link"
              placeholder="e.g., Invitation link"
            />
          </div>
        </div>

        <div class="flex gap-3 pt-2">
          <button class="btn btn-primary" @click="onSaveGroup(g)" :disabled="tg.loading">
            {{ tg.loading ? 'Saving...' : 'Save Group' }}
          </button>
          <button class="btn" @click="onTest(g)" :disabled="tg.loading || !g.chat_id">Test Message</button>
        </div>
      </div>
    </div>
  </div>
</template>


<script setup>
import { onMounted, computed, ref, reactive } from 'vue';
import { useUserStore } from '@/stores/users';
import { useUIStore } from '@/stores/ui';
import { Trash2 } from 'lucide-vue-next';

// Initialize stores
const userStore = useUserStore();
const uiStore = useUIStore();

const users = computed(() => userStore.users);

// State for Add User modal
const isAddModalOpen = ref(false);
const initialNewUserState = {
  username: '', email: '', first_name: '', last_name: '', role: 'viewer', password: '',
};
const newUser = reactive({ ...initialNewUserState });

// State for Edit User modal
const isEditModalOpen = ref(false);
const currentUserToEdit = ref(null);

// State for Delete User modal
const isDeleteModalOpen = ref(false);
const userToDelete = ref(null);

const roleOptions = ['viewer', 'operator', 'supervisor', 'admin'];

onMounted(() => {
  userStore.fetchUsers();
});

// --- Add User Functions ---
function openAddModal() {
  Object.assign(newUser, initialNewUserState);
  isAddModalOpen.value = true;
}

async function saveNewUser() {
  if (!newUser.username || !newUser.password) {
    uiStore.pushToast({ type: 'error', title: 'Missing Fields', message: 'User ID (PF Number) and Password are required.' });
    return;
  }
  await userStore.addUser(newUser);
  if (!userStore.error) {
    isAddModalOpen.value = false;
  }
}

// --- Edit User Functions ---
function openEditModal(user) {
  currentUserToEdit.value = reactive({ ...user, password: '' });
  isEditModalOpen.value = true;
}

async function saveUserChanges() {
  if (!currentUserToEdit.value) return;
  await userStore.updateUser(currentUserToEdit.value.id, currentUserToEdit.value);
  if (!userStore.error) {
    isEditModalOpen.value = false;
    currentUserToEdit.value = null;
  }
}

// --- Delete User Functions ---
function openDeleteModal(user) {
  userToDelete.value = user;
  isDeleteModalOpen.value = true;
}

async function confirmDelete() {
  if (!userToDelete.value) return;
  await userStore.deleteUser(userToDelete.value.id);
  if (!userStore.error) {
    isDeleteModalOpen.value = false;
    userToDelete.value = null;
  }
}

// --- UI Helpers ---
function getRoleClass(role) {
  switch (role) {
    case 'admin': return 'bg-red-100 text-red-800 border-red-200';
    case 'supervisor': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
    case 'operator': return 'bg-blue-100 text-blue-800 border-blue-200';
    case 'viewer': default: return 'bg-gray-100 text-gray-800 border-gray-200';
  }
}

function getStatusClass(isActive) {
  return isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800';
}
</script>

<template>
  <div class="space-y-4">
    <div class="flex justify-between items-center">
      <p class="text-app/80 text-sm">Create users, assign roles, and manage permissions for the RFMS application.</p>
      <button class="btn btn-primary" @click="openAddModal">+ Add User</button>
    </div>

    <div class="rounded-2xl border-app bg-card text-app overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left border-b border-app/40">
              <th class="py-2.5 px-3 whitespace-nowrap">DB ID</th>
              <th class="py-2.5 px-3 whitespace-nowrap">User ID (PF Number)</th>
              <th class="py-2.5 px-3 whitespace-nowrap">Full Name</th>
              <th class="py-2.5 px-3 whitespace-nowrap">Email</th>
              <th class="py-2.5 px-3 whitespace-nowrap text-center">Role</th>
              <th class="py-2.5 px-3 whitespace-nowrap text-center">Status</th>
              <th class="py-2.5 px-3 w-40 text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr v-if="userStore.loading && users.length === 0">
              <td colspan="7" class="py-6 px-3 text-center text-muted">Loading users...</td>
            </tr>
            <tr v-else-if="userStore.error && users.length === 0">
              <td colspan="7" class="py-6 px-3 text-center text-red-500">{{ userStore.error }}</td>
            </tr>
            <tr v-else-if="users.length === 0">
              <td colspan="7" class="py-6 px-3 text-center text-app/60">No users found. Click "Add User" to begin.</td>
            </tr>
            <tr v-for="user in users" :key="user.id" class="border-t border-app/30">
              <td class="py-2 px-3 align-middle">{{ user.id }}</td>
              <td class="py-2 px-3 align-middle">{{ user.username }}</td>
              <td class="py-2 px-3 align-middle">{{ user.first_name }} {{ user.last_name }}</td>
              <td class="py-2 px-3 align-middle">{{ user.email }}</td>
              <td class="py-2 px-3 align-middle text-center">
                <span class="badge capitalize" :class="getRoleClass(user.role)">{{ user.role }}</span>
              </td>
              <td class="py-2 px-3 align-middle text-center">
                 <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" :class="getStatusClass(user.is_active)">
                  {{ user.is_active ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td class="py-2 px-3 align-middle text-center">
                <div class="flex items-center justify-center gap-2">
                  <button @click="openEditModal(user)" class="h-9 w-9 flex items-center justify-center rounded-lg bg-[var(--button-primary)] text-[var(--seasalt)] hover:bg-[var(--button-hover)] transition" title="Edit User">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                    </svg>
                  </button>
                  <button @click="openDeleteModal(user)" class="inline-flex items-center justify-center h-9 w-9 rounded-md text-app border border-app hover:bg-gray-100 transition" title="Remove User">
                    <Trash2 class="w-6 h-6" />
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div v-if="isAddModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">Add New User</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium mb-1">User ID (PF Number)</label><input v-model="newUser.username" class="field" placeholder="e.g., 12345678" /></div>
          <div><label class="block text-sm font-medium mb-1">Email</label><input v-model="newUser.email" type="email" class="field" placeholder="e.g., j.doe@example.com" /></div>
          <div><label class="block text-sm font-medium mb-1">First Name</label><input v-model="newUser.first_name" class="field" placeholder="e.g., John" /></div>
          <div><label class="block text-sm font-medium mb-1">Last Name</label><input v-model="newUser.last_name" class="field" placeholder="e.g., Doe" /></div>
          <div>
            <label class="block text-sm font-medium mb-1">Role</label>
            <select v-model="newUser.role" class="field capitalize">
              <option v-for="role in roleOptions" :key="role" :value="role">{{ role }}</option>
            </select>
          </div>
          <div><label class="block text-sm font-medium mb-1">Password</label><input v-model="newUser.password" type="password" class="field" placeholder="Enter a temporary password" /></div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isAddModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveNewUser" class="btn btn-primary" :disabled="userStore.loading">{{ userStore.loading ? 'Saving...' : 'Save User' }}</button>
        </div>
      </div>
    </div>

    <div v-if="isEditModalOpen && currentUserToEdit" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-2xl space-y-4">
        <h3 class="text-lg font-semibold">Edit User: {{ currentUserToEdit.username }}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label class="block text-sm font-medium mb-1">User ID (PF Number)</label><input v-model="currentUserToEdit.username" class="field" /></div>
          <div><label class="block text-sm font-medium mb-1">Email</label><input v-model="currentUserToEdit.email" type="email" class="field" /></div>
          <div><label class="block text-sm font-medium mb-1">First Name</label><input v-model="currentUserToEdit.first_name" class="field" /></div>
          <div><label class="block text-sm font-medium mb-1">Last Name</label><input v-model="currentUserToEdit.last_name" class="field" /></div>
          <div>
            <label class="block text-sm font-medium mb-1">Role</label>
            <select v-model="currentUserToEdit.role" class="field capitalize">
              <option v-for="role in roleOptions" :key="role" :value="role">{{ role }}</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Status</label>
            <label class="flex items-center gap-2">
              <input type="checkbox" v-model="currentUserToEdit.is_active" class="h-4 w-4 rounded" />
              <span>Active</span>
            </label>
          </div>
          <div class="md:col-span-2"><label class="block text-sm font-medium mb-1">New Password</label><input v-model="currentUserToEdit.password" type="password" class="field" placeholder="Leave blank to keep unchanged" /></div>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isEditModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="saveUserChanges" class="btn btn-primary" :disabled="userStore.loading">{{ userStore.loading ? 'Saving...' : 'Save Changes' }}</button>
        </div>
      </div>
    </div>
      
    <div v-if="isDeleteModalOpen" class="fixed inset-0 z-50 bg-black/40 flex items-center justify-center p-4">
      <div class="bg-card rounded-2xl p-6 w-full max-w-md space-y-4">
        <h3 class="text-lg font-semibold">Confirm Deletion</h3>
        <p>Are you sure you want to delete the user "<strong>{{ userToDelete?.username }}</strong>"? This action cannot be undone.</p>
        <div class="flex justify-end gap-3 pt-4">
          <button @click="isDeleteModalOpen = false" class="btn btn-outline">Cancel</button>
          <button @click="confirmDelete" class="btn" style="background-color: #ef4444; color: white;" :disabled="userStore.loading">
            {{ userStore.loading ? 'Deleting...' : 'Delete' }}
          </button>
        </div>
      </div>
    </div>

  </div>
</template>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite + Vue</title>
    <!-- PrimeIcons (CDN) -->
    <link rel="stylesheet" href="https://unpkg.com/primeicons/primeicons.css">
  </head>
  <body style="background:red"> <!-- temporary -->
  <div id="app"></div>
  <script type="module" src="/src/main.js"></script>
</body>
</html>


{
  "name": "frontend",
  "version": "0.0.0",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "name": "frontend",
      "version": "0.0.0",
      "dependencies": {
        "axios": "^1.12.2",
        "chart.js": "^4.5.0",
        "lucide-vue-next": "^0.540.0",
        "pinia": "^3.0.3",
        "vue": "^3.5.18",
        "vue-chartjs": "^5.3.2",
        "vue-router": "^4.5.1"
      },
      "devDependencies": {
        "@vitejs/plugin-vue": "^6.0.1",
        "autoprefixer": "^10.4.21",
        "postcss": "^8.5.6",
        "tailwindcss": "^3.4.17",
        "vite": "^7.1.3"
      }
    },
    "node_modules/@alloc/quick-lru": {
      "version": "5.2.0",
      "resolved": "https://registry.npmjs.org/@alloc/quick-lru/-/quick-lru-5.2.0.tgz",
      "integrity": "sha512-UrcABB+4bUrFABwbluTIBErXwvbsU/V7TZWfmbgJfbkwiBuziS9gxdODUyuiecfdGQ85jglMW6juS3+z5TsKLw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/@babel/helper-string-parser": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-string-parser/-/helper-string-parser-7.27.1.tgz",
      "integrity": "sha512-qMlSxKbpRlAridDExk92nSobyDdpPijUq2DW6oDnUqd0iOGxmQjyqhMIihI9+zv4LPyZdRje2cavWPbCbWm3eA==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/helper-validator-identifier": {
      "version": "7.27.1",
      "resolved": "https://registry.npmjs.org/@babel/helper-validator-identifier/-/helper-validator-identifier-7.27.1.tgz",
      "integrity": "sha512-D2hP9eA+Sqx1kBZgzxZh0y1trbuU+JoDkiEwqhQ36nodYqJwyEIhPSdMNd7lOm/4io72luTPWH20Yda0xOuUow==",
      "license": "MIT",
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@babel/parser": {
      "version": "7.28.3",
      "resolved": "https://registry.npmjs.org/@babel/parser/-/parser-7.28.3.tgz",
      "integrity": "sha512-7+Ey1mAgYqFAx2h0RuoxcQT5+MlG3GTV0TQrgr7/ZliKsm/MNDxVVutlWaziMq7wJNAz8MTqz55XLpWvva6StA==",
      "license": "MIT",
      "dependencies": {
        "@babel/types": "^7.28.2"
      },
      "bin": {
        "parser": "bin/babel-parser.js"
      },
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@babel/types": {
      "version": "7.28.2",
      "resolved": "https://registry.npmjs.org/@babel/types/-/types-7.28.2.tgz",
      "integrity": "sha512-ruv7Ae4J5dUYULmeXw1gmb7rYRz57OWCPM57pHojnLq/3Z1CK2lNSLTCVjxVk1F/TZHwOZZrOWi0ur95BbLxNQ==",
      "license": "MIT",
      "dependencies": {
        "@babel/helper-string-parser": "^7.27.1",
        "@babel/helper-validator-identifier": "^7.27.1"
      },
      "engines": {
        "node": ">=6.9.0"
      }
    },
    "node_modules/@esbuild/aix-ppc64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/aix-ppc64/-/aix-ppc64-0.25.9.tgz",
      "integrity": "sha512-OaGtL73Jck6pBKjNIe24BnFE6agGl+6KxDtTfHhy1HmhthfKouEcOhqpSL64K4/0WCtbKFLOdzD/44cJ4k9opA==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "aix"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-arm": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm/-/android-arm-0.25.9.tgz",
      "integrity": "sha512-5WNI1DaMtxQ7t7B6xa572XMXpHAaI/9Hnhk8lcxF4zVN4xstUgTlvuGDorBguKEnZO70qwEcLpfifMLoxiPqHQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/android-arm64/-/android-arm64-0.25.9.tgz",
      "integrity": "sha512-IDrddSmpSv51ftWslJMvl3Q2ZT98fUSL2/rlUXuVqRXHCs5EUF1/f+jbjF5+NG9UffUDMCiTyh8iec7u8RlTLg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/android-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/android-x64/-/android-x64-0.25.9.tgz",
      "integrity": "sha512-I853iMZ1hWZdNllhVZKm34f4wErd4lMyeV7BLzEExGEIZYsOzqDWDf+y082izYUE8gtJnYHdeDpN/6tUdwvfiw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/darwin-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-arm64/-/darwin-arm64-0.25.9.tgz",
      "integrity": "sha512-XIpIDMAjOELi/9PB30vEbVMs3GV1v2zkkPnuyRRURbhqjyzIINwj+nbQATh4H9GxUgH1kFsEyQMxwiLFKUS6Rg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/darwin-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/darwin-x64/-/darwin-x64-0.25.9.tgz",
      "integrity": "sha512-jhHfBzjYTA1IQu8VyrjCX4ApJDnH+ez+IYVEoJHeqJm9VhG9Dh2BYaJritkYK3vMaXrf7Ogr/0MQ8/MeIefsPQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/freebsd-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-arm64/-/freebsd-arm64-0.25.9.tgz",
      "integrity": "sha512-z93DmbnY6fX9+KdD4Ue/H6sYs+bhFQJNCPZsi4XWJoYblUqT06MQUdBCpcSfuiN72AbqeBFu5LVQTjfXDE2A6Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/freebsd-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/freebsd-x64/-/freebsd-x64-0.25.9.tgz",
      "integrity": "sha512-mrKX6H/vOyo5v71YfXWJxLVxgy1kyt1MQaD8wZJgJfG4gq4DpQGpgTB74e5yBeQdyMTbgxp0YtNj7NuHN0PoZg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-arm": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm/-/linux-arm-0.25.9.tgz",
      "integrity": "sha512-HBU2Xv78SMgaydBmdor38lg8YDnFKSARg1Q6AT0/y2ezUAKiZvc211RDFHlEZRFNRVhcMamiToo7bDx3VEOYQw==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-arm64/-/linux-arm64-0.25.9.tgz",
      "integrity": "sha512-BlB7bIcLT3G26urh5Dmse7fiLmLXnRlopw4s8DalgZ8ef79Jj4aUcYbk90g8iCa2467HX8SAIidbL7gsqXHdRw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-ia32": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ia32/-/linux-ia32-0.25.9.tgz",
      "integrity": "sha512-e7S3MOJPZGp2QW6AK6+Ly81rC7oOSerQ+P8L0ta4FhVi+/j/v2yZzx5CqqDaWjtPFfYz21Vi1S0auHrap3Ma3A==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-loong64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-loong64/-/linux-loong64-0.25.9.tgz",
      "integrity": "sha512-Sbe10Bnn0oUAB2AalYztvGcK+o6YFFA/9829PhOCUS9vkJElXGdphz0A3DbMdP8gmKkqPmPcMJmJOrI3VYB1JQ==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-mips64el": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-mips64el/-/linux-mips64el-0.25.9.tgz",
      "integrity": "sha512-YcM5br0mVyZw2jcQeLIkhWtKPeVfAerES5PvOzaDxVtIyZ2NUBZKNLjC5z3/fUlDgT6w89VsxP2qzNipOaaDyA==",
      "cpu": [
        "mips64el"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-ppc64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-ppc64/-/linux-ppc64-0.25.9.tgz",
      "integrity": "sha512-++0HQvasdo20JytyDpFvQtNrEsAgNG2CY1CLMwGXfFTKGBGQT3bOeLSYE2l1fYdvML5KUuwn9Z8L1EWe2tzs1w==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-riscv64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-riscv64/-/linux-riscv64-0.25.9.tgz",
      "integrity": "sha512-uNIBa279Y3fkjV+2cUjx36xkx7eSjb8IvnL01eXUKXez/CBHNRw5ekCGMPM0BcmqBxBcdgUWuUXmVWwm4CH9kg==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-s390x": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-s390x/-/linux-s390x-0.25.9.tgz",
      "integrity": "sha512-Mfiphvp3MjC/lctb+7D287Xw1DGzqJPb/J2aHHcHxflUo+8tmN/6d4k6I2yFR7BVo5/g7x2Monq4+Yew0EHRIA==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/linux-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-0.25.9.tgz",
      "integrity": "sha512-iSwByxzRe48YVkmpbgoxVzn76BXjlYFXC7NvLYq+b+kDjyyk30J0JY47DIn8z1MO3K0oSl9fZoRmZPQI4Hklzg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/netbsd-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-arm64/-/netbsd-arm64-0.25.9.tgz",
      "integrity": "sha512-9jNJl6FqaUG+COdQMjSCGW4QiMHH88xWbvZ+kRVblZsWrkXlABuGdFJ1E9L7HK+T0Yqd4akKNa/lO0+jDxQD4Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/netbsd-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/netbsd-x64/-/netbsd-x64-0.25.9.tgz",
      "integrity": "sha512-RLLdkflmqRG8KanPGOU7Rpg829ZHu8nFy5Pqdi9U01VYtG9Y0zOG6Vr2z4/S+/3zIyOxiK6cCeYNWOFR9QP87g==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "netbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openbsd-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-arm64/-/openbsd-arm64-0.25.9.tgz",
      "integrity": "sha512-YaFBlPGeDasft5IIM+CQAhJAqS3St3nJzDEgsgFixcfZeyGPCd6eJBWzke5piZuZ7CtL656eOSYKk4Ls2C0FRQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openbsd-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/openbsd-x64/-/openbsd-x64-0.25.9.tgz",
      "integrity": "sha512-1MkgTCuvMGWuqVtAvkpkXFmtL8XhWy+j4jaSO2wxfJtilVCi0ZE37b8uOdMItIHz4I6z1bWWtEX4CJwcKYLcuA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openbsd"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/openharmony-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/openharmony-arm64/-/openharmony-arm64-0.25.9.tgz",
      "integrity": "sha512-4Xd0xNiMVXKh6Fa7HEJQbrpP3m3DDn43jKxMjxLLRjWnRsfxjORYJlXPO4JNcXtOyfajXorRKY9NkOpTHptErg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openharmony"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/sunos-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/sunos-x64/-/sunos-x64-0.25.9.tgz",
      "integrity": "sha512-WjH4s6hzo00nNezhp3wFIAfmGZ8U7KtrJNlFMRKxiI9mxEK1scOMAaa9i4crUtu+tBr+0IN6JCuAcSBJZfnphw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "sunos"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-arm64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-arm64/-/win32-arm64-0.25.9.tgz",
      "integrity": "sha512-mGFrVJHmZiRqmP8xFOc6b84/7xa5y5YvR1x8djzXpJBSv/UsNK6aqec+6JDjConTgvvQefdGhFDAs2DLAds6gQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-ia32": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-ia32/-/win32-ia32-0.25.9.tgz",
      "integrity": "sha512-b33gLVU2k11nVx1OhX3C8QQP6UHQK4ZtN56oFWvVXvz2VkDoe6fbG8TOgHFxEvqeqohmRnIHe5A1+HADk4OQww==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@esbuild/win32-x64": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/@esbuild/win32-x64/-/win32-x64-0.25.9.tgz",
      "integrity": "sha512-PPOl1mi6lpLNQxnGoyAfschAodRFYXJ+9fs6WHXz7CSWKbOqiMZsubC+BQsVKuul+3vKLuwTHsS2c2y9EoKwxQ==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ],
      "engines": {
        "node": ">=18"
      }
    },
    "node_modules/@isaacs/cliui": {
      "version": "8.0.2",
      "resolved": "https://registry.npmjs.org/@isaacs/cliui/-/cliui-8.0.2.tgz",
      "integrity": "sha512-O8jcjabXaleOG9DQ0+ARXWZBTfnP4WNAqzuiJK7ll44AmxGKv/J2M4TPjxjY3znBCfvBXFzucm1twdyFybFqEA==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "string-width": "^5.1.2",
        "string-width-cjs": "npm:string-width@^4.2.0",
        "strip-ansi": "^7.0.1",
        "strip-ansi-cjs": "npm:strip-ansi@^6.0.1",
        "wrap-ansi": "^8.1.0",
        "wrap-ansi-cjs": "npm:wrap-ansi@^7.0.0"
      },
      "engines": {
        "node": ">=12"
      }
    },
    "node_modules/@jridgewell/gen-mapping": {
      "version": "0.3.13",
      "resolved": "https://registry.npmjs.org/@jridgewell/gen-mapping/-/gen-mapping-0.3.13.tgz",
      "integrity": "sha512-2kkt/7niJ6MgEPxF0bYdQ6etZaA+fQvDcLKckhy1yIQOzaoKjBBjSj63/aLVjYE3qhRt5dvM+uUyfCg6UKCBbA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.0",
        "@jridgewell/trace-mapping": "^0.3.24"
      }
    },
    "node_modules/@jridgewell/resolve-uri": {
      "version": "3.1.2",
      "resolved": "https://registry.npmjs.org/@jridgewell/resolve-uri/-/resolve-uri-3.1.2.tgz",
      "integrity": "sha512-bRISgCIjP20/tbWSPWMEi54QVPRZExkuD9lJL+UIxUKtwVJA8wW1Trb1jMs1RFXo1CBTNZ/5hpC9QvmKWdopKw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6.0.0"
      }
    },
    "node_modules/@jridgewell/sourcemap-codec": {
      "version": "1.5.5",
      "resolved": "https://registry.npmjs.org/@jridgewell/sourcemap-codec/-/sourcemap-codec-1.5.5.tgz",
      "integrity": "sha512-cYQ9310grqxueWbl+WuIUIaiUaDcj7WOq5fVhEljNVgRfOUhY9fy2zTvfoqWsnebh8Sl70VScFbICvJnLKB0Og==",
      "license": "MIT"
    },
    "node_modules/@jridgewell/trace-mapping": {
      "version": "0.3.30",
      "resolved": "https://registry.npmjs.org/@jridgewell/trace-mapping/-/trace-mapping-0.3.30.tgz",
      "integrity": "sha512-GQ7Nw5G2lTu/BtHTKfXhKHok2WGetd4XYcVKGx00SjAk8GMwgJM3zr6zORiPGuOE+/vkc90KtTosSSvaCjKb2Q==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/resolve-uri": "^3.1.0",
        "@jridgewell/sourcemap-codec": "^1.4.14"
      }
    },
    "node_modules/@kurkle/color": {
      "version": "0.3.4",
      "resolved": "https://registry.npmjs.org/@kurkle/color/-/color-0.3.4.tgz",
      "integrity": "sha512-M5UknZPHRu3DEDWoipU6sE8PdkZ6Z/S+v4dD+Ke8IaNlpdSQah50lz1KtcFBa2vsdOnwbbnxJwVM4wty6udA5w==",
      "license": "MIT"
    },
    "node_modules/@nodelib/fs.scandir": {
      "version": "2.1.5",
      "resolved": "https://registry.npmjs.org/@nodelib/fs.scandir/-/fs.scandir-2.1.5.tgz",
      "integrity": "sha512-vq24Bq3ym5HEQm2NKCr3yXDwjc7vTsEThRDnkp2DK9p1uqLR+DHurm/NOTo0KG7HYHU7eppKZj3MyqYuMBf62g==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@nodelib/fs.stat": "2.0.5",
        "run-parallel": "^1.1.9"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/@nodelib/fs.stat": {
      "version": "2.0.5",
      "resolved": "https://registry.npmjs.org/@nodelib/fs.stat/-/fs.stat-2.0.5.tgz",
      "integrity": "sha512-RkhPPp2zrqDAQA/2jNhnztcPAlv64XdhIp7a7454A5ovI7Bukxgt7MX7udwAu3zg1DcpPU0rz3VV1SeaqvY4+A==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/@nodelib/fs.walk": {
      "version": "1.2.8",
      "resolved": "https://registry.npmjs.org/@nodelib/fs.walk/-/fs.walk-1.2.8.tgz",
      "integrity": "sha512-oGB+UxlgWcgQkgwo8GcEGwemoTFt3FIO9ababBmaGwXIoBKZ+GTy0pP185beGg7Llih/NSHSV2XAs1lnznocSg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@nodelib/fs.scandir": "2.1.5",
        "fastq": "^1.6.0"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/@pkgjs/parseargs": {
      "version": "0.11.0",
      "resolved": "https://registry.npmjs.org/@pkgjs/parseargs/-/parseargs-0.11.0.tgz",
      "integrity": "sha512-+1VkjdD0QBLPodGrJUeqarH8VAIvQODIbwh9XpP5Syisf7YoQgsJKPNFoqqLQlu+VQ/tVSshMR6loPMn8U+dPg==",
      "dev": true,
      "license": "MIT",
      "optional": true,
      "engines": {
        "node": ">=14"
      }
    },
    "node_modules/@rolldown/pluginutils": {
      "version": "1.0.0-beta.29",
      "resolved": "https://registry.npmjs.org/@rolldown/pluginutils/-/pluginutils-1.0.0-beta.29.tgz",
      "integrity": "sha512-NIJgOsMjbxAXvoGq/X0gD7VPMQ8j9g0BiDaNjVNVjvl+iKXxL3Jre0v31RmBYeLEmkbj2s02v8vFTbUXi5XS2Q==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@rollup/rollup-android-arm-eabi": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm-eabi/-/rollup-android-arm-eabi-4.50.0.tgz",
      "integrity": "sha512-lVgpeQyy4fWN5QYebtW4buT/4kn4p4IJ+kDNB4uYNT5b8c8DLJDg6titg20NIg7E8RWwdWZORW6vUFfrLyG3KQ==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-android-arm64": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-android-arm64/-/rollup-android-arm64-4.50.0.tgz",
      "integrity": "sha512-2O73dR4Dc9bp+wSYhviP6sDziurB5/HCym7xILKifWdE9UsOe2FtNcM+I4xZjKrfLJnq5UR8k9riB87gauiQtw==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "android"
      ]
    },
    "node_modules/@rollup/rollup-darwin-arm64": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-arm64/-/rollup-darwin-arm64-4.50.0.tgz",
      "integrity": "sha512-vwSXQN8T4sKf1RHr1F0s98Pf8UPz7pS6P3LG9NSmuw0TVh7EmaE+5Ny7hJOZ0M2yuTctEsHHRTMi2wuHkdS6Hg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-darwin-x64": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-darwin-x64/-/rollup-darwin-x64-4.50.0.tgz",
      "integrity": "sha512-cQp/WG8HE7BCGyFVuzUg0FNmupxC+EPZEwWu2FCGGw5WDT1o2/YlENbm5e9SMvfDFR6FRhVCBePLqj0o8MN7Vw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-arm64": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-arm64/-/rollup-freebsd-arm64-4.50.0.tgz",
      "integrity": "sha512-UR1uTJFU/p801DvvBbtDD7z9mQL8J80xB0bR7DqW7UGQHRm/OaKzp4is7sQSdbt2pjjSS72eAtRh43hNduTnnQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-freebsd-x64": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-freebsd-x64/-/rollup-freebsd-x64-4.50.0.tgz",
      "integrity": "sha512-G/DKyS6PK0dD0+VEzH/6n/hWDNPDZSMBmqsElWnCRGrYOb2jC0VSupp7UAHHQ4+QILwkxSMaYIbQ72dktp8pKA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "freebsd"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-gnueabihf": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-gnueabihf/-/rollup-linux-arm-gnueabihf-4.50.0.tgz",
      "integrity": "sha512-u72Mzc6jyJwKjJbZZcIYmd9bumJu7KNmHYdue43vT1rXPm2rITwmPWF0mmPzLm9/vJWxIRbao/jrQmxTO0Sm9w==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm-musleabihf": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm-musleabihf/-/rollup-linux-arm-musleabihf-4.50.0.tgz",
      "integrity": "sha512-S4UefYdV0tnynDJV1mdkNawp0E5Qm2MtSs330IyHgaccOFrwqsvgigUD29uT+B/70PDY1eQ3t40+xf6wIvXJyg==",
      "cpu": [
        "arm"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-gnu": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-gnu/-/rollup-linux-arm64-gnu-4.50.0.tgz",
      "integrity": "sha512-1EhkSvUQXJsIhk4msxP5nNAUWoB4MFDHhtc4gAYvnqoHlaL9V3F37pNHabndawsfy/Tp7BPiy/aSa6XBYbaD1g==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-arm64-musl": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-arm64-musl/-/rollup-linux-arm64-musl-4.50.0.tgz",
      "integrity": "sha512-EtBDIZuDtVg75xIPIK1l5vCXNNCIRM0OBPUG+tbApDuJAy9mKago6QxX+tfMzbCI6tXEhMuZuN1+CU8iDW+0UQ==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-loongarch64-gnu": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-loongarch64-gnu/-/rollup-linux-loongarch64-gnu-4.50.0.tgz",
      "integrity": "sha512-BGYSwJdMP0hT5CCmljuSNx7+k+0upweM2M4YGfFBjnFSZMHOLYR0gEEj/dxyYJ6Zc6AiSeaBY8dWOa11GF/ppQ==",
      "cpu": [
        "loong64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-ppc64-gnu": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-ppc64-gnu/-/rollup-linux-ppc64-gnu-4.50.0.tgz",
      "integrity": "sha512-I1gSMzkVe1KzAxKAroCJL30hA4DqSi+wGc5gviD0y3IL/VkvcnAqwBf4RHXHyvH66YVHxpKO8ojrgc4SrWAnLg==",
      "cpu": [
        "ppc64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-gnu": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-gnu/-/rollup-linux-riscv64-gnu-4.50.0.tgz",
      "integrity": "sha512-bSbWlY3jZo7molh4tc5dKfeSxkqnf48UsLqYbUhnkdnfgZjgufLS/NTA8PcP/dnvct5CCdNkABJ56CbclMRYCA==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-riscv64-musl": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-riscv64-musl/-/rollup-linux-riscv64-musl-4.50.0.tgz",
      "integrity": "sha512-LSXSGumSURzEQLT2e4sFqFOv3LWZsEF8FK7AAv9zHZNDdMnUPYH3t8ZlaeYYZyTXnsob3htwTKeWtBIkPV27iQ==",
      "cpu": [
        "riscv64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-s390x-gnu": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-s390x-gnu/-/rollup-linux-s390x-gnu-4.50.0.tgz",
      "integrity": "sha512-CxRKyakfDrsLXiCyucVfVWVoaPA4oFSpPpDwlMcDFQvrv3XY6KEzMtMZrA+e/goC8xxp2WSOxHQubP8fPmmjOQ==",
      "cpu": [
        "s390x"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-gnu": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-gnu/-/rollup-linux-x64-gnu-4.50.0.tgz",
      "integrity": "sha512-8PrJJA7/VU8ToHVEPu14FzuSAqVKyo5gg/J8xUerMbyNkWkO9j2ExBho/68RnJsMGNJq4zH114iAttgm7BZVkA==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-linux-x64-musl": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-linux-x64-musl/-/rollup-linux-x64-musl-4.50.0.tgz",
      "integrity": "sha512-SkE6YQp+CzpyOrbw7Oc4MgXFvTw2UIBElvAvLCo230pyxOLmYwRPwZ/L5lBe/VW/qT1ZgND9wJfOsdy0XptRvw==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "linux"
      ]
    },
    "node_modules/@rollup/rollup-openharmony-arm64": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-openharmony-arm64/-/rollup-openharmony-arm64-4.50.0.tgz",
      "integrity": "sha512-PZkNLPfvXeIOgJWA804zjSFH7fARBBCpCXxgkGDRjjAhRLOR8o0IGS01ykh5GYfod4c2yiiREuDM8iZ+pVsT+Q==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "openharmony"
      ]
    },
    "node_modules/@rollup/rollup-win32-arm64-msvc": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-arm64-msvc/-/rollup-win32-arm64-msvc-4.50.0.tgz",
      "integrity": "sha512-q7cIIdFvWQoaCbLDUyUc8YfR3Jh2xx3unO8Dn6/TTogKjfwrax9SyfmGGK6cQhKtjePI7jRfd7iRYcxYs93esg==",
      "cpu": [
        "arm64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-ia32-msvc": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-ia32-msvc/-/rollup-win32-ia32-msvc-4.50.0.tgz",
      "integrity": "sha512-XzNOVg/YnDOmFdDKcxxK410PrcbcqZkBmz+0FicpW5jtjKQxcW1BZJEQOF0NJa6JO7CZhett8GEtRN/wYLYJuw==",
      "cpu": [
        "ia32"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@rollup/rollup-win32-x64-msvc": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/@rollup/rollup-win32-x64-msvc/-/rollup-win32-x64-msvc-4.50.0.tgz",
      "integrity": "sha512-xMmiWRR8sp72Zqwjgtf3QbZfF1wdh8X2ABu3EaozvZcyHJeU0r+XAnXdKgs4cCAp6ORoYoCygipYP1mjmbjrsg==",
      "cpu": [
        "x64"
      ],
      "dev": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "win32"
      ]
    },
    "node_modules/@types/estree": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/@types/estree/-/estree-1.0.8.tgz",
      "integrity": "sha512-dWHzHa2WqEXI/O1E9OjrocMTKJl2mSrEolh1Iomrv6U+JuNwaHXsXx9bLu5gG7BUWFIN0skIQJQ/L1rIex4X6w==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/@vitejs/plugin-vue": {
      "version": "6.0.1",
      "resolved": "https://registry.npmjs.org/@vitejs/plugin-vue/-/plugin-vue-6.0.1.tgz",
      "integrity": "sha512-+MaE752hU0wfPFJEUAIxqw18+20euHHdxVtMvbFcOEpjEyfqXH/5DCoTHiVJ0J29EhTJdoTkjEv5YBKU9dnoTw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@rolldown/pluginutils": "1.0.0-beta.29"
      },
      "engines": {
        "node": "^20.19.0 || >=22.12.0"
      },
      "peerDependencies": {
        "vite": "^5.0.0 || ^6.0.0 || ^7.0.0",
        "vue": "^3.2.25"
      }
    },
    "node_modules/@vue/compiler-core": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/@vue/compiler-core/-/compiler-core-3.5.20.tgz",
      "integrity": "sha512-8TWXUyiqFd3GmP4JTX9hbiTFRwYHgVL/vr3cqhr4YQ258+9FADwvj7golk2sWNGHR67QgmCZ8gz80nQcMokhwg==",
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.28.3",
        "@vue/shared": "3.5.20",
        "entities": "^4.5.0",
        "estree-walker": "^2.0.2",
        "source-map-js": "^1.2.1"
      }
    },
    "node_modules/@vue/compiler-dom": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/@vue/compiler-dom/-/compiler-dom-3.5.20.tgz",
      "integrity": "sha512-whB44M59XKjqUEYOMPYU0ijUV0G+4fdrHVKDe32abNdX/kJe1NUEMqsi4cwzXa9kyM9w5S8WqFsrfo1ogtBZGQ==",
      "license": "MIT",
      "dependencies": {
        "@vue/compiler-core": "3.5.20",
        "@vue/shared": "3.5.20"
      }
    },
    "node_modules/@vue/compiler-sfc": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/@vue/compiler-sfc/-/compiler-sfc-3.5.20.tgz",
      "integrity": "sha512-SFcxapQc0/feWiSBfkGsa1v4DOrnMAQSYuvDMpEaxbpH5dKbnEM5KobSNSgU+1MbHCl+9ftm7oQWxvwDB6iBfw==",
      "license": "MIT",
      "dependencies": {
        "@babel/parser": "^7.28.3",
        "@vue/compiler-core": "3.5.20",
        "@vue/compiler-dom": "3.5.20",
        "@vue/compiler-ssr": "3.5.20",
        "@vue/shared": "3.5.20",
        "estree-walker": "^2.0.2",
        "magic-string": "^0.30.17",
        "postcss": "^8.5.6",
        "source-map-js": "^1.2.1"
      }
    },
    "node_modules/@vue/compiler-ssr": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/@vue/compiler-ssr/-/compiler-ssr-3.5.20.tgz",
      "integrity": "sha512-RSl5XAMc5YFUXpDQi+UQDdVjH9FnEpLDHIALg5J0ITHxkEzJ8uQLlo7CIbjPYqmZtt6w0TsIPbo1izYXwDG7JA==",
      "license": "MIT",
      "dependencies": {
        "@vue/compiler-dom": "3.5.20",
        "@vue/shared": "3.5.20"
      }
    },
    "node_modules/@vue/devtools-api": {
      "version": "7.7.7",
      "resolved": "https://registry.npmjs.org/@vue/devtools-api/-/devtools-api-7.7.7.tgz",
      "integrity": "sha512-lwOnNBH2e7x1fIIbVT7yF5D+YWhqELm55/4ZKf45R9T8r9dE2AIOy8HKjfqzGsoTHFbWbr337O4E0A0QADnjBg==",
      "license": "MIT",
      "dependencies": {
        "@vue/devtools-kit": "^7.7.7"
      }
    },
    "node_modules/@vue/devtools-kit": {
      "version": "7.7.7",
      "resolved": "https://registry.npmjs.org/@vue/devtools-kit/-/devtools-kit-7.7.7.tgz",
      "integrity": "sha512-wgoZtxcTta65cnZ1Q6MbAfePVFxfM+gq0saaeytoph7nEa7yMXoi6sCPy4ufO111B9msnw0VOWjPEFCXuAKRHA==",
      "license": "MIT",
      "dependencies": {
        "@vue/devtools-shared": "^7.7.7",
        "birpc": "^2.3.0",
        "hookable": "^5.5.3",
        "mitt": "^3.0.1",
        "perfect-debounce": "^1.0.0",
        "speakingurl": "^14.0.1",
        "superjson": "^2.2.2"
      }
    },
    "node_modules/@vue/devtools-shared": {
      "version": "7.7.7",
      "resolved": "https://registry.npmjs.org/@vue/devtools-shared/-/devtools-shared-7.7.7.tgz",
      "integrity": "sha512-+udSj47aRl5aKb0memBvcUG9koarqnxNM5yjuREvqwK6T3ap4mn3Zqqc17QrBFTqSMjr3HK1cvStEZpMDpfdyw==",
      "license": "MIT",
      "dependencies": {
        "rfdc": "^1.4.1"
      }
    },
    "node_modules/@vue/reactivity": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/@vue/reactivity/-/reactivity-3.5.20.tgz",
      "integrity": "sha512-hS8l8x4cl1fmZpSQX/NXlqWKARqEsNmfkwOIYqtR2F616NGfsLUm0G6FQBK6uDKUCVyi1YOL8Xmt/RkZcd/jYQ==",
      "license": "MIT",
      "dependencies": {
        "@vue/shared": "3.5.20"
      }
    },
    "node_modules/@vue/runtime-core": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/@vue/runtime-core/-/runtime-core-3.5.20.tgz",
      "integrity": "sha512-vyQRiH5uSZlOa+4I/t4Qw/SsD/gbth0SW2J7oMeVlMFMAmsG1rwDD6ok0VMmjXY3eI0iHNSSOBilEDW98PLRKw==",
      "license": "MIT",
      "dependencies": {
        "@vue/reactivity": "3.5.20",
        "@vue/shared": "3.5.20"
      }
    },
    "node_modules/@vue/runtime-dom": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/@vue/runtime-dom/-/runtime-dom-3.5.20.tgz",
      "integrity": "sha512-KBHzPld/Djw3im0CQ7tGCpgRedryIn4CcAl047EhFTCCPT2xFf4e8j6WeKLgEEoqPSl9TYqShc3Q6tpWpz/Xgw==",
      "license": "MIT",
      "dependencies": {
        "@vue/reactivity": "3.5.20",
        "@vue/runtime-core": "3.5.20",
        "@vue/shared": "3.5.20",
        "csstype": "^3.1.3"
      }
    },
    "node_modules/@vue/server-renderer": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/@vue/server-renderer/-/server-renderer-3.5.20.tgz",
      "integrity": "sha512-HthAS0lZJDH21HFJBVNTtx+ULcIbJQRpjSVomVjfyPkFSpCwvsPTA+jIzOaUm3Hrqx36ozBHePztQFg6pj5aKg==",
      "license": "MIT",
      "dependencies": {
        "@vue/compiler-ssr": "3.5.20",
        "@vue/shared": "3.5.20"
      },
      "peerDependencies": {
        "vue": "3.5.20"
      }
    },
    "node_modules/@vue/shared": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/@vue/shared/-/shared-3.5.20.tgz",
      "integrity": "sha512-SoRGP596KU/ig6TfgkCMbXkr4YJ91n/QSdMuqeP5r3hVIYA3CPHUBCc7Skak0EAKV+5lL4KyIh61VA/pK1CIAA==",
      "license": "MIT"
    },
    "node_modules/ansi-regex": {
      "version": "6.2.0",
      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-6.2.0.tgz",
      "integrity": "sha512-TKY5pyBkHyADOPYlRT9Lx6F544mPl0vS5Ew7BJ45hA08Q+t3GjbueLliBWN3sMICk6+y7HdyxSzC4bWS8baBdg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/chalk/ansi-regex?sponsor=1"
      }
    },
    "node_modules/ansi-styles": {
      "version": "6.2.1",
      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-6.2.1.tgz",
      "integrity": "sha512-bN798gFfQX+viw3R7yrGWRqnrN2oRkEkUjjl4JNn4E8GxxbjtG3FbrEIIY3l8/hrwUwIeCZvi4QuOTP4MErVug==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
      }
    },
    "node_modules/any-promise": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/any-promise/-/any-promise-1.3.0.tgz",
      "integrity": "sha512-7UvmKalWRt1wgjL1RrGxoSJW/0QZFIegpeGvZG9kjp8vrRu55XTHbwnqq2GpXm9uLbcuhxm3IqX9OB4MZR1b2A==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/anymatch": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/anymatch/-/anymatch-3.1.3.tgz",
      "integrity": "sha512-KMReFUr0B4t+D+OBkjR3KYqvocp2XaSzO55UcB6mgQMd3KbcE+mWTyvVV7D/zsdEbNnV6acZUutkiHQXvTr1Rw==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "normalize-path": "^3.0.0",
        "picomatch": "^2.0.4"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/arg": {
      "version": "5.0.2",
      "resolved": "https://registry.npmjs.org/arg/-/arg-5.0.2.tgz",
      "integrity": "sha512-PYjyFOLKQ9y57JvQ6QLo8dAgNqswh8M1RMJYdQduT6xbWSgK36P/Z/v+p888pM69jMMfS8Xd8F6I1kQ/I9HUGg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/asynckit": {
      "version": "0.4.0",
      "resolved": "https://registry.npmjs.org/asynckit/-/asynckit-0.4.0.tgz",
      "integrity": "sha512-Oei9OH4tRh0YqU3GxhX79dM/mwVgvbZJaSNaRk+bshkj0S5cfHcgYakreBjrHwatXKbz+IoIdYLxrKim2MjW0Q==",
      "license": "MIT"
    },
    "node_modules/autoprefixer": {
      "version": "10.4.21",
      "resolved": "https://registry.npmjs.org/autoprefixer/-/autoprefixer-10.4.21.tgz",
      "integrity": "sha512-O+A6LWV5LDHSJD3LjHYoNi4VLsj/Whi7k6zG12xTYaU4cQ8oxQGckXNX8cRHK5yOZ/ppVHe0ZBXGzSV9jXdVbQ==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/autoprefixer"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "browserslist": "^4.24.4",
        "caniuse-lite": "^1.0.30001702",
        "fraction.js": "^4.3.7",
        "normalize-range": "^0.1.2",
        "picocolors": "^1.1.1",
        "postcss-value-parser": "^4.2.0"
      },
      "bin": {
        "autoprefixer": "bin/autoprefixer"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      },
      "peerDependencies": {
        "postcss": "^8.1.0"
      }
    },
    "node_modules/axios": {
      "version": "1.12.2",
      "resolved": "https://registry.npmjs.org/axios/-/axios-1.12.2.tgz",
      "integrity": "sha512-vMJzPewAlRyOgxV2dU0Cuz2O8zzzx9VYtbJOaBgXFeLc4IV/Eg50n4LowmehOOR61S8ZMpc2K5Sa7g6A4jfkUw==",
      "license": "MIT",
      "dependencies": {
        "follow-redirects": "^1.15.6",
        "form-data": "^4.0.4",
        "proxy-from-env": "^1.1.0"
      }
    },
    "node_modules/balanced-match": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/balanced-match/-/balanced-match-1.0.2.tgz",
      "integrity": "sha512-3oSeUO0TMV67hN1AmbXsK4yaqU7tjiHlbxRDZOpH0KW9+CeX4bRAaX0Anxt0tx2MrpRpWwQaPwIlISEJhYU5Pw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/binary-extensions": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/binary-extensions/-/binary-extensions-2.3.0.tgz",
      "integrity": "sha512-Ceh+7ox5qe7LJuLHoY0feh3pHuUDHAcRUeyL2VYghZwfpkNIy/+8Ocg0a3UuSoYzavmylwuLWQOf3hl0jjMMIw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/birpc": {
      "version": "2.5.0",
      "resolved": "https://registry.npmjs.org/birpc/-/birpc-2.5.0.tgz",
      "integrity": "sha512-VSWO/W6nNQdyP520F1mhf+Lc2f8pjGQOtoHHm7Ze8Go1kX7akpVIrtTa0fn+HB0QJEDVacl6aO08YE0PgXfdnQ==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/antfu"
      }
    },
    "node_modules/brace-expansion": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/brace-expansion/-/brace-expansion-2.0.2.tgz",
      "integrity": "sha512-Jt0vHyM+jmUBqojB7E1NIYadt0vI0Qxjxd2TErW94wDz+E2LAm5vKMXXwg6ZZBTHPuUlDgQHKXvjGBdfcF1ZDQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "balanced-match": "^1.0.0"
      }
    },
    "node_modules/braces": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/braces/-/braces-3.0.3.tgz",
      "integrity": "sha512-yQbXgO/OSZVD2IsiLlro+7Hf6Q18EJrKSEsdoMzKePKXct3gvD8oLcOQdIzGupr5Fj+EDe8gO/lxc1BzfMpxvA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "fill-range": "^7.1.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/browserslist": {
      "version": "4.25.4",
      "resolved": "https://registry.npmjs.org/browserslist/-/browserslist-4.25.4.tgz",
      "integrity": "sha512-4jYpcjabC606xJ3kw2QwGEZKX0Aw7sgQdZCvIK9dhVSPh76BKo+C+btT1RRofH7B+8iNpEbgGNVWiLki5q93yg==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "caniuse-lite": "^1.0.30001737",
        "electron-to-chromium": "^1.5.211",
        "node-releases": "^2.0.19",
        "update-browserslist-db": "^1.1.3"
      },
      "bin": {
        "browserslist": "cli.js"
      },
      "engines": {
        "node": "^6 || ^7 || ^8 || ^9 || ^10 || ^11 || ^12 || >=13.7"
      }
    },
    "node_modules/call-bind-apply-helpers": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/call-bind-apply-helpers/-/call-bind-apply-helpers-1.0.2.tgz",
      "integrity": "sha512-Sp1ablJ0ivDkSzjcaJdxEunN5/XvksFJ2sMBFfq6x0ryhQV/2b/KwFe21cMpmHtPOSij8K99/wSfoEuTObmuMQ==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/camelcase-css": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/camelcase-css/-/camelcase-css-2.0.1.tgz",
      "integrity": "sha512-QOSvevhslijgYwRx6Rv7zKdMF8lbRmx+uQGx2+vDc+KI/eBnsy9kit5aj23AgGu3pa4t9AgwbnXWqS+iOY+2aA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/caniuse-lite": {
      "version": "1.0.30001739",
      "resolved": "https://registry.npmjs.org/caniuse-lite/-/caniuse-lite-1.0.30001739.tgz",
      "integrity": "sha512-y+j60d6ulelrNSwpPyrHdl+9mJnQzHBr08xm48Qno0nSk4h3Qojh+ziv2qE6rXf4k3tadF4o1J/1tAbVm1NtnA==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/caniuse-lite"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "CC-BY-4.0"
    },
    "node_modules/chart.js": {
      "version": "4.5.0",
      "resolved": "https://registry.npmjs.org/chart.js/-/chart.js-4.5.0.tgz",
      "integrity": "sha512-aYeC/jDgSEx8SHWZvANYMioYMZ2KX02W6f6uVfyteuCGcadDLcYVHdfdygsTQkQ4TKn5lghoojAsPj5pu0SnvQ==",
      "license": "MIT",
      "dependencies": {
        "@kurkle/color": "^0.3.0"
      },
      "engines": {
        "pnpm": ">=8"
      }
    },
    "node_modules/chokidar": {
      "version": "3.6.0",
      "resolved": "https://registry.npmjs.org/chokidar/-/chokidar-3.6.0.tgz",
      "integrity": "sha512-7VT13fmjotKpGipCW9JEQAusEPE+Ei8nl6/g4FBAmIm0GOOLMua9NDDo/DWp0ZAxCr3cPq5ZpBqmPAQgDda2Pw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "anymatch": "~3.1.2",
        "braces": "~3.0.2",
        "glob-parent": "~5.1.2",
        "is-binary-path": "~2.1.0",
        "is-glob": "~4.0.1",
        "normalize-path": "~3.0.0",
        "readdirp": "~3.6.0"
      },
      "engines": {
        "node": ">= 8.10.0"
      },
      "funding": {
        "url": "https://paulmillr.com/funding/"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/chokidar/node_modules/glob-parent": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
      "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "is-glob": "^4.0.1"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/color-convert": {
      "version": "2.0.1",
      "resolved": "https://registry.npmjs.org/color-convert/-/color-convert-2.0.1.tgz",
      "integrity": "sha512-RRECPsj7iu/xb5oKYcsFHSppFNnsj/52OVTRKb4zP5onXwVF3zVmmToNcOfGC+CRDpfK/U584fMg38ZHCaElKQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "color-name": "~1.1.4"
      },
      "engines": {
        "node": ">=7.0.0"
      }
    },
    "node_modules/color-name": {
      "version": "1.1.4",
      "resolved": "https://registry.npmjs.org/color-name/-/color-name-1.1.4.tgz",
      "integrity": "sha512-dOy+3AuW3a2wNbZHIuMZpTcgjGuLU/uBL/ubcZF9OXbDo8ff4O8yVp5Bf0efS8uEoYo5q4Fx7dY9OgQGXgAsQA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/combined-stream": {
      "version": "1.0.8",
      "resolved": "https://registry.npmjs.org/combined-stream/-/combined-stream-1.0.8.tgz",
      "integrity": "sha512-FQN4MRfuJeHf7cBbBMJFXhKSDq+2kAArBlmRBvcvFE5BB1HZKXtSFASDhdlz9zOYwxh8lDdnvmMOe/+5cdoEdg==",
      "license": "MIT",
      "dependencies": {
        "delayed-stream": "~1.0.0"
      },
      "engines": {
        "node": ">= 0.8"
      }
    },
    "node_modules/commander": {
      "version": "4.1.1",
      "resolved": "https://registry.npmjs.org/commander/-/commander-4.1.1.tgz",
      "integrity": "sha512-NOKm8xhkzAjzFx8B2v5OAHT+u5pRQc2UCa2Vq9jYL/31o2wi9mxBA7LIFs3sV5VSC49z6pEhfbMULvShKj26WA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/copy-anything": {
      "version": "3.0.5",
      "resolved": "https://registry.npmjs.org/copy-anything/-/copy-anything-3.0.5.tgz",
      "integrity": "sha512-yCEafptTtb4bk7GLEQoM8KVJpxAfdBJYaXyzQEgQQQgYrZiDp8SJmGKlYza6CYjEDNstAdNdKA3UuoULlEbS6w==",
      "license": "MIT",
      "dependencies": {
        "is-what": "^4.1.8"
      },
      "engines": {
        "node": ">=12.13"
      },
      "funding": {
        "url": "https://github.com/sponsors/mesqueeb"
      }
    },
    "node_modules/cross-spawn": {
      "version": "7.0.6",
      "resolved": "https://registry.npmjs.org/cross-spawn/-/cross-spawn-7.0.6.tgz",
      "integrity": "sha512-uV2QOWP2nWzsy2aMp8aRibhi9dlzF5Hgh5SHaB9OiTGEyDTiJJyx0uy51QXdyWbtAHNua4XJzUKca3OzKUd3vA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "path-key": "^3.1.0",
        "shebang-command": "^2.0.0",
        "which": "^2.0.1"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/cssesc": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/cssesc/-/cssesc-3.0.0.tgz",
      "integrity": "sha512-/Tb/JcjK111nNScGob5MNtsntNM1aCNUDipB/TkwZFhyDrrE47SOx/18wF2bbjgc3ZzCSKW1T5nt5EbFoAz/Vg==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "cssesc": "bin/cssesc"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/csstype": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/csstype/-/csstype-3.1.3.tgz",
      "integrity": "sha512-M1uQkMl8rQK/szD0LNhtqxIPLpimGm8sOBwU7lLnCpSbTyY3yeU1Vc7l4KT5zT4s/yOxHH5O7tIuuLOCnLADRw==",
      "license": "MIT"
    },
    "node_modules/delayed-stream": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/delayed-stream/-/delayed-stream-1.0.0.tgz",
      "integrity": "sha512-ZySD7Nf91aLB0RxL4KGrKHBXl7Eds1DAmEdcoVawXnLD7SDhpNgtuII2aAkg7a7QS41jxPSZ17p4VdGnMHk3MQ==",
      "license": "MIT",
      "engines": {
        "node": ">=0.4.0"
      }
    },
    "node_modules/didyoumean": {
      "version": "1.2.2",
      "resolved": "https://registry.npmjs.org/didyoumean/-/didyoumean-1.2.2.tgz",
      "integrity": "sha512-gxtyfqMg7GKyhQmb056K7M3xszy/myH8w+B4RT+QXBQsvAOdc3XymqDDPHx1BgPgsdAA5SIifona89YtRATDzw==",
      "dev": true,
      "license": "Apache-2.0"
    },
    "node_modules/dlv": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/dlv/-/dlv-1.1.3.tgz",
      "integrity": "sha512-+HlytyjlPKnIG8XuRG8WvmBP8xs8P71y+SKKS6ZXWoEgLuePxtDoUEiH7WkdePWrQ5JBpE6aoVqfZfJUQkjXwA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/dunder-proto": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/dunder-proto/-/dunder-proto-1.0.1.tgz",
      "integrity": "sha512-KIN/nDJBQRcXw0MLVhZE9iQHmG68qAVIBg9CqmUYjmQIhgij9U5MFvrqkUL5FbtyyzZuOeOt0zdeRe4UY7ct+A==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.1",
        "es-errors": "^1.3.0",
        "gopd": "^1.2.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/eastasianwidth": {
      "version": "0.2.0",
      "resolved": "https://registry.npmjs.org/eastasianwidth/-/eastasianwidth-0.2.0.tgz",
      "integrity": "sha512-I88TYZWc9XiYHRQ4/3c5rjjfgkjhLyW2luGIheGERbNQ6OY7yTybanSpDXZa8y7VUP9YmDcYa+eyq4ca7iLqWA==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/electron-to-chromium": {
      "version": "1.5.211",
      "resolved": "https://registry.npmjs.org/electron-to-chromium/-/electron-to-chromium-1.5.211.tgz",
      "integrity": "sha512-IGBvimJkotaLzFnwIVgW9/UD/AOJ2tByUmeOrtqBfACSbAw5b1G0XpvdaieKyc7ULmbwXVx+4e4Be8pOPBrYkw==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/emoji-regex": {
      "version": "9.2.2",
      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-9.2.2.tgz",
      "integrity": "sha512-L18DaJsXSUk2+42pv8mLs5jJT2hqFkFE4j21wOmgbUqsZ2hL72NsUU785g9RXgo3s0ZNgVl42TiHp3ZtOv/Vyg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/entities": {
      "version": "4.5.0",
      "resolved": "https://registry.npmjs.org/entities/-/entities-4.5.0.tgz",
      "integrity": "sha512-V0hjH4dGPh9Ao5p0MoRY6BVqtwCjhz6vI5LT8AJ55H+4g9/4vbHx1I54fS0XuclLhDHArPQCiMjDxjaL8fPxhw==",
      "license": "BSD-2-Clause",
      "engines": {
        "node": ">=0.12"
      },
      "funding": {
        "url": "https://github.com/fb55/entities?sponsor=1"
      }
    },
    "node_modules/es-define-property": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/es-define-property/-/es-define-property-1.0.1.tgz",
      "integrity": "sha512-e3nRfgfUZ4rNGL232gUgX06QNyyez04KdjFrF+LTRoOXmrOgFKDg4BCdsjW8EnT69eqdYGmRpJwiPVYNrCaW3g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-errors": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/es-errors/-/es-errors-1.3.0.tgz",
      "integrity": "sha512-Zf5H2Kxt2xjTvbJvP2ZWLEICxA6j+hAmMzIlypy4xcBg1vKVnx89Wy0GbS+kf5cwCVFFzdCFh2XSCFNULS6csw==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-object-atoms": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/es-object-atoms/-/es-object-atoms-1.1.1.tgz",
      "integrity": "sha512-FGgH2h8zKNim9ljj7dankFPcICIK9Cp5bm+c2gQSYePhpaG5+esrLODihIorn+Pe6FGJzWhXQotPv73jTaldXA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/es-set-tostringtag": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/es-set-tostringtag/-/es-set-tostringtag-2.1.0.tgz",
      "integrity": "sha512-j6vWzfrGVfyXxge+O0x5sh6cvxAog0a/4Rdd2K36zCMV5eJ+/+tOAngRO8cODMNWbVRdVlmGZQL2YS3yR8bIUA==",
      "license": "MIT",
      "dependencies": {
        "es-errors": "^1.3.0",
        "get-intrinsic": "^1.2.6",
        "has-tostringtag": "^1.0.2",
        "hasown": "^2.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/esbuild": {
      "version": "0.25.9",
      "resolved": "https://registry.npmjs.org/esbuild/-/esbuild-0.25.9.tgz",
      "integrity": "sha512-CRbODhYyQx3qp7ZEwzxOk4JBqmD/seJrzPa/cGjY1VtIn5E09Oi9/dB4JwctnfZ8Q8iT7rioVv5k/FNT/uf54g==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "bin": {
        "esbuild": "bin/esbuild"
      },
      "engines": {
        "node": ">=18"
      },
      "optionalDependencies": {
        "@esbuild/aix-ppc64": "0.25.9",
        "@esbuild/android-arm": "0.25.9",
        "@esbuild/android-arm64": "0.25.9",
        "@esbuild/android-x64": "0.25.9",
        "@esbuild/darwin-arm64": "0.25.9",
        "@esbuild/darwin-x64": "0.25.9",
        "@esbuild/freebsd-arm64": "0.25.9",
        "@esbuild/freebsd-x64": "0.25.9",
        "@esbuild/linux-arm": "0.25.9",
        "@esbuild/linux-arm64": "0.25.9",
        "@esbuild/linux-ia32": "0.25.9",
        "@esbuild/linux-loong64": "0.25.9",
        "@esbuild/linux-mips64el": "0.25.9",
        "@esbuild/linux-ppc64": "0.25.9",
        "@esbuild/linux-riscv64": "0.25.9",
        "@esbuild/linux-s390x": "0.25.9",
        "@esbuild/linux-x64": "0.25.9",
        "@esbuild/netbsd-arm64": "0.25.9",
        "@esbuild/netbsd-x64": "0.25.9",
        "@esbuild/openbsd-arm64": "0.25.9",
        "@esbuild/openbsd-x64": "0.25.9",
        "@esbuild/openharmony-arm64": "0.25.9",
        "@esbuild/sunos-x64": "0.25.9",
        "@esbuild/win32-arm64": "0.25.9",
        "@esbuild/win32-ia32": "0.25.9",
        "@esbuild/win32-x64": "0.25.9"
      }
    },
    "node_modules/escalade": {
      "version": "3.2.0",
      "resolved": "https://registry.npmjs.org/escalade/-/escalade-3.2.0.tgz",
      "integrity": "sha512-WUj2qlxaQtO4g6Pq5c29GTcWGDyd8itL8zTlipgECz3JesAiiOKotd8JU6otB3PACgG6xkJUyVhboMS+bje/jA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=6"
      }
    },
    "node_modules/estree-walker": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/estree-walker/-/estree-walker-2.0.2.tgz",
      "integrity": "sha512-Rfkk/Mp/DL7JVje3u18FxFujQlTNR2q6QfMSMB7AvCBx91NGj/ba3kCfza0f6dVDbw7YlRf/nDrn7pQrCCyQ/w==",
      "license": "MIT"
    },
    "node_modules/fast-glob": {
      "version": "3.3.3",
      "resolved": "https://registry.npmjs.org/fast-glob/-/fast-glob-3.3.3.tgz",
      "integrity": "sha512-7MptL8U0cqcFdzIzwOTHoilX9x5BrNqye7Z/LuC7kCMRio1EMSyqRK3BEAUD7sXRq4iT4AzTVuZdhgQ2TCvYLg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@nodelib/fs.stat": "^2.0.2",
        "@nodelib/fs.walk": "^1.2.3",
        "glob-parent": "^5.1.2",
        "merge2": "^1.3.0",
        "micromatch": "^4.0.8"
      },
      "engines": {
        "node": ">=8.6.0"
      }
    },
    "node_modules/fast-glob/node_modules/glob-parent": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-5.1.2.tgz",
      "integrity": "sha512-AOIgSQCepiJYwP3ARnGx+5VnTu2HBYdzbGP45eLw1vr3zB3vZLeyed1sC9hnbcOc9/SrMyM5RPQrkGz4aS9Zow==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "is-glob": "^4.0.1"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/fastq": {
      "version": "1.19.1",
      "resolved": "https://registry.npmjs.org/fastq/-/fastq-1.19.1.tgz",
      "integrity": "sha512-GwLTyxkCXjXbxqIhTsMI2Nui8huMPtnxg7krajPJAjnEG/iiOS7i+zCtWGZR9G0NBKbXKh6X9m9UIsYX/N6vvQ==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "reusify": "^1.0.4"
      }
    },
    "node_modules/fill-range": {
      "version": "7.1.1",
      "resolved": "https://registry.npmjs.org/fill-range/-/fill-range-7.1.1.tgz",
      "integrity": "sha512-YsGpe3WHLK8ZYi4tWDg2Jy3ebRz2rXowDxnld4bkQB00cc/1Zw9AWnC0i9ztDJitivtQvaI9KaLyKrc+hBW0yg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "to-regex-range": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/follow-redirects": {
      "version": "1.15.11",
      "resolved": "https://registry.npmjs.org/follow-redirects/-/follow-redirects-1.15.11.tgz",
      "integrity": "sha512-deG2P0JfjrTxl50XGCDyfI97ZGVCxIpfKYmfyrQ54n5FO/0gfIES8C/Psl6kWVDolizcaaxZJnTS0QSMxvnsBQ==",
      "funding": [
        {
          "type": "individual",
          "url": "https://github.com/sponsors/RubenVerborgh"
        }
      ],
      "license": "MIT",
      "engines": {
        "node": ">=4.0"
      },
      "peerDependenciesMeta": {
        "debug": {
          "optional": true
        }
      }
    },
    "node_modules/foreground-child": {
      "version": "3.3.1",
      "resolved": "https://registry.npmjs.org/foreground-child/-/foreground-child-3.3.1.tgz",
      "integrity": "sha512-gIXjKqtFuWEgzFRJA9WCQeSJLZDjgJUOMCMzxtvFq/37KojM1BFGufqsCy0r4qSQmYLsZYMeyRqzIWOMup03sw==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "cross-spawn": "^7.0.6",
        "signal-exit": "^4.0.1"
      },
      "engines": {
        "node": ">=14"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/form-data": {
      "version": "4.0.4",
      "resolved": "https://registry.npmjs.org/form-data/-/form-data-4.0.4.tgz",
      "integrity": "sha512-KrGhL9Q4zjj0kiUt5OO4Mr/A/jlI2jDYs5eHBpYHPcBEVSiipAvn2Ko2HnPe20rmcuuvMHNdZFp+4IlGTMF0Ow==",
      "license": "MIT",
      "dependencies": {
        "asynckit": "^0.4.0",
        "combined-stream": "^1.0.8",
        "es-set-tostringtag": "^2.1.0",
        "hasown": "^2.0.2",
        "mime-types": "^2.1.12"
      },
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/fraction.js": {
      "version": "4.3.7",
      "resolved": "https://registry.npmjs.org/fraction.js/-/fraction.js-4.3.7.tgz",
      "integrity": "sha512-ZsDfxO51wGAXREY55a7la9LScWpwv9RxIrYABrlvOFBlH/ShPnrtsXeuUIfXKKOVicNxQ+o8JTbJvjS4M89yew==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": "*"
      },
      "funding": {
        "type": "patreon",
        "url": "https://github.com/sponsors/rawify"
      }
    },
    "node_modules/fsevents": {
      "version": "2.3.3",
      "resolved": "https://registry.npmjs.org/fsevents/-/fsevents-2.3.3.tgz",
      "integrity": "sha512-5xoDfX+fL7faATnagmWPpbFtwh/R77WmMMqqHGS65C3vvB0YHrgF+B1YmZ3441tMj5n63k0212XNoJwzlhffQw==",
      "dev": true,
      "hasInstallScript": true,
      "license": "MIT",
      "optional": true,
      "os": [
        "darwin"
      ],
      "engines": {
        "node": "^8.16.0 || ^10.6.0 || >=11.0.0"
      }
    },
    "node_modules/function-bind": {
      "version": "1.1.2",
      "resolved": "https://registry.npmjs.org/function-bind/-/function-bind-1.1.2.tgz",
      "integrity": "sha512-7XHNxH7qX9xG5mIwxkhumTox/MIRNcOgDrxWsMt2pAr23WHp6MrRlN7FBSFpCpr+oVO0F744iUgR82nJMfG2SA==",
      "license": "MIT",
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-intrinsic": {
      "version": "1.3.0",
      "resolved": "https://registry.npmjs.org/get-intrinsic/-/get-intrinsic-1.3.0.tgz",
      "integrity": "sha512-9fSjSaos/fRIVIp+xSJlE6lfwhES7LNtKaCBIamHsjr2na1BiABJPo0mOjjz8GJDURarmCPGqaiVg5mfjb98CQ==",
      "license": "MIT",
      "dependencies": {
        "call-bind-apply-helpers": "^1.0.2",
        "es-define-property": "^1.0.1",
        "es-errors": "^1.3.0",
        "es-object-atoms": "^1.1.1",
        "function-bind": "^1.1.2",
        "get-proto": "^1.0.1",
        "gopd": "^1.2.0",
        "has-symbols": "^1.1.0",
        "hasown": "^2.0.2",
        "math-intrinsics": "^1.1.0"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/get-proto": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/get-proto/-/get-proto-1.0.1.tgz",
      "integrity": "sha512-sTSfBjoXBp89JvIKIefqw7U2CCebsc74kiY6awiGogKtoSGbgjYE/G/+l9sF3MWFPNc9IcoOC4ODfKHfxFmp0g==",
      "license": "MIT",
      "dependencies": {
        "dunder-proto": "^1.0.1",
        "es-object-atoms": "^1.0.0"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/glob": {
      "version": "10.4.5",
      "resolved": "https://registry.npmjs.org/glob/-/glob-10.4.5.tgz",
      "integrity": "sha512-7Bv8RF0k6xjo7d4A/PxYLbUCfb6c+Vpd2/mB2yRDlew7Jb5hEXiCD9ibfO7wpk8i4sevK6DFny9h7EYbM3/sHg==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "foreground-child": "^3.1.0",
        "jackspeak": "^3.1.2",
        "minimatch": "^9.0.4",
        "minipass": "^7.1.2",
        "package-json-from-dist": "^1.0.0",
        "path-scurry": "^1.11.1"
      },
      "bin": {
        "glob": "dist/esm/bin.mjs"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/glob-parent": {
      "version": "6.0.2",
      "resolved": "https://registry.npmjs.org/glob-parent/-/glob-parent-6.0.2.tgz",
      "integrity": "sha512-XxwI8EOhVQgWp6iDL+3b0r86f4d6AX6zSU55HfB4ydCEuXLXc5FcYeOu+nnGftS4TEju/11rt4KJPTMgbfmv4A==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "is-glob": "^4.0.3"
      },
      "engines": {
        "node": ">=10.13.0"
      }
    },
    "node_modules/gopd": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/gopd/-/gopd-1.2.0.tgz",
      "integrity": "sha512-ZUKRh6/kUFoAiTAtTYPZJ3hw9wNxx+BIBOijnlG9PnrJsCcSjs1wyyD6vJpaYtgnzDrKYRSqf3OO6Rfa93xsRg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-symbols": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/has-symbols/-/has-symbols-1.1.0.tgz",
      "integrity": "sha512-1cDNdwJ2Jaohmb3sg4OmKaMBwuC48sYni5HUw2DvsC8LjGTLK9h+eb1X6RyuOHe4hT0ULCW68iomhjUoKUqlPQ==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/has-tostringtag": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/has-tostringtag/-/has-tostringtag-1.0.2.tgz",
      "integrity": "sha512-NqADB8VjPFLM2V0VvHUewwwsw0ZWBaIdgo+ieHtK3hasLz4qeCRjYcqfB6AQrBggRKppKF8L52/VqdVsO47Dlw==",
      "license": "MIT",
      "dependencies": {
        "has-symbols": "^1.0.3"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/hasown": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/hasown/-/hasown-2.0.2.tgz",
      "integrity": "sha512-0hJU9SCPvmMzIBdZFqNPXWa6dqh7WdH0cII9y+CyS8rG3nL48Bclra9HmKhVVUHyPWNH5Y7xDwAB7bfgSjkUMQ==",
      "license": "MIT",
      "dependencies": {
        "function-bind": "^1.1.2"
      },
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/hookable": {
      "version": "5.5.3",
      "resolved": "https://registry.npmjs.org/hookable/-/hookable-5.5.3.tgz",
      "integrity": "sha512-Yc+BQe8SvoXH1643Qez1zqLRmbA5rCL+sSmk6TVos0LWVfNIB7PGncdlId77WzLGSIB5KaWgTaNTs2lNVEI6VQ==",
      "license": "MIT"
    },
    "node_modules/is-binary-path": {
      "version": "2.1.0",
      "resolved": "https://registry.npmjs.org/is-binary-path/-/is-binary-path-2.1.0.tgz",
      "integrity": "sha512-ZMERYes6pDydyuGidse7OsHxtbI7WVeUEozgR/g7rd0xUimYNlvZRE/K2MgZTjWy725IfelLeVcEM97mmtRGXw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "binary-extensions": "^2.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/is-core-module": {
      "version": "2.16.1",
      "resolved": "https://registry.npmjs.org/is-core-module/-/is-core-module-2.16.1.tgz",
      "integrity": "sha512-UfoeMA6fIJ8wTYFEUjelnaGI67v6+N7qXJEvQuIGa99l4xsCruSYOVSQ0uPANn4dAzm8lkYPaKLrrijLq7x23w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "hasown": "^2.0.2"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/is-extglob": {
      "version": "2.1.1",
      "resolved": "https://registry.npmjs.org/is-extglob/-/is-extglob-2.1.1.tgz",
      "integrity": "sha512-SbKbANkN603Vi4jEZv49LeVJMn4yGwsbzZworEoyEiutsN3nJYdbO36zfhGJ6QEDpOZIFkDtnq5JRxmvl3jsoQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-fullwidth-code-point": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/is-fullwidth-code-point/-/is-fullwidth-code-point-3.0.0.tgz",
      "integrity": "sha512-zymm5+u+sCsSWyD9qNaejV3DFvhCKclKdizYaJUuHA83RLjb7nSuGnddCHGv0hk+KY7BMAlsWeK4Ueg6EV6XQg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/is-glob": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/is-glob/-/is-glob-4.0.3.tgz",
      "integrity": "sha512-xelSayHH36ZgE7ZWhli7pW34hNbNl8Ojv5KVmkJD4hBdD3th8Tfk9vYasLM+mXWOZhFkgZfxhLSnrwRr4elSSg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "is-extglob": "^2.1.1"
      },
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/is-number": {
      "version": "7.0.0",
      "resolved": "https://registry.npmjs.org/is-number/-/is-number-7.0.0.tgz",
      "integrity": "sha512-41Cifkg6e8TylSpdtTpeLVMqvSBEVzTttHvERD741+pnZ8ANv0004MRL43QKPDlK9cGvNp6NZWZUBlbGXYxxng==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.12.0"
      }
    },
    "node_modules/is-what": {
      "version": "4.1.16",
      "resolved": "https://registry.npmjs.org/is-what/-/is-what-4.1.16.tgz",
      "integrity": "sha512-ZhMwEosbFJkA0YhFnNDgTM4ZxDRsS6HqTo7qsZM08fehyRYIYa0yHu5R6mgo1n/8MgaPBXiPimPD77baVFYg+A==",
      "license": "MIT",
      "engines": {
        "node": ">=12.13"
      },
      "funding": {
        "url": "https://github.com/sponsors/mesqueeb"
      }
    },
    "node_modules/isexe": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/isexe/-/isexe-2.0.0.tgz",
      "integrity": "sha512-RHxMLp9lnKHGHRng9QFhRCMbYAcVpn69smSGcq3f36xjgVVWThj4qqLbTLlq7Ssj8B+fIQ1EuCEGI2lKsyQeIw==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/jackspeak": {
      "version": "3.4.3",
      "resolved": "https://registry.npmjs.org/jackspeak/-/jackspeak-3.4.3.tgz",
      "integrity": "sha512-OGlZQpz2yfahA/Rd1Y8Cd9SIEsqvXkLVoSw/cgwhnhFMDbsQFeZYoJJ7bIZBS9BcamUW96asq/npPWugM+RQBw==",
      "dev": true,
      "license": "BlueOak-1.0.0",
      "dependencies": {
        "@isaacs/cliui": "^8.0.2"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      },
      "optionalDependencies": {
        "@pkgjs/parseargs": "^0.11.0"
      }
    },
    "node_modules/jiti": {
      "version": "1.21.7",
      "resolved": "https://registry.npmjs.org/jiti/-/jiti-1.21.7.tgz",
      "integrity": "sha512-/imKNG4EbWNrVjoNC/1H5/9GFy+tqjGBHCaSsN+P2RnPqjsLmv6UD3Ej+Kj8nBWaRAwyk7kK5ZUc+OEatnTR3A==",
      "dev": true,
      "license": "MIT",
      "bin": {
        "jiti": "bin/jiti.js"
      }
    },
    "node_modules/lilconfig": {
      "version": "3.1.3",
      "resolved": "https://registry.npmjs.org/lilconfig/-/lilconfig-3.1.3.tgz",
      "integrity": "sha512-/vlFKAoH5Cgt3Ie+JLhRbwOsCQePABiU3tJ1egGvyQ+33R/vcwM2Zl2QR/LzjsBeItPt3oSVXapn+m4nQDvpzw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=14"
      },
      "funding": {
        "url": "https://github.com/sponsors/antonk52"
      }
    },
    "node_modules/lines-and-columns": {
      "version": "1.2.4",
      "resolved": "https://registry.npmjs.org/lines-and-columns/-/lines-and-columns-1.2.4.tgz",
      "integrity": "sha512-7ylylesZQ/PV29jhEDl3Ufjo6ZX7gCqJr5F7PKrqc93v7fzSymt1BpwEU8nAUXs8qzzvqhbjhK5QZg6Mt/HkBg==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/lru-cache": {
      "version": "10.4.3",
      "resolved": "https://registry.npmjs.org/lru-cache/-/lru-cache-10.4.3.tgz",
      "integrity": "sha512-JNAzZcXrCt42VGLuYz0zfAzDfAvJWW6AfYlDBQyDV5DClI2m5sAmK+OIO7s59XfsRsWHp02jAJrRadPRGTt6SQ==",
      "dev": true,
      "license": "ISC"
    },
    "node_modules/lucide-vue-next": {
      "version": "0.540.0",
      "resolved": "https://registry.npmjs.org/lucide-vue-next/-/lucide-vue-next-0.540.0.tgz",
      "integrity": "sha512-H7qhKVNKLyoFMo05pWcGSWBiLPiI3zJmWV65SuXWHlrIGIcvDer10xAyWcRJ0KLzIH5k5+yi7AGw/Xi1VF8Pbw==",
      "license": "ISC",
      "peerDependencies": {
        "vue": ">=3.0.1"
      }
    },
    "node_modules/magic-string": {
      "version": "0.30.18",
      "resolved": "https://registry.npmjs.org/magic-string/-/magic-string-0.30.18.tgz",
      "integrity": "sha512-yi8swmWbO17qHhwIBNeeZxTceJMeBvWJaId6dyvTSOwTipqeHhMhOrz6513r1sOKnpvQ7zkhlG8tPrpilwTxHQ==",
      "license": "MIT",
      "dependencies": {
        "@jridgewell/sourcemap-codec": "^1.5.5"
      }
    },
    "node_modules/math-intrinsics": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/math-intrinsics/-/math-intrinsics-1.1.0.tgz",
      "integrity": "sha512-/IXtbwEk5HTPyEwyKX6hGkYXxM9nbj64B+ilVJnC/R6B0pH5G4V3b0pVbL7DBj4tkhBAppbQUlf6F6Xl9LHu1g==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      }
    },
    "node_modules/merge2": {
      "version": "1.4.1",
      "resolved": "https://registry.npmjs.org/merge2/-/merge2-1.4.1.tgz",
      "integrity": "sha512-8q7VEgMJW4J8tcfVPy8g09NcQwZdbwFEqhe/WZkoIzjn/3TGDwtOCYtXGxA3O8tPzpczCCDgv+P2P5y00ZJOOg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/micromatch": {
      "version": "4.0.8",
      "resolved": "https://registry.npmjs.org/micromatch/-/micromatch-4.0.8.tgz",
      "integrity": "sha512-PXwfBhYu0hBCPw8Dn0E+WDYb7af3dSLVWKi3HGv84IdF4TyFoC0ysxFd0Goxw7nSv4T/PzEJQxsYsEiFCKo2BA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "braces": "^3.0.3",
        "picomatch": "^2.3.1"
      },
      "engines": {
        "node": ">=8.6"
      }
    },
    "node_modules/mime-db": {
      "version": "1.52.0",
      "resolved": "https://registry.npmjs.org/mime-db/-/mime-db-1.52.0.tgz",
      "integrity": "sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==",
      "license": "MIT",
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/mime-types": {
      "version": "2.1.35",
      "resolved": "https://registry.npmjs.org/mime-types/-/mime-types-2.1.35.tgz",
      "integrity": "sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==",
      "license": "MIT",
      "dependencies": {
        "mime-db": "1.52.0"
      },
      "engines": {
        "node": ">= 0.6"
      }
    },
    "node_modules/minimatch": {
      "version": "9.0.5",
      "resolved": "https://registry.npmjs.org/minimatch/-/minimatch-9.0.5.tgz",
      "integrity": "sha512-G6T0ZX48xgozx7587koeX9Ys2NYy6Gmv//P89sEte9V9whIapMNF4idKxnW2QtCcLiTWlb/wfCabAtAFWhhBow==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "brace-expansion": "^2.0.1"
      },
      "engines": {
        "node": ">=16 || 14 >=14.17"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/minipass": {
      "version": "7.1.2",
      "resolved": "https://registry.npmjs.org/minipass/-/minipass-7.1.2.tgz",
      "integrity": "sha512-qOOzS1cBTWYF4BH8fVePDBOO9iptMnGUEZwNc/cMWnTV2nVLZ7VoNWEPHkYczZA0pdoA7dl6e7FL659nX9S2aw==",
      "dev": true,
      "license": "ISC",
      "engines": {
        "node": ">=16 || 14 >=14.17"
      }
    },
    "node_modules/mitt": {
      "version": "3.0.1",
      "resolved": "https://registry.npmjs.org/mitt/-/mitt-3.0.1.tgz",
      "integrity": "sha512-vKivATfr97l2/QBCYAkXYDbrIWPM2IIKEl7YPhjCvKlG3kE2gm+uBo6nEXK3M5/Ffh/FLpKExzOQ3JJoJGFKBw==",
      "license": "MIT"
    },
    "node_modules/mz": {
      "version": "2.7.0",
      "resolved": "https://registry.npmjs.org/mz/-/mz-2.7.0.tgz",
      "integrity": "sha512-z81GNO7nnYMEhrGh9LeymoE4+Yr0Wn5McHIZMK5cfQCl+NDX08sCZgUc9/6MHni9IWuFLm1Z3HTCXu2z9fN62Q==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "any-promise": "^1.0.0",
        "object-assign": "^4.0.1",
        "thenify-all": "^1.0.0"
      }
    },
    "node_modules/nanoid": {
      "version": "3.3.11",
      "resolved": "https://registry.npmjs.org/nanoid/-/nanoid-3.3.11.tgz",
      "integrity": "sha512-N8SpfPUnUp1bK+PMYW8qSWdl9U+wwNWI4QKxOYDy9JAro3WMX7p2OeVRF9v+347pnakNevPmiHhNmZ2HbFA76w==",
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "bin": {
        "nanoid": "bin/nanoid.cjs"
      },
      "engines": {
        "node": "^10 || ^12 || ^13.7 || ^14 || >=15.0.1"
      }
    },
    "node_modules/node-releases": {
      "version": "2.0.19",
      "resolved": "https://registry.npmjs.org/node-releases/-/node-releases-2.0.19.tgz",
      "integrity": "sha512-xxOWJsBKtzAq7DY0J+DTzuz58K8e7sJbdgwkbMWQe8UYB6ekmsQ45q0M/tJDsGaZmbC+l7n57UV8Hl5tHxO9uw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/normalize-path": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/normalize-path/-/normalize-path-3.0.0.tgz",
      "integrity": "sha512-6eZs5Ls3WtCisHWp9S2GUy8dqkpGi4BVSz3GaqiE6ezub0512ESztXUwUB6C6IKbQkY2Pnb/mD4WYojCRwcwLA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/normalize-range": {
      "version": "0.1.2",
      "resolved": "https://registry.npmjs.org/normalize-range/-/normalize-range-0.1.2.tgz",
      "integrity": "sha512-bdok/XvKII3nUpklnV6P2hxtMNrCboOjAcyBuQnWEhO665FwrSNRxU+AqpsyvO6LgGYPspN+lu5CLtw4jPRKNA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/object-assign": {
      "version": "4.1.1",
      "resolved": "https://registry.npmjs.org/object-assign/-/object-assign-4.1.1.tgz",
      "integrity": "sha512-rJgTQnkUnH1sFw8yT6VSU3zD3sWmu6sZhIseY8VX+GRu3P6F7Fu+JNDoXfklElbLJSnc3FUQHVe4cU5hj+BcUg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/object-hash": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/object-hash/-/object-hash-3.0.0.tgz",
      "integrity": "sha512-RSn9F68PjH9HqtltsSnqYC1XXoWe9Bju5+213R98cNGttag9q9yAOTzdbsqvIa7aNm5WffBZFpWYr2aWrklWAw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/package-json-from-dist": {
      "version": "1.0.1",
      "resolved": "https://registry.npmjs.org/package-json-from-dist/-/package-json-from-dist-1.0.1.tgz",
      "integrity": "sha512-UEZIS3/by4OC8vL3P2dTXRETpebLI2NiI5vIrjaD/5UtrkFX/tNbwjTSRAGC/+7CAo2pIcBaRgWmcBBHcsaCIw==",
      "dev": true,
      "license": "BlueOak-1.0.0"
    },
    "node_modules/path-key": {
      "version": "3.1.1",
      "resolved": "https://registry.npmjs.org/path-key/-/path-key-3.1.1.tgz",
      "integrity": "sha512-ojmeN0qd+y0jszEtoY48r0Peq5dwMEkIlCOu6Q5f41lfkswXuKtYrhgoTpLnyIcHm24Uhqx+5Tqm2InSwLhE6Q==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/path-parse": {
      "version": "1.0.7",
      "resolved": "https://registry.npmjs.org/path-parse/-/path-parse-1.0.7.tgz",
      "integrity": "sha512-LDJzPVEEEPR+y48z93A0Ed0yXb8pAByGWo/k5YYdYgpY2/2EsOsksJrq7lOHxryrVOn1ejG6oAp8ahvOIQD8sw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/path-scurry": {
      "version": "1.11.1",
      "resolved": "https://registry.npmjs.org/path-scurry/-/path-scurry-1.11.1.tgz",
      "integrity": "sha512-Xa4Nw17FS9ApQFJ9umLiJS4orGjm7ZzwUrwamcGQuHSzDyth9boKDaycYdDcZDuqYATXw4HFXgaqWTctW/v1HA==",
      "dev": true,
      "license": "BlueOak-1.0.0",
      "dependencies": {
        "lru-cache": "^10.2.0",
        "minipass": "^5.0.0 || ^6.0.2 || ^7.0.0"
      },
      "engines": {
        "node": ">=16 || 14 >=14.18"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/perfect-debounce": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/perfect-debounce/-/perfect-debounce-1.0.0.tgz",
      "integrity": "sha512-xCy9V055GLEqoFaHoC1SoLIaLmWctgCUaBaWxDZ7/Zx4CTyX7cJQLJOok/orfjZAh9kEYpjJa4d0KcJmCbctZA==",
      "license": "MIT"
    },
    "node_modules/picocolors": {
      "version": "1.1.1",
      "resolved": "https://registry.npmjs.org/picocolors/-/picocolors-1.1.1.tgz",
      "integrity": "sha512-xceH2snhtb5M9liqDsmEw56le376mTZkEX/jEb/RxNFyegNul7eNslCXP9FDj/Lcu0X8KEyMceP2ntpaHrDEVA==",
      "license": "ISC"
    },
    "node_modules/picomatch": {
      "version": "2.3.1",
      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-2.3.1.tgz",
      "integrity": "sha512-JU3teHTNjmE2VCGFzuY8EXzCDVwEqB2a8fsIvwaStHhAWJEeVd1o1QD80CU6+ZdEXXSLbSsuLwJjkCBWqRQUVA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8.6"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/pify": {
      "version": "2.3.0",
      "resolved": "https://registry.npmjs.org/pify/-/pify-2.3.0.tgz",
      "integrity": "sha512-udgsAY+fTnvv7kI7aaxbqwWNb0AHiB0qBO89PZKPkoTmGOgdbrHDKD+0B2X4uTfJ/FT1R09r9gTsjUjNJotuog==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/pinia": {
      "version": "3.0.3",
      "resolved": "https://registry.npmjs.org/pinia/-/pinia-3.0.3.tgz",
      "integrity": "sha512-ttXO/InUULUXkMHpTdp9Fj4hLpD/2AoJdmAbAeW2yu1iy1k+pkFekQXw5VpC0/5p51IOR/jDaDRfRWRnMMsGOA==",
      "license": "MIT",
      "dependencies": {
        "@vue/devtools-api": "^7.7.2"
      },
      "funding": {
        "url": "https://github.com/sponsors/posva"
      },
      "peerDependencies": {
        "typescript": ">=4.4.4",
        "vue": "^2.7.0 || ^3.5.11"
      },
      "peerDependenciesMeta": {
        "typescript": {
          "optional": true
        }
      }
    },
    "node_modules/pirates": {
      "version": "4.0.7",
      "resolved": "https://registry.npmjs.org/pirates/-/pirates-4.0.7.tgz",
      "integrity": "sha512-TfySrs/5nm8fQJDcBDuUng3VOUKsd7S+zqvbOTiGXHfxX4wK31ard+hoNuvkicM/2YFzlpDgABOevKSsB4G/FA==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 6"
      }
    },
    "node_modules/postcss": {
      "version": "8.5.6",
      "resolved": "https://registry.npmjs.org/postcss/-/postcss-8.5.6.tgz",
      "integrity": "sha512-3Ybi1tAuwAP9s0r1UQ2J4n5Y0G05bJkpUIO0/bI9MhwmD70S5aTWbXGBwxHrelT+XM1k6dM0pk+SwNkpTRN7Pg==",
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/postcss"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "nanoid": "^3.3.11",
        "picocolors": "^1.1.1",
        "source-map-js": "^1.2.1"
      },
      "engines": {
        "node": "^10 || ^12 || >=14"
      }
    },
    "node_modules/postcss-import": {
      "version": "15.1.0",
      "resolved": "https://registry.npmjs.org/postcss-import/-/postcss-import-15.1.0.tgz",
      "integrity": "sha512-hpr+J05B2FVYUAXHeK1YyI267J/dDDhMU6B6civm8hSY1jYJnBXxzKDKDswzJmtLHryrjhnDjqqp/49t8FALew==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "postcss-value-parser": "^4.0.0",
        "read-cache": "^1.0.0",
        "resolve": "^1.1.7"
      },
      "engines": {
        "node": ">=14.0.0"
      },
      "peerDependencies": {
        "postcss": "^8.0.0"
      }
    },
    "node_modules/postcss-js": {
      "version": "4.0.1",
      "resolved": "https://registry.npmjs.org/postcss-js/-/postcss-js-4.0.1.tgz",
      "integrity": "sha512-dDLF8pEO191hJMtlHFPRa8xsizHaM82MLfNkUHdUtVEV3tgTp5oj+8qbEqYM57SLfc74KSbw//4SeJma2LRVIw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "camelcase-css": "^2.0.1"
      },
      "engines": {
        "node": "^12 || ^14 || >= 16"
      },
      "funding": {
        "type": "opencollective",
        "url": "https://opencollective.com/postcss/"
      },
      "peerDependencies": {
        "postcss": "^8.4.21"
      }
    },
    "node_modules/postcss-load-config": {
      "version": "4.0.2",
      "resolved": "https://registry.npmjs.org/postcss-load-config/-/postcss-load-config-4.0.2.tgz",
      "integrity": "sha512-bSVhyJGL00wMVoPUzAVAnbEoWyqRxkjv64tUl427SKnPrENtq6hJwUojroMz2VB+Q1edmi4IfrAPpami5VVgMQ==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "lilconfig": "^3.0.0",
        "yaml": "^2.3.4"
      },
      "engines": {
        "node": ">= 14"
      },
      "peerDependencies": {
        "postcss": ">=8.0.9",
        "ts-node": ">=9.0.0"
      },
      "peerDependenciesMeta": {
        "postcss": {
          "optional": true
        },
        "ts-node": {
          "optional": true
        }
      }
    },
    "node_modules/postcss-nested": {
      "version": "6.2.0",
      "resolved": "https://registry.npmjs.org/postcss-nested/-/postcss-nested-6.2.0.tgz",
      "integrity": "sha512-HQbt28KulC5AJzG+cZtj9kvKB93CFCdLvog1WFLf1D+xmMvPGlBstkpTEZfK5+AN9hfJocyBFCNiqyS48bpgzQ==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/postcss/"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "postcss-selector-parser": "^6.1.1"
      },
      "engines": {
        "node": ">=12.0"
      },
      "peerDependencies": {
        "postcss": "^8.2.14"
      }
    },
    "node_modules/postcss-selector-parser": {
      "version": "6.1.2",
      "resolved": "https://registry.npmjs.org/postcss-selector-parser/-/postcss-selector-parser-6.1.2.tgz",
      "integrity": "sha512-Q8qQfPiZ+THO/3ZrOrO0cJJKfpYCagtMUkXbnEfmgUjwXg6z/WBeOyS9APBBPCTSiDV+s4SwQGu8yFsiMRIudg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "cssesc": "^3.0.0",
        "util-deprecate": "^1.0.2"
      },
      "engines": {
        "node": ">=4"
      }
    },
    "node_modules/postcss-value-parser": {
      "version": "4.2.0",
      "resolved": "https://registry.npmjs.org/postcss-value-parser/-/postcss-value-parser-4.2.0.tgz",
      "integrity": "sha512-1NNCs6uurfkVbeXG4S8JFT9t19m45ICnif8zWLd5oPSZ50QnwMfK+H3jv408d4jw/7Bttv5axS5IiHoLaVNHeQ==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/proxy-from-env": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/proxy-from-env/-/proxy-from-env-1.1.0.tgz",
      "integrity": "sha512-D+zkORCbA9f1tdWRK0RaCR3GPv50cMxcrz4X8k5LTSUD1Dkw47mKJEZQNunItRTkWwgtaUSo1RVFRIG9ZXiFYg==",
      "license": "MIT"
    },
    "node_modules/queue-microtask": {
      "version": "1.2.3",
      "resolved": "https://registry.npmjs.org/queue-microtask/-/queue-microtask-1.2.3.tgz",
      "integrity": "sha512-NuaNSa6flKT5JaSYQzJok04JzTL1CA6aGhv5rfLW3PgqA+M2ChpZQnAC8h8i4ZFkBS8X5RqkDBHA7r4hej3K9A==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "license": "MIT"
    },
    "node_modules/read-cache": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/read-cache/-/read-cache-1.0.0.tgz",
      "integrity": "sha512-Owdv/Ft7IjOgm/i0xvNDZ1LrRANRfew4b2prF3OWMQLxLfu3bS8FVhCsrSCMK4lR56Y9ya+AThoTpDCTxCmpRA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "pify": "^2.3.0"
      }
    },
    "node_modules/readdirp": {
      "version": "3.6.0",
      "resolved": "https://registry.npmjs.org/readdirp/-/readdirp-3.6.0.tgz",
      "integrity": "sha512-hOS089on8RduqdbhvQ5Z37A0ESjsqz6qnRcffsMU3495FuTdqSm+7bhJ29JvIOsBDEEnan5DPu9t3To9VRlMzA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "picomatch": "^2.2.1"
      },
      "engines": {
        "node": ">=8.10.0"
      }
    },
    "node_modules/resolve": {
      "version": "1.22.10",
      "resolved": "https://registry.npmjs.org/resolve/-/resolve-1.22.10.tgz",
      "integrity": "sha512-NPRy+/ncIMeDlTAsuqwKIiferiawhefFJtkNSW0qZJEqMEb+qBt/77B/jGeeek+F0uOeN05CDa6HXbbIgtVX4w==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "is-core-module": "^2.16.0",
        "path-parse": "^1.0.7",
        "supports-preserve-symlinks-flag": "^1.0.0"
      },
      "bin": {
        "resolve": "bin/resolve"
      },
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/reusify": {
      "version": "1.1.0",
      "resolved": "https://registry.npmjs.org/reusify/-/reusify-1.1.0.tgz",
      "integrity": "sha512-g6QUff04oZpHs0eG5p83rFLhHeV00ug/Yf9nZM6fLeUrPguBTkTQOdpAWWspMh55TZfVQDPaN3NQJfbVRAxdIw==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "iojs": ">=1.0.0",
        "node": ">=0.10.0"
      }
    },
    "node_modules/rfdc": {
      "version": "1.4.1",
      "resolved": "https://registry.npmjs.org/rfdc/-/rfdc-1.4.1.tgz",
      "integrity": "sha512-q1b3N5QkRUWUl7iyylaaj3kOpIT0N2i9MqIEQXP73GVsN9cw3fdx8X63cEmWhJGi2PPCF23Ijp7ktmd39rawIA==",
      "license": "MIT"
    },
    "node_modules/rollup": {
      "version": "4.50.0",
      "resolved": "https://registry.npmjs.org/rollup/-/rollup-4.50.0.tgz",
      "integrity": "sha512-/Zl4D8zPifNmyGzJS+3kVoyXeDeT/GrsJM94sACNg9RtUE0hrHa1bNPtRSrfHTMH5HjRzce6K7rlTh3Khiw+pw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@types/estree": "1.0.8"
      },
      "bin": {
        "rollup": "dist/bin/rollup"
      },
      "engines": {
        "node": ">=18.0.0",
        "npm": ">=8.0.0"
      },
      "optionalDependencies": {
        "@rollup/rollup-android-arm-eabi": "4.50.0",
        "@rollup/rollup-android-arm64": "4.50.0",
        "@rollup/rollup-darwin-arm64": "4.50.0",
        "@rollup/rollup-darwin-x64": "4.50.0",
        "@rollup/rollup-freebsd-arm64": "4.50.0",
        "@rollup/rollup-freebsd-x64": "4.50.0",
        "@rollup/rollup-linux-arm-gnueabihf": "4.50.0",
        "@rollup/rollup-linux-arm-musleabihf": "4.50.0",
        "@rollup/rollup-linux-arm64-gnu": "4.50.0",
        "@rollup/rollup-linux-arm64-musl": "4.50.0",
        "@rollup/rollup-linux-loongarch64-gnu": "4.50.0",
        "@rollup/rollup-linux-ppc64-gnu": "4.50.0",
        "@rollup/rollup-linux-riscv64-gnu": "4.50.0",
        "@rollup/rollup-linux-riscv64-musl": "4.50.0",
        "@rollup/rollup-linux-s390x-gnu": "4.50.0",
        "@rollup/rollup-linux-x64-gnu": "4.50.0",
        "@rollup/rollup-linux-x64-musl": "4.50.0",
        "@rollup/rollup-openharmony-arm64": "4.50.0",
        "@rollup/rollup-win32-arm64-msvc": "4.50.0",
        "@rollup/rollup-win32-ia32-msvc": "4.50.0",
        "@rollup/rollup-win32-x64-msvc": "4.50.0",
        "fsevents": "~2.3.2"
      }
    },
    "node_modules/run-parallel": {
      "version": "1.2.0",
      "resolved": "https://registry.npmjs.org/run-parallel/-/run-parallel-1.2.0.tgz",
      "integrity": "sha512-5l4VyZR86LZ/lDxZTR6jqL8AFE2S0IFLMP26AbjsLVADxHdhB/c0GUsH+y39UfCi3dzz8OlQuPmnaJOMoDHQBA==",
      "dev": true,
      "funding": [
        {
          "type": "github",
          "url": "https://github.com/sponsors/feross"
        },
        {
          "type": "patreon",
          "url": "https://www.patreon.com/feross"
        },
        {
          "type": "consulting",
          "url": "https://feross.org/support"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "queue-microtask": "^1.2.2"
      }
    },
    "node_modules/shebang-command": {
      "version": "2.0.0",
      "resolved": "https://registry.npmjs.org/shebang-command/-/shebang-command-2.0.0.tgz",
      "integrity": "sha512-kHxr2zZpYtdmrN1qDjrrX/Z1rR1kG8Dx+gkpK1G4eXmvXswmcE1hTWBWYUzlraYw1/yZp6YuDY77YtvbN0dmDA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "shebang-regex": "^3.0.0"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/shebang-regex": {
      "version": "3.0.0",
      "resolved": "https://registry.npmjs.org/shebang-regex/-/shebang-regex-3.0.0.tgz",
      "integrity": "sha512-7++dFhtcx3353uBaq8DDR4NuxBetBzC7ZQOhmTQInHEd6bSrXdiEyzCvG07Z44UYdLShWUyXt5M/yhz8ekcb1A==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/signal-exit": {
      "version": "4.1.0",
      "resolved": "https://registry.npmjs.org/signal-exit/-/signal-exit-4.1.0.tgz",
      "integrity": "sha512-bzyZ1e88w9O1iNJbKnOlvYTrWPDl46O1bG0D3XInv+9tkPrxrN8jUUTiFlDkkmKWgn1M6CfIA13SuGqOa9Korw==",
      "dev": true,
      "license": "ISC",
      "engines": {
        "node": ">=14"
      },
      "funding": {
        "url": "https://github.com/sponsors/isaacs"
      }
    },
    "node_modules/source-map-js": {
      "version": "1.2.1",
      "resolved": "https://registry.npmjs.org/source-map-js/-/source-map-js-1.2.1.tgz",
      "integrity": "sha512-UXWMKhLOwVKb728IUtQPXxfYU+usdybtUrK/8uGE8CQMvrhOpwvzDBwj0QhSL7MQc7vIsISBG8VQ8+IDQxpfQA==",
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/speakingurl": {
      "version": "14.0.1",
      "resolved": "https://registry.npmjs.org/speakingurl/-/speakingurl-14.0.1.tgz",
      "integrity": "sha512-1POYv7uv2gXoyGFpBCmpDVSNV74IfsWlDW216UPjbWufNf+bSU6GdbDsxdcxtfwb4xlI3yxzOTKClUosxARYrQ==",
      "license": "BSD-3-Clause",
      "engines": {
        "node": ">=0.10.0"
      }
    },
    "node_modules/string-width": {
      "version": "5.1.2",
      "resolved": "https://registry.npmjs.org/string-width/-/string-width-5.1.2.tgz",
      "integrity": "sha512-HnLOCR3vjcY8beoNLtcjZ5/nxn2afmME6lhrDrebokqMap+XbeW8n9TXpPDOqdGK5qcI3oT0GKTW6wC7EMiVqA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "eastasianwidth": "^0.2.0",
        "emoji-regex": "^9.2.2",
        "strip-ansi": "^7.0.1"
      },
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/sindresorhus"
      }
    },
    "node_modules/string-width-cjs": {
      "name": "string-width",
      "version": "4.2.3",
      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "emoji-regex": "^8.0.0",
        "is-fullwidth-code-point": "^3.0.0",
        "strip-ansi": "^6.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/string-width-cjs/node_modules/ansi-regex": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-5.0.1.tgz",
      "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/string-width-cjs/node_modules/emoji-regex": {
      "version": "8.0.0",
      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/string-width-cjs/node_modules/strip-ansi": {
      "version": "6.0.1",
      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
      "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ansi-regex": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/strip-ansi": {
      "version": "7.1.0",
      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-7.1.0.tgz",
      "integrity": "sha512-iq6eVVI64nQQTRYq2KtEg2d2uU7LElhTJwsH4YzIHZshxlgZms/wIc4VoDQTlG/IvVIrBKG06CrZnp0qv7hkcQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ansi-regex": "^6.0.1"
      },
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/chalk/strip-ansi?sponsor=1"
      }
    },
    "node_modules/strip-ansi-cjs": {
      "name": "strip-ansi",
      "version": "6.0.1",
      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
      "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ansi-regex": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/strip-ansi-cjs/node_modules/ansi-regex": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-5.0.1.tgz",
      "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/sucrase": {
      "version": "3.35.0",
      "resolved": "https://registry.npmjs.org/sucrase/-/sucrase-3.35.0.tgz",
      "integrity": "sha512-8EbVDiu9iN/nESwxeSxDKe0dunta1GOlHufmSSXxMD2z2/tMZpDMpvXQGsc+ajGo8y2uYUmixaSRUc/QPoQ0GA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@jridgewell/gen-mapping": "^0.3.2",
        "commander": "^4.0.0",
        "glob": "^10.3.10",
        "lines-and-columns": "^1.1.6",
        "mz": "^2.7.0",
        "pirates": "^4.0.1",
        "ts-interface-checker": "^0.1.9"
      },
      "bin": {
        "sucrase": "bin/sucrase",
        "sucrase-node": "bin/sucrase-node"
      },
      "engines": {
        "node": ">=16 || 14 >=14.17"
      }
    },
    "node_modules/superjson": {
      "version": "2.2.2",
      "resolved": "https://registry.npmjs.org/superjson/-/superjson-2.2.2.tgz",
      "integrity": "sha512-5JRxVqC8I8NuOUjzBbvVJAKNM8qoVuH0O77h4WInc/qC2q5IreqKxYwgkga3PfA22OayK2ikceb/B26dztPl+Q==",
      "license": "MIT",
      "dependencies": {
        "copy-anything": "^3.0.2"
      },
      "engines": {
        "node": ">=16"
      }
    },
    "node_modules/supports-preserve-symlinks-flag": {
      "version": "1.0.0",
      "resolved": "https://registry.npmjs.org/supports-preserve-symlinks-flag/-/supports-preserve-symlinks-flag-1.0.0.tgz",
      "integrity": "sha512-ot0WnXS9fgdkgIcePe6RHNk1WA8+muPa6cSjeR3V8K27q9BB1rTE3R1p7Hv0z1ZyAc8s6Vvv8DIyWf681MAt0w==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">= 0.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/ljharb"
      }
    },
    "node_modules/tailwindcss": {
      "version": "3.4.17",
      "resolved": "https://registry.npmjs.org/tailwindcss/-/tailwindcss-3.4.17.tgz",
      "integrity": "sha512-w33E2aCvSDP0tW9RZuNXadXlkHXqFzSkQew/aIa2i/Sj8fThxwovwlXHSPXTbAHwEIhBFXAedUhP2tueAKP8Og==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "@alloc/quick-lru": "^5.2.0",
        "arg": "^5.0.2",
        "chokidar": "^3.6.0",
        "didyoumean": "^1.2.2",
        "dlv": "^1.1.3",
        "fast-glob": "^3.3.2",
        "glob-parent": "^6.0.2",
        "is-glob": "^4.0.3",
        "jiti": "^1.21.6",
        "lilconfig": "^3.1.3",
        "micromatch": "^4.0.8",
        "normalize-path": "^3.0.0",
        "object-hash": "^3.0.0",
        "picocolors": "^1.1.1",
        "postcss": "^8.4.47",
        "postcss-import": "^15.1.0",
        "postcss-js": "^4.0.1",
        "postcss-load-config": "^4.0.2",
        "postcss-nested": "^6.2.0",
        "postcss-selector-parser": "^6.1.2",
        "resolve": "^1.22.8",
        "sucrase": "^3.35.0"
      },
      "bin": {
        "tailwind": "lib/cli.js",
        "tailwindcss": "lib/cli.js"
      },
      "engines": {
        "node": ">=14.0.0"
      }
    },
    "node_modules/thenify": {
      "version": "3.3.1",
      "resolved": "https://registry.npmjs.org/thenify/-/thenify-3.3.1.tgz",
      "integrity": "sha512-RVZSIV5IG10Hk3enotrhvz0T9em6cyHBLkH/YAZuKqd8hRkKhSfCGIcP2KUY0EPxndzANBmNllzWPwak+bheSw==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "any-promise": "^1.0.0"
      }
    },
    "node_modules/thenify-all": {
      "version": "1.6.0",
      "resolved": "https://registry.npmjs.org/thenify-all/-/thenify-all-1.6.0.tgz",
      "integrity": "sha512-RNxQH/qI8/t3thXJDwcstUO4zeqo64+Uy/+sNVRBx4Xn2OX+OZ9oP+iJnNFqplFra2ZUVeKCSa2oVWi3T4uVmA==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "thenify": ">= 3.1.0 < 4"
      },
      "engines": {
        "node": ">=0.8"
      }
    },
    "node_modules/tinyglobby": {
      "version": "0.2.15",
      "resolved": "https://registry.npmjs.org/tinyglobby/-/tinyglobby-0.2.15.tgz",
      "integrity": "sha512-j2Zq4NyQYG5XMST4cbs02Ak8iJUdxRM0XI5QyxXuZOzKOINmWurp3smXu3y5wDcJrptwpSjgXHzIQxR0omXljQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "fdir": "^6.5.0",
        "picomatch": "^4.0.3"
      },
      "engines": {
        "node": ">=12.0.0"
      },
      "funding": {
        "url": "https://github.com/sponsors/SuperchupuDev"
      }
    },
    "node_modules/tinyglobby/node_modules/fdir": {
      "version": "6.5.0",
      "resolved": "https://registry.npmjs.org/fdir/-/fdir-6.5.0.tgz",
      "integrity": "sha512-tIbYtZbucOs0BRGqPJkshJUYdL+SDH7dVM8gjy+ERp3WAUjLEFJE+02kanyHtwjWOnwrKYBiwAmM0p4kLJAnXg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=12.0.0"
      },
      "peerDependencies": {
        "picomatch": "^3 || ^4"
      },
      "peerDependenciesMeta": {
        "picomatch": {
          "optional": true
        }
      }
    },
    "node_modules/tinyglobby/node_modules/picomatch": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.3.tgz",
      "integrity": "sha512-5gTmgEY/sqK6gFXLIsQNH19lWb4ebPDLA4SdLP7dsWkIXHWlG66oPuVvXSGFPppYZz8ZDZq0dYYrbHfBCVUb1Q==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/to-regex-range": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/to-regex-range/-/to-regex-range-5.0.1.tgz",
      "integrity": "sha512-65P7iz6X5yEr1cwcgvQxbbIw7Uk3gOy5dIdtZ4rDveLqhrdJP+Li/Hx6tyK0NEb+2GCyneCMJiGqrADCSNk8sQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "is-number": "^7.0.0"
      },
      "engines": {
        "node": ">=8.0"
      }
    },
    "node_modules/ts-interface-checker": {
      "version": "0.1.13",
      "resolved": "https://registry.npmjs.org/ts-interface-checker/-/ts-interface-checker-0.1.13.tgz",
      "integrity": "sha512-Y/arvbn+rrz3JCKl9C4kVNfTfSm2/mEp5FSz5EsZSANGPSlQrpRI5M4PKF+mJnE52jOO90PnPSc3Ur3bTQw0gA==",
      "dev": true,
      "license": "Apache-2.0"
    },
    "node_modules/update-browserslist-db": {
      "version": "1.1.3",
      "resolved": "https://registry.npmjs.org/update-browserslist-db/-/update-browserslist-db-1.1.3.tgz",
      "integrity": "sha512-UxhIZQ+QInVdunkDAaiazvvT/+fXL5Osr0JZlJulepYu6Jd7qJtDZjlur0emRlT71EN3ScPoE7gvsuIKKNavKw==",
      "dev": true,
      "funding": [
        {
          "type": "opencollective",
          "url": "https://opencollective.com/browserslist"
        },
        {
          "type": "tidelift",
          "url": "https://tidelift.com/funding/github/npm/browserslist"
        },
        {
          "type": "github",
          "url": "https://github.com/sponsors/ai"
        }
      ],
      "license": "MIT",
      "dependencies": {
        "escalade": "^3.2.0",
        "picocolors": "^1.1.1"
      },
      "bin": {
        "update-browserslist-db": "cli.js"
      },
      "peerDependencies": {
        "browserslist": ">= 4.21.0"
      }
    },
    "node_modules/util-deprecate": {
      "version": "1.0.2",
      "resolved": "https://registry.npmjs.org/util-deprecate/-/util-deprecate-1.0.2.tgz",
      "integrity": "sha512-EPD5q1uXyFxJpCrLnCc1nHnq3gOa6DZBocAIiI2TaSCA7VCJ1UJDMagCzIkXNsUYfD1daK//LTEQ8xiIbrHtcw==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/vite": {
      "version": "7.1.6",
      "resolved": "https://registry.npmjs.org/vite/-/vite-7.1.6.tgz",
      "integrity": "sha512-SRYIB8t/isTwNn8vMB3MR6E+EQZM/WG1aKmmIUCfDXfVvKfc20ZpamngWHKzAmmu9ppsgxsg4b2I7c90JZudIQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "esbuild": "^0.25.0",
        "fdir": "^6.5.0",
        "picomatch": "^4.0.3",
        "postcss": "^8.5.6",
        "rollup": "^4.43.0",
        "tinyglobby": "^0.2.15"
      },
      "bin": {
        "vite": "bin/vite.js"
      },
      "engines": {
        "node": "^20.19.0 || >=22.12.0"
      },
      "funding": {
        "url": "https://github.com/vitejs/vite?sponsor=1"
      },
      "optionalDependencies": {
        "fsevents": "~2.3.3"
      },
      "peerDependencies": {
        "@types/node": "^20.19.0 || >=22.12.0",
        "jiti": ">=1.21.0",
        "less": "^4.0.0",
        "lightningcss": "^1.21.0",
        "sass": "^1.70.0",
        "sass-embedded": "^1.70.0",
        "stylus": ">=0.54.8",
        "sugarss": "^5.0.0",
        "terser": "^5.16.0",
        "tsx": "^4.8.1",
        "yaml": "^2.4.2"
      },
      "peerDependenciesMeta": {
        "@types/node": {
          "optional": true
        },
        "jiti": {
          "optional": true
        },
        "less": {
          "optional": true
        },
        "lightningcss": {
          "optional": true
        },
        "sass": {
          "optional": true
        },
        "sass-embedded": {
          "optional": true
        },
        "stylus": {
          "optional": true
        },
        "sugarss": {
          "optional": true
        },
        "terser": {
          "optional": true
        },
        "tsx": {
          "optional": true
        },
        "yaml": {
          "optional": true
        }
      }
    },
    "node_modules/vite/node_modules/fdir": {
      "version": "6.5.0",
      "resolved": "https://registry.npmjs.org/fdir/-/fdir-6.5.0.tgz",
      "integrity": "sha512-tIbYtZbucOs0BRGqPJkshJUYdL+SDH7dVM8gjy+ERp3WAUjLEFJE+02kanyHtwjWOnwrKYBiwAmM0p4kLJAnXg==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=12.0.0"
      },
      "peerDependencies": {
        "picomatch": "^3 || ^4"
      },
      "peerDependenciesMeta": {
        "picomatch": {
          "optional": true
        }
      }
    },
    "node_modules/vite/node_modules/picomatch": {
      "version": "4.0.3",
      "resolved": "https://registry.npmjs.org/picomatch/-/picomatch-4.0.3.tgz",
      "integrity": "sha512-5gTmgEY/sqK6gFXLIsQNH19lWb4ebPDLA4SdLP7dsWkIXHWlG66oPuVvXSGFPppYZz8ZDZq0dYYrbHfBCVUb1Q==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/sponsors/jonschlinkert"
      }
    },
    "node_modules/vue": {
      "version": "3.5.20",
      "resolved": "https://registry.npmjs.org/vue/-/vue-3.5.20.tgz",
      "integrity": "sha512-2sBz0x/wis5TkF1XZ2vH25zWq3G1bFEPOfkBcx2ikowmphoQsPH6X0V3mmPCXA2K1N/XGTnifVyDQP4GfDDeQw==",
      "license": "MIT",
      "dependencies": {
        "@vue/compiler-dom": "3.5.20",
        "@vue/compiler-sfc": "3.5.20",
        "@vue/runtime-dom": "3.5.20",
        "@vue/server-renderer": "3.5.20",
        "@vue/shared": "3.5.20"
      },
      "peerDependencies": {
        "typescript": "*"
      },
      "peerDependenciesMeta": {
        "typescript": {
          "optional": true
        }
      }
    },
    "node_modules/vue-chartjs": {
      "version": "5.3.2",
      "resolved": "https://registry.npmjs.org/vue-chartjs/-/vue-chartjs-5.3.2.tgz",
      "integrity": "sha512-NrkbRRoYshbXbWqJkTN6InoDVwVb90C0R7eAVgMWcB9dPikbruaOoTFjFYHE/+tNPdIe6qdLCDjfjPHQ0fw4jw==",
      "license": "MIT",
      "peerDependencies": {
        "chart.js": "^4.1.1",
        "vue": "^3.0.0-0 || ^2.7.0"
      }
    },
    "node_modules/vue-router": {
      "version": "4.5.1",
      "resolved": "https://registry.npmjs.org/vue-router/-/vue-router-4.5.1.tgz",
      "integrity": "sha512-ogAF3P97NPm8fJsE4by9dwSYtDwXIY1nFY9T6DyQnGHd1E2Da94w9JIolpe42LJGIl0DwOHBi8TcRPlPGwbTtw==",
      "license": "MIT",
      "dependencies": {
        "@vue/devtools-api": "^6.6.4"
      },
      "funding": {
        "url": "https://github.com/sponsors/posva"
      },
      "peerDependencies": {
        "vue": "^3.2.0"
      }
    },
    "node_modules/vue-router/node_modules/@vue/devtools-api": {
      "version": "6.6.4",
      "resolved": "https://registry.npmjs.org/@vue/devtools-api/-/devtools-api-6.6.4.tgz",
      "integrity": "sha512-sGhTPMuXqZ1rVOk32RylztWkfXTRhuS7vgAKv0zjqk8gbsHkJ7xfFf+jbySxt7tWObEJwyKaHMikV/WGDiQm8g==",
      "license": "MIT"
    },
    "node_modules/which": {
      "version": "2.0.2",
      "resolved": "https://registry.npmjs.org/which/-/which-2.0.2.tgz",
      "integrity": "sha512-BLI3Tl1TW3Pvl70l3yq3Y64i+awpwXqsGBYWkkqMtnbXgrMD+yj7rhW0kuEDxzJaYXGjEW5ogapKNMEKNMjibA==",
      "dev": true,
      "license": "ISC",
      "dependencies": {
        "isexe": "^2.0.0"
      },
      "bin": {
        "node-which": "bin/node-which"
      },
      "engines": {
        "node": ">= 8"
      }
    },
    "node_modules/wrap-ansi": {
      "version": "8.1.0",
      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-8.1.0.tgz",
      "integrity": "sha512-si7QWI6zUMq56bESFvagtmzMdGOtoxfR+Sez11Mobfc7tm+VkUckk9bW2UeffTGVUbOksxmSw0AA2gs8g71NCQ==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ansi-styles": "^6.1.0",
        "string-width": "^5.0.1",
        "strip-ansi": "^7.0.1"
      },
      "engines": {
        "node": ">=12"
      },
      "funding": {
        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
      }
    },
    "node_modules/wrap-ansi-cjs": {
      "name": "wrap-ansi",
      "version": "7.0.0",
      "resolved": "https://registry.npmjs.org/wrap-ansi/-/wrap-ansi-7.0.0.tgz",
      "integrity": "sha512-YVGIj2kamLSTxw6NsZjoBxfSwsn0ycdesmc4p+Q21c5zPuZ1pl+NfxVdxPtdHvmNVOQ6XSYG4AUtyt/Fi7D16Q==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ansi-styles": "^4.0.0",
        "string-width": "^4.1.0",
        "strip-ansi": "^6.0.0"
      },
      "engines": {
        "node": ">=10"
      },
      "funding": {
        "url": "https://github.com/chalk/wrap-ansi?sponsor=1"
      }
    },
    "node_modules/wrap-ansi-cjs/node_modules/ansi-regex": {
      "version": "5.0.1",
      "resolved": "https://registry.npmjs.org/ansi-regex/-/ansi-regex-5.0.1.tgz",
      "integrity": "sha512-quJQXlTSUGL2LH9SUXo8VwsY4soanhgo6LNSm84E1LBcE8s3O0wpdiRzyR9z/ZZJMlMWv37qOOb9pdJlMUEKFQ==",
      "dev": true,
      "license": "MIT",
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/wrap-ansi-cjs/node_modules/ansi-styles": {
      "version": "4.3.0",
      "resolved": "https://registry.npmjs.org/ansi-styles/-/ansi-styles-4.3.0.tgz",
      "integrity": "sha512-zbB9rCJAT1rbjiVDb2hqKFHNYLxgtk8NURxZ3IZwD3F6NtxbXZQCnnSi1Lkx+IDohdPlFp222wVALIheZJQSEg==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "color-convert": "^2.0.1"
      },
      "engines": {
        "node": ">=8"
      },
      "funding": {
        "url": "https://github.com/chalk/ansi-styles?sponsor=1"
      }
    },
    "node_modules/wrap-ansi-cjs/node_modules/emoji-regex": {
      "version": "8.0.0",
      "resolved": "https://registry.npmjs.org/emoji-regex/-/emoji-regex-8.0.0.tgz",
      "integrity": "sha512-MSjYzcWNOA0ewAHpz0MxpYFvwg6yjy1NG3xteoqz644VCo/RPgnr1/GGt+ic3iJTzQ8Eu3TdM14SawnVUmGE6A==",
      "dev": true,
      "license": "MIT"
    },
    "node_modules/wrap-ansi-cjs/node_modules/string-width": {
      "version": "4.2.3",
      "resolved": "https://registry.npmjs.org/string-width/-/string-width-4.2.3.tgz",
      "integrity": "sha512-wKyQRQpjJ0sIp62ErSZdGsjMJWsap5oRNihHhu6G7JVO/9jIB6UyevL+tXuOqrng8j/cxKTWyWUwvSTriiZz/g==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "emoji-regex": "^8.0.0",
        "is-fullwidth-code-point": "^3.0.0",
        "strip-ansi": "^6.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/wrap-ansi-cjs/node_modules/strip-ansi": {
      "version": "6.0.1",
      "resolved": "https://registry.npmjs.org/strip-ansi/-/strip-ansi-6.0.1.tgz",
      "integrity": "sha512-Y38VPSHcqkFrCpFnQ9vuSXmquuv5oXOKpGeT6aGrr3o3Gc9AlVa6JBfUSOCnbxGGZF+/0ooI7KrPuUSztUdU5A==",
      "dev": true,
      "license": "MIT",
      "dependencies": {
        "ansi-regex": "^5.0.1"
      },
      "engines": {
        "node": ">=8"
      }
    },
    "node_modules/yaml": {
      "version": "2.8.1",
      "resolved": "https://registry.npmjs.org/yaml/-/yaml-2.8.1.tgz",
      "integrity": "sha512-lcYcMxX2PO9XMGvAJkJ3OsNMw+/7FKes7/hgerGUYWIoWu5j/+YQqcZr5JnPZWzOsEBgMbSbiSTn/dv/69Mkpw==",
      "dev": true,
      "license": "ISC",
      "bin": {
        "yaml": "bin.mjs"
      },
      "engines": {
        "node": ">= 14.6"
      }
    }
  }
}


{
  "name": "frontend",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "axios": "^1.12.2",
    "chart.js": "^4.5.0",
    "lucide-vue-next": "^0.540.0",
    "pinia": "^3.0.3",
    "vue": "^3.5.18",
    "vue-chartjs": "^5.3.2",
    "vue-router": "^4.5.1"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^6.0.1",
    "autoprefixer": "^10.4.21",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "vite": "^7.1.3"
  }
}


export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


/** @type {import('tailwindcss').Config} */
export default {
  content: ["./index.html", "./src/**/*.{vue,js,ts}"],
  darkMode: "class",
  theme: { extend: {} },
  plugins: [],
}


import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { fileURLToPath, URL } from 'node:url'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url)),
    },
  },
  server: {
    host: true,
    port: 5173,
    proxy: {
      '/api': {
        target: 'http://192.168.3.240:8000',
        changeOrigin: true,
      },
    },
  },
})

